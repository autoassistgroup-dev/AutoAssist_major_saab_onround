<!-- COMPLETELY REDESIGNED TICKET HEADER -->
<div
    class="redesigned-ticket-header bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl shadow-2xl p-8 mb-8">
    <!-- Title Section with Larger Text -->
    <div class="mb-8">
        <h1 class="text-4xl font-extrabold text-white mb-4 tracking-tight">
            #{{ ticket.ticket_id }} - {{ ticket.subject or 'No Subject' }}
        </h1>

        <!-- Priority & Technician - Larger Badges -->
        <div class="flex flex-wrap items-center gap-5">
            <div class="relative">
                <select id="prioritySelect"
                    class="px-6 py-3 text-base rounded-xl font-bold appearance-none cursor-pointer bg-slate-700 border-3 border-slate-600 text-white hover:bg-slate-600 transition-all shadow-lg"
                    style="min-width: 150px;" data-ticket-id="{{ ticket.ticket_id }}">
                    <option value="Urgent" {% if ticket.priority=='Urgent' %}selected{% endif %}>üî¥ URGENT</option>
                    <option value="High" {% if ticket.priority=='High' %}selected{% endif %}>üü† HIGH</option>
                    <option value="Medium" {% if ticket.priority=='Medium' %}selected{% endif %}>üü° MEDIUM</option>
                    <option value="Low" {% if ticket.priority=='Low' %}selected{% endif %}>üü¢ LOW</option>
                </select>
                <i
                    class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-white pointer-events-none"></i>
            </div>

            {% if technicians and technicians|length > 0 %}
            <div class="relative">
                <select id="technicianSelect"
                    class="px-6 py-3 text-base rounded-xl font-bold appearance-none cursor-pointer bg-slate-700 border-3 border-slate-600 text-white hover:bg-slate-600 transition-all shadow-lg"
                    style="min-width: 220px;" data-ticket-id="{{ ticket.ticket_id }}">
                    <option value="">üë§ Select Technician</option>
                    {% for tech in technicians %}\r\n <option value="{{ tech._id }}" {% if
                        (ticket.assigned_technician_id and ticket.assigned_technician_id|string==tech._id|string) or
                        (ticket.technician_id and ticket.technician_id|string==tech._id|string) %}selected{% endif %}>
                        {{ tech.name }} ({{ tech.role or 'Technician' }})
                    </option>
                    {% endfor %}
                </select>
                <i
                    class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-white pointer-events-none"></i>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Grid Layout: Info on Left, Actions on Right -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- LEFT COLUMN: Status Info & Assignment -->
        <div class="space-y-6">
            <!-- Status & Action Buttons Row -->
            <div class="flex flex-wrap items-center gap-4">
                <!-- Star Button - LARGER -->
                <button id="importantBtn"
                    class="importance-btn {% if ticket.is_important %}important{% endif %} w-16 h-16 rounded-2xl bg-amber-500/20 hover:bg-amber-500/30 border-3 border-amber-500/40 transition-all shadow-lg"
                    title="Mark as important">
                    <i
                        class="{% if ticket.is_important %}fas fa-star{% else %}far fa-star{% endif %} text-3xl text-amber-400"></i>
                </button>

                <!-- Status Dropdown - LARGER -->
                <div class="status-dropdown flex-1">
                    <button id="statusDropdownBtn"
                        class="status-dropdown-btn w-full px-6 py-4 rounded-2xl text-lg font-bold shadow-lg bg-blue-600 hover:bg-blue-700 text-white transition-all">
                        <span id="currentStatusDisplay">{{ ticket.status or 'Set Status' }}</span>
                        <i class="fas fa-chevron-down ml-3"></i>
                    </button>
                    <div id="statusDropdownContent" class="status-dropdown-content">
                        <div class="status-option" data-status="Open">Open</div>
                        <div class="status-option" data-status="New">New</div>
                        <div class="status-option" data-status="Form Sent">Form Sent</div>
                        <div class="status-option" data-status="Awaiting Submission">Awaiting Submission</div>
                        <div class="status-option" data-status="Under Review">Under Review</div>
                        <div class="status-option" data-status="Info Requested">Info Requested</div>
                        <div class="status-option" data-status="Warranty Form Received">Warranty Form Received</div>
                        <div class="status-option" data-status="Referred to Tech Director">Referred to Tech Director
                        </div>
                        <div class="status-option" data-status="Approved ‚Äì Revisit Booked">Approved ‚Äì Revisit Booked
                        </div>
                        <div class="status-option" data-status="Declined ‚Äì Not Covered">Declined ‚Äì Not Covered</div>
                        <div class="status-option" data-status="Revisit">Revisit</div>
                        <div class="status-option" data-status="Closed">Closed</div>
                    </div>
                </div>

                <!-- Close Ticket Button - LARGER -->
                {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed', 'declined', 'cancelled'] %}
                <button id="closeResolvedBtn"
                    class="px-6 py-4 flex items-center gap-3 rounded-2xl bg-red-600 text-white hover:bg-red-700 transition-all shadow-lg text-lg font-bold">
                    <i class="fas fa-lock text-xl"></i>
                    <span>Close</span>
                </button>
                {% endif %}
            </div>

            <!-- Assignment/Forwarding Card  - MUCH LARGER & MORE PROMINENT -->
            {% if ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member and
            ticket.assigned_member|length > 0 %}
            <div
                class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl p-6 shadow-2xl border-3 border-slate-600">
                <div class="flex items-start gap-5">
                    <div class="flex-shrink-0">
                        {% if ticket.assignment[0].is_forwarded %}
                        <div
                            class="w-20 h-20 rounded-2xl bg-blue-500/20 flex items-center justify-center border-3 border-blue-500/40">
                            <i class="fas fa-share text-blue-400 text-4xl"></i>
                        </div>
                        {% else %}
                        <div
                            class="w-20 h-20 rounded-2xl bg-green-500/20 flex items-center justify-center border-3 border-green-500/40">
                            <i class="fas fa-hand-paper text-green400 text-4xl"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <div class="text-2xl font-bold text-white mb-3">
                            {% if ticket.assignment[0].is_forwarded %}
                            {% if ticket.forwarded_to_member and ticket.forwarded_to_member|length > 0 %}
                            Forwarded to {{ ticket.forwarded_to_member[0].name }}
                            {% elif ticket.assigned_member and ticket.assigned_member|length > 0 %}
                            Forwarded to {{ ticket.assigned_member[0].name }}
                            {% else %}
                            Forwarded
                            {% endif %}
                            {% if ticket.forwarded_from_member and ticket.forwarded_from_member|length > 0 %}
                            <span class="text-slate-300 font-normal text-lg block mt-1">from {{
                                ticket.forwarded_from_member[0].name }}</span>
                            {% endif %}
                            {% else %}
                            Taken over by {{ ticket.assigned_member[0].name }}
                            {% endif %}
                        </div>

                        {% if ticket.assignment[0].assigned_at %}
                        <div class="flex items-center text-base text-slate-300 mb-4">
                            <i class="fas fa-clock mr-2 text-xl"></i>
                            <span>{{ ticket.assignment[0].assigned_at|format_datetime }}</span>
                        </div>
                        {% endif %}

                        <!-- NOTE SECTION - SUPER PROMINENT -->
                        {% if ticket.assignment[0].notes %}
                        <div
                            class="bg-gradient-to-r from-amber-500/30 to-orange-500/30 border-l-8 border-amber-400 rounded-r-2xl p-6 shadow-xl">
                            <div class="flex items-start gap-4">
                                <i class="fas fa-sticky-note text-amber-300 text-4xl"></i>
                                <div>
                                    <p class="text-xl font-extrabold text-amber-100 mb-3 flex items-center gap-2">
                                        <span>üìù NOTE:</span>
                                    </p>
                                    <p class="text-lg text-white leading-relaxed font-medium">{{
                                        ticket.assignment[0].notes }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- RIGHT COLUMN: Action Buttons -->
        <div class="space-y-5">
            <!-- Send Email Button - HUGE -->
            {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed', 'declined', 'cancelled'] %}
            <button id="emailTemplateBtn"
                class="w-full px-8 py-6 flex items-center justify-center gap-4 rounded-2xl bg-gradient-to-r from-purple-600 to-purple-500 text-white hover:from-purple-700 hover:to-purple-600 transition-all shadow-2xl transform hover:scale-105"
                title="Send email using template">
                <i class="fas fa-envelope-open-text text-3xl"></i>
                <span class="text-2xl font-bold">SEND EMAIL</span>
            </button>
            {% endif %}

            <!-- Forward Button - HUGE-->
            {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed', 'declined', 'cancelled'] %}
            {% set is_forwarded = ticket.is_forwarded and ticket.forwarded_to %}
            {% if is_forwarded and ticket.forwarded_to_member and ticket.forwarded_to_member|length > 0 %}
            <div id="forwardStatusBadge"
                class="w-full px-8 py-6 flex items-center justify-center gap-4 rounded-2xl bg-blue-500/20 text-blue-300 border-4 border-blue-500/40 shadow-xl text-xl font-bold">
                <i class="fas fa-share text-3xl"></i>
                <span>Forwarded to {{ ticket.forwarded_to_member[0].name }}</span>
            </div>
            {% else %}
            <button id="forwardBtn"
                class="w-full px-8 py-6 flex items-center justify-center gap-4 rounded-2xl {% if is_tech_director %}bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600{% else %}bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-700 hover:to-emerald-600{% endif %} text-white transition-all shadow-2xl transform hover:scale-105"
                title="Forward ticket">
                <i class="fas fa-share text-3xl"></i>
                <span class="text-2xl font-bold">{% if is_tech_director %}FORWARD TO SUPPORT{% else %}FORWARD TICKET{%
                    endif %}</span>
            </button>
            {% endif %}
            {% endif %}

            <!-- Refer to Tech Director - HUGE -->
            {% if not is_tech_director %}
            {% set can_refer_to_td = (ticket.status != 'Referred to Tech Director') and (ticket.status != 'Closed') and
            (ticket.status != 'Resolved') %}
            {% if can_refer_to_td %}
            <button id="referToTechDirectorBtn"
                class="w-full px-8 py-6 flex items-center justify-center gap-4 rounded-2xl bg-gradient-to-r from-amber-600 to-orange-500 text-white hover:from-amber-700 hover:to-orange-600 transition-all shadow-2xl transform hover:scale-105"
                title="Refer this ticket to Technical Director">
                <i class="fas fa-user-cog text-3xl"></i>
                <span class="text-2xl font-bold">REFER TO TECH DIRECTOR</span>
            </button>
            {% else %}
            {% if ticket.status == 'Referred to Tech Director' %}
            <div
                class="w-full px-8 py-6 rounded-2xl bg-gradient-to-r from-amber-600 to-orange-500 text-white border-4 border-amber-500 shadow-2xl flex items-center justify-center gap-4">
                <i class="fas fa-check-circle text-4xl"></i>
                <span class="text-2xl font-extrabold">WITH TECH DIRECTOR</span>
            </div>
            {% endif %}
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>