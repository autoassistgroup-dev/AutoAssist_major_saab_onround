<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoAssistGroup Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Socket.IO for real-time updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ===== ANIMATIONS FOR BACKGROUND REFRESH ===== */
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== DARK PROFESSIONAL THEME ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: #0a0a0f;
            color: #fff;
        }

        /* Background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(180deg, #0a0a0f 0%, #141420 100%);
        }

        .bg-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            transition: background-image 1s ease-in-out;
        }

        /* ===== NAVBAR ===== */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 12px 24px;
        }

        @media (min-width: 768px) {
            .navbar {
                padding: 12px 48px;
            }
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .nav-link-active {
            background: rgba(255, 117, 143, 0.15);
            border-color: rgba(255, 117, 143, 0.3);
            color: #ff758f;
        }

        .nav-link i {
            margin-right: 6px;
            font-size: 11px;
            opacity: 0.8;
        }

        /* ===== MAIN CONTAINER ===== */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 20px;
            padding-top: 80px;
            /* Account for fixed navbar */
        }

        @media (min-width: 768px) {
            .main-container {
                padding: 32px 48px;
                padding-top: 80px;
            }
        }

        /* ===== GLASS CARDS ===== */
        .glass-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            transition: all 0.2s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
        }

        /* ===== HEADER SECTION ===== */
        .header-section {
            padding: 24px;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }

        @media (min-width: 768px) {
            .page-title {
                font-size: 28px;
            }
        }

        .page-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
        }

        .stats-card {
            padding: 20px;
        }

        .stats-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-right: 14px;
            flex-shrink: 0;
        }

        .stats-icon.pink {
            background: rgba(255, 117, 143, 0.15);
            color: #ff758f;
        }

        .stats-icon.blue {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .stats-icon.yellow {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .stats-icon.green {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .stats-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .stats-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        /* ===== BREAKDOWN CARDS ===== */
        .breakdown-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (min-width: 768px) {
            .breakdown-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .breakdown-card {
            padding: 20px;
        }

        .breakdown-title {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 14px;
            font-weight: 500;
        }

        .badge-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .priority-badge,
        .type-badge,
        .status-badge,
        .method-badge {
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            font-weight: 700 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.3px;
        }

        .priority-badge {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(255, 255, 255, 0.7);
        }

        .badge-urgent {
            background: rgba(220, 38, 38, 0.12) !important;
            border-color: rgba(220, 38, 38, 0.25) !important;
            color: #fca5a5 !important;
        }

        .badge-fast {
            background: rgba(245, 158, 11, 0.10) !important;
            border-color: rgba(245, 158, 11, 0.20) !important;
            color: #fcd34d !important;
        }

        .badge-medium {
            background: rgba(255, 255, 255, 0.06) !important;
            border-color: rgba(255, 255, 255, 0.12) !important;
            color: rgba(255, 255, 255, 0.65) !important;
        }

        .badge-low {
            background: rgba(255, 255, 255, 0.04) !important;
            border-color: rgba(255, 255, 255, 0.08) !important;
            color: rgba(255, 255, 255, 0.5) !important;
        }

        .type-badge {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.2px;
        }

        .type-technical,
        .type-payment,
        .type-support,
        .type-warranty,
        .type-spam,
        .type-account {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.10) !important;
            color: rgba(255, 255, 255, 0.55) !important;
        }

        /* Special badges ‚Äî uniform subtle styling */
        .badge-forwarded {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.10) !important;
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .badge-assigned {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.10) !important;
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .badge-technician {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.10) !important;
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .badge-star {
            background: rgba(245, 158, 11, 0.10) !important;
            border: 1px solid rgba(245, 158, 11, 0.20) !important;
            color: #fbbf24 !important;
            padding: 4px 8px !important;
        }

        /* ===== FILTER SECTION ===== */
        .filter-section {
            padding: 20px;
            margin-bottom: 24px;
        }

        .filter-row {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        @media (min-width: 768px) {
            .filter-row {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .search-input {
            flex: 1;
            max-width: 400px;
            padding: 12px 16px 12px 42px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 14px;
        }

        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .custom-dropdown {
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 13px;
            min-width: 130px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-dropdown:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .custom-dropdown option {
            background: #1a1a24;
            color: #fff;
        }

        .clear-btn {
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .clear-btn:hover {
            color: #fff;
        }

        /* ===== TICKETS SECTION ===== */
        .tickets-section {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .total-badge {
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .tickets-grid {
            padding: 16px;
        }

        /* ===== TICKET TABLE ===== */
        .ticket-table-wrapper {
            overflow-x: auto;
            padding: 0;
        }

        .ticket-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .ticket-table thead th {
            padding: 10px 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: rgba(255, 255, 255, 0.45);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            text-align: left;
            white-space: nowrap;
            position: sticky;
            top: 0;
            background: rgba(15, 15, 20, 0.95);
            backdrop-filter: blur(8px);
        }

        .ticket-table tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .ticket-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .ticket-table tbody tr:not(:last-child) td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .ticket-table td {
            padding: 10px 10px;
            font-size: 11.5px;
            color: rgba(255, 255, 255, 0.75);
            vertical-align: middle;
            white-space: nowrap;
        }

        .ticket-table td a.table-row-link {
            color: inherit;
            text-decoration: none;
        }

        .ticket-table td.td-id {
            font-weight: 600;
            color: #3b82f6;
            font-size: 11px;
        }

        .ticket-table td.td-subject {
            max-width: 220px;
            overflow: hidden;
        }

        .ticket-table td.td-subject .subj-title {
            font-size: 11.5px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .ticket-table td.td-subject .subj-body {
            font-size: 11px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.40);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            margin-top: 2px;
        }

        .ticket-table td.td-user {
            max-width: 130px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ticket-table .td-user .user-name {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            font-size: 11.5px;
            display: block;
            line-height: 1.3;
        }

        .ticket-table .td-user .user-email {
            color: rgba(255, 255, 255, 0.35);
            font-size: 10px;
            display: block;
            line-height: 1.3;
        }

        .ticket-table td.td-priority .tbl-badge {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 46px;
        }

        .ticket-table td.td-status .tbl-badge {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: 500;
            display: inline-block;
            text-align: center;
            min-width: 46px;
        }

        .ticket-table td.td-tech,
        .ticket-table td.td-assignment {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        .ticket-table td.td-tech i,
        .ticket-table td.td-assignment i {
            margin-right: 4px;
            font-size: 9px;
            opacity: 0.6;
        }

        .ticket-table td.td-assignment .assign-forwarded {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ticket-table td.td-assignment .assign-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: rgba(255, 255, 255, 0.3);
        }

        .ticket-table td.td-assignment .assign-name {
            color: rgba(255, 255, 255, 0.65);
        }

        .ticket-table td.td-source .method-badge {
            font-size: 9px;
            padding: 2px 7px;
        }

        .ticket-table td.td-date {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            white-space: nowrap;
            min-width: 110px;
        }

        .ticket-table .unread-dot {
            width: 7px;
            height: 7px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: pulse 2s infinite;
            vertical-align: middle;
        }

        .ticket-table .star-indicator {
            color: #fbbf24;
            font-size: 10px;
            margin-left: 4px;
        }

        .ticket-table-empty {
            text-align: center;
            padding: 48px 20px;
            color: rgba(255, 255, 255, 0.35);
        }

        .ticket-table-empty i {
            font-size: 36px;
            margin-bottom: 12px;
            display: block;
            opacity: 0.4;
        }

        /* Responsive: stack columns on small screens */
        @media (max-width: 768px) {
            .ticket-table thead {
                display: none;
            }

            .ticket-table tbody tr {
                display: flex;
                flex-wrap: wrap;
                padding: 14px 16px;
                gap: 6px 12px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            }

            .ticket-table tbody tr:not(:last-child) td {
                border-bottom: none;
            }

            .ticket-table td {
                padding: 2px 0;
                white-space: normal;
                border: none !important;
            }

            .ticket-table td.td-id {
                width: auto;
            }

            .ticket-table td.td-subject {
                width: 100%;
                max-width: none;
                order: 10;
            }

            .ticket-table td.td-date {
                order: 20;
                margin-left: auto;
            }
        }

        /* ===== TICKET CARD (forwarded section only) ===== */
        div.ticket-card {
            display: flex;
            padding: 18px 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.2s ease;
        }

        div.ticket-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        div.ticket-card:last-child {
            margin-bottom: 0;
        }

        div.ticket-card a {
            display: flex;
            width: 100%;
            text-decoration: none;
            color: inherit;
        }

        .unread-indicator {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            margin-right: 14px;
            margin-top: 6px;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .ticket-content {
            flex: 1;
            min-width: 0;
        }

        .ticket-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .ticket-id {
            font-weight: 600;
            color: #3b82f6;
            font-size: 13px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-open {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.7);
        }

        .status-waiting {
            background: rgba(245, 158, 11, 0.08);
            border: 1px solid rgba(245, 158, 11, 0.18);
            color: #fcd34d;
        }

        .status-resolved {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.5);
        }

        .status-closed {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.35);
        }

        .status-new {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.75);
        }

        .ticket-subject {
            font-size: 15px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .ticket-body {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ticket-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
        }

        .ticket-meta i {
            margin-right: 5px;
            opacity: 0.7;
        }

        .ticket-sidebar {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            margin-left: 20px;
            flex-shrink: 0;
        }

        .method-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .method-email {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(255, 255, 255, 0.6);
        }

        .method-manual {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(255, 255, 255, 0.6);
        }

        /* ===== FORWARDED SECTION ===== */
        .forwarded-section {
            border-left: 3px solid #3b82f6;
        }

        .forwarded-header {
            color: #3b82f6;
        }

        /* ===== BUTTONS ===== */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .btn-primary i {
            margin-right: 8px;
        }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            padding: 10px 18px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .btn-secondary i {
            margin-right: 8px;
        }

        /* ===== USER AVATAR ===== */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .page-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .page-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .page-btn.active {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        /* ===== MOBILE MENU ===== */
        .mobile-menu {
            display: none;
            padding: 16px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            margin-top: 16px;
        }

        .mobile-menu.open {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .ticket-card {
                flex-direction: column;
            }

            .ticket-sidebar {
                flex-direction: row;
                margin-left: 0;
                margin-top: 14px;
                padding-top: 14px;
                border-top: 1px solid rgba(255, 255, 255, 0.06);
            }

            .header-actions {
                flex-direction: column;
                gap: 12px;
            }
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            padding: 48px 24px;
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* ===== FORWARDED TICKETS SECTION ===== */
        .forwarded-section-container {
            transition: all 0.3s ease;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.03);
        }

        .forwarded-section-container:fullscreen {
            border-radius: 0 !important;
            max-height: 100vh;
            overflow-y: auto;
        }

        .forwarded-section-container.fullscreen-mode {
            border-radius: 0 !important;
        }

        .forwarded-card {
            transition: all 0.2s ease;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }

        .forwarded-card:hover {
            background: rgba(255, 255, 255, 0.08) !important;
            transform: translateX(4px);
            border-left-color: rgba(255, 255, 255, 0.4);
        }

        .forwarded-card.unviewed {
            animation: pulse-white 2s infinite;
            border-left-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes pulse-white {

            0%,
            100% {
                box-shadow: inset 3px 0 0 rgba(255, 255, 255, 0.4);
            }

            50% {
                box-shadow: inset 3px 0 0 rgba(255, 255, 255, 0.6);
            }
        }

        .forwarded-meta {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .forwarded-badge {
            transition: all 0.2s ease;
        }

        .forwarded-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }

        .btn-fullscreen {
            transition: all 0.2s ease;
        }

        .btn-fullscreen:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            transform: scale(1.02);
        }

        /* Forwarded pill styling */
        .forwarded-pill {
            max-width: 100%;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .forwarded-pill {
                font-size: 10px !important;
                padding: 2px 8px !important;
            }

            .forwarded-card .ticket-sidebar {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
        }
    </style>
</head>

<body>
    <div class="bg-gradient"></div>
    {% if system_settings.show_background %}
    <div class="bg-image"></div>
    {% endif %}

    <!-- Navigation -->
    <nav class="navbar">
        <div class="flex items-center justify-between">
            <!-- Logo -->
            <div class="flex-1 flex justify-start">
                <a href="{% if current_user_role == 'Technical Director' %}/tech-director-dashboard{% else %}/{% endif %}"
                    class="flex items-center">
                    <img src="/static/logo.png" alt="AutoAssistGroup Logo" class="h-7 md:h-8">
                </a>
            </div>

            <!-- Navigation Links -->
            <div class="nav-links">
                <a href="/" class="nav-link nav-link-active">
                    <i class="fas fa-ticket-alt"></i>Tickets
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="fas fa-chart-line"></i>Dashboard
                </a>
                <a href="/create-ticket" class="nav-link">
                    <i class="fas fa-plus-circle"></i>Create Ticket
                </a>
                {% if current_user_role == 'Administrator' %}
                <a href="/technicians" class="nav-link">
                    <i class="fas fa-tools"></i>Technicians
                </a>
                <a href="/members" class="nav-link">
                    <i class="fas fa-users"></i>Members
                </a>
                <a href="/admin" class="nav-link">
                    <i class="fas fa-cog"></i>Admin Panel
                </a>
                {% endif %}
            </div>

            <!-- User Section -->
            <div class="flex items-center space-x-2">
                {% if current_user %}
                <span class="text-sm text-gray-400 hidden sm:inline">{{ current_user }}</span>
                <a href="/logout" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>Logout
                </a>
                {% else %}
                <a href="/login" class="nav-link">
                    <i class="fas fa-sign-in-alt"></i>Login
                </a>
                {% endif %}

                <!-- Hamburger menu button -->
                <button class="nav-link hamburger-btn" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <!-- Mobile menu (dropdown) -->
        <div id="mobileMenu" class="mobile-menu">
            <a href="/" class="nav-link nav-link-active">
                <i class="fas fa-ticket-alt"></i>Tickets
            </a>
            <a href="/dashboard" class="nav-link">
                <i class="fas fa-chart-line"></i>Dashboard
            </a>
            <a href="/create-ticket" class="nav-link">
                <i class="fas fa-plus-circle"></i>Create Ticket
            </a>
            {% if current_user_role == 'Administrator' %}
            <a href="/technicians" class="nav-link">
                <i class="fas fa-tools"></i>Technicians
            </a>
            <a href="/members" class="nav-link">
                <i class="fas fa-users"></i>Members
            </a>
            <a href="/admin" class="nav-link">
                <i class="fas fa-cog"></i>Admin Panel
            </a>
            {% endif %}
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Header Section -->
        <header class="glass-card header-section">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="page-title">AutoAssist Support Portal</h1>
                    <p class="page-subtitle">Manage and track support tickets efficiently</p>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 header-actions">
                    <span class="text-gray-400 text-sm">Welcome, {{ current_user }}</span>
                    <div class="flex items-center gap-2">
                        <a href="/create-ticket" class="btn-primary">
                            <i class="fas fa-plus"></i>Create Ticket
                        </a>
                        <button id="manualRefreshBtn" class="btn-secondary">
                            <i class="fas fa-sync-alt"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="glass-card stats-card">
                <div class="flex items-center">
                    <div class="stats-icon pink">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div>
                        <div class="stats-label">Total Tickets</div>
                        <div class="stats-value">{{ total_tickets }}</div>
                    </div>
                </div>
            </div>
            <div class="glass-card stats-card">
                <div class="flex items-center">
                    <div class="stats-icon blue">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div>
                        <div class="stats-label">Open Tickets</div>
                        <div class="stats-value">{{ open_tickets }}</div>
                    </div>
                </div>
            </div>
            <div class="glass-card stats-card">
                <div class="flex items-center">
                    <div class="stats-icon yellow">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <div class="stats-label">Waiting Response</div>
                        <div class="stats-value">{{ waiting_tickets }}</div>
                    </div>
                </div>
            </div>
            <div class="glass-card stats-card">
                <div class="flex items-center">
                    <div class="stats-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <div class="stats-label">Resolved</div>
                        <div class="stats-value">{{ resolved_tickets }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Breakdown Cards -->
        <div class="breakdown-grid">
            <div class="glass-card breakdown-card">
                <div class="breakdown-title">Priority Breakdown</div>
                <div class="badge-row">
                    {% for priority, count in priorities.items() %}
                    <span class="priority-badge 
                            {% if priority == 'Urgent' %}badge-urgent
                            {% elif priority == 'Fast' %}badge-fast
                            {% elif priority == 'Medium' %}badge-medium
                            {% else %}badge-low{% endif %}" data-priority="{{ priority }}">
                        {{ priority }}: {{ count }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            <div class="glass-card breakdown-card">
                <div class="breakdown-title">Type Breakdown</div>
                <div class="badge-row">
                    {% for classification, count in classifications.items() %}
                    {% if classification in ['Support', 'Technical Issue', 'Warranty Claim', 'Payment', 'Spam',
                    'Account'] %}
                    <span class="type-badge 
                            {% if classification == 'Technical Issue' %}type-technical
                            {% elif classification == 'Payment' %}type-payment
                            {% elif classification == 'Support' %}type-support
                            {% elif classification == 'Warranty Claim' %}type-warranty
                            {% elif classification == 'Spam' %}type-spam
                            {% else %}type-account{% endif %}" data-classification="{{ classification }}">
                        {% if classification == 'Warranty Claim' %}üõ°Ô∏è{% endif %}
                        {{ classification }}: {{ count }}
                    </span>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="glass-card filter-section">
            <div class="filter-row">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search tickets by ID, subject, email..."
                        class="search-input">
                </div>
                <div class="filters-container">
                    <select id="typeFilter" class="custom-dropdown">
                        <option value="All">All Types</option>
                        <option value="Technical Issue">Technical Issue</option>
                        <option value="Payment">Payment</option>
                        <option value="Support">Support</option>
                        <option value="Warranty Claim">Warranty Claim</option>
                        <option value="Account">Account</option>
                        <option value="Spam">Spam</option>
                    </select>
                    <select id="priorityFilter" class="custom-dropdown">
                        <option value="All">All Priority</option>
                        <option value="Urgent">Urgent</option>
                        <option value="Fast">Fast</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="statusFilter" class="custom-dropdown">
                        <option value="All">All Status</option>
                        <option value="Open">Open</option>
                        <option value="Waiting for Response">Waiting</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                    <button id="clearFilters" class="clear-btn">Clear Filters</button>
                </div>
            </div>
        </div>


        <!-- Forwarded to You Section (Not for Tech Director) -->
        {% if not is_tech_director and forwarded_tickets and forwarded_tickets|length > 0 %}
        <div class="glass-card forwarded-section-container">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-share" style="transform: scaleX(-1);"></i>Tickets Forwarded to You
                </h2>
                <span class="status-badge badge-forwarded" style="font-size: 12px; padding: 6px 14px;">
                    {{ forwarded_tickets|length }} pending
                </span>
            </div>
            <div class="tickets-grid" id="forwardedTicketsGrid">
                {% for ticket in forwarded_tickets %}
                <div class="ticket-card forwarded-card {% if not ticket.is_forwarded_viewed %}unviewed{% endif %}">
                    <a href="/ticket/{{ ticket.ticket_id }}">
                        <!-- Unread indicator for unviewed forwarded tickets -->
                        {% if not ticket.is_forwarded_viewed %}
                        <div class="unread-indicator"></div>
                        {% endif %}

                        <div class="ticket-content">
                            <div class="ticket-badges">
                                <span class="ticket-id">#{{ ticket.ticket_id }}</span>
                                <span class="priority-badge 
                                        {% if ticket.priority == 'Urgent' %}badge-urgent
                                        {% elif ticket.priority == 'Fast' %}badge-fast
                                        {% elif ticket.priority == 'Medium' %}badge-medium
                                        {% else %}badge-low{% endif %}">
                                    {{ ticket.priority }}
                                </span>

                                {% if ticket.classification %}
                                <span class="type-badge badge-classification
                                        {% if ticket.classification == 'Technical Issue' %}type-technical
                                        {% elif ticket.classification == 'Payment' %}type-payment
                                        {% elif ticket.classification == 'Support' %}type-support
                                        {% elif ticket.classification == 'Warranty Claim' %}type-warranty
                                        {% elif ticket.classification == 'Spam' %}type-spam{% endif %}">
                                    {{ ticket.classification }}
                                </span>
                                {% endif %}

                                <!-- Forwarding Info Badge (Green) -->
                                <span class="status-badge badge-assigned">
                                    <i class="fas fa-user" style="font-size: 9px; margin-right: 4px;"></i>
                                    From {{ ticket.forwarded_from_name|default('Unknown') }} ({{
                                    ticket.forwarded_from_role|default('Member') }})
                                </span>

                                <span class="status-badge badge-status
                                        {% if ticket.status == 'Open' %}status-open
                                        {% elif ticket.status == 'Waiting for Response' %}status-waiting
                                        {% elif ticket.status == 'Closed' %}status-closed
                                        {% elif ticket.status == 'Resolved' %}status-resolved
                                        {% else %}status-new{% endif %}">
                                    {{ ticket.status }}
                                </span>
                            </div>

                            <h3 class="ticket-subject">{{ ticket.subject | default('No Subject') }}</h3>
                            <p class="ticket-body">{{ ticket.body | default('No Body') }}</p>

                            {% if ticket.forwarding_note %}
                            <div
                                style="margin-top: 6px; padding: 6px 10px; background: rgba(255,255,255,0.06); border-left: 2px solid rgba(255,255,255,0.3); border-radius: 4px; font-size: 12px; color: rgba(255,255,255,0.7);">
                                <i class="fas fa-comment-dots"
                                    style="margin-right: 5px; font-size: 10px; opacity: 0.6;"></i>
                                <em>"{{ ticket.forwarding_note }}"</em>
                            </div>
                            {% endif %}

                            <div class="ticket-meta">
                                <span><i class="fas fa-user"></i>{{ ticket.name or ((ticket.customer_first_name or '') ~
                                    ' ' ~ (ticket.customer_surname or ''))|trim or 'Anonymous' }}</span>
                                <span><i class="fas fa-envelope"></i>{{ ticket.email | default('No Email') }}</span>
                                {% if ticket.formatted_forwarded_at %}
                                <span class="forwarded-meta">
                                    <i class="fas fa-clock"></i>Forwarded: {{ ticket.formatted_forwarded_at }}
                                </span>
                                {% else %}
                                <span><i class="fas fa-clock"></i>{{ ticket.created_at | format_datetime }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Manual/Email Badge Sidebar with Unviewed tag -->
                        <div class="ticket-sidebar">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if not ticket.is_forwarded_viewed %}
                                <span class="status-badge"
                                    style="background: rgba(255, 255, 255, 0.15); color: #ffffff; font-size: 10px; padding: 2px 8px;">Unviewed</span>
                                {% endif %}
                                <span class="method-badge 
                                    {% if ticket.ticket_id and ticket.ticket_id[:1] == 'M' %}method-manual
                                    {% else %}method-email{% endif %}">
                                    {% if ticket.ticket_id and ticket.ticket_id[:1] == 'M' %}
                                    <i class="fas fa-user-edit"></i> Manual
                                    {% else %}
                                    <i class="fas fa-envelope"></i> Email
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Main Tickets Section -->
        <div class="glass-card tickets-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list-ul"></i>Recent Tickets
                </h2>
                <span class="total-badge">Total: {{ total_tickets }}</span>
            </div>
            <div class="ticket-table-wrapper" id="mainTicketsGrid">
                <table class="ticket-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Subject</th>
                            <th>User</th>
                            <th>Technician</th>
                            <th>Takeover / Forwarded</th>
                            <th>Source</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="ticketTableBody">
                        {% for ticket in tickets %}
                        <tr class="ticket-card" onclick="window.location='/ticket/{{ ticket.ticket_id }}'">
                            <td class="td-id">
                                {% if ticket.has_unread_reply %}<span class="unread-dot"></span>{% endif %}#{{
                                ticket.ticket_id }}
                                {% if ticket.is_important %}<i class="fas fa-star star-indicator"></i>{% endif %}
                            </td>
                            <td class="td-priority">
                                <span class="tbl-badge priority-badge
                                    {% if ticket.priority == 'Urgent' %}badge-urgent
                                    {% elif ticket.priority == 'Fast' %}badge-fast
                                    {% elif ticket.priority == 'Medium' %}badge-medium
                                    {% else %}badge-low{% endif %}">
                                    {{ ticket.priority }}
                                </span>
                            </td>
                            <td class="td-status">
                                <span class="tbl-badge status-badge badge-status
                                    {% if ticket.status == 'Open' %}status-open
                                    {% elif ticket.status == 'Waiting for Response' %}status-waiting
                                    {% elif ticket.status == 'Closed' %}status-closed
                                    {% elif ticket.status == 'Resolved' %}status-resolved
                                    {% else %}status-new{% endif %}">
                                    {{ ticket.status }}
                                </span>
                            </td>
                            <td class="td-subject">
                                <div class="subj-title">{{ ticket.subject | default('No Subject') }}</div>
                                {% set body_text = ticket.body or ticket.message or ticket.description or '' %}
                                {% if body_text %}
                                <div class="subj-body">{{ body_text | striptags | truncate(120, true, '‚Ä¶') }}</div>
                                {% endif %}
                            </td>
                            <td class="td-user">
                                <span class="user-name">{{ ticket.name or ((ticket.customer_first_name or '') ~ ' ' ~
                                    (ticket.customer_surname or ''))|trim or 'Anonymous' }}</span>
                                <span class="user-email">{{ ticket.email | default('No Email') }}</span>
                            </td>
                            <td class="td-tech">
                                {% if ticket.assigned_technician or ticket.technician_name %}
                                <i class="fas fa-wrench"></i>{{ (ticket.technician_name or
                                ticket.assigned_technician)|truncate(15, True, '...') }}
                                {% else %}
                                <span style="color: rgba(255,255,255,0.2);">‚Äî</span>
                                {% endif %}
                            </td>
                            <td class="td-assignment">
                                <div class="assign-forwarded">
                                    {% if ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member
                                    and ticket.assigned_member|length > 0 %}
                                    <div>
                                        <span class="assign-label">Takeover</span>
                                        <span class="assign-name"><i class="fas fa-user-check"></i>{{
                                            ticket.assigned_member[0].name|truncate(15, True, '...') }}</span>
                                    </div>
                                    {% endif %}
                                    {% if ticket.is_forwarded and ticket.forwarded_to_member and
                                    ticket.forwarded_to_member|length > 0 %}
                                    <div>
                                        <span class="assign-label">Forwarded</span>
                                        <span class="assign-name"><i class="fas fa-share"
                                                style="transform: scaleX(-1);"></i>{{
                                            ticket.forwarded_to_member[0].name|truncate(15, True, '...') }}</span>
                                    </div>
                                    {% endif %}
                                    {% if not (ticket.assignment and ticket.assignment|length > 0 and
                                    ticket.assigned_member and ticket.assigned_member|length > 0) and not
                                    (ticket.is_forwarded and ticket.forwarded_to_member and
                                    ticket.forwarded_to_member|length > 0) %}
                                    <span style="color: rgba(255,255,255,0.2);">‚Äî</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="td-source">
                                <span class="method-badge
                                    {% if ticket.ticket_id and ticket.ticket_id[:1] == 'M' %}method-manual
                                    {% else %}method-email{% endif %}">
                                    {% if ticket.ticket_id and ticket.ticket_id[:1] == 'M' %}
                                    <i class="fas fa-user-edit"></i> Manual
                                    {% else %}
                                    <i class="fas fa-envelope"></i> Email
                                    {% endif %}
                                </span>
                            </td>
                            <td class="td-date">
                                <i class="fas fa-clock" style="opacity:0.5; margin-right:4px;"></i>{{ ticket.created_at
                                | format_datetime }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% if not tickets %}
                <div class="ticket-table-empty">
                    <i class="fas fa-inbox"></i>
                    <p>No tickets found.</p>
                </div>
                {% endif %}
            </div>

            <!-- Pagination -->
            {% if pagination %}
            <div class="pagination">
                {% if pagination.has_prev %}
                <a href="?page={{ pagination.prev_page }}&per_page={{ pagination.per_page }}&status={{ pagination.status_filter }}&priority={{ pagination.priority_filter }}&search={{ pagination.search_query }}"
                    class="page-btn">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
                {% endif %}

                {% for page_num in range(1, pagination.total_pages + 1) %}
                {% if page_num == pagination.current_page %}
                <span class="page-btn active">{{ page_num }}</span>
                {% elif page_num <= 3 or page_num> pagination.total_pages - 3 %}
                    <a href="?page={{ page_num }}&per_page={{ pagination.per_page }}&status={{ pagination.status_filter }}&priority={{ pagination.priority_filter }}&search={{ pagination.search_query }}"
                        class="page-btn">
                        {{ page_num }}
                    </a>
                    {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                    <a href="?page={{ pagination.next_page }}&per_page={{ pagination.per_page }}&status={{ pagination.status_filter }}&priority={{ pagination.priority_filter }}&search={{ pagination.search_query }}"
                        class="page-btn">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) mobileMenu.classList.toggle('open');
        }

        function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        // Fullscreen toggle for forwarded tickets section
        function toggleFullscreen(elementId) {
            const element = document.getElementById(elementId);
            const container = element?.closest('.forwarded-section-container');
            if (!container) return;

            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                    // Fallback: expand to full viewport
                    container.style.position = 'fixed';
                    container.style.top = '0';
                    container.style.left = '0';
                    container.style.width = '100vw';
                    container.style.height = '100vh';
                    container.style.zIndex = '9999';
                    container.style.borderRadius = '0';
                    container.classList.add('fullscreen-mode');
                });
            } else {
                document.exitFullscreen();
                container.classList.remove('fullscreen-mode');
            }
        }

        // Mark forwarded ticket as viewed
        function markAsViewed(ticketId, cardElement) {
            // Optimistic UI update
            const viewStatus = cardElement.querySelector('.view-status');
            if (viewStatus) {
                viewStatus.textContent = 'viewed';
                viewStatus.style.background = '#d1fae5';
                viewStatus.style.color = '#059669';
            }

            // Remove unviewed styling - use white background for viewed
            cardElement.classList.remove('unviewed');
            cardElement.style.background = '#ffffff';

            // Call API
            fetch(`/api/tickets/${ticketId}/mark-forwarded-viewed`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Ticket marked as viewed');
                    }
                })
                .catch(error => console.error('Error marking as viewed:', error));

            // Allow default navigation to proceed
            return true;
        }

        // Filter functionality
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const typeFilter = document.getElementById('typeFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const statusFilter = document.getElementById('statusFilter');
            const clearFilters = document.getElementById('clearFilters');
            function filterTickets() {
                const searchTerm = searchInput.value.toLowerCase();
                const typeValue = typeFilter.value;
                const priorityValue = priorityFilter.value;
                const statusValue = statusFilter.value;

                const ticketRows = document.querySelectorAll('#ticketTableBody .ticket-card');
                ticketRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const priority = row.querySelector('.priority-badge')?.textContent.trim() || '';
                    const status = row.querySelector('.badge-status')?.textContent.trim() || '';

                    const matchesSearch = !searchTerm || text.includes(searchTerm);
                    const matchesPriority = priorityValue === 'All' || priority.includes(priorityValue);
                    const matchesStatus = statusValue === 'All' || status.includes(statusValue);
                    // Type filter: match against the subject/user text since classification is removed from table
                    const matchesType = typeValue === 'All' || text.includes(typeValue.toLowerCase());

                    if (matchesSearch && matchesPriority && matchesStatus && matchesType) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // Event listeners
            searchInput.addEventListener('input', filterTickets);
            typeFilter.addEventListener('change', filterTickets);
            priorityFilter.addEventListener('change', filterTickets);
            statusFilter.addEventListener('change', filterTickets);

            clearFilters.addEventListener('click', function () {
                searchInput.value = '';
                typeFilter.value = 'All';
                priorityFilter.value = 'All';
                statusFilter.value = 'All';
                filterTickets();
            });

            // Manual refresh button - use AJAX instead of full reload
            document.getElementById('manualRefreshBtn')?.addEventListener('click', function () {
                refreshIndexTickets();
            });

            // Background image rotation (every 60 minutes)
            const bgImages = [
                '/static/css/portal_bg.png',
                '/static/css/ticket_page2.png',
                '/static/css/ticket_page3.png'
            ];

            function setBackgroundImage() {
                const bgElement = document.querySelector('.bg-image');
                if (bgElement) {
                    bgElement.style.backgroundImage = `url('${bgImages[currentBgIndex]}')`;
                    currentBgIndex = (currentBgIndex + 1) % bgImages.length;
                }
            }

            let currentBgIndex = 0;

            // Set initial background (login_bg.png)
            const bgElement = document.querySelector('.bg-image');
            if (bgElement) {
                bgElement.style.backgroundImage = `url('${bgImages[0]}')`;
            }

            // Start rotation from index 1, every 60 minutes
            currentBgIndex = 1;
            setInterval(setBackgroundImage, 60 * 60 * 1000);
        });

        // ===== AJAX BACKGROUND REFRESH (Full DOM-diff, every 5s) =====
        let _refreshInProgress = false;

        async function fetchIndexTicketsForHome() {
            try {
                // Pass current filters so the API returns matching results
                const params = new URLSearchParams(window.location.search);
                const res = await fetch('/api/index/tickets?' + params.toString());
                if (!res.ok) return null;
                const data = await res.json();
                if (!data.success) return null;
                return data.tickets || [];
            } catch (e) {
                console.warn('[REFRESH] Failed to fetch tickets', e);
                return null;
            }
        }

        /**
         * Build a complete ticket-card HTML string from API data.
         * Mirrors the Jinja template so dynamically-added cards look identical.
         */
        function buildTicketCardHtml(t) {
            const priority = t.priority || 'Medium';
            const status = t.status || 'New';
            const subject = escapeHtml(t.subject || 'No Subject');
            const rawBody = (t.body || t.message || t.description || '').replace(/<[^>]*>/g, '').trim();
            const bodyPreview = rawBody ? `<div class="subj-body">${escapeHtml(rawBody.length > 120 ? rawBody.substring(0, 120) + '‚Ä¶' : rawBody)}</div>` : '';
            const name = escapeHtml(t.name || 'Anonymous');
            const email = escapeHtml(t.email || 'No Email');
            const ticketId = t.ticket_id || 'Unknown';
            const isManual = ticketId.startsWith('M');
            const methodClass = isManual ? 'method-manual' : 'method-email';
            const methodIcon = isManual ? 'fa-user-edit' : 'fa-envelope';
            const methodText = isManual ? 'Manual' : 'Email';

            const priorityClass = priority === 'Urgent' ? 'badge-urgent'
                : priority === 'Fast' ? 'badge-fast'
                    : priority === 'Medium' ? 'badge-medium' : 'badge-low';

            const statusClass = status === 'Open' ? 'status-open'
                : status === 'Waiting for Response' ? 'status-waiting'
                    : status === 'Closed' ? 'status-closed'
                        : status === 'Resolved' ? 'status-resolved' : 'status-new';

            const hasNew = !!(t.has_new_reply || t.has_unread_reply);
            const unreadDot = hasNew ? '<span class="unread-dot"></span>' : '';
            const starHtml = t.is_bookmarked ? '<i class="fas fa-star star-indicator"></i>' : '';

            // Technician
            let techHtml = '<span style="color: rgba(255,255,255,0.2);">‚Äî</span>';
            if (t.assigned_technician_name) {
                techHtml = `<i class="fas fa-wrench" style="font-size:10px;opacity:0.6;margin-right:5px;"></i>${escapeHtml(t.assigned_technician_name)}`;
            }

            // Takeover / Forwarded
            let assignHtml = '<span style="color: rgba(255,255,255,0.2);">‚Äî</span>';
            let parts = [];
            if (t.assigned_member_name) {
                parts.push(`<div><span class="assign-label">Takeover</span><span class="assign-name"><i class="fas fa-user-check" style="font-size:10px;opacity:0.6;margin-right:5px;"></i>${escapeHtml(t.assigned_member_name)}</span></div>`);
            }
            if (t.is_forwarded && t.forwarded_to_name) {
                parts.push(`<div><span class="assign-label">Forwarded</span><span class="assign-name"><i class="fas fa-share" style="font-size:10px;opacity:0.6;margin-right:5px;transform:scaleX(-1);"></i>${escapeHtml(t.forwarded_to_name)}</span></div>`);
            }
            if (parts.length > 0) assignHtml = `<div class="assign-forwarded">${parts.join('')}</div>`;

            // Format time
            let timeStr = 'N/A';
            if (t.created_at) {
                try {
                    const d = new Date(t.created_at);
                    timeStr = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) + ', ' +
                        d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                } catch (e) { timeStr = t.created_at; }
            }

            return `
                <td class="td-id">${unreadDot}#${ticketId}${starHtml}</td>
                <td class="td-priority"><span class="tbl-badge priority-badge ${priorityClass}">${priority}</span></td>
                <td class="td-status"><span class="tbl-badge status-badge badge-status ${statusClass}">${status}</span></td>
                <td class="td-subject">
                    <div class="subj-title">${subject}</div>
                    ${bodyPreview}
                </td>
                <td class="td-user"><span class="user-name">${name}</span><span class="user-email">${email}</span></td>
                <td class="td-tech">${techHtml}</td>
                <td class="td-assignment">${assignHtml}</td>
                <td class="td-source"><span class="method-badge ${methodClass}"><i class="fas ${methodIcon}"></i> ${methodText}</span></td>
                <td class="td-date"><i class="fas fa-clock" style="opacity:0.5;margin-right:4px;"></i>${timeStr}</td>
            `;
        }

        /**
         * Patch an existing card's badges/status in-place (no DOM rebuild).
         */
        function patchTicketCard(row, ticket) {
            // Priority
            const priorityBadge = row.querySelector('.priority-badge');
            if (priorityBadge && ticket.priority) {
                const p = ticket.priority;
                const cls = p === 'Urgent' ? 'badge-urgent' : p === 'Fast' ? 'badge-fast' : p === 'Medium' ? 'badge-medium' : 'badge-low';
                priorityBadge.className = `tbl-badge priority-badge ${cls}`;
                priorityBadge.textContent = p;
            }

            // Status
            const statusBadge = row.querySelector('.badge-status');
            if (statusBadge && ticket.status) {
                const s = ticket.status;
                const sc = s === 'Open' ? 'status-open' : s === 'Waiting for Response' ? 'status-waiting' : s === 'Closed' ? 'status-closed' : s === 'Resolved' ? 'status-resolved' : 'status-new';
                statusBadge.className = `tbl-badge status-badge badge-status ${sc}`;
                statusBadge.textContent = s;
            }

            // Unread dot
            const idCell = row.querySelector('.td-id');
            if (idCell) {
                const existingDot = idCell.querySelector('.unread-dot');
                const hasNew = !!(ticket.has_new_reply || ticket.has_unread_reply);
                if (hasNew && !existingDot) {
                    const dot = document.createElement('span');
                    dot.className = 'unread-dot';
                    idCell.prepend(dot);
                } else if (!hasNew && existingDot) {
                    existingDot.remove();
                }
            }

            // Star
            if (idCell) {
                const existingStar = idCell.querySelector('.star-indicator');
                if (ticket.is_bookmarked && !existingStar) {
                    const star = document.createElement('i');
                    star.className = 'fas fa-star star-indicator';
                    idCell.appendChild(star);
                } else if (!ticket.is_bookmarked && existingStar) {
                    existingStar.remove();
                }
            }

            // Technician
            const techCell = row.querySelector('.td-tech');
            if (techCell && ticket.assigned_technician_name) {
                techCell.innerHTML = `<i class="fas fa-wrench" style="font-size:10px;opacity:0.6;margin-right:5px;"></i>${escapeHtml(ticket.assigned_technician_name)}`;
            }
        }

        /**
         * Full DOM-diff refresh: add new, remove stale, reorder, patch badges.
         * No page reload, no flash, preserves scroll position.
         */
        async function refreshIndexTickets() {
            if (_refreshInProgress) return;
            _refreshInProgress = true;
            try {
                const tickets = await fetchIndexTicketsForHome();
                if (!tickets) return;

                const tbody = document.getElementById('ticketTableBody');
                if (!tbody) return;

                // Build map of existing DOM rows by ticket_id
                const existingCards = new Map();
                tbody.querySelectorAll('tr.ticket-card').forEach(row => {
                    const onclick = row.getAttribute('onclick') || '';
                    const match = onclick.match(/\/ticket\/([^'"]+)/);
                    if (match) {
                        existingCards.set(match[1], row);
                    }
                });

                const apiTicketIds = new Set(tickets.map(t => t.ticket_id));

                // 1. Remove rows that are no longer in the API response
                existingCards.forEach((row, id) => {
                    if (!apiTicketIds.has(id)) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 300);
                    }
                });

                // 2. Insert new rows and reorder existing ones
                let prevSibling = null;
                for (let i = 0; i < tickets.length; i++) {
                    const ticket = tickets[i];
                    const id = ticket.ticket_id;
                    let row = existingCards.get(id);

                    if (row) {
                        patchTicketCard(row, ticket);
                    } else {
                        row = document.createElement('tr');
                        row.className = 'ticket-card';
                        row.setAttribute('onclick', `window.location='/ticket/${id}'`);
                        row.innerHTML = buildTicketCardHtml(ticket);
                        row.style.animation = 'fadeSlideIn 0.4s ease-out';
                    }

                    const expectedNext = prevSibling ? prevSibling.nextElementSibling : tbody.firstElementChild;
                    if (row !== expectedNext) {
                        if (prevSibling) {
                            prevSibling.after(row);
                        } else {
                            tbody.prepend(row);
                        }
                    }
                    prevSibling = row;
                }

                // 3. Update total count
                const totalBadge = document.querySelector('.total-badge');
                if (totalBadge) {
                    totalBadge.textContent = `Total: ${tickets.length}`;
                }

                // Remove empty state if tickets exist
                if (tickets.length > 0) {
                    const emptyState = tbody.querySelector('.empty-state');
                    if (emptyState) emptyState.remove();
                }

            } catch (e) {
                console.warn('[REFRESH] Error during DOM diff:', e);
            } finally {
                _refreshInProgress = false;
            }
        }

        // Periodic background refresh every 5 seconds
        setInterval(refreshIndexTickets, 5000);

        // ===== SOCKET.IO REAL-TIME UPDATES =====
        (function () {
            // Connect to Socket.IO server
            const socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 1000
            });

            // Current user info from session (populated by Jinja)
            const currentUserId = '{{ session.get("member_id", "") }}';
            const currentUserRole = '{{ session.get("member_role", "") }}';

            // Notification Sound
            const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

            socket.on('connect', function () {
                console.log('[SOCKET] Connected to real-time server');

                // Join dashboard room for ticket notifications
                socket.emit('join_dashboard');

                // Join user-specific room for targeted notifications
                socket.emit('join_user_room');

                // Join role-based room
                socket.emit('join_role_room');
            });

            socket.on('disconnect', function () {
                console.log('[SOCKET] Disconnected from server');
            });

            // Listen for new tickets
            socket.on('new_ticket', function (data) {
                console.log('[SOCKET] New ticket received:', data);

                // Play sound
                notificationSound.play().catch(e => console.log('Audio autoplay blocked:', e));

                showToast('New Ticket', `#${data.ticket_id}: ${data.subject}`, 'info');

                // Optionally refresh the page or prepend ticket to list
                addNewTicketToList(data);
            });

            // Listen for ticket updates (status/priority)
            socket.on('ticket_updated', function (data) {
                console.log('[SOCKET] Ticket updated:', data);
                updateTicketCard(data);
            });

            // ===== NEW: Ticket Status Changed =====
            socket.on('ticket_status_changed', function (data) {
                console.log('[SOCKET] Ticket status changed:', data);

                const ticketCard = document.querySelector(`a[href="/ticket/${data.ticket_id}"]`);
                if (ticketCard) {
                    const statusBadge = ticketCard.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = data.new_status;
                        const statusClass = 'status-' + data.new_status.toLowerCase().replace(/ /g, '-').replace('‚Äì', '');
                        statusBadge.className = `status-badge ${statusClass}`;
                    }
                    showToast('Status Changed', `#${data.ticket_id}: ${data.new_status}`, 'info');
                }
            });

            // ===== NEW: Ticket Priority Changed =====
            socket.on('ticket_priority_changed', function (data) {
                console.log('[SOCKET] Ticket priority changed:', data);

                const ticketCard = document.querySelector(`a[href="/ticket/${data.ticket_id}"]`);
                if (ticketCard) {
                    const priorityBadge = ticketCard.querySelector('.priority-badge');
                    if (priorityBadge) {
                        const newPriorityClass = data.new_priority === 'Urgent' ? 'badge-urgent' :
                            data.new_priority === 'High' ? 'badge-fast' :
                                data.new_priority === 'Medium' ? 'badge-medium' : 'badge-low';
                        priorityBadge.className = `priority-badge ${newPriorityClass}`;
                        priorityBadge.textContent = data.new_priority;
                    }
                    showToast('Priority Changed', `#${data.ticket_id}: ${data.new_priority}`, 'info');
                }
            });

            // ===== NEW: Ticket Forwarded =====
            socket.on('ticket_forwarded', function (data) {
                console.log('[SOCKET] Ticket forwarded:', data);

                const ticketCard = document.querySelector(`a[href="/ticket/${data.ticket_id}"]`);
                if (ticketCard) {
                    // Add forwarded badge
                    const badgesContainer = ticketCard.querySelector('.ticket-badges');
                    if (badgesContainer) {
                        // Remove any existing forwarded badge
                        const existingBadge = badgesContainer.querySelector('.badge-forwarded');
                        if (existingBadge) existingBadge.remove();

                        // Add new forwarded badge
                        const forwardedBadge = document.createElement('span');
                        forwardedBadge.className = 'status-badge badge-forwarded';
                        forwardedBadge.style.cssText = 'background: rgba(59, 130, 246, 0.12); border: 1px solid rgba(59, 130, 246, 0.25); color: #3b82f6;';
                        forwardedBadge.innerHTML = `<i class="fas fa-share" style="font-size: 9px; margin-right: 4px;"></i>Forwarded to ${data.forwarded_to_name}`;

                        // Insert after priority badge
                        const priorityBadge = badgesContainer.querySelector('.priority-badge');
                        if (priorityBadge && priorityBadge.nextSibling) {
                            badgesContainer.insertBefore(forwardedBadge, priorityBadge.nextSibling);
                        } else {
                            badgesContainer.appendChild(forwardedBadge);
                        }
                    }
                }

                showToast('Ticket Forwarded', `#${data.ticket_id} forwarded to ${data.forwarded_to_name}`, 'info');
            });

            // ===== NEW: Ticket Forwarded TO YOU (targeted notification) =====
            socket.on('ticket_forwarded_to_you', function (data) {
                console.log('[SOCKET] Ticket forwarded to you:', data);

                // Play notification sound
                notificationSound.play().catch(e => console.log('Audio autoplay blocked:', e));

                // Show prominent notification
                showToast('Ticket Assigned to You', `#${data.ticket_id}: ${data.subject} - from ${data.forwarded_from_name}`, 'success');

                // Add ticket to list
                addNewTicketToList({
                    ...data,
                    is_forwarded: true,
                    forwarded_to_member_name: 'You',
                    status: 'Assigned'
                });
            });

            // ===== NEW: Ticket Taken Over =====
            socket.on('ticket_taken_over', function (data) {
                console.log('[SOCKET] Ticket taken over:', data);

                const ticketCard = document.querySelector(`a[href="/ticket/${data.ticket_id}"]`);
                if (ticketCard) {
                    // Update or add technician badge
                    const badgesContainer = ticketCard.querySelector('.ticket-badges');
                    if (badgesContainer) {
                        let existingTechBadge = badgesContainer.querySelector('.technician-badge');
                        if (!existingTechBadge) {
                            existingTechBadge = document.createElement('span');
                            existingTechBadge.className = 'status-badge technician-badge';
                            existingTechBadge.style.cssText = 'background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border: none; color: white; font-weight: 500; font-size: 10px;';
                            badgesContainer.appendChild(existingTechBadge);
                        }
                        existingTechBadge.innerHTML = `<i class="fas fa-user" style="font-size: 9px; margin-right: 4px;"></i>${data.taken_by_name}`;
                    }
                }

                showToast('Ticket Taken Over', `#${data.ticket_id} taken by ${data.taken_by_name}`, 'info');
            });

            // ===== NEW: Technician Assigned =====
            socket.on('technician_assigned', function (data) {
                console.log('[SOCKET] Technician assigned:', data);

                const ticketCard = document.querySelector(`a[href="/ticket/${data.ticket_id}"]`);
                if (ticketCard) {
                    const badgesContainer = ticketCard.querySelector('.ticket-badges');
                    if (badgesContainer) {
                        // Remove existing technician badge if any
                        const existingTechBadge = badgesContainer.querySelector('.technician-badge');
                        if (existingTechBadge) existingTechBadge.remove();

                        // Add new technician badge
                        if (data.technician_name) {
                            const techBadge = document.createElement('span');
                            techBadge.className = 'status-badge technician-badge';
                            techBadge.style.cssText = 'background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border: none; color: white; font-weight: 500; font-size: 10px;';
                            techBadge.innerHTML = `<i class="fas fa-wrench" style="font-size: 9px; margin-right: 4px;"></i>${data.technician_name}`;
                            badgesContainer.appendChild(techBadge);
                        }
                    }
                }

                showToast('Technician Assigned', `#${data.ticket_id}: ${data.technician_name}`, 'info');
            });

            // ===== NEW: Ticket Bookmarked =====
            socket.on('ticket_bookmarked', function (data) {
                console.log('[SOCKET] Ticket bookmark changed:', data);

                const ticketCard = document.querySelector(`a[href="/ticket/${data.ticket_id}"]`);
                if (ticketCard) {
                    const bookmarkIcon = ticketCard.querySelector('.bookmark-icon, [data-bookmark]');
                    if (bookmarkIcon) {
                        if (data.is_important) {
                            bookmarkIcon.classList.add('text-yellow-500', 'fas');
                            bookmarkIcon.classList.remove('text-gray-400', 'far');
                        } else {
                            bookmarkIcon.classList.remove('text-yellow-500', 'fas');
                            bookmarkIcon.classList.add('text-gray-400', 'far');
                        }
                    }

                    // Optionally move bookmarked tickets to top
                    if (data.is_important) {
                        const ticketParent = ticketCard.closest('.ticket-card');
                        if (ticketParent) {
                            const container = ticketParent.parentElement;
                            if (container) {
                                container.prepend(ticketParent);
                            }
                        }
                    }
                }
            });

            // ===== NEW: Tech Director Referral =====
            socket.on('ticket_referred_to_you', function (data) {
                console.log('[SOCKET] Ticket referred to you (Tech Director):', data);

                // Play notification sound
                notificationSound.play().catch(e => console.log('Audio autoplay blocked:', e));

                // Show prominent notification
                showToast('Ticket Referred to You', `#${data.ticket_id}: ${data.subject} - from ${data.referred_by_name}`, 'success');
            });

            // Helper to update ticket card with any data
            function updateTicketCard(data) {
                const ticketCard = document.querySelector(`a[href="/ticket/${data.ticket_id}"]`);
                if (!ticketCard) return;

                // Update Status Badge
                if (data.status) {
                    const statusBadge = ticketCard.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = data.status;
                        const statusClass = 'status-' + data.status.toLowerCase().replace(/ /g, '-').replace('‚Äì', '');
                        statusBadge.className = `status-badge ${statusClass}`;
                    }
                }

                // Update Priority Badge
                if (data.priority) {
                    const priorityBadge = ticketCard.querySelector('.priority-badge');
                    if (priorityBadge) {
                        const newPriorityClass = data.priority === 'Urgent' ? 'badge-urgent' :
                            data.priority === 'Fast' ? 'badge-fast' :
                                data.priority === 'Medium' ? 'badge-medium' : 'badge-low';
                        priorityBadge.className = `priority-badge ${newPriorityClass}`;
                        priorityBadge.textContent = data.priority;
                    }
                }

                // Update Subject
                if (data.subject) {
                    const subjectEl = ticketCard.querySelector('.ticket-subject');
                    if (subjectEl) subjectEl.textContent = data.subject;
                }
            }

            // Toast notification function
            function showToast(title, message, type = 'info') {
                // Create toast container if not exists
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;';
                    document.body.appendChild(container);
                }

                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.style.cssText = `
                    background: linear-gradient(135deg, rgba(30, 30, 40, 0.95), rgba(40, 40, 55, 0.95));
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(147, 51, 234, 0.4);
                    border-radius: 12px;
                    padding: 16px 20px;
                    min-width: 300px;
                    max-width: 400px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
                    animation: slideIn 0.3s ease-out;
                    cursor: pointer;
                `;

                const icon = type === 'info' ? 'fa-ticket-alt' : type === 'success' ? 'fa-check-circle' : 'fa-bell';
                const iconColor = type === 'info' ? '#a855f7' : type === 'success' ? '#22c55e' : '#fbbf24';

                toast.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <i class="fas ${icon}" style="color: ${iconColor}; font-size: 20px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">${title}</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 13px;">${message}</div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; padding: 0;"><i class="fas fa-times"></i></button>
                    </div>
                `;

                container.appendChild(toast);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            // Add new ticket to list dynamically
            function addNewTicketToList(ticketData) {
                try {
                    const ticketGrid = document.getElementById('mainTicketsGrid') || document.querySelector('.tickets-grid');
                    if (!ticketGrid) {
                        console.error('[SOCKET] Ticket grid not found!');
                        return;
                    }

                    // Check if ticket already exists
                    if (document.querySelector(`a[href="/ticket/${ticketData.ticket_id}"]`)) {
                        console.log('[SOCKET] Ticket already in list:', ticketData.ticket_id);
                        return; // Already in list
                    }

                    console.log('[SOCKET] Rendering new ticket:', ticketData);

                    // Safe Defaults
                    const priority = ticketData.priority || 'Medium';
                    const status = ticketData.status || 'New';
                    const subject = ticketData.subject || 'No Subject';
                    const name = ticketData.name || 'Anonymous';
                    const email = ticketData.email || 'No Email';
                    const ticketId = ticketData.ticket_id || 'Unknown';
                    const isManual = ticketId.startsWith('M');
                    const methodClass = isManual ? 'method-manual' : 'method-email';
                    const methodIcon = isManual ? 'fa-user-edit' : 'fa-envelope';
                    const methodText = isManual ? 'Manual' : 'Email';

                    // Classes
                    const priorityClass = priority === 'Urgent' ? 'badge-urgent' :
                        priority === 'Fast' ? 'badge-fast' :
                            priority === 'Medium' ? 'badge-medium' : 'badge-low';

                    const statusClass = status === 'Open' ? 'status-open' :
                        status === 'Waiting for Response' ? 'status-waiting' :
                            status === 'Resolved' ? 'status-resolved' : 'status-new';

                    const ticketCard = document.createElement('div');
                    ticketCard.className = 'ticket-card';
                    ticketCard.style.animation = 'slideIn 0.5s ease-out';

                    // Unread indicator for new tickets
                    const unreadHtml = '<div class="unread-indicator"></div>';

                    // Check if ticket is forwarded
                    const isForwarded = ticketData.is_forwarded || false;
                    const forwardedToName = ticketData.forwarded_to_member && ticketData.forwarded_to_member.length > 0
                        ? ticketData.forwarded_to_member[0].name
                        : (ticketData.forwarded_to_member_name || null);
                    const forwardedBadge = (isForwarded && forwardedToName)
                        ? `<span class="status-badge badge-forwarded" style="background: rgba(59, 130, 246, 0.12); border: 1px solid rgba(59, 130, 246, 0.25); color: #3b82f6;">
                            <i class="fas fa-share" style="font-size: 9px; margin-right: 4px;"></i>Forwarded to ${forwardedToName}
                           </span>`
                        : '';

                    ticketCard.innerHTML = `
                        <a href="/ticket/${ticketId}">
                            ${unreadHtml}
                            <div class="ticket-content">
                                <div class="ticket-badges">
                                    <span class="ticket-id">#${ticketId}</span>
                                    <span class="priority-badge ${priorityClass}">${priority}</span>
                                    <!-- Classification omitted for simplicity in dynamic render -->
                                    ${forwardedBadge}
                                    <span class="status-badge ${statusClass}">${status}</span>
                                </div>
                                <h3 class="ticket-subject">${subject}</h3>
                                <p class="ticket-body">${ticketData.body || 'No Body'}</p>
                                <div class="ticket-meta">
                                    <span><i class="fas fa-user"></i>${name}</span>
                                    <span><i class="fas fa-envelope"></i>${email}</span>
                                    <span><i class="fas fa-clock"></i>Just now</span>
                                </div>
                            </div>
                            <div class="ticket-sidebar">
                                <span class="method-badge ${methodClass}">
                                    <i class="fas ${methodIcon}"></i> ${methodText}
                                </span>
                            </div>
                        </a>
                    `;

                    // Prepend to list (newest first)
                    ticketGrid.prepend(ticketCard);

                    // Update total count
                    const totalBadge = document.querySelector('.total-badge');
                    if (totalBadge) {
                        const currentText = totalBadge.textContent;
                        const match = currentText.match(/(\d+)/);
                        if (match) {
                            const currentTotal = parseInt(match[0]);
                            totalBadge.textContent = `Total: ${currentTotal + 1}`;
                        } else {
                            totalBadge.textContent = 'Total: Updated';
                        }
                    }
                } catch (e) {
                    console.error('[SOCKET] Error rendering ticket:', e);
                }
            }

            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // Listen for technician updates from ticket detail page
            window.addEventListener('storage', function (e) {
                if (e.key === 'technicianUpdate') {
                    try {
                        const updateData = JSON.parse(e.newValue);
                        if (!updateData || !updateData.ticketId) return;

                        console.log('[HOME] Received technician update:', updateData);

                        // Find the ticket card
                        const ticketLink = document.querySelector(`a[href="/ticket/${updateData.ticketId}"]`);
                        if (!ticketLink) {
                            console.log('[HOME] Ticket card not found:', updateData.ticketId);
                            return;
                        }

                        const badgesContainer = ticketLink.querySelector('.ticket-badges');
                        if (!badgesContainer) return;

                        // Remove existing technician badge if any
                        const existingTechBadge = badgesContainer.querySelector('.technician-badge');
                        if (existingTechBadge) {
                            existingTechBadge.remove();
                        }

                        // Add new technician badge if technician is assigned
                        if (updateData.technicianName) {
                            const techBadge = document.createElement('span');
                            techBadge.className = 'status-badge technician-badge';
                            techBadge.style.cssText = 'background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border: none; color: white; font-weight: 500; font-size: 10px;';
                            techBadge.innerHTML = `<i class="fas fa-wrench" style="font-size: 9px; margin-right: 4px;"></i>${updateData.technicianName}`;

                            // Insert before the status badge
                            const statusBadge = badgesContainer.querySelector('.badge-status');
                            if (statusBadge) {
                                badgesContainer.insertBefore(techBadge, statusBadge);
                            } else {
                                badgesContainer.appendChild(techBadge);
                            }

                            console.log('[HOME] Added technician badge:', updateData.technicianName);
                        } else {
                            console.log('[HOME] Removed technician badge');
                        }

                    } catch (err) {
                        console.error('[HOME] Error processing technician update:', err);
                    }
                }
            });
        })();
    </script>
</body>

</html>