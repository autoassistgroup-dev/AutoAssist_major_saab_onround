<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="AutoAssistGroup Support Ticket #{{ ticket.ticket_id }} - {{ (ticket.subject or 'No Subject')[:100] }}">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#4f46e5">
    <title>Ticket #{{ ticket.ticket_id }} - AutoAssistGroup Portal</title>

    <!-- Preconnect to external domains for performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Optimized external stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" media="all">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="all">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"
        media="all">
    <link href="/static/css/animations.css" rel="stylesheet">
    <!-- Socket.IO for real-time updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ===== PROFESSIONAL DARK THEME ===== */
        :root {
            /* Dark Color Palette */
            --primary: #ec4899;
            --secondary: #f472b6;
            --primary-dark: #db2777;
            --primary-light: rgba(236, 72, 153, 0.15);
            --urgent: #ef4444;
            --fast: #f59e0b;
            --low: #6366f1;
            --waiting: #f59e0b;
            --medium: #ec4899;

            /* Dark Theme Colors */
            --bg-dark: #0a0a0f;
            --bg-card: #14141e;
            --bg-card-hover: #1e1e2d;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: rgba(0, 0, 0, 0.4);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.4);
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.2);

            /* Transitions */
            --transition-fast: 0.1s ease;
            --transition-smooth: 0.2s ease;
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: auto !important;
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(20, 20, 30, 0.6);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 120, 0.6);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(130, 130, 150, 0.8);
        }

        ::-webkit-scrollbar-corner {
            background: rgba(20, 20, 30, 0.6);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(100, 100, 120, 0.6) rgba(20, 20, 30, 0.6);
        }


        /* ===== GLOBAL STYLES ===== */
        body {
            font-family: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            background: var(--bg-dark) !important;
            color: var(--text-primary) !important;
            line-height: 1.4;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            font-size: 14px !important;
        }


        /* ===== NAVBAR ===== */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            background: #1c1c26;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 8px 24px;
        }

        @media (min-width: 768px) {
            .navbar {
                padding: 8px 48px;
            }
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .nav-link-active {
            background: rgba(255, 117, 143, 0.15);
            border-color: rgba(255, 117, 143, 0.3);
            color: #ff758f;
        }

        .nav-link i {
            margin-right: 6px;
            font-size: 11px;
            opacity: 0.8;
        }

        /* ===== USER AVATAR ===== */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 117, 143, 0.15);
            border: 1px solid rgba(255, 117, 143, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: #ff758f;
        }

        /* ===== MOBILE MENU ===== */
        .mobile-menu {
            display: none;
            padding: 16px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            margin-top: 16px;
        }

        .mobile-menu.open {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-btn {
            display: none;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        @media (max-width: 768px) {
            .menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .nav-links.desktop {
                display: none;
            }
        }

        /* Fix Main Content for Fixed Navbar */
        .container.main-content {
            padding-top: 80px !important;
        }

        /* ===== COMPACT STYLING FIXES ===== */

        /* Make all buttons compact */
        button,
        .btn,
        [class*="btn-"],
        a.px-4,
        a.px-3,
        a.px-2 {
            padding: 6px 12px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
        }

        /* Fix action buttons to be compact */
        .close-ticket-btn,
        .take-over-btn,
        [class*="Close"],
        [class*="Take Over"] {
            padding: 6px 12px !important;
            font-size: 12px !important;
        }

        /* Remove green color - use purple instead */
        .bg-green-100,
        .bg-green-500,
        .bg-green-600 {
            background: rgba(99, 102, 241, 0.15) !important;
        }

        .text-green-800,
        .text-green-600,
        .text-green-500 {
            color: #818cf8 !important;
        }

        /* Fix white containers to dark */
        .bg-white,
        [class*="bg-white"] {
            background: var(--bg-card) !important;
            border: 1px solid var(--glass-border) !important;
        }

        /* Fix all card/container backgrounds */
        .rounded-xl,
        .rounded-lg,
        .rounded-md,
        .shadow-lg,
        .shadow-md {
            background: var(--bg-card) !important;
            border: 1px solid var(--glass-border) !important;
        }

        /* Fix text colors for dark theme */
        .text-gray-800,
        .text-gray-900 {
            color: var(--text-primary) !important;
        }

        .text-gray-600,
        .text-gray-700 {
            color: var(--text-secondary) !important;
        }

        .text-gray-400,
        .text-gray-500 {
            color: var(--text-muted) !important;
        }

        /* Logout button uses same nav-link styling as other pages */

        /* Compact badge styling */
        .px-3.py-1,
        [class*="badge"],
        .rounded-full {
            padding: 3px 8px !important;
            font-size: 11px !important;
        }

        /* Hide the pink floating toggle button */
        #sidebarToggleMobile,
        .sidebar-toggle {
            display: none !important;
        }

        /* Compact ticket header */
        .ticket-header,
        [class*="ticket-header"] {
            padding: 16px !important;
        }

        /* Compact card padding */
        .p-5,
        .p-6,
        .p-8 {
            padding: 16px !important;
        }

        /* Fix Low badge to use purple not green */
        .bg-green-100.text-green-800,
        [class*="bg-green"][class*="text-green"] {
            background: rgba(99, 102, 241, 0.15) !important;
            color: #a5b4fc !important;
        }

        /* Smaller font sizes overall */
        h1 {
            font-size: 1.25rem !important;
        }

        h2 {
            font-size: 1.1rem !important;
        }

        h3 {
            font-size: 1rem !important;
        }

        h4,
        h5,
        h6 {
            font-size: 0.9rem !important;
        }

        p,
        span,
        div,
        label {
            font-size: 13px;
        }

        /* Legacy styles removed for consistency */

        /* Fix reply box */
        .reply-form,
        [class*="reply-form"],
        textarea,
        input[type="text"],
        input[type="email"],
        .form-control {
            background: rgba(20, 20, 30, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-primary) !important;
        }

        textarea::placeholder,
        input::placeholder {
            color: var(--text-muted) !important;
        }

        /* Fix all remaining white/gray backgrounds */
        [class*="bg-gray-"],
        [class*="bg-slate-"],
        .bg-gray-50,
        .bg-gray-100,
        .bg-gray-200 {
            background: #191923 !important;
        }

        /* Fix glowing borders */
        .ring-pink-500,
        [class*="ring-"] {
            box-shadow: none !important;
        }

        /* Fix any remaining border colors */
        [class*="border-gray"],
        [class*="border-slate"] {
            border-color: rgba(255, 255, 255, 0.08) !important;
        }

        /* ===== BACKGROUND ===== */
        .bg-gradient-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(180deg, #0a0a0f 0%, #141420 100%);
        }

        .background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
            background-image: url('/static/css/portal_bg.png');
            background-size: cover;
            background-position: center;
            opacity: 0.15;
        }

        /* Hide gradient orbs - using background image instead */
        .gradient-orb {
            display: none;
        }

        /* ===== GLASS COMPONENTS - DARK THEME ===== */
        .glass-panel,
        .stats-card,
        .ticket-card,
        .main-container-glass,
        .enhanced-search-container,
        .bg-white,
        .card,
        .dashboard-card,
        .sidebar-section,
        .detail-card {
            background: rgba(255, 255, 255, 0.04) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
            transition: all 0.2s ease;
            color: var(--text-primary) !important;
        }

        .glass-panel:hover,
        .stats-card:hover,
        .ticket-card:hover,
        .detail-card:hover {
            background: rgba(255, 255, 255, 0.06) !important;
            border-color: rgba(255, 255, 255, 0.12) !important;
        }

        .right-sidebar {
            background: rgba(10, 10, 15, 0.98) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-left: 1px solid rgba(255, 255, 255, 0.06) !important;
        }

        /* Right sidebar sections - enforce dark theme */
        .right-sidebar .sidebar-section {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.06) !important;
        }

        .right-sidebar .note-card {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        /* ===== COMPACT PROFESSIONAL STYLING ===== */

        /* 1. COMPACT TICKET HEADER - Smaller, professional green container */
        .ticket-header,
        [class*="ticket-header"],
        .p-5.ticket-header {
            padding: 12px 16px !important;
            margin-bottom: 12px !important;
        }

        .ticket-header h1,
        .ticket-header-main h1 {
            font-size: 1rem !important;
            font-weight: 600 !important;
            margin-bottom: 6px !important;
            line-height: 1.3 !important;
        }

        /* 2. INLINE BADGES - Small, proper line with dropdown arrows */
        .ticket-header .flex.flex-wrap,
        .ticket-header-main .flex.flex-wrap {
            gap: 6px !important;
            align-items: center !important;
            flex-wrap: wrap !important;
        }

        /* Small inline badges */
        .ticket-header .px-3.py-1,
        .ticket-header .px-2.py-1,
        .ticket-header [class*="badge"],
        .ticket-header .rounded-full,
        .ticket-header .rounded-lg,
        .ticket-header select,
        .ticket-header button {
            padding: 4px 10px !important;
            font-size: 11px !important;
            height: auto !important;
            min-height: 24px !important;
            line-height: 1.3 !important;
            border-radius: 4px !important;
        }

        /* Fix dropdown select styling */
        .ticket-header select,
        select.status-select,
        select[class*="status"],
        select[class*="priority"],
        select[class*="technician"] {
            appearance: none !important;
            -webkit-appearance: none !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a0aec0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            padding-right: 24px !important;
            min-width: 80px !important;
            cursor: pointer !important;
            background-color: rgba(30, 30, 45, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: var(--text-primary) !important;
        }

        /* Matthew (Technician) dropdown - compact */
        .ticket-header .flex.items-center.gap-1,
        .ticket-header-main .flex.items-center.gap-1 {
            gap: 4px !important;
        }

        /* 3. FORMAL CLOSE/STAR BUTTONS */
        .ticket-header button[class*="star"],
        .ticket-header button[class*="close"],
        .ticket-header .close-btn,
        .ticket-header .star-btn,
        .ticket-header button svg,
        button[title*="Close"],
        button[title*="Star"],
        button[aria-label*="Close"],
        button[aria-label*="Star"] {
            width: 28px !important;
            height: 28px !important;
            padding: 4px !important;
            border-radius: 6px !important;
            background: rgba(40, 40, 55, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
        }

        .ticket-header button:hover,
        button[title*="Close"]:hover,
        button[title*="Star"]:hover {
            background: rgba(60, 60, 80, 0.95) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* 4. COMPACT DETAIL CARDS - Customer info, Created, Last Updated, Outcome */
        .detail-card {
            padding: 10px 12px !important;
            margin-bottom: 8px !important;
            border-radius: 6px !important;
        }

        .detail-card h3,
        .detail-card h4,
        .detail-card .font-semibold {
            font-size: 11px !important;
            font-weight: 500 !important;
            color: var(--text-muted) !important;
            margin-bottom: 2px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .detail-card p,
        .detail-card span,
        .detail-card .text-gray-800,
        .detail-card .text-gray-900 {
            font-size: 12px !important;
            color: var(--text-primary) !important;
            font-weight: 400 !important;
        }

        /* Grid for Customer/Created/Last Updated - compact */
        .grid.grid-cols-1.md\:grid-cols-3,
        .grid.grid-cols-3 {
            gap: 8px !important;
        }

        /* Dark theme overrides for icon containers in detail cards */
        .detail-card .bg-blue-100 {
            background: rgba(59, 130, 246, 0.15) !important;
        }

        .detail-card .text-blue-600 {
            color: #3b82f6 !important;
        }

        .detail-card .bg-purple-100 {
            background: rgba(168, 85, 247, 0.15) !important;
        }

        .detail-card .text-purple-600 {
            color: #a855f7 !important;
        }

        .detail-card .bg-green-100 {
            background: rgba(34, 197, 94, 0.15) !important;
        }

        .detail-card .text-green-600 {
            color: #22c55e !important;
        }

        .detail-card .bg-orange-100,
        .detail-card .bg-amber-100 {
            background: rgba(249, 115, 22, 0.15) !important;
        }

        .detail-card .text-orange-600,
        .detail-card .text-amber-600 {
            color: #f97316 !important;
        }

        /* Fix edit/action buttons for dark theme */
        .text-indigo-600 {
            color: rgba(255, 255, 255, 0.5) !important;
        }

        .text-indigo-600:hover,
        .hover\:text-indigo-800:hover {
            color: #fff !important;
        }

        .hover\:bg-indigo-50:hover {
            background: rgba(255, 255, 255, 0.08) !important;
        }

        /* Fix all light bg- utility classes for dark theme */
        .bg-blue-100,
        .bg-green-100,
        .bg-purple-100,
        .bg-orange-100,
        .bg-amber-100,
        .bg-red-100,
        .bg-indigo-100,
        .bg-yellow-100,
        .bg-pink-100 {
            background: rgba(255, 255, 255, 0.06) !important;
        }

        /* Legacy styles removed for consistency */

        /* 6. OUTCOME ASSESSMENT - Compact */
        .outcome-section,
        [class*="outcome"] {
            padding: 12px 16px !important;
        }

        .outcome-section h2,
        .outcome-section h3 {
            font-size: 13px !important;
            font-weight: 600 !important;
            margin-bottom: 10px !important;
        }

        /* Edit Outcome button - formal */
        .outcome-section a,
        .outcome-section button,
        a[href*="outcome"],
        button[class*="outcome"] {
            font-size: 11px !important;
            padding: 4px 10px !important;
        }

        /* Outcome section icons - slightly larger */
        .outcome-section i.fas,
        .outcome-section i.far {
            font-size: 16px !important;
        }

        .outcome-section .detail-card .p-2.rounded-full {
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 7. ACTION BUTTONS ROW - Compact */
        .ticket-header-actions,
        .ticket-header .flex.gap-2,
        .ticket-header .flex.gap-3 {
            gap: 6px !important;
        }

        .ticket-header-actions button,
        .ticket-header-actions a {
            padding: 5px 10px !important;
            font-size: 11px !important;
            border-radius: 4px !important;
            height: auto !important;
        }

        /* ===== ADDITIONAL FIXES ===== */



        /* 2. STAR BUTTON - Gold/Yellow color */
        .star-btn,
        button[class*="star"],
        button[title*="Star"],
        button[aria-label*="star"],
        .ticket-header button:first-of-type,
        .ticket-header-main>.flex>button:first-child {
            color: #fbbf24 !important;
            background: rgba(251, 191, 36, 0.15) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
        }

        .star-btn svg,
        button[class*="star"] svg,
        button[title*="Star"] svg {
            fill: #fbbf24 !important;
            stroke: #fbbf24 !important;
            color: #fbbf24 !important;
        }

        .star-btn:hover,
        button[class*="star"]:hover {
            background: rgba(251, 191, 36, 0.25) !important;
            border-color: rgba(251, 191, 36, 0.5) !important;
        }

        /* 3. FIX DROPDOWN ARROW OVERLAP on badges */
        .ticket-header select,
        .ticket-header-main select,
        select[class*="status"],
        select[class*="priority"],
        select.rounded-lg,
        .ticket-header .flex select {
            padding-right: 28px !important;
            padding-left: 10px !important;
            min-width: 90px !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            overflow: hidden !important;
        }

        /* Badge with dropdown - ensure text doesn't overlap arrow */
        .ticket-header .px-3.py-1.rounded-lg,
        .ticket-header .bg-green-100,
        .ticket-header [class*="Low"],
        .ticket-header [class*="Open"],
        .ticket-header [class*="Closed"] {
            padding-right: 8px !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
        }

        /* SVG chevron icons inside badges */
        .ticket-header svg.w-4.h-4,
        .ticket-header svg[class*="chevron"],
        .ticket-header .flex svg {
            width: 10px !important;
            height: 10px !important;
            flex-shrink: 0 !important;
            margin-left: 4px !important;
        }

        /* 4. MESSAGE CARDS - Complete fix for layout */
        /* Legacy styles removed for consistency */

        /* Legacy styles removed for consistency */

        /* Conversation container */
        .conversation-container {
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
        }

        /* Support vs Customer message differentiation */
        /* Legacy colored borders and icons removed */


        /* Navbar styles defined at top of file - no duplicates needed */

        /* ===== GRADIENT TEXT & BUTTONS ===== */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-gradient {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 117, 143, 0.4);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 117, 143, 0.5);
        }

        /* ===== PRIORITY INDICATORS - NEUTRAL BACKGROUNDS ===== */
        /* Priority is indicated by left border color only, header uses neutral slate */
        .badge-urgent,
        .priority-urgent {
            background: rgba(30, 41, 59, 0.95) !important;
            /* slate-800 */
            border-left-color: #ef4444 !important;
            backdrop-filter: blur(10px);
        }

        .badge-fast,
        .priority-fast,
        .priority-high {
            background: rgba(30, 41, 59, 0.95) !important;
            /* slate-800 */
            border-left-color: #f97316 !important;
            backdrop-filter: blur(10px);
        }

        .badge-medium,
        .priority-medium {
            background: rgba(30, 41, 59, 0.95) !important;
            /* slate-800 */
            border-left-color: #eab308 !important;
            backdrop-filter: blur(10px);
        }

        .badge-low,
        .priority-low {
            background: rgba(30, 41, 59, 0.95) !important;
            /* slate-800 */
            border-left-color: #22c55e !important;
            backdrop-filter: blur(10px);
        }

        /* ===== PROFESSIONAL MESSAGE BOX STYLING ===== */
        .reply-card,
        .original-message-container,
        .message {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem !important;
            padding: 1rem !important;
            margin-bottom: 1rem !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .details-card:hover,
        .reply-card:hover,
        .message:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* Specific styling for internal text boxes - REMOVED INNER STYLING */
        /* Override any previous definitions for .reply-message-box */
        .reply-message-box,
        .original-message-content {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            font-size: 0.95rem !important;
            /* Slightly smaller for cleaner look */
            line-height: 1.5 !important;
            color: var(--text-primary);
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        /* Rounded corners and sizing for message bubbles */
        .message.customer-message {
            border-top-left-radius: 0.25rem !important;
            background: rgba(79, 70, 229, 0.1) !important;
            /* Indigo tint */
            border-color: rgba(79, 70, 229, 0.2) !important;
            margin-right: auto;
            max-width: 75% !important;
        }

        .message.support-message {
            border-top-right-radius: 0.25rem !important;
            background: rgba(255, 255, 255, 0.05) !important;
            /* Neutral dark tint */
            border-color: rgba(255, 255, 255, 0.1) !important;
            /* NO GREEN BORDER */
            margin-left: auto;
            max-width: 75% !important;
        }

        /* Standardized Expand Button for replies */
        .expand-btn {
            display: none;
            width: fit-content;
            margin: 0.5rem 0 0 auto !important;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 9999px !important;
            font-size: 0.75rem !important;
            font-weight: 600;
            color: var(--text-secondary) !important;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            text-align: center;
        }

        .expand-btn:hover {
            background: rgba(79, 70, 229, 0.2) !important;
            border-color: rgba(79, 70, 229, 0.3) !important;
            color: white !important;
        }

        .message-header {
            margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            /* Subtle separator */
            padding-bottom: 0.25rem;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* ===== EMAIL TEMPLATE MODAL - DARK THEME ===== */
        .email-template-modal-content {
            background: #1a1a2e !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-primary) !important;
        }

        .email-template-modal-content h3 {
            color: white !important;
            border-bottom-color: rgba(255, 255, 255, 0.1) !important;
        }

        .email-template-modal-content label {
            color: var(--text-secondary) !important;
        }

        .email-template-modal-content input,
        .email-template-modal-content select,
        .email-template-modal-content textarea {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: var(--text-primary) !important;
        }

        .email-template-modal-content input:focus,
        .email-template-modal-content select:focus,
        .email-template-modal-content textarea:focus {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
        }

        .email-template-modal-content .bg-gray-50,
        .email-template-modal-content .bg-blue-50 {
            background: rgba(255, 255, 255, 0.03) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .email-template-modal-content .text-blue-800 {
            color: #a5b4fc !important;
        }

        /* ===== REPLY FORM - DARK THEME ===== */
        #replyDropzone {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        #response {
            background: transparent !important;
            color: var(--text-primary) !important;
        }

        .reply-form .border-t {
            border-color: rgba(255, 255, 255, 0.08) !important;
        }

        /* Final Fix for Read More Buttons */
        .read-more-btn,
        .expand-btn {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin-top: 0.5rem !important;
            margin-left: auto !important;
            float: right !important;
            /* Secondary safeguard */
            padding: 0.25rem 0.75rem !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 999px !important;
            font-size: 0.75rem !important;
            color: var(--text-secondary) !important;
            border: 1px solid transparent !important;
            clear: both !important;
        }

        .read-more-btn:hover,
        .expand-btn:hover {
            background: rgba(99, 102, 241, 0.3) !important;
            border-color: rgba(99, 102, 241, 0.5) !important;
            color: #ffffff !important;
            transform: translateY(-1px) !important;
        }

        .read-more-btn i,
        .expand-btn i {
            margin-right: 6px !important;
            font-size: 0.7rem !important;
        }

        .original-message-content.truncated .read-more-btn,
        .reply-message-box.truncated .expand-btn {
            display: inline-flex !important;
        }

        /* Remove any float issues */
        .original-message-content::after,
        .reply-message-box::after {
            content: "";
            display: table;
            clear: both;
        }

        /* All sidebar states - always visible */
        .right-sidebar.sidebar-open,
        .right-sidebar.ultra-wide-open {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }

        /* ===== NORMAL UI STYLES - READABLE SIZES ===== */

        /* Critical CSS optimizations */
        * {
            box-sizing: border-box;
        }

        /* ===== ALWAYS VISIBLE STICKY SIDEBAR ===== */
        /* Sidebar is ALWAYS visible on desktop - like Google Gemini */
        .right-sidebar,
        body .right-sidebar,
        html body .right-sidebar,
        html body div#rightSidebar.right-sidebar {
            transform: translateX(0) !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: flex !important;
            position: fixed !important;
            right: 0 !important;
            top: 10vh !important;
            height: 90vh !important;
            width: 320px !important;
            z-index: 42 !important;
        }

        /* All sidebar states - always visible */
        body .right-sidebar.sidebar-open,
        body .right-sidebar.ultra-wide-open,
        html body .right-sidebar.sidebar-open,
        html body .right-sidebar.ultra-wide-open,
        html body div#rightSidebar.right-sidebar.sidebar-open,
        html body div#rightSidebar.right-sidebar.ultra-wide-open,
        .right-sidebar:not(.sidebar-open):not(.ultra-wide-open) {
            transform: translateX(0) !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: flex !important;
            position: fixed !important;
        }

        /* ALWAYS VISIBLE SIDEBAR - override any hiding */
        .right-sidebar {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }

        /* All sidebar states - always visible */
        .right-sidebar.sidebar-open,
        .right-sidebar.ultra-wide-open {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }

        /* ===== 2560PX OPTIMIZATION STYLES ===== */

        /* Container optimization for 2560px */
        .max-w-screen-ultra {
            max-width: 2400px;
        }

        /* Grid optimization for ultra-wide */
        .grid-cols-ultra {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        /* Enhanced ticket header layout for ultra-wide */
        .ticket-header-ultra {
            display: grid;
            grid-template-columns: minmax(400px, 1fr) auto;
            gap: 2rem;
            align-items: start;
        }

        .ticket-header-main {
            grid-column: 1;
        }

        .ticket-header-actions {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }

        /* Enhanced badge layout for ultra-wide */
        .badge-container-ultra {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        /* Enhanced action buttons layout for ultra-wide */
        .action-buttons-ultra {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }

        /* Enhanced layout for ultra-wide screens */
        @media (min-width: 2560px) {
            body {
                font-size: 1.1rem !important;
            }

            .container {
                max-width: 2400px !important;
                padding-left: 3rem !important;
                padding-right: 3rem !important;
            }

            /* Enhanced stats cards layout */
            .stats-grid {
                grid-template-columns: repeat(4, minmax(300px, 1fr)) !important;
                gap: 2.5rem !important;
            }

            /* Enhanced management sections */
            .management-grid {
                grid-template-columns: repeat(3, minmax(400px, 1fr)) !important;
                gap: 2.5rem !important;
            }

            /* Enhanced cards */
            .dashboard-card,
            .ticket-card,
            .stats-card {
                padding: 2rem !important;
                margin-bottom: 2rem !important;
                border-radius: 0.75rem !important;
            }

            /* Enhanced typography */
            h1 {
                font-size: 2.25rem !important;
            }

            h2 {
                font-size: 1.875rem !important;
            }

            h3 {
                font-size: 1.5rem !important;
            }

            h4 {
                font-size: 1.25rem !important;
            }

            /* Enhanced buttons */
            button,
            .btn {
                padding: 1rem 2rem !important;
                font-size: 1.1rem !important;
                border-radius: 0.5rem !important;
            }

            /* Enhanced modals */
            .modal-content {
                padding: 3rem !important;
                max-width: 600px !important;
            }

            /* Optimize navigation for ultra-wide */
            nav .container {
                padding-left: 3rem !important;
                padding-right: 3rem !important;
            }

            nav .hidden.md\:flex {
                gap: 2rem !important;
            }

            /* Better ticket card layout for wide screens */
            .ticket-card {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 1.5rem;
            }

            .ticket-info {
                grid-column: 1;
            }

            .ticket-actions {
                grid-column: 2;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 0.5rem;
            }

            /* Enhanced sidebar for ultra-wide displays */
            .right-sidebar {
                width: 340px !important;
                right: 2rem !important;
                top: 150px !important;
                bottom: 2rem !important;
                border-radius: 1rem !important;
                box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15) !important;
            }

            .right-sidebar .sidebar-section {
                padding: 1.5rem 2rem !important;
                margin-bottom: 2rem !important;
                border-radius: 0.75rem !important;
            }

            .right-sidebar .sidebar-title {
                font-size: 1.25rem !important;
                margin-bottom: 1rem !important;
            }

            /* Optimize toggle button for ultra-wide */
            .sidebar-toggle {
                width: 64px !important;
                height: 64px !important;
                right: 2rem !important;
                font-size: 1.5rem !important;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25) !important;
            }

            /* Enhance main layout spacing */
            .main-layout {
                padding: 0 3rem !important;
            }

            .parallel-container {
                gap: 3rem !important;
            }

            /* Optimize app container for ultra-wide */
            .app-container {
                flex: 1 !important;
                max-width: none !important;
            }

            /* Enhance container responsiveness */
            .container {
                max-width: none !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            /* Optimize priority and classification badges */
            .priority-badge,
            .status-badge {
                padding: 0.75rem 1.5rem !important;
                font-size: 0.875rem !important;
                border-radius: 0.5rem !important;
            }

            /* Enhance dropdown styling for large screens */
            .relative.inline-block select {
                padding: 0.75rem 1.5rem !important;
                font-size: 0.875rem !important;
                border-radius: 0.5rem !important;
            }

            /* Optimize action buttons for ultra-wide */
            .action-buttons button {
                padding: 1rem 2rem !important;
                font-size: 1rem !important;
                border-radius: 0.5rem !important;
            }
        }


        /* ===== NORMAL UI STYLES - STANDARD SIZES ===== */

        /* Normal base font size - READABLE */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9fafb;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            /* Performance optimizations */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Normal Cards and Elements */
        .dashboard-card,
        .ticket-card,
        .stats-card {
            padding: 1rem !important;
            margin-bottom: 1rem !important;
            border-radius: 0.5rem !important;
        }

        /* Normal Badges */
        .badge {
            padding: 0.25rem 0.75rem !important;
            font-size: 0.875rem !important;
            font-weight: 500 !important;
        }

        /* Normal Buttons */
        button,
        .btn {
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            border-radius: 0.375rem !important;
        }

        /* Normal Headers */
        h1 {
            font-size: 1.875rem !important;
        }

        h2 {
            font-size: 1.5rem !important;
        }

        h3 {
            font-size: 1.25rem !important;
        }

        h4 {
            font-size: 1.125rem !important;
        }

        /* Normal Spacing */
        .p-6 {
            padding: 1.5rem !important;
        }

        .p-4 {
            padding: 1rem !important;
        }

        .m-6 {
            margin: 1.5rem !important;
        }

        .m-4 {
            margin: 1rem !important;
        }

        .mb-6 {
            margin-bottom: 1.5rem !important;
        }

        .mb-4 {
            margin-bottom: 1rem !important;
        }

        /* Normal Icons */
        .fas,
        .fab,
        .far {
            font-size: 1rem !important;
        }

        .ticket-header {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .priority-urgent {
            border-left-color: var(--urgent);
        }

        .priority-fast {
            border-left-color: var(--fast);
        }

        .priority-medium {
            border-left-color: var(--medium);
        }

        .priority-low {
            border-left-color: #6366f1;
        }

        .btn-primary {
            background-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        /* ===== ENHANCED DRAG & DROP STYLES ===== */

        /* Enhanced drop zone styling */
        #replyDropzone {
            transition: all 0.2s ease;
            position: relative;
        }

        #replyDropzone.drag-over {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #replyDropzone.has-attachments {
            border-color: #10b981 !important;
            background-color: #f0fdf4 !important;
        }

        /* ===== MODERN ATTACHMENT PREVIEW - DARK GLASSMORPHISM DESIGN ===== */
        #enhancedAttachmentPreview {
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.6) 0%, rgba(20, 20, 30, 0.8) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0 0 12px 12px;
            margin-top: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Attachment Preview Header */
        #enhancedAttachmentPreview .flex.items-center.justify-between {
            margin-bottom: 12px;
        }

        #enhancedAttachmentPreview .text-xs.text-gray-400 {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Clear All Button - Subtle and Modern */
        #clearAllAttachments {
            font-size: 10px;
            font-weight: 500;
            color: rgba(255, 100, 100, 0.7);
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.2);
            padding: 4px 10px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        #clearAllAttachments:hover {
            color: rgba(255, 255, 255, 0.95);
            background: rgba(255, 100, 100, 0.25);
            border-color: rgba(255, 100, 100, 0.4);
            transform: translateY(-1px);
        }

        /* Attachment List Container */
        #attachmentPreviewList {
            max-height: 240px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
        }

        /* Custom Scrollbar for Attachment List */
        #attachmentPreviewList::-webkit-scrollbar {
            width: 6px;
        }

        #attachmentPreviewList::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
        }

        #attachmentPreviewList::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        #attachmentPreviewList::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ===== MODERN ATTACHMENT CARD STYLING ===== */
        .attachment-card-modern {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(40, 40, 55, 0.4) 0%, rgba(30, 30, 45, 0.6) 100%);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
        }

        .attachment-card-modern:hover {
            background: linear-gradient(135deg, rgba(50, 50, 65, 0.5) 0%, rgba(40, 40, 55, 0.7) 100%);
            border-color: rgba(255, 255, 255, 0.18);
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .attachment-card-modern:last-child {
            margin-bottom: 0;
        }

        /* Attachment Icon */
        .attachment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }

        .attachment-card-modern:hover .attachment-icon {
            transform: scale(1.1);
        }

        /* Attachment Info Container */
        .attachment-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Attachment Name */
        .attachment-name {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        /* Attachment Meta Row */
        .attachment-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-badge.success {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .status-badge.error {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-badge.loading {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .status-badge i {
            font-size: 9px;
        }

        /* File Size & Type Labels */
        .file-size,
        .file-type {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
        }

        .file-type {
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* Remove Button */
        .attachment-remove {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.2);
            color: rgba(255, 100, 100, 0.8);
            font-size: 12px;
            flex-shrink: 0;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .attachment-remove:hover {
            background: rgba(255, 100, 100, 0.25);
            border-color: rgba(255, 100, 100, 0.4);
            color: rgba(255, 255, 255, 0.95);
            transform: scale(1.1);
        }

        .attachment-remove:active {
            transform: scale(0.95);
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .attachment-card-modern {
                gap: 10px;
                padding: 8px 10px;
            }

            .attachment-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .attachment-name {
                font-size: 12px;
            }

            .status-badge,
            .file-size,
            .file-type {
                font-size: 9px;
            }

            .attachment-remove {
                width: 26px;
                height: 26px;
            }
        }

        /* ===== ATTACHMENT STYLING (46px x 300px) ===== */

        /* HIDE "Attachments (x):" header completely */
        .text-xs.text-gray-500.mb-1,
        h3.text-sm.font-medium.text-gray-500.mb-2,
        div.text-xs.text-gray-500.mb-1 {
            display: none !important;
        }

        /* Attachments container - inline row */
        .attachments-container,
        div.flex.flex-wrap.gap-2 {
            display: inline-flex !important;
            flex-wrap: wrap !important;
            gap: 10px !important;
            align-items: center !important;
        }

        /* Attachment cards - Large size 46px height, 300px width */
        .attachments-container .detail-card,
        .attachments-container>div,
        div[class*="bg-gray-50"][class*="border-gray-200"],
        div.flex.flex-wrap.gap-2>div {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            border-radius: 10px !important;
            padding: 8px 16px !important;
            margin: 0 !important;
            width: 300px !important;
            height: 46px !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 12px !important;
        }

        /* Hide icon circle for attachments only, preserve vehicle info icons */
        .attachments-container .detail-card .p-3.rounded-full,
        .attachments-container .detail-card>div.p-3,
        .attachments-container .detail-card .flex-1 {
            display: contents !important;
            padding: 0 !important;
            background: transparent !important;
            margin: 0 !important;
        }

        /* Ensure vehicle info icons don't overlap - proper flex display */
        .vehicle-info-grid .detail-card {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 0.75rem !important;
        }

        .vehicle-info-grid .detail-card>div.p-3.rounded-full {
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 36px !important;
            height: 36px !important;
            padding: 0 !important;
        }

        /* Hide file size */
        .attachments-container .text-gray-400,
        div.flex.flex-wrap.gap-2 .text-gray-400,
        p.text-xs.text-gray-400,
        .attachments-container .mt-1 {
            display: none !important;
        }

        /* File type icon - larger */
        .attachments-container i.fas,
        div[class*="bg-gray-50"] i.fas,
        div.flex.flex-wrap.gap-2 i.fas {
            font-size: 18px !important;
            margin: 0 !important;
            opacity: 0.9 !important;
        }

        /* Filename - larger and readable */
        .attachments-container .text-xs,
        .attachments-container h4,
        .font-medium.truncate,
        div.flex.flex-wrap.gap-2 .font-medium {
            font-size: 14px !important;
            margin: 0 !important;
            line-height: 1.4 !important;
            max-width: 180px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500 !important;
        }

        /* Preview/Download buttons - nicely sized */
        .attachments-container button,
        div[class*="bg-gray-50"] .flex.gap-1 button,
        button[class*="bg-blue-100"],
        button[class*="bg-green-100"],
        div.flex.flex-wrap.gap-2 button {
            background: rgba(255, 255, 255, 0.1) !important;
            border: none !important;
            padding: 6px !important;
            min-width: 28px !important;
            width: 28px !important;
            height: 28px !important;
            border-radius: 6px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 0.8 !important;
            transition: all 0.2s !important;
        }

        .attachments-container button:hover,
        div.flex.flex-wrap.gap-2 button:hover {
            opacity: 1 !important;
            background: rgba(99, 102, 241, 0.4) !important;
        }

        /* Button icons - clear */
        button[class*="bg-blue-100"] i,
        button[class*="bg-green-100"] i,
        div.flex.flex-wrap.gap-2 button i {
            font-size: 14px !important;
        }

        /* Hide warranty badge */
        .attachments-container .bg-green-100.text-green-800 {
            display: none !important;
        }

        /* File size hidden */
        .text-gray-400.text-\[10px\] {
            display: none !important;
        }

        /* Remove attachment styling */
        .remove-attachment {
            color: #ef4444;
            transition: all 0.2s ease;
        }

        .remove-attachment:hover {
            color: #dc2626;
            background-color: rgba(220, 38, 38, 0.1);
            transform: scale(1.1);
        }

        /* Clear all button styling */
        #clearAllAttachments {
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        #clearAllAttachments:hover {
            background-color: rgba(220, 38, 38, 0.1);
        }

        /* ===== IMPROVED READABILITY - TARGETED OVERRIDES ===== */
        /* Note: Removed aggressive global overrides that were breaking layout */

        /* Primary text content readability */
        .original-message-content,
        .message-content,
        .reply-message-box .message-content,
        .ticket-body-content {
            font-size: 0.95rem !important;
            line-height: 1.7 !important;
        }

        /* Ensure conversation messages are readable */
        .message {
            font-size: 0.95rem !important;
        }

        /* Make badges readable but compact */
        .badge,
        .status-badge,
        .priority-badge {
            font-size: 0.85rem !important;
            padding: 0.35rem 0.75rem !important;
        }

        /* Ensure small text is still somewhat readable */
        .text-xs {
            font-size: 0.8rem !important;
        }

        .text-sm {
            font-size: 0.9rem !important;
        }

        /* Icon sizing - more reasonable */
        .sidebar-section i.fas,
        .sidebar-section i.far {
            font-size: 1rem !important;
        }


        /* Drop zone instructions */
        .drop-instructions {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .drop-instructions i {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        /* Animation for new attachments */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attachment-card {
            animation: slideIn 0.3s ease-out;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #10b981;
            color: white;
        }

        .notification.error {
            background-color: #ef4444;
            color: white;
        }

        /* Original Message styles - DARK THEME FIX */
        .original-message-container {
            background: rgba(255, 255, 255, 0.03) !important;
            border-radius: 1rem !important;
            padding: 1.25rem !important;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            margin-bottom: 1.5rem !important;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        .original-message-content {
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: break-word;
            max-height: none;
            overflow: visible;
            position: relative;
            hyphens: auto;
            margin-bottom: 0.5rem !important;
            color: var(--text-primary) !important;
            font-size: 0.95rem !important;
            line-height: 1.7 !important;
            transition: max-height 0.3s ease-out;
            width: 100%;
            max-width: 100%;
        }

        /* Only truncate when explicitly has truncated class (very long messages) */
        .original-message-content.truncated {
            max-height: 400px;
            overflow: hidden;
        }

        /* Gradient fade effect for truncated content */
        .original-message-content.truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(25, 25, 35, 0.95));
            pointer-events: none;
        }

        .original-message-content.expanded {
            max-height: none !important;
            overflow: visible !important;
        }

        .original-message-content.expanded::after {
            display: none;
        }


        /* Standardized Read More Button */
        .read-more-btn {
            display: none;
            width: fit-content;
            margin: 0.75rem 0 0 auto !important;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
            border: 1px solid rgba(99, 102, 241, 0.3) !important;
            border-radius: 9999px !important;
            text-align: center;
            cursor: pointer;
            color: #a5b4fc !important;
            font-weight: 600;
            font-size: 0.8rem !important;
            transition: all 0.2s ease;
            z-index: 10;
            position: relative;
        }

        .read-more-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.4), rgba(139, 92, 246, 0.4)) !important;
            border-color: rgba(99, 102, 241, 0.5) !important;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }

        /* Show read-more button for sibling (original message - conditionally rendered in HTML) */
        .original-message-container .read-more-btn {
            display: block !important;
        }

        /* Show expand button when reply is truncated */
        .reply-message-box.truncated .expand-btn {
            display: block !important;
        }

        /* Reply Message Box Styles */
        .reply-message-box {
            position: relative;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Truncate the message content only when very long */
        .reply-message-box.truncated .message-content {
            /* max-height: 300px; */
            /* overflow: hidden; */
            position: relative;
        }

        /* Gradient fade on the message content itself */
        .reply-message-box.truncated .message-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(transparent, rgba(25, 25, 35, 0.9));
            pointer-events: none;
        }

        .reply-message-box.expanded .message-content {
            max-height: none !important;
            overflow: visible !important;
        }

        .reply-message-box.expanded .message-content::after {
            display: none;
        }

        .reply-message-box .message-content {
            color: var(--text-primary);
            line-height: 1.6;
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: break-word;
            position: relative;
            width: 100%;
            max-width: 100%;
        }



        /* Expand Button for Replies */
        .expand-btn {
            display: none;
            width: fit-content;
            margin: 0.5rem 0 0 auto !important;
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            border-radius: 9999px !important;
            text-align: center;
            cursor: pointer;
            color: #9ca3af !important;
            font-weight: 500;
            font-size: 0.75rem !important;
            transition: all 0.2s ease;
            z-index: 10;
            position: relative;
        }

        .expand-btn:hover {
            background: rgba(99, 102, 241, 0.2) !important;
            border-color: rgba(99, 102, 241, 0.3) !important;
            color: #a5b4fc !important;
            transform: translateY(-1px);
        }

        /* Responsive styles for original message */
        @media (max-width: 768px) {
            .original-message-container {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            .original-message-content.truncated {
                max-height: 300px;
                font-size: 0.9rem !important;
                line-height: 1.6 !important;
            }

            .read-more-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem !important;
            }

            .reply-message-box.truncated .message-content {
                max-height: 200px;
            }

            .expand-btn {
                padding: 0.35rem 0.7rem;
                font-size: 0.7rem !important;
            }
        }

        @media (max-width: 480px) {
            .original-message-container {
                padding: 0.75rem !important;
                border-radius: 0.75rem !important;
            }

            .original-message-content.truncated {
                max-height: 250px;
                font-size: 0.85rem !important;
            }

            .read-more-btn,
            .expand-btn {
                width: 100%;
                text-align: center;
            }
        }


        /* Importance button styles - NO CIRCLE, JUST STAR */
        .importance-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb;
            transition: all 0.2s ease;
            border: 1px solid #d1d5db;
            border-radius: 50%;
        }

        .importance-btn:hover {
            border-color: #9ca3af;
            background-color: #f3f4f6;
            border-radius: 50%;
        }

        .importance-btn.important {
            border-color: #f59e0b;
            background-color: #fffbeb;
            border-radius: 50%;
        }

        .importance-btn .star-icon {
            color: #d1d5db;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .importance-btn:hover .star-icon {
            color: #f59e0b;
        }

        .importance-btn.important .star-icon {
            color: #f59e0b;
        }

        /* User Requested Button Styles */
        .attachments-container button,
        div[class*="bg-gray-50"] .flex.gap-1 button,
        button[class*="bg-blue-100"],
        button[class*="bg-green-100"],
        div.flex.flex-wrap.gap-2 button {
            background: rgba(255, 255, 255, 0.1) !important;
            border: none !important;
            padding: 6px !important;
            min-width: 28px !important;
            width: 96px !important;
            height: 28px !important;
            border-radius: 6px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 0.8 !important;
            transition: all 0.2s !important;
        }

        /* Conversation styles */
        .conversation-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        /* Customer messages - aligned to the LEFT */
        .customer-message {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.2);
            margin-right: auto;
        }

        /* Support/Internal messages - aligned to the RIGHT */
        .support-message {
            align-self: flex-end;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.05));
            border: 1px solid rgba(168, 85, 247, 0.2);
            margin-left: auto;
        }

        /* Legacy message styles removed for consistency */

        /* Modern icons */
        .customer-icon {
            color: #3b82f6;
            margin-right: 8px;
            font-size: 1.2rem;
        }

        .support-icon {
            color: #a855f7;
            margin-right: 8px;
            font-size: 1.2rem;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #1a2023;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: all 0.3s ease;
            max-width: 90%;
            width: 500px;
            overflow: hidden;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Vehicle & Claim Modal Specific Styles */
        #vehicleClaimModal .modal-content {
            width: 800px;
            max-width: 95%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 0;
        }

        #vehicleClaimModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        #vehicleClaimModal .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        #vehicleClaimModal .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        #vehicleClaimModal .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        #vehicleClaimModal .section-title i {
            font-size: 1rem;
        }

        #vehicleClaimModal .form-group {
            margin-bottom: 1rem;
        }

        #vehicleClaimModal .form-label {
            display: block;
            color: #9ca3af;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        #vehicleClaimModal .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        #vehicleClaimModal .form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        #vehicleClaimModal .form-input::placeholder {
            color: #6b7280;
        }

        #vehicleClaimModal .input-wrapper {
            position: relative;
        }

        #vehicleClaimModal .input-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 0.875rem;
        }

        #vehicleClaimModal .section-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        #vehicleClaimModal .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        #vehicleClaimModal .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #vehicleClaimModal .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        #vehicleClaimModal .checkbox-item input {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
        }

        #vehicleClaimModal .checkbox-item span {
            color: #d1d5db;
            font-size: 0.85rem;
        }

        #vehicleClaimModal .upload-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #vehicleClaimModal .upload-zone:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.12));
        }

        #vehicleClaimModal .upload-zone i {
            font-size: 2rem;
            color: #818cf8;
            margin-bottom: 0.5rem;
        }

        #vehicleClaimModal .btn-cancel {
            padding: 0.625rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #vehicleClaimModal .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        #vehicleClaimModal .btn-save {
            padding: 0.625rem 1.5rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        #vehicleClaimModal .btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        #vehicleClaimModal .btn-upload {
            padding: 0.5rem 1.25rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #vehicleClaimModal .btn-upload:hover {
            transform: translateY(-1px);
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .message {
                max-width: 85%;
            }

            .customer-message {
                align-self: flex-start;
                margin-right: auto;
                margin-left: 0;
            }

            .support-message {
                align-self: flex-end;
                margin-left: auto;
                margin-right: 0;
            }

            .modal-content {
                max-width: 95%;
                margin: 1rem;
                max-height: 90vh;
            }

            .flex.flex-col.md\:flex-row {
                gap: 1rem;
            }

            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 90%;
                padding: 0.5rem 0.75rem;
            }

            .ticket-header {
                padding: 1rem !important;
            }

            h1 {
                font-size: 1.25rem !important;
                line-height: 1.4;
            }

            .px-6 {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }

        /* Line clamp utilities for text truncation */
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Responsive word breaking */
        .break-words {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }

        /* Auto-expanding textarea styles */
        .auto-expand-textarea {
            transition: height 0.2s ease-out;
            resize: none;
            overflow: hidden;
        }

        /* Smooth transition for height changes */
        .auto-expand-textarea:focus {
            transition: height 0.15s ease-out;
        }

        /* REMOVED: Annoying blinking blue dot animation
           The pulse animation was causing endless blinking on forwarded tickets */

        /* Forward/Takeover specific styles */
        .forwarded-badge {
            background-color: #e0f2fe !important;
            color: #0369a1 !important;
        }

        .takeover-badge {
            background-color: #dcfce7 !important;
            color: #166534 !important;
            border-left: 3px solid #4ade80 !important;
        }

        .assignment-status {
            position: relative;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        /* REMOVED: All blinking assignment status animations
           These were causing annoying endless blinking on forwarded tickets */

        .takeover-badge.assignment-status::before {
            background-color: #166534;
        }

        /* Card styling */
        .detail-card {
            background: rgba(25, 25, 35, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 14px;
        }

        /* FIXED LAYOUT STYLES */

        /* Custom max-width for 1440px constraint */
        .max-w-1440 {
            max-width: 1440px;
        }

        /* ===== STICKY SIDEBAR LAYOUT (Google Gemini Style) ===== */

        /* Main layout container - fills viewport height minus navbar */
        .main-layout {
            position: relative;
            width: 100%;
            min-height: calc(100vh - 10vh);
            display: flex;
            flex-direction: row;
        }

        /* Parallel container - flex layout for app and sidebar */
        .parallel-container {
            display: flex;
            width: 100%;
            position: relative;
            align-items: stretch;
            flex: 1;
        }

        /* App container - left side, scrollable content */
        .app-container {
            flex: 1;
            width: calc(100% - 280px);
            position: relative;
            overflow-y: auto;
            padding-right: 12px;
            transition: all 0.15s ease;
        }

        /* Right sidebar styles - ALWAYS VISIBLE AND STICKY */
        /* Right sidebar styles - ALWAYS VISIBLE AND STICKY */
        .right-sidebar {
            width: 280px !important;
            position: fixed !important;
            right: 0 !important;
            top: 10vh !important;
            height: calc(100vh - 10vh) !important;
            background: #0f0f13 !important;
            /* Solid dark background */
            border-left: 1px solid rgba(255, 255, 255, 0.1) !important;
            /* Visual separator */
            overflow-y: auto !important;
            overflow-x: hidden !important;
            z-index: 42 !important;
            padding: 16px !important;
            padding-left: 20px !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 16px !important;
            transform: translateX(0) !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            box-shadow: none !important;
        }

        /* Minimized sidebar state - not used with always-visible sidebar */
        .right-sidebar.minimized {
            width: 60px;
            padding: 0.5rem;
        }

        .right-sidebar.minimized .sidebar-section {
            display: none;
        }

        .right-sidebar.minimized .sidebar-header {
            display: none;
        }

        .right-sidebar.minimized .sidebar-content {
            display: none;
        }

        /* Minimize button styles - dark theme */
        .minimize-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.25rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .minimize-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .minimize-btn i {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Toggle button - hidden since sidebar is always visible */
        .sidebar-toggle {
            display: none !important;
        }

        .sidebar-toggle.hidden {
            display: none !important;
        }

        .sidebar-toggle:hover {
            display: none !important;
        }

        .sidebar-toggle i {
            font-size: 1.25rem !important;
        }

        /* Ensure toggle button is always visible when sidebar is closed */
        .sidebar-toggle:not(.hidden) {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Hide toggle button only when explicitly hidden */
        .sidebar-toggle.hidden {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }

        /* Responsive toggle button positioning */
        @media (min-width: 1921px) {
            .sidebar-toggle:not(.hidden) {
                right: 2rem !important;
                width: 64px !important;
                height: 64px !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.5rem !important;
            }
        }

        @media (max-width: 1920px) {
            .sidebar-toggle:not(.hidden) {
                right: 1rem !important;
                width: 56px !important;
                height: 56px !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.25rem !important;
            }
        }

        /* Enhanced mobile and tablet behavior with better responsive coverage */
        @media (max-width: 1280px) {
            .right-sidebar {
                transform: translateX(120%) !important;
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                width: 100%;
                top: 118px;
                max-width: 300px;
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            /* Add overlay for mobile - lower z-index to allow drag interactions */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3);
                /* Lighter overlay */
                z-index: 35;
                /* Lower z-index */
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            /* Ensure draggable elements and main content have higher z-index */
            .main-content,
            .document-item,
            .conversation-container,
            .ticket-header {
                position: relative;
                z-index: 36;
                /* Higher than overlay */
            }

            /* Draggable document items get even higher z-index */
            .document-item[draggable="true"] {
                z-index: 45;
                /* Higher than sidebar */
            }

            /* Interactive form elements should also be above overlay */
            #replyForm,
            .reply-message-box,
            .attachment-preview,
            textarea,
            input {
                position: relative;
                z-index: 36;
                /* Higher than overlay */
            }

            /* Ensure dropzone for file uploads works */
            #attachmentDropzone,
            #attachmentSection {
                position: relative;
                z-index: 36;
            }
        }

        /* Enhanced mobile portrait behavior */
        @media (max-width: 768px) {
            .right-sidebar {
                max-width: 280px;
                top: 100px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 48px !important;
                height: 48px !important;
                right: 0.75rem !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.1rem !important;
            }
        }

        /* Enhanced small mobile behavior */
        @media (max-width: 480px) {
            .right-sidebar {
                max-width: 260px;
                top: 90px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 44px !important;
                height: 44px !important;
                right: 0.5rem !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1rem !important;
            }
        }

        /* Enhanced very small mobile behavior */
        @media (max-width: 360px) {
            .right-sidebar {
                max-width: 240px;
                top: 80px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 40px !important;
                height: 40px !important;
                right: 0.25rem !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 0.9rem !important;
            }

            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }

        /* Enhanced landscape mobile behavior */
        @media (max-width: 768px) and (orientation: landscape) {
            .right-sidebar {
                top: 70px;
                max-width: 300px;
            }

            .sidebar-toggle:not(.hidden) {
                top: 60% !important;
            }
        }

        /* Enhanced tablet portrait behavior */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .right-sidebar {
                max-width: 340px;
                top: 120px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 56px !important;
                height: 56px !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.3rem !important;
            }
        }

        /* Container optimization for desktop screens */
        @media (min-width: 1281px) and (max-width: 1920px) {

            /* Ensure container takes full available width */
            .container {
                max-width: none;
                width: 100%;
            }

            /* Hide sidebar by default on all desktop screens */
            .right-sidebar {
                transform: translateX(120%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            .app-container.sidebar-open {
                width: calc(100% - 340px) !important;
                max-width: calc(100% - 340px) !important;
            }

            .app-container.sidebar-closed {
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        /* Enhanced responsive breakpoints for better coverage */
        @media (min-width: 1025px) and (max-width: 1280px) {

            /* Medium desktop: hide sidebar by default but allow toggling */
            .right-sidebar {
                transform: translateX(120%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            .app-container.sidebar-open {
                width: calc(100% - 340px) !important;
                max-width: calc(100% - 340px) !important;
            }

            .app-container.sidebar-closed {
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Show toggle button for medium desktop */
            .sidebar-toggle {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 1000 !important;
                background: #4f46e5 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                width: 48px !important;
                height: 48px !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3) !important;
            }

            .sidebar-toggle:hover {
                background: #4338ca;
                transform: translateY(-50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            }

            .sidebar-toggle i {
                font-size: 1.1rem;
            }
        }

        /* Enhanced tablet landscape behavior */
        @media (min-width: 769px) and (max-width: 1024px) {
            .right-sidebar {
                transform: translateX(100%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                width: 100%;
                top: 118px;
                max-width: 320px;
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }

            /* Enhanced toggle button for tablet */
            .sidebar-toggle:not(.hidden) {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 1000 !important;
                background: #4f46e5 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                width: 52px !important;
                height: 52px !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3) !important;
            }

            .sidebar-toggle:not(.hidden):hover {
                background: #4338ca;
                transform: translateY(-50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.2rem;
            }
        }

        /* Enhanced main content - with space for fixed sidebar */
        .main-content.expanded {
            margin-right: 295px !important;
            max-width: calc(100% - 295px) !important;
            width: calc(100% - 295px) !important;
            padding-right: 12px !important;
            transition: all 0.15s ease;
        }

        /* Make main content have space for sidebar by default */
        .main-content {
            margin-right: 295px !important;
            max-width: calc(100% - 295px) !important;
            width: calc(100% - 295px) !important;
            padding-right: 12px !important;
        }

        /* Sidebar always visible on desktop */
        .right-sidebar {
            transition: all 0.15s ease;
            /* Default state - ALWAYS VISIBLE */
            transform: translateX(0) !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: flex !important;
        }

        /* Keep sidebar visible */
        .right-sidebar:not(.sidebar-open):not(.ultra-wide-open) {
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }

        /* Sidebar always visible */
        .right-sidebar.sidebar-open,
        .right-sidebar.ultra-wide-open {
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }

        .app-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ensure smooth transitions for all interactive elements */
        .sidebar-toggle,
        .minimize-btn,
        .right-sidebar,
        .sidebar-overlay {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced responsive container behavior */
        .container {
            transition: all 0.3s ease-in-out;
        }

        /* Ensure consistent spacing across all screen sizes */
        @media (min-width: 320px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        @media (min-width: 768px) {
            .container {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .container {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }

        @media (min-width: 1280px) {
            .container {
                padding-left: 2.5rem;
                padding-right: 2.5rem;
            }
        }

        @media (min-width: 1920px) {
            .container {
                padding-left: 3rem;
                padding-right: 3rem;
            }
        }

        /* When sidebar is closed, expand app container to full width */
        .app-container.sidebar-closed {
            width: 100% !important;
            margin-right: 0 !important;
            max-width: 100% !important;
            flex: 1 !important;
            transition: all 0.3s ease-in-out;
        }

        /* When sidebar is open, give space for sidebar */
        .app-container.sidebar-open {
            width: calc(100% - 340px) !important;
            margin-right: 0 !important;
            max-width: calc(100% - 340px) !important;
            flex: 1 !important;
            transition: all 0.3s ease-in-out;
        }

        /* Enhanced expansion effects for better visual feedback */
        .main-content.expanded .ticket-header {
            padding-right: 2rem !important;
        }

        .main-content.expanded .conversation-container {
            max-width: 100% !important;
            padding-right: 2rem !important;
        }

        .main-content.expanded #replyForm {
            max-width: 100% !important;
            padding-right: 2rem !important;
        }

        .main-content.expanded .outcome-section {
            max-width: 100% !important;
            padding-right: 2rem !important;
        }



        /* Smooth transition for all expandable elements */
        .main-content,
        .ticket-header,
        .conversation-container,
        #replyForm,
        .outcome-section {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ultra-wide screens with hidden sidebar - maximize content width */
        @media (min-width: 1921px) {
            .main-content.expanded {
                margin-right: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding-right: 0 !important;
            }
        }

        /* Mobile/tablet with hidden sidebar - maximize content width */
        @media (max-width: 1280px) {
            .main-content.expanded {
                margin-right: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding-right: 0 !important;
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }
        }

        /* Ultra-wide screens (1921px+) - Auto-hide sidebar for better space utilization */
        @media (min-width: 1921px) {
            .right-sidebar {
                transform: translateX(120%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                position: fixed !important;
                z-index: 1000 !important;
                background: rgba(15, 15, 20, 0.95) !important;
                overflow-y: auto !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            /* Ensure sidebar is completely hidden when not open */
            .right-sidebar:not(.ultra-wide-open) {
                clip-path: inset(0 100% 0 0) !important;
            }

            .right-sidebar.ultra-wide-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            .main-content {
                margin-right: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding-right: 0 !important;
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }

            /* Show hamburger menu on ultra-wide screens */
            .sidebar-toggle {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 1000 !important;
                background: #4f46e5 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                width: 56px !important;
                height: 56px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3) !important;
            }

            .sidebar-toggle:hover {
                background: #4338ca;
                transform: translateY(-50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            }

            .sidebar-toggle i {
                font-size: 1.25rem;
            }
        }

        /* Enhanced ultra-wide screen behavior (2560px+) */
        @media (min-width: 2560px) {

            /* Base sidebar behavior - ALWAYS VISIBLE */
            .right-sidebar {
                transform: translateX(0) !important;
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1) !important;
                max-width: 400px !important;
                width: 400px !important;
                right: 0 !important;
                top: 10vh !important;
                bottom: 0 !important;
                height: 90vh !important;
                border-radius: 0 !important;
                position: fixed !important;
                z-index: 1000 !important;
                background: #0f0f13 !important;
                border-left: 1px solid rgba(255, 255, 255, 0.1) !important;
                overflow-y: auto !important;
                padding: 2rem !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            /* Hide toggle button as sidebar is always visible */
            .sidebar-toggle {
                display: none !important;
            }

            /* Ensure main content expands properly with separation */
            .main-content {
                margin-right: 420px !important;
                max-width: calc(100% - 420px) !important;
                width: calc(100% - 420px) !important;
                padding-right: 2rem !important;
                margin-left: 0 !important;
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }


            /* Optimize ticket header for ultra-wide displays */
            .ticket-header {
                padding: 1rem 1.5rem !important;
                margin-bottom: 1rem !important;
            }

            .ticket-header h1 {
                font-size: 1.25rem !important;
                line-height: 1.3 !important;
            }

            /* Enhance badge spacing and sizing */
            .ticket-header .flex.flex-wrap.items-center.gap-2 {
                gap: 0.5rem !important;
            }

            .ticket-header .px-3.py-1.text-xs {
                padding: 0.25rem 0.75rem !important;
                font-size: 0.8rem !important;
            }

            /* Optimize action buttons layout */
            .ticket-header .flex.flex-wrap.items-center.gap-3 {
                gap: 0.5rem !important;
            }

            /* Enhance conversation container for ultra-wide */
            .conversation-container {
                max-width: 100% !important;
                margin: 0 auto !important;
                padding: 0 !important;
            }

            /* Optimize reply cards for large screens */
            .reply-card {
                padding: 1.5rem !important;
                margin-bottom: 1.5rem !important;
                border-radius: 0.75rem !important;
            }

            .reply-card .reply-header {
                margin-bottom: 1rem !important;
            }

            .reply-card .reply-content {
                font-size: 1rem !important;
                line-height: 1.5 !important;
            }

            /* Enhance form inputs for large screens */
            .reply-form input,
            .reply-form textarea {
                padding: 1rem !important;
                font-size: 1rem !important;
                border-radius: 0.5rem !important;
            }

            /* Optimize attachment display */
            .attachments-container {
                max-width: 100% !important;
                margin: 0 auto !important;
            }

            .attachment-item {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                border-radius: 0.5rem !important;
            }

            /* Enhanced grid layouts for ultra-wide */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 1.5rem !important;
            }

            /* Enhanced detail cards for ultra-wide */
            .detail-card {
                padding: 1.5rem !important;
                margin-bottom: 1.5rem !important;
                border-radius: 0.75rem !important;
            }

            /* Enhanced message styling for ultra-wide */
            .message {
                max-width: 70% !important;
                padding: 1rem 1.5rem !important;
                border-radius: 0.75rem !important;
            }

            .customer-message {
                margin-right: auto !important;
            }

            .support-message {
                margin-left: auto !important;
            }

            /* Enhanced reply form for ultra-wide */
            #replyForm {
                max-width: 100% !important;
                margin: 0 auto !important;
            }

            #replyDropzone {
                padding: 1.5rem !important;
                border-radius: 0.75rem !important;
            }

            #response {
                font-size: 1rem !important;
                padding: 1rem !important;
            }

            /* Enhanced outcome section for ultra-wide */
            .outcome-section {
                max-width: 100% !important;
                margin: 0 auto !important;
                padding: 1.5rem 2rem !important;
            }

            /* Enhanced vehicle information grid */
            .vehicle-info-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 1.5rem !important;
            }

            /* Enhanced checklist grid */
            .checklist-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 1.5rem !important;
            }

            /* Enhanced sidebar for ultra-wide displays */
            .right-sidebar {
                width: 320px !important;
                right: 0 !important;
                top: 0 !important;
                bottom: 0 !important;
                border-radius: 0 !important;
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1) !important;
            }

            .right-sidebar .sidebar-section {
                padding: 1.5rem !important;
                margin-bottom: 1.5rem !important;
                border-radius: 0.75rem !important;
            }

            .right-sidebar .sidebar-title {
                font-size: 1.1rem !important;
                margin-bottom: 1rem !important;
            }

            /* Optimize toggle button for ultra-wide */
            .sidebar-toggle {
                width: 48px !important;
                height: 48px !important;
                right: 3rem !important;
                font-size: 1.75rem !important;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
            }

            /* Enhance main layout spacing */
            .main-layout {
                padding: 0 4rem !important;
            }

            .parallel-container {
                gap: 4rem !important;
            }

            /* Optimize app container for ultra-wide */
            .app-container {
                flex: 1 !important;
                max-width: none !important;
            }

            /* Enhance container responsiveness */
            .container {
                max-width: none !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            /* Optimize priority and classification badges */
            .priority-badge,
            .status-badge {
                padding: 1rem 2rem !important;
                font-size: 1rem !important;
                border-radius: 0.75rem !important;
            }

            /* Enhance dropdown styling for large screens */
            .relative.inline-block select {
                padding: 1rem 2rem !important;
                font-size: 1rem !important;
                border-radius: 0.75rem !important;
            }

            /* Optimize action buttons for ultra-wide */
            .action-buttons button {
                padding: 1.25rem 2.5rem !important;
                font-size: 1.1rem !important;
                border-radius: 0.75rem !important;
            }

            /* Enhanced importance button for ultra-wide */
            .importance-btn {
                width: 48px !important;
                height: 48px !important;
            }

            .importance-btn .star-icon {
                font-size: 18px !important;
            }

            /* Enhanced modal styling for ultra-wide */
            .modal-content {
                max-width: 800px !important;
                padding: 3rem !important;
            }

            /* Enhanced notification positioning for ultra-wide */
            .notification {
                top: 3rem !important;
                right: 3rem !important;
                padding: 2rem 3rem !important;
                font-size: 1.1rem !important;
            }
        }

        /* Sidebar toggle button for mobile */
        .sidebar-toggle {
            position: fixed !important;
            top: 50% !important;
            right: 1rem !important;
            transform: translateY(-50%) !important;
            z-index: 9999 !important;
            /* Highest z-index to always be accessible */
            background: var(--primary) !important;
            color: white !important;
            border: none !important;
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2) !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 1.25rem !important;
            touch-action: manipulation !important;
            /* Ensure button is always visible */
            opacity: 1 !important;
            visibility: visible !important;
            /* Make button more visible for debugging */
            border: 3px solid #ffffff !important;
            animation: pulse 2s infinite !important;
        }

        /* Pulse animation for debugging */
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            }

            50% {
                box-shadow: 0 4px 20px rgba(79, 70, 229, 0.8);
            }

            100% {
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            }
        }

        .sidebar-toggle:hover {
            background: #4338ca;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .sidebar-toggle:active {
            transform: translateY(-50%) scale(0.95);
        }

        .sidebar-toggle:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Hide toggle button on larger desktop screens only */
        @media (min-width: 1281px) and (max-width: 1710px) {
            .sidebar-toggle {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 9999 !important;
            }

            .right-sidebar {
                transform: translateX(100%) !important;
                position: fixed;
                right: 0;
                top: 137px;
                bottom: 0;
                width: 340px;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease-in-out;
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0) !important;
            }

            .main-content {
                margin-right: 0 !important;
                max-width: 100% !important;
                padding-right: 1rem;
            }
        }

        /* Show sidebar by default on wide screens (1711px - 1920px) */
        @media (min-width: 1711px) and (max-width: 1920px) {
            .sidebar-toggle {
                display: none !important;
            }

            .right-sidebar {
                transform: translateX(0) !important;
                position: fixed;
                right: 0;
                top: 137px;
                bottom: 0;
                width: 340px;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            }

            .main-content {
                margin-right: 360px;
                max-width: calc(100% - 360px);
                padding-right: 1rem;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }



        /* Ensure draggable elements and main content have higher z-index */
        .main-content,
        .document-item,
        .conversation-container,
        .ticket-header {
            position: relative;
            z-index: 36;
            /* Higher than overlay */
        }

        /* Draggable document items get even higher z-index */
        .document-item[draggable="true"] {
            z-index: 45;
            /* Higher than sidebar */
        }

        /* Interactive form elements should also be above overlay */
        #replyForm,
        .reply-message-box,
        .attachment-preview,
        textarea,
        input {
            position: relative;
            z-index: 36;
            /* Higher than overlay */
        }

        /* Ensure dropzone for file uploads works */
        #attachmentDropzone,
        #attachmentSection {
            position: relative;
            z-index: 36;
        }

        /* Adjust main content margins for larger screens with smooth transitions */
        @media (min-width: 1401px) and (max-width: 1710px) {
            .main-content {
                margin: 0 !important;
                /* No margins to ensure left alignment */
                max-width: none;
                /* Remove max-width restriction */
                width: auto;
                /* Ensure proper width calculation */
                transition: margin-right 0.3s ease-in-out;
            }

            /* Ensure container takes full available width */
            .container {
                max-width: none;
                width: 100%;
                margin-left: 0;
                /* Ensure left alignment */
            }
        }

        /* Wide desktop screens (1711px+) - ensure sidebar margin is respected */
        @media (min-width: 1711px) {
            .main-content {
                margin-right: 360px !important;
                max-width: calc(100% - 360px) !important;
                transition: margin-right 0.3s ease-in-out;
            }
        }

        /* Comprehensive Responsive Design for Ticket Detail */

        /* Small mobile devices (320px - 480px) */
        @media (max-width: 480px) {
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            .ticket-header {
                padding: 0.625rem;
            }

            .detail-card {
                padding: 0.5rem;
                margin-bottom: 0.625rem;
            }

            .conversation-container {
                padding: 0.5rem 0;
                gap: 0.75rem;
            }

            .message {
                max-width: 90%;
                padding: 0.5rem 0.625rem;
                font-size: 0.875rem;
            }

            .customer-message {
                margin-right: 2%;
            }

            .support-message {
                margin-left: 2%;
            }

            .message-header {
                font-size: 0.75rem;
                margin-bottom: 0.375rem;
            }

            .message-time {
                font-size: 0.6875rem;
            }

            /* Navigation responsive */
            nav .container {
                padding: 0.5rem;
            }

            /* Grid layout for small screens */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(1, 1fr) !important;
                gap: 0.75rem;
            }

            /* Button responsiveness */
            .px-3.py-1 {
                padding: 0.375rem 0.5rem;
                font-size: 0.6875rem;
            }

            /* Reply form */
            textarea {
                min-height: 80px;
                font-size: 0.875rem;
            }
        }

        /* Mobile devices (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
                margin-right: 0 !important;
            }

            .main-content {
                margin-right: 0 !important;
                padding: 1rem;
            }

            .ticket-header {
                padding: 1rem;
            }

            .detail-card {
                padding: 1rem;
            }

            .conversation-container {
                padding: 0.5rem 0;
            }

            .message {
                max-width: 85%;
                padding: 0.75rem 1rem;
            }

            .customer-message {
                margin-right: 7.5%;
            }

            .support-message {
                margin-left: 7.5%;
            }

            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem;
            }

            /* Touch-friendly buttons */
            button,
            .btn,
            a.btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
                touch-action: manipulation;
            }

            /* Better spacing for tablet */
            h1 {
                font-size: 1.375rem;
                line-height: 1.25;
            }

            /* Modal improvements */
            .modal-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }
        }

        /* Tablet devices (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
                margin-right: 0 !important;
            }

            .main-content {
                margin-right: 0 !important;
                padding: 1.5rem;
            }

            .ticket-header {
                padding: 1.5rem;
            }

            .detail-card {
                padding: 1.25rem;
            }

            .message {
                max-width: 80%;
                padding: 0.875rem 1.125rem;
            }

            .customer-message {
                margin-right: 10%;
            }

            .support-message {
                margin-left: 10%;
            }

            /* Better button sizing for tablet */
            button,
            .btn,
            a.btn {
                min-height: 44px;
                padding: 0.75rem 1.25rem;
            }

            /* Grid improvements */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
        }

        /* Laptop screens (1025px - 1400px) */
        @media (min-width: 1025px) and (max-width: 1400px) {
            .container {
                max-width: none;
                margin: 0;
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .main-content {
                /* FORCE SEPARATION on laptop screens */
                margin-right: 295px !important;
                padding: 1.5rem;
                max-width: calc(100% - 295px) !important;
                width: calc(100% - 295px) !important;
            }

            .ticket-header {
                padding: 1.75rem;
            }

            .detail-card {
                padding: 1.5rem;
            }

            .message {
                max-width: 75%;
                padding: 1rem 1.25rem;
            }

            .customer-message {
                margin-right: 12.5%;
            }

            .support-message {
                margin-left: 12.5%;
            }

            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }

        /* Large desktop screens (1401px+) - Maintain separation */
        @media (min-width: 1401px) {
            .container {
                max-width: none;
                margin: 0;
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .main-content {
                /* FORCE SEPARATION on large screens */
                margin-right: 350px !important;
                padding: 1.5rem;
                max-width: calc(100% - 350px) !important;
                width: calc(100% - 350px) !important;
            }

            .ticket-header {
                padding: 1.5rem;
            }

            .detail-card {
                padding: 1.5rem;
            }

            .message {
                max-width: 70%;
                padding: 1rem 1.5rem;
            }

            .customer-message {
                margin-right: 15%;
            }

            .support-message {
                margin-left: 15%;
            }

            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }

        .detail-card {
            padding: 2rem;
        }

        /* Desktop sidebar behavior - REMOVED CONFLICTING STYLES */
        /* These styles were conflicting with the main layout system */

        .sidebar-section {
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.03) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0;
            padding: 20px 0;
            box-shadow: none;
            transition: none;
            overflow-x: hidden !important;
            max-width: 100% !important;
        }

        /* Fix Common Documents container overflow */
        #documentsContainer {
            overflow-x: hidden !important;
            max-width: 100% !important;
            padding-right: 8px !important;
        }

        /* Document item styling - keep buttons visible */
        #documentsContainer>div {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Document card - ensure proper layout */
        #documentsContainer .document-card,
        #documentsContainer [class*="document"] {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Keep action buttons visible and properly sized */
        #documentsContainer .flex.gap-2,
        #documentsContainer .flex.items-center.gap-2 {
            flex-wrap: nowrap !important;
            gap: 4px !important;
        }

        #documentsContainer button,
        #documentsContainer a[target="_blank"] {
            flex-shrink: 0 !important;
            min-width: 32px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .sidebar-section:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }

        .add-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 11px;
        }

        .add-btn:hover {
            background: var(--primary-dark);
        }

        /* Note card styles - dark theme */
        .note-card {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-left: 3px solid var(--primary);
            color: var(--text-primary);
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .note-content {
            color: var(--text-secondary);
            font-size: 0.875rem;
            white-space: pre-line;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .note-action-btn {
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .note-action-btn:hover {
            color: var(--primary);
        }

        /* Template styles - dark theme */
        .template-item {
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
        }

        .template-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
        }

        .template-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .template-content {
            color: var(--text-muted);
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .template-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .template-action-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .template-use-btn {
            background-color: rgba(236, 72, 153, 0.2);
            color: var(--primary);
        }

        .template-use-btn:hover {
            background-color: rgba(236, 72, 153, 0.3);
        }

        .template-edit-btn {
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
        }

        .template-edit-btn:hover {
            background-color: rgba(255, 255, 255, 0.12);
        }

        /* Document item styles */
        .document-item {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .document-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .document-item button {
            transition: all 0.15s ease;
        }

        .document-item:hover button {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.02);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            margin: 0.5rem 0;
            transition: all 0.2s ease-in-out;
        }

        .empty-state:hover {
            border-color: rgba(236, 72, 153, 0.3);
            background: rgba(236, 72, 153, 0.05);
        }

        .empty-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: var(--text-muted);
            opacity: 0.6;
        }

        .empty-state p {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
        }



        .sidebar-section {
            margin-bottom: 1.25rem;
            background: rgba(255, 255, 255, 0.03) !important;
            border-radius: 0.5rem;
            padding: 0.875rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
        }

        /* Note card styles - dark theme (overriding light theme) */
        .note-card {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--primary);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .note-content {
            color: var(--text-secondary);
            font-size: 0.875rem;
            white-space: pre-line;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .note-action-btn {
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .note-action-btn:hover {
            color: var(--primary);
        }

        /* Template styles - dark theme */
        .template-item {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
        }

        .template-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
        }

        .template-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .template-content {
            color: var(--text-secondary);
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .template-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .template-action-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .template-use-btn {
            background-color: rgba(236, 72, 153, 0.2);
            color: var(--primary);
        }

        .template-use-btn:hover {
            background-color: rgba(236, 72, 153, 0.3);
        }

        .template-edit-btn {
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
        }

        .template-edit-btn:hover {
            background-color: rgba(255, 255, 255, 0.12);
        }

        /* Document item styles */
        .document-item {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .document-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .document-item button {
            transition: all 0.15s ease;
        }

        .document-item:hover button {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 1.5rem;
            color: #64748b;
        }

        .empty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #cbd5e1;
        }

        .add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 50%;
            background-color: #e0e7ff;
            color: #4f46e5;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-btn:hover {
            background-color: #c7d2fe;
        }

        /* Status dropdown styles */
        .status-dropdown {
            position: relative;
            display: inline-block;
        }

        .status-dropdown-btn {
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-dropdown-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .status-dropdown-content {
            position: absolute;
            background-color: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 220px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
            z-index: 50;
            display: none;
            overflow: hidden;
            margin-top: 5px;
        }

        .status-dropdown-content.show {
            display: block;
        }

        .status-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .status-option:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
        }

        /* Status badge colors */
        /* Status badge colors - DARK THEME */
        .status-new {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .status-open {
            background-color: rgba(59, 130, 246, 0.12);
            color: #3b82f6;
        }

        .status-form-sent {
            background-color: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .status-awaiting-submission {
            background-color: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .status-under-review {
            background-color: rgba(99, 102, 241, 0.2);
            color: #c7d2fe;
        }

        .status-info-requested {
            background-color: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .status-warranty-form-received {
            background-color: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .status-referred-to-tech-director {
            background-color: rgba(236, 72, 153, 0.2);
            color: #f9a8d4;
        }

        .status-approved--revisit-booked {
            background-color: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .status-declined--not-covered {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .status-revisit {
            background-color: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }

        .status-closed {
            background-color: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
        }

        /* Status dropdown button styling based on current status - DARK THEME */
        .status-dropdown-btn.status-new {
            background-color: rgba(59, 130, 246, 0.1) !important;
            color: #93c5fd !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
        }

        .status-dropdown-btn.status-open {
            background-color: rgba(59, 130, 246, 0.12) !important;
            color: #3b82f6 !important;
            border-color: rgba(59, 130, 246, 0.25) !important;
        }

        .status-dropdown-btn.status-form-sent {
            background-color: rgba(245, 158, 11, 0.1) !important;
            color: #fcd34d !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
        }

        .status-dropdown-btn.status-awaiting-submission {
            background-color: rgba(245, 158, 11, 0.1) !important;
            color: #fcd34d !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
        }

        .status-dropdown-btn.status-under-review {
            background-color: rgba(99, 102, 241, 0.1) !important;
            color: #c7d2fe !important;
            border-color: rgba(99, 102, 241, 0.3) !important;
        }

        .status-dropdown-btn.status-info-requested {
            background-color: rgba(245, 158, 11, 0.1) !important;
            color: #fcd34d !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
        }

        .status-dropdown-btn.status-warranty-form-received {
            background-color: rgba(16, 185, 129, 0.1) !important;
            color: #6ee7b7 !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
        }

        .status-dropdown-btn.status-referred-to-tech-director {
            background-color: rgba(236, 72, 153, 0.1) !important;
            color: #f9a8d4 !important;
            border-color: rgba(236, 72, 153, 0.3) !important;
        }

        .status-dropdown-btn.status-approved--revisit-booked {
            background-color: rgba(16, 185, 129, 0.1) !important;
            color: #6ee7b7 !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
        }

        .status-dropdown-btn.status-declined--not-covered {
            background-color: rgba(239, 68, 68, 0.1) !important;
            color: #fca5a5 !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .status-dropdown-btn.status-revisit {
            background-color: rgba(139, 92, 246, 0.1) !important;
            color: #c4b5fd !important;
            border-color: rgba(139, 92, 246, 0.3) !important;
        }

        .status-dropdown-btn.status-closed {
            background-color: rgba(107, 114, 128, 0.1) !important;
            color: #d1d5db !important;
            border-color: rgba(107, 114, 128, 0.3) !important;
        }

        /* Enhanced Email Template Modal Styles */
        .email-template-modal {
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            overflow: hidden;
        }

        .email-template-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .email-template-content::-webkit-scrollbar {
            width: 8px;
        }

        .email-template-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .email-template-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .email-template-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Enhanced form field styles */
        .email-template-content input,
        .email-template-content select,
        .email-template-content textarea {
            transition: all 0.2s ease;
        }

        .email-template-content input:focus,
        .email-template-content select:focus,
        .email-template-content textarea:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Responsive adjustments for email template modal */
        @media (max-width: 768px) {
            .email-template-modal {
                max-height: 95vh;
                width: 95vw !important;
                margin: 1rem;
            }

            .email-template-content {
                max-height: calc(95vh - 180px);
            }

            .email-template-modal .flex.flex-wrap {
                gap: 0.5rem;
            }

            .email-template-modal button {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
        }

        @media (max-width: 480px) {
            .email-template-modal {
                max-height: 98vh;
                width: 98vw !important;
                margin: 0.5rem;
            }

            .email-template-content {
                max-height: calc(98vh - 160px);
            }

            .email-template-modal .flex.flex-wrap {
                flex-direction: column;
                gap: 0.5rem;
            }

            .email-template-modal button {
                width: 100%;
                justify-content: center;
            }
        }

        /* Additional enhancements for very small screens */
        @media (max-width: 360px) {
            .email-template-modal {
                width: 100vw !important;
                margin: 0;
                border-radius: 0;
            }

            .email-template-content {
                padding: 0.5rem;
            }

            .email-template-modal .p-6 {
                padding: 1rem;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .email-template-modal {
                max-height: 95vh;
            }

            .email-template-content {
                max-height: calc(95vh - 140px);
            }

            .email-template-modal .p-6 {
                padding: 1rem;
            }
        }

        /* ===== PROFESSIONAL SIDEBAR STYLING - AGGRESSIVE OVERRIDES ===== */

        /* Fix ticket header alignment - remove extra top padding */
        .p-5.ticket-header,
        .ticket-header.p-5,
        [class*="ticket-header"].p-5,
        div.p-5.ticket-header {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }

        /* Make ALL buttons in right sidebar TINY */
        .right-sidebar button,
        .sidebar button,
        aside button,
        [class*="right"] button,
        .w-80 button,
        .md\:w-80 button {
            padding: 4px 8px !important;
            /* Super tiny */
            font-size: 10px !important;
            /* Super tiny text */
            min-height: auto !important;
            height: auto !important;
            line-height: 1.2 !important;
        }

        /* Specifically target those big + buttons */
        button.text-4xl,
        button[class*="text-4xl"],
        button[class*="text-3xl"],
        button[class*="text-2xl"],
        button[class*="text-xl"] {
            font-size: 12px !important;
            /* Tiny plus signs */
            padding: 4px !important;
            width: 24px !important;
            height: 24px !important;
        }

        /* Target Download buttons specifically */
        button:contains("Download"),
        button[class*="download"],
        .download-btn,
        button[onclick*="download"] {
            padding: 4px 8px !important;
            font-size: 9px !important;
        }

        /* Make all sidebar text TINY */
        .right-sidebar,
        .sidebar,
        aside,
        [class*="right"],
        .w-80,
        .md\:w-80 {
            font-size: 10px !important;
        }

        .right-sidebar h1,
        .right-sidebar h2,
        .right-sidebar h3,
        .right-sidebar h4,
        aside h1,
        aside h2,
        aside h3,
        aside h4 {
            font-size: 11px !important;
            font-weight: 600 !important;
            margin-bottom: 4px !important;
        }

        .right-sidebar p,
        .right-sidebar span,
        .right-sidebar div,
        aside p,
        aside span,
        aside div {
            font-size: 9px !important;
        }

        /* Rounded corners for sidebar */
        .right-sidebar,
        aside,
        [class*="right-"],
        .w-80,
        .md\:w-80 {
            border-radius: 12px !important;
        }

        /* Compact spacing */
        .right-sidebar .mb-4,
        .right-sidebar .mb-3,
        .right-sidebar .mb-2,
        aside .mb-4,
        aside .mb-3,
        aside .mb-2 {
            margin-bottom: 6px !important;
        }

        .right-sidebar .p-3,
        .right-sidebar .p-4,
        .right-sidebar .p-5,
        aside .p-3,
        aside .p-4,
        aside .p-5 {
            padding: 6px !important;
        }

        /* Tiny icons */
        .right-sidebar i,
        aside i {
            font-size: 9px !important;
        }

        /* Ensure parallel alignment */
        .parallel-container {
            display: flex !important;
            align-items: flex-start !important;
            gap: 1rem !important;
        }

        .parallel-container>* {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* Override any conflicting Tailwind classes */
        .container.main-content {
            padding-top: 0 !important;
        }

        /* Make sure both main content and sidebar start at same Y position */
        .app-container,
        .right-sidebar,
        aside {
            align-self: flex-start !important;
        }

        /* ===== VEHICLE & CLAIM MODAL PROFESSIONAL STYLING ===== */
        #closeVehicleClaimModal:hover {
            background: rgba(255, 255, 255, 0.12) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        #cancelVehicleClaim:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.15) !important;
        }

        #saveVehicleClaim:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35) !important;
        }

        /* ===== VEHICLE & CLAIM MODAL - COMPLETE OVERRIDE ===== */
        /* Match application theme from dashboard */

        #vehicleClaimModal .modal-content {
            background: #1a1a2e !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            border-radius: 16px !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5) !important;
            max-width: 700px !important;
        }

        #vehicleClaimModal .modal-header {
            background: #1a1a2e !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
            padding: 24px !important;
        }

        #vehicleClaimModal .modal-body {
            background: #1a1a2e !important;
            padding: 24px !important;
        }

        /* Section Cards - Match dashboard cards */
        #vehicleClaimModal .section-card {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.06) !important;
            border-radius: 12px !important;
            padding: 20px !important;
            margin-bottom: 16px !important;
        }

        /* Section Titles - Clean, no emoji icons */
        #vehicleClaimModal .section-title {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            margin-bottom: 16px !important;
            padding-bottom: 12px !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        #vehicleClaimModal .section-title i {
            color: #6366f1 !important;
            font-size: 14px !important;
            opacity: 0.8 !important;
        }

        #vehicleClaimModal .section-title span {
            color: #e2e8f0 !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            letter-spacing: 0.02em !important;
        }

        /* Form Labels - UPPERCASE like dashboard */
        #vehicleClaimModal .form-label {
            color: #94a3b8 !important;
            font-size: 0.7rem !important;
            font-weight: 500 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
            margin-bottom: 8px !important;
            display: block !important;
        }

        /* Input Fields - Match application inputs */
        #vehicleClaimModal .form-input,
        #vehicleClaimModal input,
        #vehicleClaimModal select,
        #vehicleClaimModal textarea {
            background: rgba(15, 23, 42, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            border-radius: 8px !important;
            color: #f1f5f9 !important;
            font-size: 0.875rem !important;
            padding: 12px 14px !important;
            width: 100% !important;
            transition: all 0.2s ease !important;
        }

        #vehicleClaimModal .form-input:focus,
        #vehicleClaimModal input:focus {
            border-color: rgba(99, 102, 241, 0.5) !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
        }

        #vehicleClaimModal .form-input::placeholder,
        #vehicleClaimModal input::placeholder {
            color: #64748b !important;
        }

        /* Input Icons - Subtle */
        #vehicleClaimModal .input-icon {
            color: #64748b !important;
            font-size: 11px !important;
        }

        /* Compact Section Cards */
        #vehicleClaimModal .section-card {
            padding: 14px !important;
            margin-bottom: 12px !important;
        }

        #vehicleClaimModal .section-title {
            margin-bottom: 12px !important;
            padding-bottom: 8px !important;
        }

        #vehicleClaimModal .section-title i {
            font-size: 12px !important;
        }

        #vehicleClaimModal .section-title span {
            font-size: 0.8rem !important;
        }

        /* Compact Inputs */
        #vehicleClaimModal .form-input,
        #vehicleClaimModal input,
        #vehicleClaimModal select {
            padding: 8px 10px !important;
            font-size: 0.8rem !important;
        }

        /* Checkbox Grid - SMALLER */
        #vehicleClaimModal .checkbox-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 8px !important;
        }

        #vehicleClaimModal .checkbox-item {
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            padding: 6px 10px !important;
            background: rgba(15, 23, 42, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.06) !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        #vehicleClaimModal .checkbox-item:hover {
            background: rgba(99, 102, 241, 0.1) !important;
            border-color: rgba(99, 102, 241, 0.3) !important;
        }

        /* SMALLER Checkboxes */
        #vehicleClaimModal .checkbox-item input[type="checkbox"] {
            width: 12px !important;
            height: 12px !important;
            min-width: 12px !important;
            accent-color: #6366f1 !important;
            margin: 0 !important;
        }

        #vehicleClaimModal .checkbox-item span {
            color: #cbd5e1 !important;
            font-size: 0.7rem !important;
            font-weight: 400 !important;
            line-height: 1.2 !important;
        }

        /* Upload Zone - Compact, Clickable Label */
        #vehicleClaimModal .upload-zone {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(99, 102, 241, 0.05) !important;
            border: 1px dashed rgba(99, 102, 241, 0.3) !important;
            border-radius: 8px !important;
            padding: 16px !important;
            text-align: center !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        #vehicleClaimModal .upload-zone:hover {
            background: rgba(99, 102, 241, 0.08) !important;
            border-color: rgba(99, 102, 241, 0.5) !important;
        }

        #vehicleClaimModal .upload-zone i {
            color: #6366f1 !important;
            font-size: 18px !important;
            margin-bottom: 4px !important;
        }

        #vehicleClaimModal .upload-zone span {
            font-size: 0.75rem !important;
        }

        /* Footer - Compact */
        #vehicleClaimModal .modal-footer {
            background: #1a1a2e !important;
            border-top: 1px solid rgba(255, 255, 255, 0.06) !important;
            padding: 12px 20px !important;
        }

        /* SMALLER Buttons */
        #vehicleClaimModal .btn-upload,
        #vehicleClaimModal #uploadClaimDocBtn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
            border: none !important;
            color: #ffffff !important;
            padding: 8px 16px !important;
            min-width: 80px !important;
            border-radius: 6px !important;
            font-size: 0.75rem !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3) !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
        }

        #vehicleClaimModal .btn-upload:hover,
        #vehicleClaimModal #uploadClaimDocBtn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35) !important;
        }

        /* Save/Cancel Buttons - Smaller */
        #vehicleClaimModal #cancelVehicleClaim,
        #vehicleClaimModal #saveVehicleClaim {
            padding: 8px 16px !important;
            font-size: 0.8rem !important;
            border-radius: 6px !important;
        }

        /* File Input Styling */
        #vehicleClaimModal .file-input-wrapper {
            margin-bottom: 8px !important;
        }

        #vehicleClaimModal input[type="file"] {
            font-size: 0.7rem !important;
            padding: 4px !important;
        }

        /* Form Groups - Compact */
        #vehicleClaimModal .form-group {
            margin-bottom: 0 !important;
        }

        #vehicleClaimModal .form-label {
            font-size: 0.65rem !important;
            margin-bottom: 4px !important;
        }

        /* Grid Gap - Tighter */
        #vehicleClaimModal [style*="grid-template-columns"] {
            gap: 12px !important;
        }

        /* ===== REDESIGNED TICKET HEADER ===== */
        .ticket-header-row1 {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ticket-header-row1 h1 {
            font-size: 1rem !important;
            font-weight: 700 !important;
            margin: 0 !important;
            line-height: 1.4 !important;
            flex: 1 1 auto;
            min-width: 200px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            flex-shrink: 0;
        }

        /* ===== ASSIGNMENT CARD - Beautiful Separated Card ===== */
        .assignment-card {
            margin-top: 10px !important;
            border-radius: 10px !important;
            overflow: hidden !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            background: transparent !important;
            box-shadow: none !important;
        }

        .assignment-card:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Top row: icon + forwarding text + timestamp */
        .assignment-card-top {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.08)) !important;
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
        }

        .assignment-card-top.taken-over {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(52, 211, 153, 0.08)) !important;
            border-bottom: 1px solid rgba(16, 185, 129, 0.15);
        }

        .assignment-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 13px !important;
        }

        .assignment-icon.forwarded {
            background: rgba(59, 130, 246, 0.2) !important;
            border: 1px solid rgba(59, 130, 246, 0.35) !important;
            color: #60a5fa !important;
        }

        .assignment-icon.taken-over {
            background: rgba(16, 185, 129, 0.2) !important;
            border: 1px solid rgba(16, 185, 129, 0.35) !important;
            color: #34d399 !important;
        }

        .assignment-info {
            flex: 1;
            min-width: 0;
        }

        .assignment-info .assignment-title {
            font-size: 13px !important;
            font-weight: 600 !important;
            color: #e2e8f0 !important;
            line-height: 1.3;
        }

        .assignment-info .assignment-title .person-name {
            color: #93c5fd !important;
            font-weight: 700 !important;
        }

        .taken-over .assignment-info .assignment-title .person-name {
            color: #6ee7b7 !important;
        }

        .assignment-info .assignment-from {
            font-size: 11px !important;
            color: rgba(255, 255, 255, 0.45) !important;
            margin-top: 1px;
        }

        .assignment-timestamp {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px !important;
            background: rgba(255, 255, 255, 0.06) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 6px !important;
            font-size: 11px !important;
            color: rgba(255, 255, 255, 0.55) !important;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .assignment-timestamp i {
            font-size: 10px !important;
            opacity: 0.7;
        }

        /* Note section: distinct amber/gold card */
        .assignment-note {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.06)) !important;
            border-top: none;
        }

        .assignment-note-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: rgba(245, 158, 11, 0.2) !important;
            border: 1px solid rgba(245, 158, 11, 0.35) !important;
            color: #fbbf24 !important;
            font-size: 12px !important;
        }

        .assignment-note-content {
            flex: 1;
            min-width: 0;
        }

        .assignment-note-label {
            font-size: 10px !important;
            font-weight: 700 !important;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #fbbf24 !important;
            margin-bottom: 2px;
        }

        .assignment-note-text {
            font-size: 12.5px !important;
            color: #fde68a !important;
            line-height: 1.5;
            font-weight: 500 !important;
        }

        /* ===== ACTION BADGES ROW ===== */
        .header-badges-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .header-badge {
            display: inline-flex !important;
            align-items: center !important;
            gap: 5px;
            padding: 5px 12px !important;
            border-radius: 8px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            white-space: nowrap;
            transition: all 0.2s ease;
            cursor: default;
            border: 1px solid transparent !important;
            height: auto !important;
            min-height: unset !important;
        }

        .header-badge i {
            font-size: 11px !important;
        }

        .header-badge.badge-tech-director {
            background: rgba(245, 158, 11, 0.15) !important;
            color: #fbbf24 !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
        }

        .header-badge.badge-email {
            background: rgba(168, 85, 247, 0.15) !important;
            color: #c084fc !important;
            border-color: rgba(168, 85, 247, 0.3) !important;
            cursor: pointer;
        }

        .header-badge.badge-email:hover {
            background: rgba(168, 85, 247, 0.25) !important;
            border-color: rgba(168, 85, 247, 0.5) !important;
        }

        .header-badge.badge-forward {
            background: rgba(59, 130, 246, 0.15) !important;
            color: #93c5fd !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
        }

        .header-badge.badge-forward-btn {
            background: rgba(16, 185, 129, 0.15) !important;
            color: #6ee7b7 !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
            cursor: pointer;
        }

        .header-badge.badge-forward-btn:hover {
            background: rgba(16, 185, 129, 0.25) !important;
            border-color: rgba(16, 185, 129, 0.5) !important;
        }

        .header-badge.badge-refer {
            background: rgba(245, 158, 11, 0.15) !important;
            color: #fbbf24 !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
            cursor: pointer;
        }

        .header-badge.badge-refer:hover {
            background: rgba(245, 158, 11, 0.25) !important;
            border-color: rgba(245, 158, 11, 0.5) !important;
        }

        .header-badge.badge-locked {
            background: rgba(239, 68, 68, 0.12) !important;
            color: rgba(255, 255, 255, 0.4) !important;
            border-color: rgba(239, 68, 68, 0.2) !important;
        }

        .header-badge.badge-takeover {
            background: rgba(59, 130, 246, 0.15) !important;
            color: #93c5fd !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
            cursor: pointer;
        }

        .header-badge.badge-takeover:hover {
            background: rgba(59, 130, 246, 0.25) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
        }
    </style>
</head>

<body class="min-h-screen max-w-screen-ultra">
    <!-- Background layers matching admin panel -->
    <div class="bg-gradient-layer"></div>
    {% if system_settings.show_background %}
    <div class="background-layer">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
        <div class="gradient-orb orb-4"></div>
    </div>
    {% endif %}

    <!-- Notification System -->
    <div id="notification" class="notification hidden">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="notification-message"></span>
    </div>

    <!-- Message Expansion Modal -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content p-6 bg-[#1a1a2e] border border-white/10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Full Message</h3>
                <button id="closeMessageModal" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalMessageContent"
                class="p-4 bg-white/5 border border-white/5 rounded-lg whitespace-pre-wrap text-gray-300 leading-relaxed">
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content p-6 bg-[#1a1a2e] border border-white/10">
            <h3 class="text-xl font-semibold mb-4 text-white">Confirm Ticket Closure</h3>
            <p class="mb-6 text-gray-400">Are you sure you want to close this ticket? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelClose"
                    class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition">
                    Cancel
                </button>
                <button id="confirmClose"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Confirm Close
                </button>
            </div>
        </div>
    </div>

    <!-- Forward Modal -->
    <div id="forwardModal" class="modal-overlay">
        <div class="modal-content p-6 bg-[#1a1a2e] border border-white/10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Forward Ticket</h3>
                <button id="closeForwardModal" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <label for="forwardMemberSelect" class="block text-gray-300 text-sm font-medium mb-1">Select
                    Member</label>
                <select id="forwardMemberSelect"
                    class="w-full px-4 py-3 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white/5 text-white shadow-sm transition-all duration-200 font-medium">
                    <option value="" class="bg-[#1a1a2e] text-gray-500">Select a member...</option>
                    {% for member in members %}
                    <option value="{{ member['_id'] }}" class="bg-[#1a1a2e]">{{ member.name }} ({{ member.role }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label for="forwardNotes" class="block text-gray-300 text-sm font-medium mb-1">Notes</label>
                <textarea id="forwardNotes"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Add any notes explaining why the ticket is being forwarded"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelForward"
                    class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition">
                    Cancel
                </button>
                <button id="confirmForward"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Forward Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="noteModal" class="modal-overlay">
        <div class="modal-content p-6 bg-[#1a1a2e] border border-white/10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Add Private Note</h3>
                <button id="closeNoteModal" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Title</label>
                <input type="text" id="noteTitle"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Note title">
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Content</label>
                <textarea id="noteContent" rows="4"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Write your note here..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelNote"
                    class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition">
                    Cancel
                </button>
                <button id="saveNote" class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Save Note
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div id="editTemplateModal" class="modal-overlay">
        <div class="modal-content p-6 bg-[#1a1a2e] border border-white/10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white" id="editTemplateTitle">Add New Template</h3>
                <button id="closeEditTemplateModal" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Title</label>
                <input type="text" id="templateTitle"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Template title">
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Content</label>
                <textarea id="templateContent" rows="6"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Enter your template content here..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelEditTemplate"
                    class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition">
                    Cancel
                </button>
                <button id="saveTemplate"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Save Template
                </button>
                <button id="deleteTemplate"
                    class="px-4 py-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500/20 transition hidden">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="documentModal" class="modal-overlay">
        <div class="modal-content p-6 bg-[#1a1a2e] border border-white/10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white" id="documentModalTitle">Add New Document</h3>
                <button id="closeDocumentModal" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Document Name</label>
                <input type="text" id="documentName"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Document name">
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Document Type</label>
                <select id="documentType"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="form" class="bg-[#1a1a2e]">Form</option>
                    <option value="guide" class="bg-[#1a1a2e]">Guide</option>
                    <option value="manual" class="bg-[#1a1a2e]">Manual</option>
                    <option value="template" class="bg-[#1a1a2e]">Template Document</option>
                    <option value="other" class="bg-[#1a1a2e]">Other</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">File</label>
                <div class="flex items-center">
                    <div class="file-input-wrapper w-full font-medium">
                        <div
                            class="file-input-button w-full flex items-center justify-center py-2 bg-white/5 hover:bg-white/10 border border-white/10 transition rounded-lg text-gray-400">
                            <i class="fas fa-upload mr-2"></i> Choose File
                        </div>
                        <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls">
                    </div>
                </div>
                <p id="selectedFileName" class="mt-2 text-sm text-gray-500">No file selected</p>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Description</label>
                <textarea id="documentDescription" rows="3"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Enter a short description of this document..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelDocument"
                    class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition">
                    Cancel
                </button>
                <button id="saveDocument"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Save Document
                </button>
                <button id="deleteDocument"
                    class="px-4 py-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500/20 transition hidden">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Vehicle & Claim Edit Modal -->
    <div id="vehicleClaimModal" class="modal-overlay">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header"
                style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid rgba(99, 102, 241, 0.2); padding: 20px 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div>
                        <h3
                            style="color: #f8fafc; font-size: 1.25rem; font-weight: 600; margin: 0; letter-spacing: -0.01em;">
                            Vehicle & Claim Information</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin: 4px 0 0 0; font-weight: 400;">Edit
                            vehicle details and upload claim documents</p>
                    </div>
                    <button id="closeVehicleClaimModal"
                        style="width: 32px; height: 32px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">
                        <i class="fas fa-times" style="color: #cbd5e1; font-size: 14px;"></i>
                    </button>
                </div>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <!-- Vehicle Details Section -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-car" style="color: #818cf8;"></i>
                        <span>Vehicle Details</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Registration</label>
                            <div class="input-wrapper">
                                <i class="fas fa-id-card input-icon"></i>
                                <input type="text" id="editVehicleRegistration" class="form-input"
                                    placeholder="e.g., ABC 123">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Service Date</label>
                            <div class="input-wrapper">
                                <i class="fas fa-calendar-check input-icon"></i>
                                <input type="date" id="editServiceDate" class="form-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Claim Date</label>
                            <div class="input-wrapper">
                                <i class="fas fa-calendar-alt input-icon"></i>
                                <input type="date" id="editClaimDate" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Claim Details Section -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-clipboard-list" style="color: #a78bfa;"></i>
                        <span>Claim Details</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Type of Claim</label>
                            <div class="input-wrapper">
                                <i class="fas fa-tag input-icon"></i>
                                <input type="text" id="editTypeOfClaim" class="form-input"
                                    placeholder="e.g., Warranty, Repair">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">VHC Link</label>
                            <div class="input-wrapper">
                                <i class="fas fa-link input-icon"></i>
                                <input type="url" id="editVhcLink" class="form-input" placeholder="https://...">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Days Between</label>
                            <div class="input-wrapper">
                                <i class="fas fa-clock input-icon"></i>
                                <input type="number" id="editDaysBetween" class="form-input" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checklist Section -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-tasks" style="color: #34d399;"></i>
                        <span>Claim Checklist</span>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="editAdvisoriesFollowed">
                            <span>Advisories Followed</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="editWithinWarranty">
                            <span>Within Warranty</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="editNewFaultCodes">
                            <span>New Fault Codes</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="editDpfLightOn">
                            <span>DPF Light On</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="editEmlLightOn">
                            <span>EML Light On</span>
                        </label>
                    </div>
                </div>

                <!-- Documents Section -->
                <div class="section-card" style="margin-bottom: 0;">
                    <div class="section-title">
                        <i class="fas fa-file-alt" style="color: #60a5fa;"></i>
                        <span>Claim Documents</span>
                        <span style="margin-left: auto; font-size: 0.7rem; color: #6b7280; font-weight: 400;">Receipts,
                            Photos, Reports</span>
                    </div>

                    <!-- Upload Zone - Clickable -->
                    <div class="file-input-wrapper" style="margin-bottom: 12px;">
                        <label for="claimDocumentFile" class="upload-zone file-input-button" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span style="color: #d1d5db; font-size: 0.8rem;">Drop files here or click to upload</span>
                            <span style="color: #6b7280; font-size: 0.7rem;">PDF, DOC, JPG, PNG, XLS</span>
                        </label>
                        <input type="file" id="claimDocumentFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls"
                            multiple style="display: none;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <input type="text" id="claimDocumentDescription" class="form-input"
                            style="padding-left: 1rem; flex: 1;" placeholder="Description (optional)">
                        <button type="button" id="uploadClaimDocBtn" class="btn-upload">
                            <i class="fas fa-upload" style="margin-right: 6px;"></i>Upload
                        </button>
                    </div>

                    <!-- Existing Documents List -->
                    <div id="claimDocumentsList" style="max-height: 100px; overflow-y: auto;">
                        <p style="color: #6b7280; font-size: 0.85rem; text-align: center; padding: 8px 0;">No claim
                            documents uploaded yet.</p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer"
                style="background: #0f172a; border-top: 1px solid rgba(99, 102, 241, 0.15); padding: 16px 24px; display: flex; justify-content: flex-end; gap: 12px;">
                <button id="cancelVehicleClaim"
                    style="padding: 10px 20px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #cbd5e1; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-times" style="font-size: 12px;"></i>Cancel
                </button>
                <button id="saveVehicleClaim"
                    style="padding: 10px 20px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none; border-radius: 6px; color: #ffffff; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);">
                    <i class="fas fa-save" style="font-size: 12px;"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Assignment/Forward/Takeover Modal -->
    <div id="assignModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white" id="assignModalTitle">Assign Ticket</h3>
                <button id="closeAssignModal" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-1">Select Member</label>
                <select id="assignMemberSelect"
                    class="w-full px-4 py-3 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white/5 shadow-sm transition-all duration-200 text-white font-medium">
                    {% for member in members %}
                    <option value="{{ member._id }}" class="bg-[#1a1a2e] text-white py-2">{{ member.name }} - {{
                        member.role }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4" id="forwardNotesContainer" style="display: none;">
                <label class="block text-gray-300 text-sm font-medium mb-1">Notes</label>
                <textarea id="assignNotes"
                    class="w-full px-3 py-2 border border-white/10 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Add any notes for the forwarded ticket"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelAssign"
                    class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition">
                    Cancel
                </button>
                <button id="confirmAssign"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Email Template Modal -->
    <div id="emailTemplateModal" class="modal-overlay">
        <div class="modal-content p-6 email-template-modal bg-[#1a1a2e]"
            style="max-width: 800px; max-height: 90vh; width: 90vw;">
            <!-- Header Section -->
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-white/10">
                <h3 class="text-xl font-semibold text-white">
                    <i class="fas fa-envelope-open-text text-indigo-400 mr-2"></i>Email Template
                </h3>
                <button id="closeEmailTemplateModal"
                    class="text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Scrollable Content Area -->
            <div class="email-template-content overflow-y-auto" style="max-height: calc(90vh - 200px);">
                <!-- Info Tip -->
                <div class="mb-6 p-4 bg-indigo-500/10 border border-indigo-500/20 rounded-lg">
                    <p class="text-sm text-indigo-300 leading-relaxed">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Tip:</strong> You can edit the subject and body directly, or load a template and then
                        customize it. The fields are always editable!
                    </p>
                </div>

                <!-- Template Type Selection -->
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-file-alt mr-2 text-indigo-400"></i>Template Type
                    </label>
                    <select id="templateTypeSelect"
                        class="w-full px-4 py-3 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white/5 text-white shadow-sm transition-all duration-200">
                        <option value="warranty_claim" class="bg-[#1a1a2e]">Warranty Claim Template</option>
                    </select>
                </div>

                <!-- Recipient Email -->
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-envelope mr-2 text-purple-400"></i>Recipient Email
                    </label>
                    <input type="email" id="recipientEmail"
                        class="w-full px-4 py-3 border border-white/10 rounded-lg bg-white/5 text-gray-400 cursor-not-allowed"
                        readonly value="{{ ticket.email }}">
                </div>

                <!-- Email Subject -->
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-tag mr-2 text-orange-400"></i>Subject
                    </label>
                    <input type="text" id="emailSubject"
                        class="w-full px-4 py-3 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white/5 text-white cursor-text hover:bg-white/10 transition-colors shadow-sm"
                        placeholder="Enter email subject...">
                </div>

                <!-- Email Body -->
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-edit mr-2 text-indigo-400"></i>Email Body
                    </label>
                    <textarea id="emailBody"
                        class="w-full px-4 py-3 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white/5 text-white cursor-text hover:bg-white/10 transition-colors shadow-sm resize-vertical"
                        rows="12" placeholder="Enter email body..."></textarea>
                </div>

                <!-- Attachments Section -->
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-paperclip mr-2 text-indigo-400"></i>Available Attachments
                    </label>
                    <div id="availableAttachments"
                        class="space-y-3 max-h-48 overflow-y-auto bg-white/5 rounded-lg p-4 border border-white/10">
                        <!-- Attachments will be populated via JavaScript -->
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-paperclip text-2xl mb-2 text-gray-600"></i>
                            <p class="text-sm">No attachments available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fixed Footer with Action Buttons -->
            <div class="border-t border-white/10 pt-4 mt-4 bg-transparent">
                <div class="flex flex-wrap justify-end gap-3">
                    <button id="cancelEmailTemplate"
                        class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg hover:bg-white/20 transition-colors font-medium">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button id="regenerateAttachments"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"
                        title="Regenerate attachment data for this ticket">
                        <i class="fas fa-sync-alt mr-2"></i>Regenerate
                    </button>
                    <button id="loadTemplate"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                        <i class="fas fa-download mr-2"></i>Load Template
                    </button>
                    <button id="editTemplate"
                        class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium"
                        style="display: none;">
                        <i class="fas fa-edit mr-2"></i>Edit Template
                    </button>
                    <button id="clearFields"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                        <i class="fas fa-eraser mr-2"></i>Clear
                    </button>
                    <button id="sendEmail"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout Container - Left-Right Layout -->
    <div class="main-layout">
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggleMobile" title="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Parallel Container for App and Sidebar -->
        <div class="parallel-container">
            <!-- App Container - Left Side -->
            <div class="app-container">
                <div class="container main-content max-w-screen-ultra expanded">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-2 sm:space-y-0">
                        <a href="/" class="flex items-center transition text-sm md:text-base"
                            style="color: rgba(255,255,255,0.5);" onmouseover="this.style.color='#fff'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">
                            <i class="fas fa-arrow-left mr-1 md:mr-2"></i> Back
                        </a>

                    </div>

                    <div class="rounded-xl overflow-hidden transition-all"
                        style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div class="p-5 ticket-header priority-{{ ticket.priority|lower }} ticket-header-ultra">
                            <div class="ticket-header-main">
                                <!-- ROW 1: Title + Inline Controls -->
                                <div class="ticket-header-row1">
                                    <h1 class="text-xl font-bold text-gray-800 break-words line-clamp-3">#{{
                                        ticket.ticket_id }} - {{ ticket.subject or 'No Subject' }}</h1>
                                    <div class="header-controls">
                                        <!-- Star/Important -->
                                        <button id="importantBtn"
                                            class="importance-btn {% if ticket.is_important %}important{% endif %}"
                                            title="Mark as important"
                                            style="width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);padding:0 !important;">
                                            <i class="{% if ticket.is_important %}fas fa-star{% else %}far fa-star{% endif %}"
                                                style="font-size:13px !important;color:#fbbf24 !important;"></i>
                                        </button>

                                        <!-- Priority -->
                                        <div class="relative inline-flex items-center">
                                            <select id="prioritySelect"
                                                class="pl-2 pr-6 py-1 text-xs rounded-md font-medium appearance-none cursor-pointer bg-slate-700/80 border border-slate-600 text-white hover:bg-slate-600/80 transition-all focus:outline-none"
                                                style="min-width: 90px; height: 28px;"
                                                data-ticket-id="{{ ticket.ticket_id }}">
                                                <option value="Urgent" {% if ticket.priority=='Urgent' %}selected{%
                                                    endif %}> Urgent</option>
                                                <option value="High" {% if ticket.priority=='High' %}selected{% endif
                                                    %}> High</option>
                                                <option value="Medium" {% if ticket.priority=='Medium' %}selected{%
                                                    endif %}> Medium</option>
                                                <option value="Low" {% if ticket.priority=='Low' %}selected{% endif %}>
                                                     Low</option>
                                            </select>
                                        </div>

                                        <!-- Technician -->
                                        {% if technicians and technicians|length > 0 %}
                                        <div class="relative inline-flex items-center">
                                            <select id="technicianSelect"
                                                class="pl-2 pr-6 py-1 text-xs rounded-md font-medium appearance-none cursor-pointer bg-slate-700/80 border border-slate-600 text-white hover:bg-slate-600/80 transition-all focus:outline-none"
                                                style="min-width: 150px; height: 28px;"
                                                data-ticket-id="{{ ticket.ticket_id }}">
                                                <option value="">Select Technician</option>
                                                {% for tech in technicians %}
                                                <option value="{{ tech._id }}" {% if (ticket.assigned_technician_id and
                                                    ticket.assigned_technician_id|string==tech._id|string) or
                                                    (ticket.technician_id and
                                                    ticket.technician_id|string==tech._id|string) %}selected{% endif %}>
                                                    {{ tech.name }} ({{ tech.role or 'Technician' }})
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        {% endif %}

                                        <!-- Status -->
                                        <div class="status-dropdown">
                                            <button id="statusDropdownBtn"
                                                class="status-dropdown-btn whitespace-nowrap flex-shrink-0 h-9 flex items-center justify-center">
                                                <span id="currentStatusDisplay">{{ ticket.status or 'Set Status'
                                                    }}</span>
                                                <i class="fas fa-chevron-down" style="margin-left:4px;"></i>
                                            </button>
                                            <div id="statusDropdownContent" class="status-dropdown-content">
                                                <div class="status-option" data-status="Open">Open</div>
                                                <div class="status-option" data-status="New">New</div>
                                                <div class="status-option" data-status="Form Sent">Form Sent</div>
                                                <div class="status-option" data-status="Awaiting Submission">Awaiting
                                                    Submission</div>
                                                <div class="status-option" data-status="Under Review">Under Review</div>
                                                <div class="status-option" data-status="Info Requested">Info Requested
                                                </div>
                                                <div class="status-option" data-status="Warranty Form Received">Warranty
                                                    Form Received</div>
                                                <div class="status-option" data-status="Referred to Tech Director">
                                                    Referred to Tech Director</div>
                                                <div class="status-option" data-status="Approved  Revisit Booked">
                                                    Approved  Revisit Booked</div>
                                                <div class="status-option" data-status="Declined  Not Covered">Declined
                                                     Not Covered</div>
                                                <div class="status-option" data-status="Revisit">Revisit</div>
                                                <div class="status-option" data-status="Closed">Closed</div>
                                            </div>
                                        </div>

                                        <!-- Email Template -->
                                        {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed',
                                        'declined', 'cancelled'] %}
                                        <button id="emailTemplateBtn"
                                            style="height:28px;padding:0 10px !important;display:flex;align-items:center;gap:4px;border-radius:6px !important;background:rgba(168,85,247,0.15) !important;border:1px solid rgba(168,85,247,0.3) !important;color:#c084fc !important;font-size:11px !important;font-weight:600 !important;cursor:pointer;"
                                            title="Send email using template">
                                            <i class="fas fa-envelope-open-text" style="font-size:10px !important;"></i>
                                            Email Template
                                        </button>
                                        {% endif %}

                                        <!-- Close -->
                                        {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed',
                                        'declined', 'cancelled'] %}
                                        <button id="closeResolvedBtn"
                                            style="height:28px;padding:0 10px !important;display:flex;align-items:center;gap:4px;border-radius:6px !important;background:rgba(239,68,68,0.15) !important;border:1px solid rgba(239,68,68,0.3) !important;color:#fca5a5 !important;font-size:11px !important;font-weight:600 !important;cursor:pointer;">
                                            <i class="fas fa-lock" style="font-size:10px !important;"></i> Close
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- ROW 2: Assignment / Forwarding Card -->
                                {% if not is_tech_director %}
                                {% if not ticket.assignment or ticket.assignment|length == 0 %}
                                <!-- No assignment yet - show Take Over button in badges row -->
                                {% elif ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member
                                and ticket.assigned_member|length > 0 %}
                                <div class="assignment-card">
                                    {% if ticket.assignment[0].is_forwarded %}
                                    <!-- FORWARDED -->
                                    <div class="assignment-card-top">
                                        <div class="assignment-icon forwarded">
                                            <i class="fas fa-share"></i>
                                        </div>
                                        <div class="assignment-info">
                                            <div class="assignment-title">
                                                Forwarded to
                                                <span class="person-name">
                                                    {% if ticket.forwarded_to_member and
                                                    ticket.forwarded_to_member|length > 0 %}
                                                    {{ ticket.forwarded_to_member[0].name }}
                                                    {% elif ticket.assigned_member and ticket.assigned_member|length > 0
                                                    %}
                                                    {{ ticket.assigned_member[0].name }}
                                                    {% else %}
                                                    Unknown
                                                    {% endif %}
                                                </span>
                                                {% if ticket.forwarded_to_member and ticket.forwarded_to_member|length >
                                                0 and
                                                ticket.forwarded_to_member[0]._id|string == session.member_id|string %}
                                                <span style="color:#60a5fa;opacity:0.7;font-weight:700;">(You)</span>
                                                {% elif ticket.assigned_member and ticket.assigned_member|length > 0 and
                                                ticket.assigned_member[0]._id|string == session.member_id|string %}
                                                <span style="color:#60a5fa;opacity:0.7;font-weight:700;">(You)</span>
                                                {% endif %}
                                            </div>
                                            {% if ticket.forwarded_from_member and ticket.forwarded_from_member|length >
                                            0 %}
                                            <div class="assignment-from">
                                                <i class="fas fa-reply"
                                                    style="font-size:9px !important;margin-right:3px;"></i>
                                                from {{ ticket.forwarded_from_member[0].name }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% if ticket.assignment[0].assigned_at %}
                                        <div class="assignment-timestamp">
                                            <i class="far fa-clock"></i>
                                            {{ ticket.assignment[0].assigned_at|format_datetime }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <!-- TAKEN OVER -->
                                    <div class="assignment-card-top taken-over">
                                        <div class="assignment-icon taken-over">
                                            <i class="fas fa-hand-paper"></i>
                                        </div>
                                        <div class="assignment-info">
                                            <div class="assignment-title">
                                                Taken over by
                                                <span class="person-name">{{ ticket.assigned_member[0].name }}</span>
                                                {% if ticket.assigned_member[0]._id|string == session.member_id|string
                                                %}
                                                <span style="color:#34d399;opacity:0.7;font-weight:700;">(You)</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if ticket.assignment[0].assigned_at %}
                                        <div class="assignment-timestamp">
                                            <i class="far fa-clock"></i>
                                            {{ ticket.assignment[0].assigned_at|format_datetime }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    <!-- NOTE (if present) -->
                                    {% if ticket.assignment[0].notes %}
                                    <div class="assignment-note">
                                        <div class="assignment-note-icon">
                                            <i class="fas fa-sticky-note"></i>
                                        </div>
                                        <div class="assignment-note-content">
                                            <div class="assignment-note-label">Note</div>
                                            <div class="assignment-note-text">{{ ticket.assignment[0].notes }}</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endif %}

                                <!-- Tech Director assignment view -->
                                {% if is_tech_director %}
                                {% if ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member and
                                ticket.assigned_member|length > 0 %}
                                <div class="assignment-card">
                                    {% if ticket.assignment[0].is_forwarded %}
                                    <div class="assignment-card-top">
                                        <div class="assignment-icon forwarded">
                                            <i class="fas fa-share"></i>
                                        </div>
                                        <div class="assignment-info">
                                            <div class="assignment-title">
                                                Forwarded to
                                                <span class="person-name">
                                                    {% if ticket.forwarded_to_member and
                                                    ticket.forwarded_to_member|length > 0 %}
                                                    {{ ticket.forwarded_to_member[0].name }}
                                                    {% elif ticket.assigned_member and ticket.assigned_member|length > 0
                                                    %}
                                                    {{ ticket.assigned_member[0].name }}
                                                    {% else %}
                                                    Unknown
                                                    {% endif %}
                                                </span>
                                            </div>
                                            {% if ticket.forwarded_from_member and ticket.forwarded_from_member|length >
                                            0 %}
                                            <div class="assignment-from">
                                                <i class="fas fa-reply"
                                                    style="font-size:9px !important;margin-right:3px;"></i>
                                                from {{ ticket.forwarded_from_member[0].name }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% if ticket.assignment[0].assigned_at %}
                                        <div class="assignment-timestamp">
                                            <i class="far fa-clock"></i>
                                            {{ ticket.assignment[0].assigned_at|format_datetime }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="assignment-card-top taken-over">
                                        <div class="assignment-icon taken-over">
                                            <i class="fas fa-hand-paper"></i>
                                        </div>
                                        <div class="assignment-info">
                                            <div class="assignment-title">
                                                Taken over by
                                                <span class="person-name">{{ ticket.assigned_member[0].name }}</span>
                                            </div>
                                        </div>
                                        {% if ticket.assignment[0].assigned_at %}
                                        <div class="assignment-timestamp">
                                            <i class="far fa-clock"></i>
                                            {{ ticket.assignment[0].assigned_at|format_datetime }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    {% if ticket.assignment[0].notes %}
                                    <div class="assignment-note">
                                        <div class="assignment-note-icon">
                                            <i class="fas fa-sticky-note"></i>
                                        </div>
                                        <div class="assignment-note-content">
                                            <div class="assignment-note-label">Note</div>
                                            <div class="assignment-note-text">{{ ticket.assignment[0].notes }}</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endif %}

                                <!-- ROW 3: Action Badges -->
                                <div class="header-badges-row">
                                    <!-- Take Over (only if not assigned and not tech director) -->
                                    {% if not is_tech_director %}
                                    {% if not ticket.assignment or ticket.assignment|length == 0 %}
                                    <button id="takeOverBtn" class="header-badge badge-takeover">
                                        <i class="fas fa-hand-paper"></i> Take Over
                                    </button>
                                    {% endif %}
                                    {% endif %}

                                    <!-- With Tech Director badge -->
                                    {% if not is_tech_director %}
                                    {% set can_refer_to_td = (ticket.status != 'Referred to Tech Director') and
                                    (ticket.status != 'Closed') and (ticket.status != 'Resolved') %}
                                    {% set was_forwarded_back = (ticket.assignment and ticket.assignment|length > 0 and
                                    ticket.assigned_member and ticket.assigned_member|length > 0 and
                                    ticket.assignment[0].get('is_forwarded', False) and
                                    ticket.assignment[0].get('forwarded_from_tech_director', False)) %}

                                    {% if can_refer_to_td %}
                                    {% if was_forwarded_back %}
                                    <button id="referToTechDirectorBtn" class="header-badge badge-refer"
                                        title="Re-refer this ticket to Technical Director (previously returned)">
                                        <i class="fas fa-redo"></i> Re-refer to Tech Director
                                    </button>
                                    {% else %}
                                    <button id="referToTechDirectorBtn" class="header-badge badge-refer"
                                        title="Refer this ticket to Technical Director for expert review">
                                        <i class="fas fa-user-cog"></i> Refer to Tech
                                    </button>
                                    {% endif %}
                                    {% else %}
                                    {% if ticket.status == 'Referred to Tech Director' %}
                                    <div class="header-badge badge-tech-director">
                                        <i class="fas fa-check-circle"></i> With Tech Director
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    {% endif %}


                                    <!-- Forward -->
                                    {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed',
                                    'declined', 'cancelled'] %}
                                    {% set is_forwarded = ticket.is_forwarded and ticket.forwarded_to %}
                                    {% if is_forwarded and ticket.forwarded_to_member and
                                    ticket.forwarded_to_member|length > 0 %}
                                    <div id="forwardStatusBadge" class="header-badge badge-forward">
                                        <i class="fas fa-share"></i> Forwarded to {{ ticket.forwarded_to_member[0].name
                                        }}
                                    </div>
                                    {% else %}
                                    <button id="forwardBtn" class="header-badge badge-forward-btn">
                                        <i class="fas fa-share"></i> {% if is_tech_director %}Forward to Support{% else
                                        %}Forward{% endif %}
                                    </button>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Ticket Details -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="detail-card">
                                <h3 class="text-sm font-medium text-gray-500">Customer</h3>
                                <p class="text-gray-800 font-medium break-words truncate">
                                    {% if customer_title or customer_first_name or customer_surname %}
                                    {% if customer_title %}{{ customer_title }} {% endif %}
                                    {% if customer_first_name %}{{ customer_first_name }} {% endif %}
                                    {% if customer_surname %}{{ customer_surname }}{% endif %}
                                    {% else %}
                                    {{ ticket.name }}
                                    {% endif %}
                                </p>
                                <p class="text-gray-600 text-sm break-words truncate">{{ ticket.email }}</p>
                                {% if ticket.phone %}
                                <p class="text-gray-600 text-sm mt-1 break-words truncate"><i
                                        class="fas fa-phone mr-1"></i> {{
                                    ticket.phone }}</p>
                                {% endif %}
                            </div>

                            <div class="detail-card">
                                <h3 class="text-sm font-medium text-gray-500">Created</h3>
                                <p class="text-gray-800">{{ formatted_date }}</p>
                            </div>

                            <div class="detail-card">
                                <h3 class="text-sm font-medium text-gray-500">Last Updated</h3>
                                <p class="text-gray-800">{{ ticket.updated_at|format_datetime }}</p>
                            </div>
                        </div>

                        <!-- Vehicle Information - Always visible -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-500">Vehicle & Claim Information</h3>
                                <button id="editVehicleInfoBtn"
                                    class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-indigo-50 transition-colors"
                                    title="Edit Vehicle & Claim Info">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                            </div>

                            {% if vehicle_registration or service_date or claim_date or type_of_claim %}
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 vehicle-info-grid">
                                {% if vehicle_registration %}
                                <div class="detail-card flex items-center">
                                    <div class="p-3 rounded-full bg-blue-100 mr-4">
                                        <i class="fas fa-car text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-gray-500">Registration</h4>
                                        <p class="text-gray-800 font-semibold break-words truncate">{{
                                            vehicle_registration }}</p>
                                    </div>
                                </div>
                                {% endif %}

                                {% if service_date %}
                                <div class="detail-card flex items-center">
                                    <div class="p-3 rounded-full bg-purple-100 mr-4">
                                        <i class="fas fa-calendar-check text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-gray-500">Service Date</h4>
                                        <p class="text-gray-800 font-semibold">{{ service_date }}</p>
                                    </div>
                                </div>
                                {% endif %}

                                {% if claim_date %}
                                <div class="detail-card flex items-center">
                                    <div class="p-3 rounded-full bg-green-100 mr-4">
                                        <i class="fas fa-file-invoice text-green-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-gray-500">Claim Date</h4>
                                        <p class="text-gray-800 font-semibold">{{ claim_date }}</p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Technician Field -->
                                {% if technician %}
                                <div class="detail-card flex items-center">
                                    <div class="p-3 rounded-full bg-indigo-100 mr-4">
                                        <i class="fas fa-user-cog text-indigo-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-gray-500">Technician</h4>
                                        <p class="text-gray-800 font-semibold">{{ technician }}</p>
                                        {% if technician_info %}
                                        <p class="text-gray-600 text-xs mt-1">
                                            <i class="fas fa-id-badge mr-1"></i> {{ technician_info.user_id }}
                                            {% if technician_info.role %}
                                            <span
                                                class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">{{
                                                technician_info.role }}</span>
                                            {% endif %}
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Type of Claim -->
                                {% if type_of_claim %}
                                <div class="detail-card flex items-center">
                                    <div class="p-3 rounded-full bg-orange-100 mr-4">
                                        <i class="fas fa-clipboard-list text-orange-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-gray-500">Type of Claim</h4>
                                        <p class="text-gray-800 font-semibold">{{ type_of_claim }}</p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Days Between Service and Claim -->
                                {% if days_between_service_claim %}
                                <div class="detail-card flex items-center">
                                    <div class="p-3 rounded-full bg-pink-100 mr-4">
                                        <i class="fas fa-clock text-pink-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-gray-500">Days Between Service & Claim
                                        </h4>
                                        <p class="text-gray-800 font-semibold">{{ days_between_service_claim }}
                                            day{% if
                                            days_between_service_claim != '1' %}s{% endif %}</p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- VHC Link -->
                                {% if vhc_link %}
                                <div class="detail-card flex items-center">
                                    <div class="p-3 rounded-full bg-cyan-100 mr-4">
                                        <i class="fas fa-link text-cyan-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-gray-500">VHC (Vehicle Health Check)
                                        </h4>
                                        <a href="{{ vhc_link }}" target="_blank"
                                            class="text-indigo-600 hover:text-indigo-800 flex items-center">
                                            <i class="fas fa-external-link-alt mr-1"></i> View Report
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <!-- Empty state when no vehicle data exists -->
                            <div class="detail-card p-4 text-center">
                                <div class="text-gray-400 mb-2">
                                    <i class="fas fa-car text-3xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm">No vehicle or claim information added yet.</p>
                                <p class="text-gray-400 text-xs mt-1">Click "Edit" to add details.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Checklist Information -->
                        {% if advisories_followed or within_warranty or new_fault_codes or dpf_light_on or
                        eml_light_on
                        %}
                        <div class="mb-3">
                            <h3 class="text-sm font-medium text-gray-500 mb-2">Claim Checklist</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 checklist-grid">
                                <div class="detail-card">
                                    <ul class="space-y-3">
                                        {% if advisories_followed == '1' %}
                                        <li class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            <span>Advisories Followed</span>
                                        </li>
                                        {% endif %}

                                        {% if within_warranty == '1' %}
                                        <li class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            <span>Within Warranty Period</span>
                                        </li>
                                        {% endif %}

                                        {% if new_fault_codes == '1' %}
                                        <li class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            <span>Provided New Fault Codes</span>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <div class="detail-card">
                                    <ul class="space-y-3">
                                        {% if dpf_light_on == '1' %}
                                        <li class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            <span>DPF Light On</span>
                                        </li>
                                        {% endif %}

                                        {% if eml_light_on == '1' %}
                                        <li class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            <span>EML Light On</span>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Original Ticket Attachments Section -->
                        {% if ticket.attachments and ticket.attachments|length > 0 %}
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-500 flex items-center">
                                    <i class="fas fa-paperclip mr-2 text-purple-500"></i>Original Ticket Attachments
                                </h3>
                                <span class="text-xs text-gray-400">({{ ticket.attachments|length }})</span>
                            </div>
                            <div class="space-y-2">
                                {% for attachment in ticket.attachments %}
                                {% set att_name = attachment.filename or attachment.fileName or attachment.name or
                                'attachment' %}
                                <div
                                    class="detail-card p-3 flex items-center justify-between hover:bg-opacity-80 transition">
                                    <div class="flex items-center flex-1 min-w-0">
                                        {% if att_name.endswith('.pdf') %}
                                        <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                                        {% elif att_name.endswith(('.jpg', '.jpeg', '.png', '.gif')) %}
                                        <i class="fas fa-file-image text-blue-500 mr-2"></i>
                                        {% elif att_name.endswith(('.doc', '.docx')) %}
                                        <i class="fas fa-file-word text-blue-600 mr-2"></i>
                                        {% else %}
                                        <i class="fas fa-file text-gray-500 mr-2"></i>
                                        {% endif %}
                                        <span class="text-sm text-gray-300 truncate mr-2" title="{{ att_name }}">
                                            {{ att_name }}
                                        </span>
                                        {% if attachment.size %}
                                        <span class="text-xs text-gray-500">
                                            ({{ (attachment.size / 1024) | round(1) }} KB)
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex gap-1 ml-2 flex-shrink-0">
                                        {% set can_preview = att_name.endswith(('.jpg', '.jpeg', '.png',
                                        '.gif', '.pdf', '.txt', '.md')) %}
                                        {% if can_preview %}
                                        <button
                                            onclick="previewTicketAttachment('{{ ticket.ticket_id|e }}', {{ loop.index0 }}, '{{ att_name|e }}')"
                                            class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-1.5 py-1 rounded text-[10px] transition flex items-center justify-center"
                                            title="Preview {{ att_name }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% endif %}
                                        <button data-action="download" data-ticket-id="{{ ticket.ticket_id|e }}"
                                            data-index="{{ loop.index0 }}" data-filename="{{ att_name|e }}"
                                            class="bg-green-100 hover:bg-green-200 text-green-600 px-1.5 py-1 rounded text-[10px] transition att-download-btn"
                                            title="Download {{ att_name }}">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Claim Documents Section -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-500 flex items-center">
                                    <i class="fas fa-file-alt mr-2 text-indigo-500"></i>Claim Documents
                                </h3>
                                <span id="ticketClaimDocsCount" class="text-xs text-gray-400"></span>
                            </div>
                            <div id="ticketClaimDocsList" class="space-y-2">
                                <p class="text-gray-400 text-sm text-center py-4">Loading documents...</p>
                            </div>
                        </div>

                        <!-- Enhanced Outcome Section -->
                        <div class="mb-4 bg-white border border-gray-200 rounded-lg p-4 shadow-sm outcome-section">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-3">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-clipboard-check mr-3 text-purple-600"></i> Outcome Assessment
                                </h3>
                                <button id="editOutcomeBtn"
                                    class="px-4 py-2 text-sm bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 transition">
                                    <i class="fas fa-edit mr-2"></i> Edit Outcome
                                </button>
                            </div>

                            <!-- Outcome Display View -->
                            <div id="outcomeDisplayView">
                                <!-- Category Badge Row -->
                                <div class="flex flex-wrap items-center gap-3 mb-4">
                                    {% if outcome_category %}
                                    <div class="flex items-center gap-2">
                                        <div class="p-1.5 rounded-lg bg-purple-500/20">
                                            <i class="fas fa-tags text-purple-400 text-xs"></i>
                                        </div>
                                        <span
                                            class="text-xs font-medium text-gray-400 uppercase tracking-wider">Outcome</span>
                                    </div>
                                    <span class="px-3 py-1 text-xs rounded-full font-semibold
                                        {% if outcome_category == 'Technician Issue' %}bg-red-500/20 text-red-300 border border-red-500/30
                                        {% elif outcome_category == 'New Fault' %}bg-orange-500/20 text-orange-300 border border-orange-500/30
                                        {% elif outcome_category == 'Advisories Not Followed' %}bg-yellow-500/20 text-yellow-300 border border-yellow-500/30
                                        {% elif outcome_category == 'Driving Style' %}bg-blue-500/20 text-blue-300 border border-blue-500/30
                                        {% elif outcome_category == 'Customer Issue' %}bg-pink-500/20 text-pink-300 border border-pink-500/30
                                        {% elif outcome_category == 'Revisit' %}bg-purple-500/20 text-purple-300 border border-purple-500/30
                                        {% else %}bg-gray-500/20 text-gray-300 border border-gray-500/30{% endif %}">
                                        {{ outcome_category }}
                                    </span>
                                    {% else %}
                                    <div class="flex items-center gap-2">
                                        <div class="p-1.5 rounded-lg bg-gray-500/20">
                                            <i class="fas fa-tags text-gray-500 text-xs"></i>
                                        </div>
                                        <span class="text-xs text-gray-500">No outcome set</span>
                                    </div>
                                    {% endif %}

                                    {% if revisit_carried_out == '1' or clean_under_warranty == '1' %}
                                    <span class="text-gray-600 mx-1">|</span>
                                    {% if revisit_carried_out == '1' %}
                                    <span
                                        class="inline-flex items-center gap-1 px-2 py-0.5 text-xs rounded-full bg-green-500/15 text-green-400 border border-green-500/20">
                                        <i class="fas fa-check-circle text-[10px]"></i> Revisit Done
                                    </span>
                                    {% endif %}
                                    {% if clean_under_warranty == '1' %}
                                    <span
                                        class="inline-flex items-center gap-1 px-2 py-0.5 text-xs rounded-full bg-green-500/15 text-green-400 border border-green-500/20">
                                        <i class="fas fa-check-circle text-[10px]"></i> Warranty Clean
                                    </span>
                                    {% endif %}
                                    {% endif %}
                                </div>

                                {% if outcome_category == 'Revisit' %}
                                <!-- Revisit Details Panel -->
                                <div
                                    class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 rounded-xl bg-gradient-to-r from-purple-900/25 to-purple-800/15 border border-purple-500/20 mb-4">
                                    <div class="flex flex-col">
                                        <span
                                            class="text-[10px] font-semibold text-purple-400/80 uppercase tracking-widest mb-1.5">
                                            <i class="fas fa-calendar-alt mr-1"></i>Date of Revisit
                                        </span>
                                        <span class="text-sm font-medium text-white/90">{{ ticket.revisit_date or 'Not
                                            Set' }}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span
                                            class="text-[10px] font-semibold text-purple-400/80 uppercase tracking-widest mb-1.5">
                                            <i class="fas fa-user-wrench mr-1"></i>Assigned Technician
                                        </span>
                                        <span class="text-sm font-medium text-white/90">
                                            {% set ns = namespace(found=false) %}
                                            {% for tech in technicians %}
                                            {% if ticket.revisit_technician_id|string == tech._id|string %}
                                            {{ tech.name }}
                                            {% set ns.found = true %}
                                            {% endif %}
                                            {% endfor %}
                                            {% if not ns.found %}Not Assigned{% endif %}
                                        </span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span
                                            class="text-[10px] font-semibold text-purple-400/80 uppercase tracking-widest mb-1.5">
                                            <i class="fas fa-comment-dots mr-1"></i>Reason for Revisit
                                        </span>
                                        <p class="text-sm text-gray-300/90 whitespace-pre-wrap leading-relaxed">{{
                                            ticket.revisit_reason or 'No reason provided.' }}</p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Outcome Notes -->
                                {% if outcome_notes %}
                                <div class="p-3 rounded-lg bg-gray-800/40 border border-gray-700/30">
                                    <h4
                                        class="text-[10px] font-semibold text-gray-400 uppercase tracking-widest mb-2 flex items-center">
                                        <i class="fas fa-sticky-note mr-1.5 text-purple-400/70"></i> Outcome Notes
                                    </h4>
                                    <p class="text-xs text-gray-300 whitespace-pre-wrap leading-relaxed">{{
                                        outcome_notes }}</p>
                                </div>
                                {% else %}
                                <div class="p-3 rounded-lg bg-gray-800/40 border border-gray-700/30">
                                    <h4
                                        class="text-[10px] font-semibold text-gray-400 uppercase tracking-widest mb-2 flex items-center">
                                        <i class="fas fa-sticky-note mr-1.5 text-purple-400/70"></i> Outcome Notes
                                    </h4>
                                    <span class="text-xs text-gray-500 italic">No notes added</span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Outcome Edit Form (Initially Hidden) - SIBLING of outcomeDisplayView -->
                            <div id="outcomeEditView"
                                class="hidden bg-gray-50 rounded-lg p-4 border-2 border-purple-200 mt-2">
                                <div class="mb-3">
                                    <h4 class="text-base font-semibold text-gray-800 flex items-center">
                                        <i class="fas fa-edit mr-2 text-purple-600"></i> Edit Outcome Assessment
                                    </h4>
                                </div>

                                <form id="outcomeForm" class="space-y-4">
                                    <!-- Grid Layout for Form Fields -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Outcome Dropdown -->
                                        <div class="md:col-span-2">
                                            <label class="block text-xs font-medium text-gray-700 mb-1">
                                                <i class="fas fa-tags mr-1"></i> Outcome Category
                                            </label>
                                            <select id="outcomeCategory"
                                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                <option value="">Select outcome</option>
                                                <option value="Technician Issue" {% if
                                                    outcome_category=='Technician Issue' %}selected{% endif %}>
                                                    Technician Issue</option>
                                                <option value="New Fault" {% if outcome_category=='New Fault'
                                                    %}selected{% endif %}>New Fault</option>
                                                <option value="Advisories Not Followed" {% if
                                                    outcome_category=='Advisories Not Followed' %}selected{% endif %}>
                                                    Advisories Not Followed</option>
                                                <option value="Driving Style" {% if outcome_category=='Driving Style'
                                                    %}selected{% endif %}>Driving Style</option>
                                                <option value="Customer Issue" {% if outcome_category=='Customer Issue'
                                                    %}selected{% endif %}>Customer Issue</option>
                                                <option value="Other" {% if outcome_category=='Other' %}selected{% endif
                                                    %}>Other</option>
                                                <option value="Revisit" {% if outcome_category=='Revisit' %}selected{%
                                                    endif %}>Revisit</option>
                                            </select>
                                        </div>

                                        <!-- Revisit Specific Fields -->
                                        <div id="revisitFields"
                                            class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 {% if outcome_category != 'Revisit' %}hidden{% endif %} bg-purple-50 p-4 rounded-lg border border-purple-100">
                                            <div class="md:col-span-1">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-calendar mr-1"></i> Date of Revisit
                                                </label>
                                                <input type="date" id="revisitDate"
                                                    value="{{ ticket.revisit_date or '' }}"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                            </div>
                                            <div class="md:col-span-1">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-user-wrench mr-1"></i> Assigned Technician
                                                </label>
                                                <select id="revisitTechnician"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                    <option value="">Select Technician</option>
                                                    {% for tech in technicians %}
                                                    <option value="{{ tech._id }}" {% if
                                                        ticket.revisit_technician_id|string==tech._id|string
                                                        %}selected{% endif %}>{{ tech.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="md:col-span-2">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-comment-dots mr-1"></i> Reason for Revisit
                                                </label>
                                                <textarea id="revisitReason" rows="2"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white"
                                                    placeholder="Provide the reason for the revisit...">{{ ticket.revisit_reason or '' }}</textarea>
                                            </div>
                                        </div>

                                        <!-- Checkboxes -->
                                        <div class="md:col-span-2">
                                            <label class="block text-xs font-medium text-gray-700 mb-2">
                                                <i class="fas fa-check-square mr-1"></i> Actions Completed
                                            </label>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                <label
                                                    class="flex items-center bg-white p-2 rounded-lg border border-gray-200 hover:border-purple-300 transition cursor-pointer">
                                                    <input type="checkbox" id="revisitCarriedOut"
                                                        class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                        {% if revisit_carried_out=='1' %}checked{% endif %}>
                                                    <span class="ml-2 text-xs text-gray-700">Revisit Carried Out</span>
                                                </label>
                                                <label
                                                    class="flex items-center bg-white p-2 rounded-lg border border-gray-200 hover:border-purple-300 transition cursor-pointer">
                                                    <input type="checkbox" id="cleanUnderWarranty"
                                                        class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                        {% if clean_under_warranty=='1' %}checked{% endif %}>
                                                    <span class="ml-2 text-xs text-gray-700">Clean Carried Out Under
                                                        Warranty</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Outcome Notes - Full Width -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-sticky-note mr-1"></i> Outcome Notes
                                        </label>
                                        <textarea id="outcomeNotes"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white"
                                            rows="5"
                                            placeholder="Add detailed outcome information, explanations, or next steps...">{{ outcome_notes or '' }}</textarea>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div
                                        class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200">
                                        <button type="button" id="cancelOutcomeBtn"
                                            class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium">
                                            <i class="fas fa-times mr-2"></i>Cancel
                                        </button>
                                        <button type="submit" id="saveOutcomeBtn"
                                            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                                            <i class="fas fa-save mr-2"></i>Save Outcome
                                        </button>
                                    </div>
                                </form>
                            </div>

                            {# Display Email Attachments (New System) - With Duplicate Removal #}
                            {% if ticket.simple_attachments and ticket.simple_attachments|length > 0 %}

                            {% set unique_attachments = [] %}
                            {% set processed_base_names = [] %}
                            {% for attachment in ticket.simple_attachments %}
                            {% set base_filename = attachment.fileName %}
                            {% if base_filename.startswith('20') and base_filename[8] == '_' and base_filename[15]
                            ==
                            '_' %}
                            {% set base_filename = base_filename[16:] %}
                            {% endif %}
                            {% if base_filename not in processed_base_names %}
                            {% set _ = processed_base_names.append(base_filename) %}
                            {% set _ = unique_attachments.append(attachment) %}
                            {% endif %}
                            {% endfor %}

                            <div class="mb-3">
                                <h3 class="text-sm font-medium text-gray-500 mb-2">Attachments ({{
                                    unique_attachments|length
                                    }})</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 attachments-container">
                                    {% for attachment in unique_attachments %}
                                    <div class="detail-card flex items-start">
                                        <div class="p-3 rounded-full mr-4 
                                {% if attachment.is_warranty %}bg-green-100{% else %}bg-blue-100{% endif %}">
                                            {% if attachment.fileName.lower().endswith('.pdf') %}
                                            <i
                                                class="fas fa-file-pdf {% if attachment.is_warranty %}text-green-600{% else %}text-red-600{% endif %}"></i>
                                            {% elif attachment.fileName.lower().endswith(('.jpg', '.jpeg', '.png',
                                            '.gif'))
                                            %}
                                            <i
                                                class="fas fa-file-image {% if attachment.is_warranty %}text-green-600{% else %}text-purple-600{% endif %}"></i>
                                            {% elif attachment.fileName.lower().endswith(('.doc', '.docx')) %}
                                            <i
                                                class="fas fa-file-word {% if attachment.is_warranty %}text-green-600{% else %}text-blue-600{% endif %}"></i>
                                            {% elif attachment.fileName.lower().endswith(('.xls', '.xlsx')) %}
                                            <i
                                                class="fas fa-file-excel {% if attachment.is_warranty %}text-green-600{% else %}text-green-500{% endif %}"></i>
                                            {% else %}
                                            <i
                                                class="fas fa-file {% if attachment.is_warranty %}text-green-600{% else %}text-gray-600{% endif %}"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="text-xs font-medium text-gray-500">
                                                    {{ attachment.fileName | truncate(40) }}
                                                </h4>
                                                {% if attachment.is_warranty %}
                                                <span
                                                    class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">
                                                    <i class="fas fa-shield-alt mr-1"></i>Warranty
                                                </span>
                                                {% endif %}
                                            </div>
                                            <div class="flex items-center gap-4">
                                                <button
                                                    onclick="downloadEmailAttachment('{{ ticket.ticket_id }}', '{{ loop.index0 }}', '{{ attachment.fileName }}')"
                                                    class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm transition">
                                                    <i class="fas fa-download mr-1"></i> Download
                                                </button>
                                                {% if attachment.fileName.lower().endswith(('.jpg', '.jpeg', '.png',
                                                '.gif',
                                                '.pdf')) %}
                                                <button
                                                    onclick="previewEmailAttachment('{{ ticket.ticket_id }}', '{{ loop.index0 }}', '{{ attachment.fileName }}')"
                                                    class="text-gray-600 hover:text-gray-800 flex items-center text-sm transition">
                                                    <i class="fas fa-eye mr-1"></i> Preview
                                                </button>
                                                {% endif %}
                                            </div>
                                            {% if attachment.size %}
                                            <p class="text-xs text-gray-400 mt-1">{{ attachment.size_formatted or
                                                (attachment.size | filesizeformat) }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}




                            <!-- Original Message -->
                            <div class="mb-6">
                                <h3 class="text-sm font-medium text-indigo-400 mb-2 professional-header">Original
                                    Message
                                </h3>
                                <div class="original-message-container" id="originalMessageContainer">
                                    <div class="original-message-content {% if (ticket.body or '')|length > 1500 %}truncated{% endif %}"
                                        id="originalMessage">
                                        {{ ticket.body or '' }}
                                    </div>
                                    {% if (ticket.body or '')|length > 1500 %}
                                    <button class="read-more-btn" onclick="expandMessage('originalMessage')"
                                        id="originalMessageReadMore">
                                        <i class="fas fa-chevron-down mr-1"></i> Read More
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                        </div>

                        <!-- Conversation Section -->
                        <div class="px-6 py-4 border-t">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-comments mr-2 text-indigo-600"></i> Conversation
                            </h2>

                            {% if not replies %}
                            <div class="text-center text-gray-500 py-8 bg-gray-50 rounded-lg">
                                <i class="fas fa-comment-slash text-3xl mb-2 text-gray-400"></i>
                                <p>No replies yet. Be the first to respond!</p>
                            </div>
                            {% endif %}

                            <div class="conversation-container" id="repliesContainer">
                                {% for reply in replies %}
                                {# robustly detect internal users #}
                                {% set is_internal = (reply.role in ['Admin', 'Support', 'Technical Director',
                                'Technician']
                                or reply.sender_type == 'agent' or reply.is_internal) %}
                                <div
                                    class="message {% if not is_internal %}customer-message{% else %}support-message{% endif %}">
                                    <div class="message-header">
                                        <span class="font-medium flex items-center">
                                            {% if not is_internal %}
                                            <i class="fas fa-user-circle customer-icon"></i> {{ reply.sender_name or
                                            ticket.name or 'Customer' }}
                                            {% else %}
                                            <i class="fas fa-headset support-icon"></i> {{ reply.sender_name or
                                            'Support
                                            Team' }}
                                            {% endif %}
                                        </span>
                                        <span class="message-time">
                                            <i class="fas fa-clock mr-1"></i>{{ reply.created_at | format_datetime
                                            }}
                                        </span>
                                    </div>
                                    <div class="reply-message-box" id="message-container-{{ loop.index }}">
                                        <!-- Message Content with Line Clamp -->
                                        <div class="message-content line-clamp-3 overflow-hidden text-gray-200 transition-all duration-300"
                                            id="message-content-{{ loop.index }}"
                                            style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.6;">
                                            {{ reply.message }}
                                        </div>

                                        <!-- Read More / Show Less Button (Conditional via JS) -->
                                        <button onclick="toggleMessage('{{ loop.index }}')"
                                            id="toggle-btn-{{ loop.index }}"
                                            class="text-blue-400 hover:text-blue-300 text-xs mt-2 font-medium flex items-center focus:outline-none hidden">
                                            <i class="fas fa-chevron-down mr-1"></i> Read More
                                        </button>

                                        <!-- Inline Script to check height and show button if needed -->
                                        <script>
                                            (function () {
                                                const content = document.getElementById('message-content-{{ loop.index }}');
                                                const btn = document.getElementById('toggle-btn-{{ loop.index }}');
                                                if (content && btn) {
                                                    // Reliable clamp detection: temporarily remove clamp, measure, restore
                                                    setTimeout(() => {
                                                        const clampedHeight = content.clientHeight;
                                                        // Temporarily remove line-clamp to measure natural height
                                                        content.style.webkitLineClamp = 'unset';
                                                        content.style.display = 'block';
                                                        const fullHeight = content.scrollHeight;
                                                        // Restore clamp
                                                        content.style.webkitLineClamp = '3';
                                                        content.style.display = '-webkit-box';
                                                        if (fullHeight > clampedHeight + 5) {
                                                            btn.classList.remove('hidden');
                                                        }
                                                    }, 100);
                                                }
                                            })();
                                        </script>
                                    </div>

                                    {% set downloadable_attachments = [] %}
                                    {% for attachment in reply.attachments %}
                                    {% if attachment.type == 'file' or attachment.source == 'webhook_base64' or
                                    attachment.source == 'webhook' or not attachment.type %}
                                    {% set _ = downloadable_attachments.append(attachment) %}
                                    {% endif %}
                                    {% endfor %}



                                    {% if downloadable_attachments and downloadable_attachments|length > 0 %}
                                    <div class="mt-2 border-t border-gray-100 pt-2">
                                        <div class="text-xs text-gray-500 mb-1 flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-paperclip mr-1"></i>
                                                Attachments ({{ downloadable_attachments|length }}):
                                            </div>
                                            <!-- Regenerate button for webhook attachments -->
                                            {% if reply.source == 'webhook' or reply.source == 'n8n' %}
                                            <button onclick="regenerateWebhookAttachments()"
                                                class="text-xs bg-orange-100 hover:bg-orange-200 text-orange-600 px-2 py-1 rounded transition"
                                                title="Regenerate webhook attachments if they're not working">
                                                <i class="fas fa-sync-alt mr-1"></i>Regenerate
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            {% for attachment in downloadable_attachments %}
                                            {% if attachment.type == 'file' or attachment.source in
                                            ['webhook_base64',
                                            'webhook'] or not attachment.type %}
                                            <div
                                                class="bg-gray-50 border border-gray-200 rounded-lg p-2 flex items-center justify-between text-xs max-w-xs">
                                                <div class="flex items-center min-w-0 flex-1">
                                                    {% set filename = attachment.filename or attachment.name or
                                                    attachment.original_name or 'Unknown File' %}
                                                    {% if filename.endswith('.pdf') %}
                                                    <i class="fas fa-file-pdf text-red-500 mr-2 flex-shrink-0"></i>
                                                    {% elif filename.endswith('.doc') or filename.endswith('.docx')
                                                    %}
                                                    <i class="fas fa-file-word text-blue-500 mr-2 flex-shrink-0"></i>
                                                    {% elif filename.endswith('.xls') or filename.endswith('.xlsx')
                                                    %}
                                                    <i class="fas fa-file-excel text-green-500 mr-2 flex-shrink-0"></i>
                                                    {% elif filename.endswith('.jpg') or filename.endswith('.jpeg')
                                                    or
                                                    filename.endswith('.png') or filename.endswith('.gif') %}
                                                    <i class="fas fa-file-image text-purple-500 mr-2 flex-shrink-0"></i>
                                                    {% else %}
                                                    <i class="fas fa-file text-gray-500 mr-2 flex-shrink-0"></i>
                                                    {% endif %}
                                                    <div class="min-w-0 flex-1">
                                                        <div class="font-medium truncate max-w-[120px]"
                                                            title="{{ filename }}">{{
                                                            filename }}</div>
                                                        {% if attachment.size and attachment.size > 0 %}
                                                        <div class="text-gray-400 text-[10px]">({{ (attachment.size
                                                            /
                                                            1024)
                                                            | round(1) }} KB)</div>
                                                        {% endif %}

                                                    </div>
                                                </div>
                                                <div class="flex gap-1 ml-2">
                                                    {% set source = attachment.source|default('reply') %}
                                                    {% set can_preview = filename.endswith('.jpg') or
                                                    filename.endswith('.jpeg') or filename.endswith('.png') or
                                                    filename.endswith('.gif') or filename.endswith('.pdf') or
                                                    filename.endswith('.txt') or filename.endswith('.md') %}
                                                    {% set can_download = attachment.type == 'file' or
                                                    attachment.source
                                                    ==
                                                    'webhook_base64' or attachment.source == 'webhook' %}
                                                    {% if can_preview %}
                                                    <button
                                                        onclick="previewAttachment('{{ reply._id|e }}', '{{ loop.index0 }}', '{{ filename|e }}', '{{ source|e }}')"
                                                        class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-1.5 py-1 rounded text-[10px] transition"
                                                        title="Preview {{ filename }}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button
                                                        onclick="downloadAttachment('{{ reply._id|e }}', '{{ loop.index0 }}', '{{ filename|e }}', '{{ source|e }}')"
                                                        class="bg-green-100 hover:bg-green-200 text-green-600 px-1.5 py-1 rounded text-[10px] transition"
                                                        title="Download {{ filename }}">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            {% elif attachment.type == 'common-document' %}
                                            <button onclick="viewCommonDocument('{{ attachment.ref }}')"
                                                class="bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded flex items-center text-xs transition">
                                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>
                                                <span>{{ attachment.name|default('Common Document') }}</span>
                                            </button>
                                            {% elif attachment.type == 'text_reference' %}
                                            <div class="bg-green-50 px-2 py-1 rounded flex items-center text-xs cursor-pointer hover:bg-green-100 transition-colors"
                                                onclick="handleTextReferenceAttachment('{{ attachment.name|e }}', '{{ attachment.description|e }}')"
                                                title="Click to view text reference details">
                                                <i class="fas fa-paperclip text-green-500 mr-1"></i>
                                                <span class="font-medium">{{ attachment.name }}</span>
                                                {% if attachment.description %}
                                                <span class="text-gray-500 ml-1">- {{ attachment.description
                                                    }}</span>
                                                {% endif %}
                                                <span class="text-blue-500 ml-2 text-[10px]">(Text Reference - Click
                                                    to
                                                    view)</span>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>

                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Reply Form (only for open tickets) -->
                            {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed', 'declined',
                            'cancelled'] %}
                            <form id="replyForm" class="mt-8 reply-form">
                                <div class="mb-4 relative">
                                    <!-- @-Mention Autocomplete Menu (Hidden by default) -->
                                    <div id="mentionMenu"
                                        class="absolute z-50 bg-gray-800 border border-gray-700 shadow-lg rounded-md hidden max-w-xs overflow-hidden"
                                        style="bottom: 100%; left: 1rem; margin-bottom: 0.5rem;">
                                        <ul class="text-sm text-gray-200">
                                            <li class="px-4 py-2 hover:bg-indigo-600 cursor-pointer mention-item flex items-center gap-2"
                                                data-value="@VHC_Link" data-id="VHC_LINK">
                                                <i class="fas fa-link text-indigo-400"></i>
                                                <span>Insert VHC Link</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex-grow relative">
                                            <!-- Enhanced Modern chat-style input area with drag & drop -->
                                            <div id="replyDropzone"
                                                class="bg-white/5 border border-white/10 rounded-lg shadow-sm overflow-hidden transition-all duration-200"
                                                data-dropzone="true">
                                                <!-- Text input area -->
                                                <!-- Hidden textarea for form submission -->
                                                <textarea id="response" name="response" rows="3"
                                                    class="hidden">{{ ticket.draft_body }}</textarea>

                                                <!-- Contenteditable div for rich UI interactions (like @-mentions) -->
                                                <div id="response_editor"
                                                    class="w-full px-4 py-3 outline-none border-0 bg-transparent text-white"
                                                    contenteditable="true"
                                                    data-placeholder="Type your response here... Type @ to insert a link (e.g., VHC Link). Drag & drop files or documents here!"
                                                    style="min-height: 60px; max-height: 300px; overflow-y: auto; cursor: text; position: relative;">
                                                    {{ ticket.draft_body }}</div>

                                                <!-- Hidden file input -->
                                                <input id="response_attachments" name="response_attachments" type="file"
                                                    multiple class="hidden"
                                                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls,.txt,.csv,.zip"
                                                    title="Select files to attach to your reply (Max 10MB per file)">

                                                <!-- Enhanced Preview area for ALL attachments (files + common documents) -->
                                                <div id="enhancedAttachmentPreview"
                                                    class="px-4 py-2 border-t border-white/5 hidden">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="text-xs text-gray-400"> Attachments:</div>
                                                        <button type="button" id="clearAllAttachments"
                                                            class="text-xs text-red-400 hover:text-red-300 hover:bg-red-500/10 px-2 py-1 rounded transition">
                                                            Clear All
                                                        </button>
                                                    </div>
                                                    <div id="attachmentPreviewList" class="space-y-2"></div>
                                                </div>

                                                <!-- Bottom toolbar -->
                                                <div
                                                    class="flex items-center justify-between px-4 py-2 border-t border-white/10">
                                                    <div class="flex items-center space-x-2">
                                                        <!-- Attachment button -->
                                                        <button type="button" id="attachmentBtn"
                                                            class="text-gray-400 hover:text-green-400 focus:outline-none p-1 rounded-full hover:bg-white/5 transition"
                                                            title="Attach files">
                                                            <i class="fas fa-paperclip text-lg"></i>
                                                            <span
                                                                class="attachment-count hidden absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
                                                        </button>

                                                        <!-- Quick response button removed as requested -->

                                                        <!-- Send button -->
                                                        <button type="submit" id="sendBtn"
                                                            class="inline-flex items-center justify-center p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </form>
                            {% else %}
                            <!-- Ticket is closed - show message instead of reply form -->
                            <div class="mt-8 p-6 bg-gray-50 border border-gray-200 rounded-lg text-center">
                                <div class="flex items-center justify-center mb-3">
                                    <i class="fas fa-lock text-gray-500 text-2xl mr-3"></i>
                                    <h3 class="text-lg font-semibold text-gray-700">Ticket Closed</h3>
                                </div>
                                <p class="text-gray-600">This ticket has been {{ ticket.status.lower() }} and is no
                                    longer
                                    accepting new replies.</p>
                                {% if ticket.closed_by and ticket.closed_at %}
                                <p class="text-sm text-gray-500 mt-2">Closed by {{ ticket.closed_by }} on {{
                                    ticket.closed_at|format_datetime }}</p>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- File Attachments Section (Hidden) - this is the dropzone for drag and drop -->
                            <div id="attachmentSection" class="hidden">
                                <div id="attachmentDropzone"
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-400 transition">
                                    <div class="space-y-1 text-center">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                            viewBox="0 0 48 48" aria-hidden="true">
                                            <path
                                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <div class="text-sm text-gray-600">
                                            <label for="response_attachments"
                                                class="relative cursor-pointer rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none">
                                                <span>Upload files</span>
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500">PDF, Word, Excel, Images up to 10MB each
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template data -->
                <script type="application/json" id="attachments-data">
        {{ (attachments|default([]))|tojson|safe }}
    </script>

                <script type="application/json" id="vehicle-data">
        {
            "vehicle_registration": {{ vehicle_registration|default('')|tojson }},
            "service_date": {{ service_date|default('')|tojson }},
            "claim_date": {{ claim_date|default('')|tojson }},
            "type_of_claim": {{ type_of_claim|default('')|tojson }},
            "vhc_link": {{ vhc_link|default('')|tojson }},
            "days_between_service_claim": {{ days_between_service_claim|default('')|tojson }},
            "advisories_followed": {{ 'true' if advisories_followed else 'false' }},
            "within_warranty": {{ 'true' if within_warranty else 'false' }},
            "new_fault_codes": {{ 'true' if new_fault_codes else 'false' }},
            "dpf_light_on": {{ 'true' if dpf_light_on else 'false' }},
            "eml_light_on": {{ 'true' if eml_light_on else 'false' }}
        }
    </script>
                <script>

                    let processedDocuments = new Set(); // Track all processed documents in this session
                    let lastProcessedDocument = null;
                    let lastProcessedTime = 0;

                    //  REMOVED: Old attachment variables - replaced by enhanced system

                    // Notification system
                    function showNotification(message, type = 'success') {
                        const notification = document.getElementById('notification');
                        const notificationMessage = document.getElementById('notification-message');

                        notification.className = `notification ${type}`;
                        notificationMessage.textContent = message;
                        notification.classList.add('show');

                        setTimeout(() => {
                            notification.classList.remove('show');
                        }, 3000);
                    }

                    // Message expansion functionality
                    function expandMessage(elementId) {
                        const element = document.getElementById(elementId);
                        if (!element) return;

                        const isExpanded = element.classList.contains('expanded');

                        // Toggle expanded class
                        element.classList.toggle('expanded');

                        // Toggle truncated class for proper gradient effect
                        // When expanding (was not expanded before), remove truncated
                        // When collapsing (was expanded before), add truncated back
                        if (!isExpanded) {
                            // Expanding: remove truncated class to hide the gradient
                            element.classList.remove('truncated');
                        } else {
                            // Collapsing: add truncated class back for the gradient
                            element.classList.add('truncated');
                        }


                        // Find the button - it might be a child or a sibling
                        let btn = element.querySelector('.expand-btn') || element.querySelector('.read-more-btn');

                        // If not found inside, look for sibling button (for original message)
                        if (!btn && element.nextElementSibling && element.nextElementSibling.classList.contains('read-more-btn')) {
                            btn = element.nextElementSibling;
                        }

                        // Also try the container's button (for original message container structure)
                        if (!btn) {
                            const container = element.closest('.original-message-container') || element.closest('.reply-message-box');
                            if (container) {
                                btn = container.querySelector('.read-more-btn') || container.querySelector('.expand-btn');
                            }
                        }

                        if (btn) {
                            if (element.classList.contains('expanded')) {
                                btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Show Less';
                            } else {
                                btn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Read More';
                            }
                        }

                        // Smooth scroll to view the content if expanding
                        if (element.classList.contains('expanded')) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }


                    // Modal control functions - SAFE VERSION: No interference with other buttons
                    function openModal(modalId) {
                        // Close any other open modals first
                        closeAllModals();
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.add('active');
                        }
                    }

                    function closeModal(modalId) {
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.remove('active');

                            // Clean up draft indicator when closing email template modal
                            if (modalId === 'emailTemplateModal') {
                                const draftIndicator = document.getElementById('draftIndicator');
                                if (draftIndicator) {
                                    draftIndicator.remove();
                                }
                            }
                        }
                    }

                    // Close all modals - prevents stuck overlays
                    function closeAllModals() {
                        const activeModals = document.querySelectorAll('.modal-overlay.active');
                        activeModals.forEach(modal => {
                            modal.classList.remove('active');
                        });
                    }

                    // Add escape key to close modals
                    document.addEventListener('keydown', function (event) {
                        if (event.key === 'Escape') {
                            closeAllModals();
                        }
                    });

                    // Close modal when clicking outside - SAFE VERSION
                    document.addEventListener('click', function (event) {
                        if (event.target.classList.contains('modal-overlay') && event.target.classList.contains('active')) {
                            closeModal(event.target.id);
                        }
                    });



                    // Initialize modal cleanup - SAFE: Won't break other buttons
                    function initializeModalCleanup() {
                        // Ensure all modals start closed
                        closeAllModals();

                        // Setup all close buttons to work properly
                        const closeButtons = document.querySelectorAll('[id*="close"], [id*="cancel"]');
                        closeButtons.forEach(button => {
                            // Don't override existing handlers, just ensure modal closes
                            button.addEventListener('click', function (e) {
                                const modal = button.closest('.modal-overlay');
                                if (modal && modal.id) {
                                    closeModal(modal.id);
                                }
                            }, true); // Use capture to ensure it runs
                        });
                    }

                    // Initialize message boxes
                    function initMessageBoxes() {
                        const originalMessage = document.getElementById('originalMessage');
                        if (originalMessage && originalMessage.scrollHeight > originalMessage.clientHeight) {
                            originalMessage.classList.add('truncated');
                        }

                        document.querySelectorAll('.reply-message-box').forEach(box => {
                            if (box.scrollHeight > box.clientHeight) {
                                box.classList.add('truncated');
                            }
                        });
                    }

                    // Notes functionality
                    function loadNotes() {
                        const ticketId = "{{ ticket.ticket_id }}";
                        const notesContainer = document.getElementById('notesContainer');

                        // Get notes from localStorage (replace with API call in production)
                        const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                        if (notes.length === 0) {
                            notesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <p>No notes yet. Add your first note!</p>
                    </div>
                `;
                            return;
                        }

                        notesContainer.innerHTML = '';
                        notes.forEach((note, index) => {
                            const noteElement = document.createElement('div');
                            noteElement.className = 'note-card';
                            noteElement.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-meta">
                        <span>${new Date(note.timestamp).toLocaleString()}</span>
                        <div class="note-actions">
                            <span class="note-action-btn" onclick="editNote(${index})">
                                <i class="fas fa-edit"></i>
                            </span>
                            <span class="note-action-btn" onclick="deleteNote(${index})">
                                <i class="fas fa-trash"></i>
                            </span>
                        </div>
                    </div>
                `;
                            notesContainer.appendChild(noteElement);
                        });
                    }

                    function saveNote() {
                        const title = document.getElementById('noteTitle').value.trim();
                        const content = document.getElementById('noteContent').value.trim();
                        const ticketId = "{{ ticket.ticket_id }}";
                        const noteIndex = document.getElementById('saveNote').getAttribute('data-note-index');

                        if (!title || !content) {
                            showNotification('Please fill in both title and content', 'error');
                            return;
                        }

                        // Get existing notes
                        const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                        if (noteIndex !== null) {
                            // Update existing note
                            notes[noteIndex] = {
                                title,
                                content,
                                timestamp: new Date().toISOString()
                            };
                        } else {
                            // Add new note
                            notes.push({
                                title,
                                content,
                                timestamp: new Date().toISOString()
                            });
                        }

                        // Save back to storage
                        localStorage.setItem(`ticket_notes_${ticketId}`, JSON.stringify(notes));

                        // Refresh notes display
                        loadNotes();

                        // Close modal and show notification
                        closeModal('noteModal');
                        showNotification(noteIndex !== null ? 'Note updated successfully' : 'Note saved successfully');

                        // Clear form
                        document.getElementById('noteTitle').value = '';
                        document.getElementById('noteContent').value = '';
                        document.getElementById('saveNote').removeAttribute('data-note-index');
                    }

                    function editNote(index) {
                        const ticketId = "{{ ticket.ticket_id }}";
                        const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                        if (index >= 0 && index < notes.length) {
                            const note = notes[index];
                            document.getElementById('noteTitle').value = note.title;
                            document.getElementById('noteContent').value = note.content;

                            // Store the index being edited in a data attribute
                            document.getElementById('saveNote').setAttribute('data-note-index', index);

                            openModal('noteModal');
                        }
                    }

                    function deleteNote(index) {
                        if (confirm('Are you sure you want to delete this note?')) {
                            const ticketId = "{{ ticket.ticket_id }}";
                            const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                            if (index >= 0 && index < notes.length) {
                                notes.splice(index, 1);
                                localStorage.setItem(`ticket_notes_${ticketId}`, JSON.stringify(notes));
                                loadNotes();
                                showNotification('Note deleted');
                            }
                        }
                    }

                    // Template functionality
                    function loadTemplates() {
                        const templatesContainer = document.getElementById('templatesContainer');

                        // Get templates from localStorage (replace with API call in production)
                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (templates.length === 0) {
                            templatesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <p>No templates yet. Add your first template!</p>
                    </div>
                `;
                            return;
                        }

                        templatesContainer.innerHTML = '';
                        templates.forEach((template, index) => {
                            const templateElement = document.createElement('div');
                            templateElement.className = 'template-item';
                            templateElement.innerHTML = `
                    <div class="template-title">${template.title}</div>
                    <div class="template-content">${template.content.substring(0, 100)}${template.content.length > 100 ? '...' : ''}</div>
                    <div class="template-actions">
                        <button class="template-action-btn template-use-btn" onclick="useTemplate(${index})">
                            <i class="fas fa-paper-plane mr-1"></i> Use
                        </button>
                        <button class="template-action-btn template-edit-btn" onclick="editTemplate(${index})">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                    </div>
                `;
                            templatesContainer.appendChild(templateElement);
                        });
                    }

                    // Helper function to format file size
                    function formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    }

                    // ===== VEHICLE & CLAIM EDIT FUNCTIONS =====
                    const ticketId = "{{ ticket.ticket_id }}";

                    // Current vehicle/claim data from template
                    // Current vehicle/claim data from template
                    let currentVehicleData = {
                        vehicle_registration: '',
                        service_date: '',
                        claim_date: '',
                        type_of_claim: '',
                        vhc_link: '',
                        days_between_service_claim: '',
                        advisories_followed: false,
                        within_warranty: false,
                        new_fault_codes: false,
                        dpf_light_on: false,
                        eml_light_on: false
                    };

                    try {
                        const vDataElement = document.getElementById('vehicle-data');
                        if (vDataElement) {
                            const parsedData = JSON.parse(vDataElement.textContent);
                            currentVehicleData = { ...currentVehicleData, ...parsedData };
                        }
                    } catch (e) {
                        console.error('Error parsing vehicle data:', e);
                    }

                    function openVehicleClaimModal() {
                        // Populate form with current data
                        document.getElementById('editVehicleRegistration').value = currentVehicleData.vehicle_registration;
                        document.getElementById('editServiceDate').value = currentVehicleData.service_date;
                        document.getElementById('editClaimDate').value = currentVehicleData.claim_date;
                        document.getElementById('editTypeOfClaim').value = currentVehicleData.type_of_claim;
                        document.getElementById('editVhcLink').value = currentVehicleData.vhc_link;
                        document.getElementById('editDaysBetween').value = currentVehicleData.days_between_service_claim;

                        // Checkboxes
                        document.getElementById('editAdvisoriesFollowed').checked = currentVehicleData.advisories_followed;
                        document.getElementById('editWithinWarranty').checked = currentVehicleData.within_warranty;
                        document.getElementById('editNewFaultCodes').checked = currentVehicleData.new_fault_codes;
                        document.getElementById('editDpfLightOn').checked = currentVehicleData.dpf_light_on;
                        document.getElementById('editEmlLightOn').checked = currentVehicleData.eml_light_on;

                        // Load claim documents
                        loadClaimDocuments();

                        openModal('vehicleClaimModal');
                    }

                    async function saveVehicleClaimInfo() {
                        const data = {
                            vehicle_registration: document.getElementById('editVehicleRegistration').value.trim(),
                            service_date: document.getElementById('editServiceDate').value,
                            claim_date: document.getElementById('editClaimDate').value,
                            type_of_claim: document.getElementById('editTypeOfClaim').value.trim(),
                            vhc_link: document.getElementById('editVhcLink').value.trim(),
                            days_between_service_claim: document.getElementById('editDaysBetween').value,
                            advisories_followed: document.getElementById('editAdvisoriesFollowed').checked,
                            within_warranty: document.getElementById('editWithinWarranty').checked,
                            new_fault_codes: document.getElementById('editNewFaultCodes').checked,
                            dpf_light_on: document.getElementById('editDpfLightOn').checked,
                            eml_light_on: document.getElementById('editEmlLightOn').checked
                        };

                        try {
                            const response = await fetch(`/api/tickets/${ticketId}/vehicle-info`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                                credentials: 'include'
                            });

                            const result = await response.json();

                            if (result.success) {
                                showNotification('Vehicle & Claim information updated successfully', 'success');
                                closeModal('vehicleClaimModal');
                                // Refresh the page to show updated data
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                showNotification(result.message || 'Failed to update', 'error');
                            }
                        } catch (error) {
                            console.error('Error saving vehicle info:', error);
                            showNotification('Error saving vehicle information', 'error');
                        }
                    }

                    async function loadClaimDocuments() {
                        const container = document.getElementById('claimDocumentsList');

                        // Helper function to get file icon based on file type
                        function getFileIcon(fileName, fileType) {
                            const ext = fileName.split('.').pop().toLowerCase();
                            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext) || fileType?.startsWith('image/')) {
                                return 'fa-file-image text-green-400';
                            } else if (ext === 'pdf' || fileType === 'application/pdf') {
                                return 'fa-file-pdf text-red-400';
                            } else if (['doc', 'docx'].includes(ext) || fileType?.includes('word')) {
                                return 'fa-file-word text-blue-400';
                            } else if (['xls', 'xlsx'].includes(ext) || fileType?.includes('excel') || fileType?.includes('spreadsheet')) {
                                return 'fa-file-excel text-green-500';
                            } else {
                                return 'fa-file text-gray-400';
                            }
                        }

                        // Helper function to check if file is previewable
                        function isPreviewable(fileName, fileType) {
                            const ext = fileName.split('.').pop().toLowerCase();
                            return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf'].includes(ext) ||
                                fileType?.startsWith('image/') ||
                                fileType === 'application/pdf';
                        }

                        // Helper function to format file size
                        function formatSize(bytes) {
                            if (!bytes || bytes === 0) return '';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                        }

                        try {
                            const response = await fetch(`/api/tickets/${ticketId}/claim-documents`, { credentials: 'include' });
                            const result = await response.json();
                            const documents = Array.isArray(result.documents) ? result.documents : [];

                            if (result.success && documents.length > 0) {
                                container.innerHTML = documents.map(doc => {
                                    const iconClass = getFileIcon(doc.file_name, doc.file_type);
                                    const canPreview = isPreviewable(doc.file_name, doc.file_type);
                                    const sizeText = formatSize(doc.file_size);

                                    return `
                                <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg mb-2 hover:bg-white/10 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <i class="fas ${iconClass} text-lg"></i>
                                        <div>
                                            <p class="text-sm text-white truncate" style="max-width: 180px;">${doc.file_name}</p>
                                            <p class="text-xs text-gray-500">${doc.description || 'No description'}${sizeText ? '  ' + sizeText : ''}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        ${canPreview ? `
                                        <a href="/api/tickets/${ticketId}/claim-documents/${doc._id}/download" 
                                           target="_blank"
                                           class="text-purple-400 hover:text-purple-300 text-sm p-1" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </a>` : ''}
                                        <a href="/api/tickets/${ticketId}/claim-documents/${doc._id}/download" 
                                           class="text-blue-400 hover:text-blue-300 text-sm p-1" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button onclick="deleteClaimDocument('${doc._id}')" 
                                                class="text-red-400 hover:text-red-300 text-sm p-1" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `}).join('');
                            } else {
                                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">No claim documents uploaded yet.</p>';
                            }
                        } catch (error) {
                            console.error('Error loading claim documents:', error);
                            container.innerHTML = '<p class="text-red-400 text-sm text-center py-2">Error loading documents</p>';
                        }
                    }

                    async function uploadClaimDocument() {
                        console.log(' uploadClaimDocument called');
                        const fileInput = document.getElementById('claimDocumentFile');
                        const description = document.getElementById('claimDocumentDescription').value.trim();

                        console.log(' File input:', fileInput);
                        console.log(' Files:', fileInput ? fileInput.files : 'null');
                        console.log(' Files length:', fileInput ? fileInput.files.length : 'null');

                        if (!fileInput.files.length) {
                            showNotification('Please select a file to upload', 'error');
                            return;
                        }

                        const formData = new FormData();
                        formData.append('file', fileInput.files[0]);
                        formData.append('description', description);

                        console.log(' Uploading file:', fileInput.files[0].name, 'Size:', fileInput.files[0].size);
                        console.log(' Ticket ID:', ticketId);

                        try {
                            const response = await fetch(`/api/tickets/${ticketId}/claim-documents`, {
                                method: 'POST',
                                body: formData,
                                credentials: 'include'
                            });

                            console.log(' Response status:', response.status);
                            const result = await response.json();
                            console.log(' Response result:', result);

                            if (result.success) {
                                showNotification('Document uploaded successfully', 'success');
                                fileInput.value = '';
                                document.getElementById('claimDocumentDescription').value = '';

                                // Reset upload zone text
                                const uploadZone = document.querySelector('#vehicleClaimModal .upload-zone');
                                if (uploadZone) {
                                    const textSpan = uploadZone.querySelector('span:first-of-type');
                                    if (textSpan) {
                                        textSpan.textContent = 'Drop files here or click to upload';
                                        textSpan.style.color = '#d1d5db';
                                    }
                                }

                                loadClaimDocuments(); // Refresh modal list
                                loadTicketClaimDocs(); // Refresh main page list
                            } else {
                                showNotification(result.message || 'Failed to upload', 'error');
                            }
                        } catch (error) {
                            console.error(' Error uploading document:', error);
                            showNotification('Error uploading document', 'error');
                        }
                    }

                    async function deleteClaimDocument(docId) {
                        if (!confirm('Are you sure you want to delete this document?')) return;

                        try {
                            const response = await fetch(`/api/tickets/${ticketId}/claim-documents/${docId}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            });

                            const result = await response.json();

                            if (result.success) {
                                showNotification('Document deleted', 'success');
                                loadClaimDocuments(); // Refresh modal list
                                loadTicketClaimDocs(); // Refresh main page list
                            } else {
                                showNotification(result.message || 'Failed to delete', 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting document:', error);
                            showNotification('Error deleting document', 'error');
                        }
                    }

                    // Load claim documents on main ticket page
                    async function loadTicketClaimDocs() {
                        const container = document.getElementById('ticketClaimDocsList');
                        const countSpan = document.getElementById('ticketClaimDocsCount');

                        if (!container) return;

                        // Helper function to get file icon based on file type
                        function getFileIcon(fileName, fileType) {
                            const ext = fileName.split('.').pop().toLowerCase();
                            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext) || fileType?.startsWith('image/')) {
                                return 'fa-file-image text-green-500';
                            } else if (ext === 'pdf' || fileType === 'application/pdf') {
                                return 'fa-file-pdf text-red-500';
                            } else if (['doc', 'docx'].includes(ext) || fileType?.includes('word')) {
                                return 'fa-file-word text-blue-500';
                            } else if (['xls', 'xlsx'].includes(ext) || fileType?.includes('excel') || fileType?.includes('spreadsheet')) {
                                return 'fa-file-excel text-green-600';
                            } else {
                                return 'fa-file text-gray-500';
                            }
                        }

                        // Helper function to check if file is previewable
                        function isPreviewable(fileName, fileType) {
                            const ext = fileName.split('.').pop().toLowerCase();
                            return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf'].includes(ext) ||
                                fileType?.startsWith('image/') ||
                                fileType === 'application/pdf';
                        }

                        // Helper function to format file size
                        function formatSize(bytes) {
                            if (!bytes || bytes === 0) return '';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                        }

                        try {
                            const response = await fetch(`/api/tickets/${ticketId}/claim-documents`, { credentials: 'include' });
                            const result = await response.json();
                            const documents = Array.isArray(result.documents) ? result.documents : [];

                            if (result.success && documents.length > 0) {
                                if (countSpan) countSpan.textContent = `(${documents.length} file${documents.length > 1 ? 's' : ''})`;

                                container.innerHTML = documents.map(doc => {
                                    const iconClass = getFileIcon(doc.file_name, doc.file_type);
                                    const canPreview = isPreviewable(doc.file_name, doc.file_type);
                                    const sizeText = formatSize(doc.file_size);

                                    return `
                                <div class="detail-card flex items-center justify-between p-3">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 rounded-full bg-gray-100">
                                            <i class="fas ${iconClass}"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-800 font-medium">${doc.file_name}</p>
                                            <p class="text-xs text-gray-500">${doc.description || 'No description'}${sizeText ? '  ' + sizeText : ''}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        ${canPreview ? `
                                        <a href="/api/tickets/${ticketId}/claim-documents/${doc._id}/download" 
                                           target="_blank"
                                           class="p-2 text-purple-600 hover:bg-purple-100 rounded-full transition" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </a>` : ''}
                                        <a href="/api/tickets/${ticketId}/claim-documents/${doc._id}/download" 
                                           class="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </div>
                            `}).join('');
                            } else {
                                if (countSpan) countSpan.textContent = '';
                                container.innerHTML = `
                                <div class="detail-card p-4 text-center">
                                    <div class="text-gray-400 mb-2">
                                        <i class="fas fa-folder-open text-2xl"></i>
                                    </div>
                                    <p class="text-gray-500 text-sm">No claim documents uploaded yet.</p>
                                    <p class="text-gray-400 text-xs mt-1">Click "Edit" to upload documents.</p>
                                </div>`;
                            }
                        } catch (error) {
                            console.error('Error loading ticket claim documents:', error);
                            container.innerHTML = '<p class="text-red-400 text-sm text-center py-4">Error loading documents</p>';
                        }
                    }

                    // Make functions globally available for onclick handlers
                    window.deleteClaimDocument = deleteClaimDocument;
                    window.loadTicketClaimDocs = loadTicketClaimDocs;
                    window.uploadClaimDocument = uploadClaimDocument;
                    window.previewAttachment = previewAttachment;
                    window.downloadAttachment = downloadAttachment;
                    window.previewEmailAttachment = previewEmailAttachment;
                    window.downloadEmailAttachment = downloadEmailAttachment;
                    window.previewTicketAttachment = previewTicketAttachment;
                    window.downloadTicketAttachment = downloadTicketAttachment;
                    window.setupAttachmentHandlers = setupAttachmentHandlers;

                    // Event delegation for data-attribute attachment buttons
                    document.addEventListener('click', function (e) {
                        const previewBtn = e.target.closest('.att-preview-btn');
                        if (previewBtn) {
                            const ticketId = previewBtn.dataset.ticketId;
                            const index = parseInt(previewBtn.dataset.index, 10);
                            const filename = previewBtn.dataset.filename;
                            if (window.previewTicketAttachment) {
                                previewTicketAttachment(ticketId, index, filename);
                            }
                            return;
                        }
                        const downloadBtn = e.target.closest('.att-download-btn');
                        if (downloadBtn) {
                            const ticketId = downloadBtn.dataset.ticketId;
                            const index = parseInt(downloadBtn.dataset.index, 10);
                            const filename = downloadBtn.dataset.filename;
                            if (window.downloadTicketAttachment) {
                                downloadTicketAttachment(ticketId, index, filename);
                            }
                            return;
                        }
                    });

                    // ==========================================
                    // ATTACHMENT HANDLING FUNCTIONS
                    // ==========================================

                    //  Inline Preview Modal (avoids popup blockers) 
                    function getOrCreatePreviewModal() {
                        let modal = document.getElementById('attachmentPreviewModal');
                        if (!modal) {
                            modal = document.createElement('div');
                            modal.id = 'attachmentPreviewModal';
                            modal.style.cssText = `
                            display:none; position:fixed; inset:0; z-index:99999;
                            background:rgba(0,0,0,0.85); backdrop-filter:blur(8px);
                            align-items:center; justify-content:center; flex-direction:column;
                        `;
                            modal.innerHTML = `
                            <div style="position:absolute;top:16px;right:24px;display:flex;gap:12px;z-index:100001;">
                                <a id="prevModalOpenTab" href="#" target="_blank" rel="noopener"
                                   style="color:#a78bfa;font-size:14px;text-decoration:underline;padding:8px;">
                                    Open in new tab
                                </a>
                                <button id="prevModalClose"
                                    style="color:#fff;font-size:28px;background:rgba(255,255,255,0.1);
                                           border:none;border-radius:50%;width:40px;height:40px;
                                           cursor:pointer;display:flex;align-items:center;justify-content:center;">
                                    
                                </button>
                            </div>
                            <div id="prevModalContent" style="max-width:90vw;max-height:85vh;display:flex;
                                 align-items:center;justify-content:center;"></div>
                        `;
                            document.body.appendChild(modal);

                            // Close handlers
                            modal.querySelector('#prevModalClose').addEventListener('click', () => {
                                modal.style.display = 'none';
                                modal.querySelector('#prevModalContent').innerHTML = '';
                            });
                            modal.addEventListener('click', (e) => {
                                if (e.target === modal) {
                                    modal.style.display = 'none';
                                    modal.querySelector('#prevModalContent').innerHTML = '';
                                }
                            });
                            document.addEventListener('keydown', (e) => {
                                if (e.key === 'Escape' && modal.style.display === 'flex') {
                                    modal.style.display = 'none';
                                    modal.querySelector('#prevModalContent').innerHTML = '';
                                }
                            });
                        }
                        return modal;
                    }

                    function showPreviewInModal(url, filename) {
                        const modal = getOrCreatePreviewModal();
                        const content = modal.querySelector('#prevModalContent');
                        const openTab = modal.querySelector('#prevModalOpenTab');
                        openTab.href = url;
                        content.innerHTML = '';

                        const ext = (filename || '').toLowerCase().split('.').pop();
                        const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];

                        if (imageExts.includes(ext)) {
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = filename;
                            img.style.cssText = 'max-width:90vw;max-height:85vh;object-fit:contain;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.4);';
                            content.appendChild(img);
                        } else {
                            // PDF / text / other  use iframe
                            const iframe = document.createElement('iframe');
                            iframe.src = url;
                            iframe.style.cssText = 'width:85vw;height:85vh;border:none;border-radius:8px;background:#fff;';
                            content.appendChild(iframe);
                        }

                        modal.style.display = 'flex';
                    }

                    function previewAttachment(messageId, attachmentIndex, filename, source) {
                        console.log('previewAttachment called:', { messageId, attachmentIndex, filename, source });
                        const url = `/api/attachments/reply/${messageId}/${attachmentIndex}/preview`;
                        showPreviewInModal(url, filename);
                    }

                    function downloadAttachment(messageId, attachmentIndex, filename, source) {
                        console.log('downloadAttachment called:', { messageId, attachmentIndex, filename, source });
                        const url = `/api/attachments/reply/${messageId}/${attachmentIndex}`;
                        console.log('Downloading from URL:', url);
                        window.location.href = url;
                    }

                    function previewEmailAttachment(ticketId, attachmentIndex, filename) {
                        console.log('previewEmailAttachment called:', { ticketId, attachmentIndex, filename });
                        const url = `/api/attachments/preview/${ticketId}/${attachmentIndex}`;
                        showPreviewInModal(url, filename);
                    }

                    function downloadEmailAttachment(ticketId, attachmentIndex, filename) {
                        console.log('downloadEmailAttachment called:', { ticketId, attachmentIndex, filename });
                        const url = `/api/attachments/ticket/${ticketId}/${attachmentIndex}`;
                        console.log('Downloading from URL:', url);
                        window.location.href = url;
                    }

                    // Original Ticket Attachment Functions
                    function previewTicketAttachment(ticketId, attachmentIndex, filename) {
                        console.log('previewTicketAttachment called:', { ticketId, attachmentIndex, filename });
                        const url = `/api/attachments/preview/${ticketId}/${attachmentIndex}`;
                        showPreviewInModal(url, filename);
                    }

                    function downloadTicketAttachment(ticketId, attachmentIndex, filename) {
                        console.log('downloadTicketAttachment called:', { ticketId, attachmentIndex, filename });
                        const url = `/api/attachments/ticket/${ticketId}/${attachmentIndex}`;
                        console.log('Downloading from URL:', url);
                        window.location.href = url;
                    }

                    function setupAttachmentHandlers() {
                        // This function is called in DOMContentLoaded
                        console.log('Attachment handlers initialized');

                        const dropzone = document.getElementById('replyDropzone');
                        const fileInput = document.getElementById('response_attachments');

                        if (dropzone && fileInput) {
                            dropzone.addEventListener('click', (e) => {
                                // Only trigger if clicking the background, not textarea or buttons
                                if (e.target.id === 'replyDropzone' || e.target.closest('#attachmentSection')) {
                                    fileInput.click();
                                }
                            });

                            fileInput.addEventListener('change', handleFileSelect);
                        }

                        // Also enable the generic attachment button
                        const attachmentBtn = document.getElementById('attachmentBtn');
                        if (attachmentBtn && fileInput) {
                            attachmentBtn.addEventListener('click', () => fileInput.click());
                        }
                    }

                    function handleFileSelect(e) {
                        const files = e.target.files;
                        const previewContainer = document.getElementById('enhancedAttachmentPreview');
                        const list = document.getElementById('attachmentPreviewList');

                        if (files.length > 0) {
                            previewContainer.classList.remove('hidden');
                            list.innerHTML = '';

                            Array.from(files).forEach((file, index) => {
                                const item = document.createElement('div');
                                item.className = 'flex items-center justify-between text-xs bg-white/5 p-2 rounded';
                                item.innerHTML = `
                                <div class="flex items-center">
                                    <i class="fas fa-file text-gray-400 mr-2"></i>
                                    <span class="text-gray-300 truncate max-w-[200px]">${file.name}</span>
                                </div>
                                <span class="text-gray-500 ml-2">${(file.size / 1024).toFixed(1)} KB</span>
                            `;
                                list.appendChild(item);
                            });

                            // Update button counter
                            const countBadge = document.querySelector('.attachment-count');
                            if (countBadge) {
                                countBadge.textContent = files.length;
                                countBadge.classList.remove('hidden');
                            }
                        }
                    }

                    // Document functions
                    let isLoadingDocuments = false; // Prevent duplicate loading
                    const loadedDocumentIds = new Set(); // Track loaded document IDs

                    async function loadDocuments() {
                        // Prevent concurrent calls
                        if (isLoadingDocuments) {
                            console.log(' loadDocuments already in progress, skipping...');
                            return;
                        }

                        isLoadingDocuments = true;

                        const documentsSection = document.getElementById('documentsContainer');

                        if (!documentsSection) {
                            console.error('Documents container not found');
                            isLoadingDocuments = false;
                            return;
                        }

                        try {
                            const response = await fetch('/api/common-documents', { credentials: 'include' });
                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Failed to load documents');
                            }

                            const documents = data.documents || [];

                            // DEBUG: Log the document structure to see what fields are available
                            console.log(' Loaded documents:', documents);
                            if (documents.length > 0) {
                                console.log(' First document structure:', documents[0]);
                                console.log(' Document has file_content:', 'file_content' in documents[0]);
                                console.log(' Document has file_data:', 'file_data' in documents[0]);
                                console.log(' Document has file_size:', 'file_size' in documents[0]);
                            }

                            // Store documents in localStorage for drag and drop functionality
                            localStorage.setItem('common_documents', JSON.stringify(documents));

                            // Clear the container first
                            documentsSection.innerHTML = '';

                            if (documents.length === 0) {
                                // Show empty state message
                                documentsSection.innerHTML = `
                    <div class="text-center text-gray-500 p-4">
                        <i class="fas fa-folder-open text-3xl mb-2"></i>
                        <p class="text-sm">No documents yet. Click "Add Document" to get started.</p>
                    </div>
                `;
                                return;
                            }

                            // Create document items
                            documents.forEach((doc, arrayIndex) => {


                                if (!doc._id) {
                                    console.error('Document missing _id field:', doc);
                                    return; // Skip this document
                                }

                                const docItem = document.createElement('div');
                                // Force vertical layout with inline style to override any CSS conflicts
                                docItem.className = 'document-item border-b border-gray-700/50 p-3 bg-gray-800/30 hover:bg-gray-800/50 cursor-pointer flex flex-col gap-2';
                                docItem.style.cssText = 'display: flex !important; flex-direction: column !important; gap: 0.5rem !important; background: rgba(255, 255, 255, 0.03) !important;';
                                docItem.dataset.documentId = doc._id;

                                // Choose appropriate icon based on file extension (primary) or document type (fallback)
                                let iconClass = 'fas fa-file-alt text-gray-400';

                                // Get file extension from file_name if available
                                const fileName = doc.file_name || doc.name || '';
                                const ext = fileName.toLowerCase().split('.').pop();

                                // Extension-based icon mapping (priority)
                                if (ext === 'pdf') {
                                    iconClass = 'fas fa-file-pdf text-red-500';
                                } else if (ext === 'doc' || ext === 'docx') {
                                    iconClass = 'fas fa-file-word text-blue-500';
                                } else if (ext === 'xls' || ext === 'xlsx') {
                                    iconClass = 'fas fa-file-excel text-green-500';
                                } else if (ext === 'csv') {
                                    iconClass = 'fas fa-file-csv text-green-500';
                                } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                                    iconClass = 'fas fa-file-image text-purple-500';
                                } else if (ext === 'zip' || ext === 'rar' || ext === '7z') {
                                    iconClass = 'fas fa-file-archive text-yellow-500';
                                } else if (ext === 'txt') {
                                    iconClass = 'fas fa-file-alt text-gray-400';
                                } else if (doc.type === 'form') {
                                    // Fallback to document type
                                    iconClass = 'fas fa-file-contract text-blue-500';
                                } else if (doc.type === 'guide') {
                                    iconClass = 'fas fa-book text-green-500';
                                } else if (doc.type === 'manual') {
                                    iconClass = 'fas fa-file-pdf text-red-500';
                                } else if (doc.type === 'template') {
                                    iconClass = 'fas fa-file-word text-indigo-500';
                                }

                                // Format date and file size
                                const createdDate = new Date(doc.created_at).toLocaleDateString();
                                const fileSize = doc.file_size ? formatFileSize(doc.file_size) : '';

                                // Use high-contrast colors for dark mode text
                                docItem.innerHTML = `
                    <div class="flex items-start w-full" style="display: flex !important; width: 100% !important;">
                        <i class="${iconClass} text-xl mr-3 mt-0.5 flex-shrink-0"></i>
                        <div class="flex-1 min-w-0 grid">
                            <p class="text-sm font-medium text-gray-100 truncate" title="${doc.name}">${doc.name}</p>
                            <p class="text-xs text-gray-400 truncate mt-0.5">${doc.type ? doc.type.charAt(0).toUpperCase() + doc.type.slice(1) : 'Doc'}  ${createdDate}</p>
                        </div>
                    </div>
                    
                    <!-- Tiny Action Buttons Row - Forced Visibility -->
                    <div class="common-doc-actions flex items-center gap-2 pl-8 mt-1 w-full" style="display: flex !important; margin-top: 4px !important; padding-left: 2rem !important; width: 100% !important; visibility: visible !important; opacity: 1 !important;">
                        <button type="button" class="view-document-btn text-xs bg-gray-800 text-blue-400 hover:bg-gray-700 hover:text-blue-300 px-2 py-1 rounded border border-gray-600 transition-colors flex items-center gap-1 h-6" style="display: inline-flex !important;" title="Download">
                            <i class="fas fa-download text-[10px]"></i> <span class="text-[10px] font-medium">Download</span>
                        </button>
                        
                        <div class="flex gap-1 ml-auto" style="display: flex !important; margin-left: auto !important;">
                             <button type="button" class="delete-document-btn text-xs bg-gray-800 text-red-400 hover:bg-gray-700 hover:text-red-300 px-2 py-1 rounded border border-gray-600 transition-colors flex items-center gap-1 h-6" style="display: inline-flex !important;" title="Delete">
                                <i class="fas fa-trash text-[10px]"></i> <span class="text-[10px] font-medium">Delete</span>
                            </button>
                            <button type="button" class="edit-document-btn text-xs bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-gray-300 px-2 py-1 rounded border border-gray-600 transition-colors flex items-center gap-1 h-6" style="display: inline-flex !important;" title="Edit">
                                <i class="fas fa-edit text-[10px]"></i> <span class="text-[10px] font-medium">Edit</span>
                            </button>
                        </div>
                    </div>
                `;

                                documentsSection.appendChild(docItem);

                                // Make document draggable
                                docItem.setAttribute('draggable', 'true');
                                docItem.addEventListener('dragstart', function (e) {
                                    // Get the index of this document in the current list
                                    const allDocItems = documentsSection.querySelectorAll('.document-item');
                                    const currentIndex = Array.from(allDocItems).indexOf(docItem);

                                    console.log(` Drag started for document ${doc._id} at index ${currentIndex} (array index: ${arrayIndex})`);
                                    console.log(' Drag data being set:', {
                                        type: 'common-document',
                                        _id: doc._id,
                                        name: doc.name,
                                        documentId: doc._id
                                    });

                                    // ENHANCED DEBUGGING: Log complete document details
                                    console.log(' COMPLETE DOCUMENT DATA FOR DRAG:', {
                                        _id: doc._id,
                                        name: doc.name,
                                        type: doc.type,
                                        description: doc.description,
                                        file_name: doc.file_name,
                                        file_size: doc.file_size,
                                        file_path: doc.file_path,
                                        created_at: doc.created_at,
                                        updated_at: doc.updated_at,
                                        is_active: doc.is_active,
                                        arrayIndex: arrayIndex,
                                        currentIndex: currentIndex,
                                        documentElement: docItem,
                                        elementDataset: docItem.dataset,
                                        doc_type: doc.datatype,
                                        file_data: "",
                                        file_name: ""
                                    });

                                    // Store the drag data for debugging
                                    const dragData = {
                                        type: 'common-document',
                                        _id: doc._id,  // Use actual document ID instead of index
                                        name: doc.name,
                                        documentId: doc._id,
                                        // ENHANCED: Include more document details for debugging
                                        documentType: doc.type,
                                        documentDescription: doc.description,
                                        documentFileName: doc.file_name,
                                        documentFileSize: doc.file_size,
                                        documentFilePath: doc.file_path,
                                        documentCreatedAt: doc.created_at,
                                        documentUpdatedAt: doc.updated_at,
                                        documentIsActive: doc.is_active
                                    };

                                    e.dataTransfer.setData('text', JSON.stringify(dragData));

                                    // Add visual feedback
                                    e.target.classList.add('opacity-50');

                                    // Log the current state of processed documents
                                    console.log(' Current processed documents:', Array.from(processedDocuments));
                                    console.log(' Current processed documents count:', processedDocuments.size);
                                });

                                docItem.addEventListener('dragend', function (e) {
                                    e.target.classList.remove('opacity-50');
                                });

                                // Add view button event handler
                                const viewBtn = docItem.querySelector('.view-document-btn');
                                if (viewBtn) {
                                    viewBtn.addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        console.log('View button clicked, doc._id:', doc._id);
                                        console.log('View button clicked, doc._id type:', typeof doc._id);
                                        console.log('View button clicked, doc._id length:', doc._id ? doc._id.length : 'null/undefined');
                                        viewDocument(doc._id);
                                    });
                                }

                                // Add edit button event handler
                                const editBtn = docItem.querySelector('.edit-document-btn');
                                if (editBtn) {
                                    editBtn.addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        editDocument(doc._id);
                                    });
                                }



                                // Add delete button event handler
                                const deleteBtn = docItem.querySelector('.delete-document-btn');
                                if (deleteBtn) {
                                    deleteBtn.addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        deleteDocument(doc._id);
                                    });
                                }

                                // Add click handler for the entire item (for viewing)
                                docItem.addEventListener('click', function () {
                                    console.log('Document item clicked, doc._id:', doc._id);
                                    console.log('Document item clicked, doc._id type:', typeof doc._id);
                                    console.log('Document item clicked, doc._id length:', doc._id ? doc._id.length : 'null/undefined');
                                    viewDocument(doc._id);
                                });
                            });

                            console.log('Documents loaded and made draggable');

                            // Reset processed documents tracking when documents are reloaded
                            processedDocuments.clear();
                            lastProcessedDocument = null;
                            lastProcessedTime = 0;

                            // Setup drag and drop for reply area
                            // setupReplyDropzone(); // OLD SYSTEM REMOVED

                            isLoadingDocuments = false; // Reset loading flag

                        } catch (error) {
                            console.error('Error loading documents:', error);
                            isLoadingDocuments = false; // Reset loading flag on error
                            documentsSection.innerHTML = `
                    <div class="text-center text-red-500 p-4">
                        <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                        <p class="text-sm">Error loading documents: ${error.message}</p>
                    </div>
                `;
                        }
                    }

                    // OLD DRAG & DROP SYSTEM REMOVED - Only enhanced system remains
                    /*
                    function setupReplyDropzone() {
                        // ... entire old function commented out ...
                    }
                    */

                    // OLD FUNCTION REMOVED - Only enhanced system remains
                    /*
                    // Add common document to reply as attachment
                    function addCommonDocumentToReply(documentId, documentName, fullDocumentData = null) {
                        console.log(' addCommonDocumentToReply called with:');
                        console.log('  - documentId:', documentId);
                        console.log('  - documentName:', documentName);
                        console.log('  - fullDocumentData:', fullDocumentData);
                        
                        // Check for duplicate documents before adding
                        const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                        if (commonDocumentPreview) {
                            const existingDoc = commonDocumentPreview.querySelector(`[data-document-id="${documentId}"]`);
                            if (existingDoc) {
                                console.log(' Document already added to reply, skipping duplicate:', documentName);
                                showNotification(` ${documentName} is already added to reply`, 'warning');
                                return;
                            }
                        }
                        
                        // ENHANCED DEBUGGING: Log all available document information
                        if (fullDocumentData) {
                            console.log(' COMPLETE DOCUMENT DATA RECEIVED:');
                            console.log('  - Document ID:', fullDocumentData.documentId);
                            console.log('  - Document Name:', fullDocumentData.name);
                            console.log('  - Document Type:', fullDocumentData.documentType);
                            console.log('  - Document Description:', fullDocumentData.documentDescription);
                            console.log('  - Document File Name:', fullDocumentData.documentFileName);
                            console.log('  - Document File Size:', fullDocumentData.documentFileSize);
                            console.log('  - Document File Path:', fullDocumentData.documentFilePath);
                            console.log('  - Document Created At:', fullDocumentData.documentCreatedAt);
                            console.log('  - Document Updated At:', fullDocumentData.documentUpdatedAt);
                            console.log('  - Document Is Active:', fullDocumentData.documentIsActive);
                            console.log('  - Array Index:', fullDocumentData.index);
                        }
                        
                        // ENHANCED DEBUGGING: Check localStorage for additional context
                        try {
                            const storedDocuments = JSON.parse(localStorage.getItem('common_documents') || '[]');
                            console.log(' Stored documents in localStorage:', storedDocuments.length);
                            
                            const matchingStoredDoc = storedDocuments.find(doc => doc._id === documentId);
                            if (matchingStoredDoc) {
                                console.log(' Found matching document in localStorage:', matchingStoredDoc);
                            } else {
                                console.log(' Document not found in localStorage - ID mismatch?');
                                console.log(' Searching for partial matches...');
                                const partialMatches = storedDocuments.filter(doc => 
                                    doc._id && doc._id.toString().includes(documentId.toString().slice(-4))
                                );
                                console.log(' Partial matches found:', partialMatches);
                            }
                        } catch (localStorageError) {
                            console.error(' Error reading localStorage:', localStorageError);
                        }
                        
                        const commonDocumentDropzone = document.getElementById('commonDocumentDropzone');
                        
                        console.log(' DOM Elements found:');
                        console.log('  - commonDocumentDropzone:', commonDocumentDropzone);
                        console.log('  - commonDocumentPreview:', commonDocumentPreview);
                        
                        // Show the dropzone if hidden
                        commonDocumentDropzone.classList.remove('hidden');
                        
                        // Create preview item
                        const previewItem = document.createElement('div');
                        previewItem.className = 'flex items-center justify-between p-2 bg-blue-50 border border-blue-200 rounded text-sm';
                        previewItem.dataset.documentId = documentId;
                        
                        // ENHANCED: Store all document data in the preview item for debugging
                        if (fullDocumentData) {
                            previewItem.dataset.documentType = fullDocumentData.documentType || '';
                            previewItem.dataset.documentDescription = fullDocumentData.documentDescription || '';
                            previewItem.dataset.documentFileName = fullDocumentData.documentFileName || '';
                            previewItem.dataset.documentFileSize = fullDocumentData.documentFileSize || '';
                            previewItem.dataset.documentFilePath = fullDocumentData.documentFilePath || '';
                            previewItem.dataset.documentCreatedAt = fullDocumentData.documentCreatedAt || '';
                            previewItem.dataset.documentUpdatedAt = fullDocumentData.documentUpdatedAt || '';
                            previewItem.dataset.documentIsActive = fullDocumentData.documentIsActive || '';
                            previewItem.dataset.arrayIndex = fullDocumentData.index || '';
                        }
                        
                        console.log(' Preview item created with dataset:', previewItem.dataset);
                        
                        previewItem.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                                <span class="text-blue-800">${documentName}</span>
                                ${fullDocumentData && fullDocumentData.documentType ? `<span class="text-xs text-blue-600 ml-2">(${fullDocumentData.documentType})</span>` : ''}
                            </div>
                            <button type="button" class="remove-doc-btn text-red-500 hover:text-red-700" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        // Add remove functionality
                        const removeBtn = previewItem.querySelector('.remove-doc-btn');
                        removeBtn.addEventListener('click', function() {
                            previewItem.remove();
                            // Hide dropzone if no more documents
                            if (commonDocumentPreview.children.length === 0) {
                                commonDocumentDropzone.classList.add('hidden');
                            }
                        });
                        
                        commonDocumentPreview.appendChild(previewItem);
                        
                        // Show success notification
                        showNotification(` ${documentName} added to reply`, 'success');
                    }
                    */

                    async function viewDocument(documentId) {
                        try {
                            if (!documentId) {
                                showNotification('No document ID provided', 'error');
                                return;
                            }

                            // Download the document file
                            const downloadUrl = `/api/common-documents/${documentId}/download`;

                            try {
                                const newWindow = window.open(downloadUrl, '_blank');
                                if (!newWindow) {
                                    showNotification('Download failed - popup blocked?', 'error');
                                }
                            } catch (windowError) {
                                showNotification(`Error opening download: ${windowError.message}`, 'error');
                            }

                        } catch (error) {
                            console.error('Error viewing document:', error);
                            showNotification(`Error viewing document: ${error.message}`, 'error');
                        }
                    }

                    async function editDocument(documentId) {
                        try {
                            const response = await fetch(`/api/common-documents/${documentId}`);
                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Document not found');
                            }

                            const doc = data.document;

                            document.getElementById('documentName').value = doc.name;
                            document.getElementById('documentType').value = doc.type;
                            document.getElementById('documentDescription').value = doc.description || '';
                            document.getElementById('selectedFileName').textContent = doc.file_name || 'Current file preserved';
                            document.getElementById('documentModalTitle').textContent = 'Edit Document';
                            document.getElementById('deleteDocument').classList.remove('hidden');
                            document.getElementById('saveDocument').setAttribute('data-document-id', documentId);
                            openModal('documentModal');

                        } catch (error) {
                            console.error('Error loading document for editing:', error);
                            showNotification(`Error loading document: ${error.message}`, 'error');
                        }
                    }

                    async function saveDocument() {
                        const name = document.getElementById('documentName').value.trim();
                        const type = document.getElementById('documentType').value;
                        const fileInput = document.getElementById('documentFile');
                        const description = document.getElementById('documentDescription').value.trim();
                        const documentId = document.getElementById('saveDocument').getAttribute('data-document-id');

                        if (!name) {
                            showNotification('Please enter a document name', 'error');
                            return;
                        }

                        // For new documents, require a file
                        if (!documentId && fileInput.files.length === 0) {
                            showNotification('Please select a file for new documents', 'error');
                            return;
                        }

                        try {
                            let response;

                            if (documentId) {
                                // Update existing document (JSON)
                                const documentData = {
                                    name,
                                    type,
                                    description,
                                    file_name: fileInput.files.length > 0 ? fileInput.files[0].name : ''
                                };

                                response = await fetch(`/api/common-documents/${documentId}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(documentData),
                                    credentials: 'include'
                                });
                            } else {
                                // Create new document with file upload (FormData)
                                const formData = new FormData();
                                formData.append('name', name);
                                formData.append('type', type);
                                formData.append('description', description);
                                formData.append('file', fileInput.files[0]);

                                response = await fetch('/api/common-documents', {
                                    method: 'POST',
                                    body: formData,
                                    credentials: 'include'
                                });
                            }

                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Failed to save document');
                            }

                            // Refresh documents display
                            await loadDocuments();

                            // Close modal and show notification
                            closeModal('documentModal');
                            showNotification(documentId ? 'Document updated successfully' : 'Document uploaded successfully');

                            // Clear form
                            document.getElementById('documentName').value = '';
                            document.getElementById('documentType').value = 'form';
                            document.getElementById('documentDescription').value = '';
                            document.getElementById('documentFile').value = '';
                            document.getElementById('selectedFileName').textContent = 'No file selected';

                        } catch (error) {
                            console.error('Error saving document:', error);
                            showNotification(`Error saving document: ${error.message}`, 'error');
                        }
                    }

                    async function deleteDocument(documentId) {
                        if (!documentId || !confirm('Are you sure you want to delete this document?')) {
                            return;
                        }

                        try {
                            const response = await fetch(`/api/common-documents/${documentId}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            });

                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Failed to delete document');
                            }

                            // Refresh documents display
                            await loadDocuments();

                            // Close modal if open
                            closeModal('documentModal');
                            showNotification('Document deleted successfully');

                        } catch (error) {
                            console.error('Error deleting document:', error);
                            showNotification(`Error deleting document: ${error.message}`, 'error');
                        }
                    }

                    function useTemplate(index) {
                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (index >= 0 && index < templates.length) {
                            const responseTextarea = document.getElementById('response');
                            responseTextarea.value = templates[index].content;

                            // Trigger auto-expand after applying template
                            if (typeof window.autoExpandTextarea === 'function') {
                                window.autoExpandTextarea(responseTextarea);
                            }

                            showNotification('Template applied to response');
                        }
                    }

                    function editTemplate(index = -1) {
                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (index >= 0 && index < templates.length) {
                            // Editing existing template
                            const template = templates[index];
                            document.getElementById('templateTitle').value = template.title;
                            document.getElementById('templateContent').value = template.content;
                            document.getElementById('editTemplateTitle').textContent = 'Edit Template';
                            document.getElementById('deleteTemplate').classList.remove('hidden');
                            document.getElementById('saveTemplate').setAttribute('data-template-index', index);
                        } else {
                            // Creating new template
                            document.getElementById('templateTitle').value = '';
                            document.getElementById('templateContent').value = '';
                            document.getElementById('editTemplateTitle').textContent = 'Add New Template';
                            document.getElementById('deleteTemplate').classList.add('hidden');
                            document.getElementById('saveTemplate').removeAttribute('data-template-index');
                        }

                        openModal('editTemplateModal');
                    }

                    function saveTemplate() {
                        const title = document.getElementById('templateTitle').value.trim();
                        const content = document.getElementById('templateContent').value.trim();
                        const index = document.getElementById('saveTemplate').getAttribute('data-template-index');

                        if (!title || !content) {
                            showNotification('Please fill in both title and content', 'error');
                            return;
                        }

                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (index !== null) {
                            // Update existing template
                            templates[index] = { title, content };
                        } else {
                            // Add new template
                            templates.push({ title, content });
                        }

                        localStorage.setItem('response_templates', JSON.stringify(templates));
                        loadTemplates();
                        closeModal('editTemplateModal');
                        showNotification(index !== null ? 'Template updated successfully' : 'Template saved successfully');
                    }

                    function deleteTemplate() {
                        const index = document.getElementById('saveTemplate').getAttribute('data-template-index');

                        if (index !== null && confirm('Are you sure you want to delete this template?')) {
                            const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                            if (index >= 0 && index < templates.length) {
                                templates.splice(index, 1);
                                localStorage.setItem('response_templates', JSON.stringify(templates));
                                loadTemplates();
                                closeModal('editTemplateModal');
                                showNotification('Template deleted');
                            }
                        }
                    }

                    // Status dropdown functionality
                    function setupStatusDropdown() {
                        const dropdownBtn = document.getElementById('statusDropdownBtn');
                        const dropdownContent = document.getElementById('statusDropdownContent');

                        // Toggle dropdown
                        dropdownBtn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            dropdownContent.classList.toggle('show');
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', function () {
                            dropdownContent.classList.remove('show');
                        });

                        // Handle status selection
                        document.querySelectorAll('.status-option').forEach(option => {
                            option.addEventListener('click', async function () {
                                const newStatus = this.getAttribute('data-status');

                                try {
                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/status`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            status: newStatus
                                        })
                                    });

                                    if (response.ok) {
                                        // Get the CURRENT status from the DOM (not the static template value)
                                        const statusDisplay = document.getElementById('currentStatusDisplay');
                                        const oldStatus = statusDisplay ? statusDisplay.textContent.trim() : '';
                                        const newStatusClass = newStatus.toLowerCase().replace(/ /g, '-').replace(//g, '');

                                        // Update the status dropdown button text
                                        if (statusDisplay) {
                                            statusDisplay.textContent = newStatus;
                                        }

                                        // Update the status dropdown button styling
                                        const statusDropdownBtn = document.getElementById('statusDropdownBtn');
                                        if (statusDropdownBtn) {
                                            // Remove ALL old status classes and add new one
                                            statusDropdownBtn.className = 'status-dropdown-btn whitespace-nowrap flex-shrink-0 h-9 flex items-center justify-center';
                                            statusDropdownBtn.classList.add(`status-${newStatusClass}`);
                                        }

                                        // Update ALL status badges on the page
                                        const statusBadges = document.querySelectorAll('[class*="status-"]');
                                        statusBadges.forEach(badge => {
                                            if (badge.textContent.trim() === oldStatus) {
                                                badge.textContent = newStatus;
                                                // Update badge classes
                                                badge.className = badge.className.replace(/status-\S+/g, '');
                                                badge.classList.add(`status-${newStatusClass}`);
                                            }
                                        });

                                        showNotification(`Status updated to ${newStatus}`, 'success');
                                    } else {
                                        const error = await response.json();
                                        showNotification(error.message || 'Failed to update status', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error updating status:', error);
                                    showNotification('Failed to update status', 'error');
                                }
                            });
                        });
                    }

                    // Function to initialize status dropdown button styling
                    function initializeStatusButton() {
                        const statusDropdownBtn = document.getElementById('statusDropdownBtn');
                        const currentStatus = '{{ ticket.status }}';

                        if (statusDropdownBtn && currentStatus) {
                            // Remove any existing status classes
                            statusDropdownBtn.className = statusDropdownBtn.className.replace(/status-\S+/g, '');

                            // Add the current status class
                            const statusClass = currentStatus.toLowerCase().replace(/ /g, '-').replace(//g, '');
                            statusDropdownBtn.classList.add(`status-${statusClass}`);
                        }
                    }

                    // Function to force 1500px layout for ALL screen sizes
                    function adjustLayoutForScreenSize() {
                        const appContainer = document.querySelector('.app-container');

                        if (appContainer) {
                            // ALWAYS force 1500px width regardless of screen size
                            appContainer.style.width = '1500px';
                            appContainer.style.maxWidth = '1500px';
                            appContainer.style.margin = '0'; /* Ensure left alignment */

                            // ALWAYS apply professional styling
                            appContainer.style.boxShadow = '0 0 30px rgba(0, 0, 0, 0.1)';
                            appContainer.style.borderRadius = '8px';
                            appContainer.style.marginTop = '20px';
                            appContainer.style.marginBottom = '20px';

                            // Color setting removed to maintain dark theme consistency
                            // document.body.style.backgroundColor = '#f8fafb';

                            // ALWAYS align to left instead of center
                            document.body.style.display = 'flex';
                            document.body.style.justifyContent = 'flex-start'; /* Changed from center to flex-start */
                            document.body.style.alignItems = 'flex-start';
                            document.body.style.minHeight = '100vh';

                            console.log(' Forced 1500px layout applied for all screen sizes with LEFT alignment');
                        }
                    }

                    // Run layout adjustment on window resize
                    window.addEventListener('resize', adjustLayoutForScreenSize);

                    // Also run on initial page load
                    window.addEventListener('load', adjustLayoutForScreenSize);

                    // CRITICAL FIX: Ensure sidebar is hidden after all resources load
                    window.addEventListener('load', function () {
                        setTimeout(() => {
                            const rightSidebar = document.querySelector('.right-sidebar');
                            const appContainer = document.querySelector('.app-container');

                            if (rightSidebar) {
                                // Force hide sidebar after page load
                                rightSidebar.classList.remove('sidebar-open', 'ultra-wide-open', 'mobile-open');
                                rightSidebar.style.transform = 'translateX(200%)';
                                rightSidebar.style.visibility = 'hidden';
                                rightSidebar.style.opacity = '0';
                                rightSidebar.style.pointerEvents = 'none';
                                rightSidebar.style.display = 'none';
                                console.log(' Sidebar forcefully hidden after page load');
                            }

                            if (appContainer) {
                                // Ensure app container is not expanded
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                                console.log(' App container set to sidebar-closed after page load');
                            }
                        }, 200); // Slightly longer delay to ensure everything is loaded
                    });
                    document.addEventListener('DOMContentLoaded', function () {
                        // Initialize modal cleanup to prevent stuck overlays
                        initializeModalCleanup();
                        initMessageBoxes();
                        loadNotes();
                        loadTemplates();
                        loadDocuments(); // Load common documents on page load
                        loadTicketClaimDocs(); // Load claim documents on main ticket page
                        setupStatusDropdown();
                        setupAttachmentHandlers(); // Setup attachment handling
                        setupQuickResponseDropdown(); // Setup quick response dropdown
                        initializeStatusButton(); // Initialize status button styling

                        // ===== VEHICLE & CLAIM MODAL EVENT LISTENERS =====
                        const editVehicleBtn = document.getElementById('editVehicleInfoBtn');
                        if (editVehicleBtn) {
                            editVehicleBtn.addEventListener('click', openVehicleClaimModal);
                        }

                        const closeVehicleClaimBtn = document.getElementById('closeVehicleClaimModal');
                        if (closeVehicleClaimBtn) {
                            closeVehicleClaimBtn.addEventListener('click', () => closeModal('vehicleClaimModal'));
                        }

                        const cancelVehicleClaimBtn = document.getElementById('cancelVehicleClaim');
                        if (cancelVehicleClaimBtn) {
                            cancelVehicleClaimBtn.addEventListener('click', () => closeModal('vehicleClaimModal'));
                        }

                        const saveVehicleClaimBtn = document.getElementById('saveVehicleClaim');
                        if (saveVehicleClaimBtn) {
                            saveVehicleClaimBtn.addEventListener('click', saveVehicleClaimInfo);
                        }

                        const uploadClaimDocBtn = document.getElementById('uploadClaimDocBtn');
                        if (uploadClaimDocBtn) {
                            uploadClaimDocBtn.addEventListener('click', uploadClaimDocument);
                        }

                        // Make upload zone clickable to trigger file input
                        const uploadZone = document.querySelector('#vehicleClaimModal .upload-zone');
                        const claimFileInput = document.getElementById('claimDocumentFile');

                        if (uploadZone && claimFileInput) {
                            // Style the upload zone for clickability
                            uploadZone.style.cursor = 'pointer';

                            // Click on zone triggers file input
                            uploadZone.addEventListener('click', function (e) {
                                e.preventDefault();
                                claimFileInput.click();
                            });

                            // Show selected file name
                            claimFileInput.addEventListener('change', function () {
                                const files = this.files;
                                if (files.length > 0) {
                                    const fileNames = Array.from(files).map(f => f.name).join(', ');
                                    // Update the upload zone text to show selected files
                                    const textSpan = uploadZone.querySelector('span:first-of-type');
                                    if (textSpan) {
                                        textSpan.textContent = files.length === 1 ? files[0].name : `${files.length} files selected`;
                                        textSpan.style.color = '#10b981'; // Green color for success
                                    }
                                }
                            });
                        }

                        // Initialize fixed-width layout for consistent appearance across screen sizes
                        adjustLayoutForScreenSize();

                        // Initialize sidebar functionality
                        initializeSidebarToggle();

                        // CRITICAL FIX: Ensure sidebar is hidden on page load
                        setTimeout(() => {
                            const rightSidebar = document.querySelector('.right-sidebar');
                            const appContainer = document.querySelector('.app-container');

                            if (rightSidebar) {
                                // Force hide sidebar on page load
                                rightSidebar.classList.remove('sidebar-open', 'ultra-wide-open', 'mobile-open');
                                rightSidebar.style.transform = 'translateX(200%)';
                                rightSidebar.style.visibility = 'hidden';
                                rightSidebar.style.opacity = '0';
                                rightSidebar.style.pointerEvents = 'none';
                                console.log(' Sidebar forcefully hidden on page load');
                            }

                            if (appContainer) {
                                // Ensure app container is not expanded
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                                console.log(' App container set to sidebar-closed on page load');
                            }
                        }, 100); // Small delay to ensure DOM is fully ready

                        // Add note button
                        document.getElementById('addNoteBtn').addEventListener('click', function () {
                            document.getElementById('saveNote').removeAttribute('data-note-index');
                            document.getElementById('noteTitle').value = '';
                            document.getElementById('noteContent').value = '';
                            openModal('noteModal');
                        });

                        // Save note button
                        document.getElementById('saveNote').addEventListener('click', saveNote);

                        // Note modal buttons
                        document.getElementById('closeNoteModal').addEventListener('click', () => closeModal('noteModal'));
                        document.getElementById('cancelNote').addEventListener('click', () => closeModal('noteModal'));

                        // Add template button
                        document.getElementById('addTemplateBtn').addEventListener('click', () => editTemplate());

                        // Edit template modal buttons
                        document.getElementById('closeEditTemplateModal').addEventListener('click', () => closeModal('editTemplateModal'));
                        document.getElementById('cancelEditTemplate').addEventListener('click', () => closeModal('editTemplateModal'));
                        document.getElementById('saveTemplate').addEventListener('click', saveTemplate);
                        document.getElementById('deleteTemplate').addEventListener('click', deleteTemplate);

                        // Document Modal
                        const addDocumentBtn = document.getElementById('addDocumentBtn');

                        const closeDocumentModal = document.getElementById('closeDocumentModal');
                        const cancelDocumentBtn = document.getElementById('cancelDocument');
                        const saveDocumentBtn = document.getElementById('saveDocument');
                        const deleteDocumentBtn = document.getElementById('deleteDocument');

                        if (addDocumentBtn) {
                            addDocumentBtn.addEventListener('click', () => {
                                document.getElementById('documentName').value = '';
                                document.getElementById('documentType').value = 'form';
                                document.getElementById('documentFile').value = '';
                                document.getElementById('selectedFileName').textContent = 'No file selected';
                                document.getElementById('documentDescription').value = '';
                                document.getElementById('documentModalTitle').textContent = 'Add New Document';
                                document.getElementById('deleteDocument').classList.add('hidden');
                                document.getElementById('saveDocument').removeAttribute('data-document-id');
                                openModal('documentModal');
                            });
                        }



                        if (closeDocumentModal) {
                            closeDocumentModal.addEventListener('click', () => closeModal('documentModal'));
                        }
                        if (cancelDocumentBtn) {
                            cancelDocumentBtn.addEventListener('click', () => closeModal('documentModal'));
                        }

                        if (saveDocumentBtn) {
                            saveDocumentBtn.addEventListener('click', saveDocument);
                        }

                        if (deleteDocumentBtn) {
                            deleteDocumentBtn.addEventListener('click', () => {
                                const documentId = document.getElementById('saveDocument').getAttribute('data-document-id');
                                if (documentId) {
                                    deleteDocument(documentId);
                                } else {
                                    showNotification('No document selected for deletion', 'error');
                                }
                            });
                        }

                        // Handle file input change event
                        document.getElementById('documentFile').addEventListener('change', function () {
                            const fileName = this.files.length > 0 ? this.files[0].name : 'No file selected';
                            document.getElementById('selectedFileName').textContent = fileName;
                        });

                        // Close Ticket Button functionality (following the same pattern as forward/takeover)
                        const closeResolvedBtn = document.getElementById('closeResolvedBtn');
                        const cancelCloseBtn = document.getElementById('cancelClose');
                        const confirmCloseBtn = document.getElementById('confirmClose');

                        if (closeResolvedBtn) {
                            closeResolvedBtn.addEventListener('click', () => {
                                console.log(' Close button clicked');
                                openModal('confirmModal');
                            });
                        }

                        if (cancelCloseBtn) {
                            cancelCloseBtn.addEventListener('click', () => closeModal('confirmModal'));
                        }

                        if (confirmCloseBtn) {
                            confirmCloseBtn.addEventListener('click', async () => {
                                console.log(' Close confirmation clicked');

                                try {
                                    // Show loading state
                                    confirmCloseBtn.disabled = true;
                                    confirmCloseBtn.innerHTML = ' Closing...';

                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/close`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Accept': 'application/json'
                                        }
                                    });

                                    const data = await response.json();
                                    console.log('Debug: Response status:', response.status);
                                    console.log('Debug: Response data:', data);

                                    if (!response.ok) {
                                        throw new Error(data.message || 'Failed to close ticket');
                                    }

                                    // Use backend message or default (same pattern as takeover)
                                    const successMessage = data.message || ' Ticket closed successfully!';
                                    showNotification(successMessage, 'success');

                                    // SUCCESS STATE: Show success button state before reload
                                    confirmCloseBtn.disabled = false;
                                    confirmCloseBtn.innerHTML = ' Ticket Closed!';
                                    confirmCloseBtn.style.backgroundColor = '#dcfce7';
                                    confirmCloseBtn.style.color = '#166534';

                                    closeModal('confirmModal');

                                    // Update UI similar to takeover button
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);

                                } catch (error) {
                                    console.error(' Error closing ticket:', error);
                                    showNotification(error.message || 'Failed to close ticket', 'error');

                                    // Reset button state
                                    confirmCloseBtn.disabled = false;
                                    confirmCloseBtn.innerHTML = 'Confirm Close';
                                }
                            });
                        }

                        // Message Modal
                        const closeMessageModal = document.getElementById('closeMessageModal');
                        if (closeMessageModal) {
                            closeMessageModal.addEventListener('click', () => closeModal('messageModal'));
                        }

                        // Assignment Modal Variables
                        const assignModal = document.getElementById('assignModal');
                        const assignModalTitle = document.getElementById('assignModalTitle');
                        const closeAssignModal = document.getElementById('closeAssignModal');
                        const cancelAssign = document.getElementById('cancelAssign');
                        const confirmAssign = document.getElementById('confirmAssign');
                        const assignMemberSelect = document.getElementById('assignMemberSelect');
                        const forwardNotesContainer = document.getElementById('forwardNotesContainer');
                        const assignNotes = document.getElementById('assignNotes');
                        const ticketId = '{{ ticket.ticket_id }}';
                        const currentUserId = "{{ session.member_id }}";

                        // Take Over Button - FIXED with proper error recovery
                        const takeOverBtn = document.getElementById('takeOverBtn');
                        if (takeOverBtn) {
                            takeOverBtn.addEventListener('click', async function () {
                                // Prevent double clicks
                                takeOverBtn.disabled = true;
                                const originalText = takeOverBtn.innerHTML;
                                takeOverBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Taking Over...';

                                // ALWAYS reset button after 15 seconds as safety fallback
                                const safetyTimeout = setTimeout(() => {
                                    console.log(' SAFETY TIMEOUT: Resetting button after 15 seconds');
                                    takeOverBtn.disabled = false;
                                    takeOverBtn.innerHTML = originalText;
                                    showNotification('Takeover may have completed. Please refresh the page to check.', 'warning');
                                }, 15000);

                                try {
                                    const requestData = {
                                        assigned_to: currentUserId,
                                        note: '',
                                        is_forwarded: false,
                                        forwarded_from: null
                                    };

                                    console.log(' TAKEOVER ATTEMPT:', { ticketId, currentUserId });

                                    const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(requestData),
                                        credentials: 'include'
                                    });

                                    const data = await response.json();
                                    console.log(' TAKEOVER RESPONSE:', data);

                                    if (response.ok && data.status === 'success') {
                                        clearTimeout(safetyTimeout); // Cancel safety timeout
                                        showNotification(' Ticket taken over successfully!', 'success');

                                        // SUCCESS: Show success state briefly, then reload
                                        takeOverBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Taken Over!';
                                        takeOverBtn.style.backgroundColor = '#dcfce7';
                                        takeOverBtn.style.color = '#166534';

                                        // Simple reload after success
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 2000);

                                    } else {
                                        clearTimeout(safetyTimeout); // Cancel safety timeout
                                        // Re-enable button on error
                                        takeOverBtn.disabled = false;
                                        takeOverBtn.innerHTML = originalText;
                                        showNotification(data.message || 'Error taking over ticket', 'error');
                                        console.error(' TAKEOVER ERROR:', data);
                                    }
                                } catch (error) {
                                    clearTimeout(safetyTimeout); // Cancel safety timeout
                                    // Re-enable button on exception
                                    takeOverBtn.disabled = false;
                                    takeOverBtn.innerHTML = originalText;
                                    console.error(' TAKEOVER EXCEPTION:', error);
                                    showNotification('Network error while taking over ticket', 'error');
                                }
                            });
                        }

                        // Refer to Tech Director Button - Direct API call
                        const referToTechDirectorBtn = document.getElementById('referToTechDirectorBtn');
                        if (referToTechDirectorBtn) {
                            referToTechDirectorBtn.addEventListener('click', async function () {
                                // Show confirmation dialog
                                if (!confirm('Are you sure you want to refer this ticket to the Technical Director?\n\nThis will:\n Change ticket status to "Referred to Tech Director"\n Send email notification to Tech Director\n Schedule AI-powered reminder via n8n workflow\n\nClick OK to proceed.')) {
                                    return;
                                }

                                // Disable button to prevent double-clicks
                                referToTechDirectorBtn.disabled = true;
                                referToTechDirectorBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Referring...';

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/tech-director`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' }
                                    });

                                    const data = await response.json();

                                    if (response.ok && data.status === 'success') {
                                        showNotification(` Ticket successfully referred to Tech Director!\n Real-time Mode: ${data.real_time_mode ? 'Active' : 'Inactive'}\n Webhook: ${data.webhook_queued ? 'Queued' : 'Failed'}\n Email: ${data.email_sent ? 'Sent' : 'Failed'}`, 'success');

                                        // Log the response for debugging
                                        console.log(' Tech Director Referral Success (Real-time):', data);

                                        // REAL-TIME STATUS UPDATE: Update the ticket status to "Referred to Tech Director"
                                        const newStatus = 'Referred to Tech Director';
                                        const oldStatus = '{{ ticket.status }}';
                                        const newStatusClass = newStatus.toLowerCase().replace(/ /g, '-').replace(//g, '');

                                        // Update ALL status badges on the page
                                        const allStatusBadges = document.querySelectorAll('[class*="status-"]');
                                        allStatusBadges.forEach(badge => {
                                            if (badge.textContent === oldStatus || badge.textContent.includes(oldStatus)) {
                                                badge.textContent = newStatus;
                                                badge.className = `px-3 py-1 text-xs rounded-lg font-medium status-${newStatusClass}`;
                                            }
                                        });

                                        // Update status dropdown button text
                                        const statusDisplay = document.getElementById('currentStatusDisplay');
                                        if (statusDisplay) {
                                            statusDisplay.textContent = newStatus;
                                        }

                                        // Update the status dropdown button styling
                                        const statusDropdownBtn = document.getElementById('statusDropdownBtn');
                                        if (statusDropdownBtn) {
                                            statusDropdownBtn.className = statusDropdownBtn.className.replace(/status-\S+/g, '');
                                            statusDropdownBtn.classList.add(`status-${newStatusClass}`);
                                        }

                                        // Update any other status-related elements
                                        const statusElements = document.querySelectorAll('[data-status]');
                                        statusElements.forEach(element => {
                                            if (element.textContent === oldStatus) {
                                                element.textContent = newStatus;
                                            }
                                        });

                                        // Update the Refer to Tech Director button to show "Currently with Tech Director"
                                        referToTechDirectorBtn.disabled = false;
                                        referToTechDirectorBtn.innerHTML = '<i class="fas fa-check-circle mr-1 text-green-600"></i> Successfully Referred!';
                                        referToTechDirectorBtn.classList.add('bg-green-100', 'text-green-800');
                                        referToTechDirectorBtn.classList.remove('bg-orange-100', 'text-orange-800');

                                        // After 3 seconds, change to "Currently with Tech Director" state
                                        setTimeout(() => {
                                            referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Currently with Tech Director';
                                            referToTechDirectorBtn.classList.remove('bg-green-100', 'text-green-800');
                                            referToTechDirectorBtn.classList.add('bg-orange-50', 'text-orange-700', 'border', 'border-orange-200');
                                            referToTechDirectorBtn.disabled = true;
                                        }, 3000);
                                    } else {
                                        showNotification(data.message || 'Error referring ticket to Tech Director', 'error');

                                        // Re-enable button on error
                                        referToTechDirectorBtn.disabled = false;
                                        referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Refer to Tech Director';
                                    }
                                } catch (error) {
                                    console.error(' Tech Director Referral Error:', error);
                                    showNotification('An error occurred while referring ticket to Tech Director', 'error');

                                    // Re-enable button on error
                                    referToTechDirectorBtn.disabled = false;
                                    referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Refer to Tech Director';
                                }
                            });
                        }

                        // Forward Button - DUPLICATE LISTENER REMOVED
                        // This was conflicting with the main forward modal listener at line ~9294
                        // const forwardBtn = document.getElementById('forwardBtn');
                        // if (forwardBtn) { ... }

                        // Close assign modal
                        function closeAssignModalFunc() {
                            assignModal.classList.remove('active');
                        }

                        if (closeAssignModal) closeAssignModal.addEventListener('click', closeAssignModalFunc);
                        if (cancelAssign) cancelAssign.addEventListener('click', closeAssignModalFunc);

                        // Confirm assignment (only for forwarding - Take Over bypasses modal)
                        if (confirmAssign) {
                            confirmAssign.addEventListener('click', async function () {
                                const memberId = assignMemberSelect.value;
                                const notes = assignNotes.value;

                                if (!memberId) {
                                    showNotification('Please select a member to forward to', 'error');
                                    return;
                                }

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            assigned_to: memberId,
                                            note: notes,
                                            is_forwarded: true,
                                            forwarded_from: currentUserId
                                        }),
                                        credentials: 'include'
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        // SMOOTH: Update assignment display instead of full reload
                                        const takeOverBtn = document.getElementById('takeOverBtn');
                                        if (takeOverBtn) {
                                            takeOverBtn.style.display = 'none';
                                        }

                                        // Add assignment badge
                                        const assignmentArea = document.querySelector('.assignment-status-area') || document.querySelector('.px-3.py-1.rounded-lg');
                                        if (assignmentArea) {
                                            assignmentArea.innerHTML = `
                                    <div class="px-3 py-1 rounded-lg bg-blue-50 text-blue-700 border border-blue-200">
                                        <i class="fas fa-share mr-1"></i> Forwarded to ${assignMemberSelect.options[assignMemberSelect.selectedIndex].text}
                                        <span class="text-xs opacity-75 ml-1">(just now)</span>
                                    </div>
                                `;
                                        }

                                        closeModal('assignModal');
                                        showNotification('Ticket forwarded successfully!', 'success');
                                    } else {
                                        showNotification(data.message || 'Error forwarding ticket', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    showNotification('An error occurred while forwarding ticket', 'error');
                                }
                            });
                        }

                        // Importance Button
                        const importantBtn = document.getElementById('importantBtn');
                        if (importantBtn) {
                            importantBtn.addEventListener('click', async function () {
                                try {
                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/important`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' }
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        importantBtn.classList.toggle('important');
                                        const icon = importantBtn.querySelector('.star-icon i');

                                        if (icon.classList.contains('far')) {
                                            // Change from empty star to filled star
                                            icon.classList.remove('far');
                                            icon.classList.add('fas');
                                            showNotification('Ticket marked as important');
                                        } else {
                                            // Change from filled star to empty star
                                            icon.classList.remove('fas');
                                            icon.classList.add('far');
                                            showNotification('Ticket importance removed');
                                        }
                                    } else {
                                        showNotification(data.message || 'Error toggling important status', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    showNotification('An error occurred while updating ticket status', 'error');
                                }
                            });
                        }



                        // Reply Form - COMPLETELY PREVENT MULTIPLE SUBMISSIONS
                        const replyForm = document.getElementById('replyForm');
                        if (replyForm) {
                            // Global flag to prevent multiple submissions
                            let isSubmitting = false;

                            // Remove ALL existing event listeners by replacing the form
                            const newReplyForm = replyForm.cloneNode(true);
                            replyForm.parentNode.replaceChild(newReplyForm, replyForm);

                            // Get fresh references after replacement
                            const freshForm = document.getElementById('replyForm');
                            const sendBtn = document.getElementById('sendBtn');
                            const responseTextarea = document.querySelector('textarea[name="response"]');

                            // MESSAGE PRESERVATION: Save and restore message content
                            const ticketId = '{{ ticket.ticket_id|e }}';
                            const messageKey = 'ticket_' + ticketId + '_message';

                            // Restore saved message on page load
                            const savedMessage = localStorage.getItem(messageKey);
                            if (savedMessage && !responseTextarea.value.trim()) {
                                responseTextarea.value = savedMessage;
                            }

                            // Save message as user types
                            const responseEditor = document.getElementById('response_editor');

                            if (responseEditor) {
                                // Initialize from textarea if exists
                                if (savedMessage && !responseEditor.innerText.trim()) {
                                    responseEditor.innerText = savedMessage;
                                }

                                responseEditor.addEventListener('input', function () {
                                    // Sync to hidden textarea
                                    responseTextarea.value = this.innerText;

                                    if (this.innerText.trim()) {
                                        localStorage.setItem(messageKey, this.innerText);
                                    } else {
                                        localStorage.removeItem(messageKey);
                                    }
                                });
                            } else {
                                responseTextarea.addEventListener('input', function () {
                                    if (this.value.trim()) {
                                        localStorage.setItem(messageKey, this.value);
                                    } else {
                                        localStorage.removeItem(messageKey);
                                    }
                                });
                            }

                            // SINGLE event listener with aggressive anti-spam protection
                            freshForm.addEventListener('submit', async function (e) {
                                e.preventDefault();
                                e.stopPropagation();



                                // ABSOLUTE PREVENTION OF MULTIPLE SUBMISSIONS
                                if (isSubmitting || sendBtn.disabled) {

                                    return false;
                                }

                                // Validate input
                                if (!responseTextarea.value.trim()) {
                                    alert('Please enter a response');
                                    return false;
                                }

                                // SET GLOBAL FLAG AND DISABLE EVERYTHING
                                isSubmitting = true;
                                sendBtn.disabled = true;
                                sendBtn.style.pointerEvents = 'none';
                                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';



                                try {
                                    // Sync contenteditable to textarea just before submitting
                                    const responseEditor = document.getElementById('response_editor');
                                    if (responseEditor) {
                                        responseTextarea.value = responseEditor.innerText;
                                    }

                                    // Create FormData object to handle both text and file attachments
                                    const formData = new FormData();
                                    formData.append('response', responseTextarea.value);

                                    // ENHANCED: Add files from the new drag & drop attachment system
                                    if (window.currentAttachments && window.currentAttachments.length > 0) {
                                        console.log(` Processing ${window.currentAttachments.length} enhanced attachments`);

                                        // Process enhanced attachments with proper file handling
                                        for (let i = 0; i < window.currentAttachments.length; i++) {
                                            const attachment = window.currentAttachments[i];

                                            if (attachment.type === 'file') {
                                                // Handle uploaded files - they have actual file data
                                                formData.append('response_attachments', attachment.file);
                                                console.log(` Added file attachment: ${attachment.name}`);
                                            } else if (attachment.type === 'common_document') {
                                                //  ENHANCED: Use already-fetched file data from drag & drop
                                                if (attachment.file && attachment.file.size > 0) {
                                                    // File data was already fetched during drag & drop
                                                    formData.append('response_attachments', attachment.file);
                                                    console.log(` Using pre-fetched file data for common document: ${attachment.name} (Size: ${attachment.file.size} bytes)`);
                                                } else {
                                                    // Fallback: fetch file data now (shouldn't happen with enhanced system)
                                                    console.log(` Fallback: Fetching file data for common document: ${attachment.name} (ID: ${attachment.documentId})`);
                                                    try {
                                                        const response = await fetch(`/api/common-documents/${attachment.documentId}/download`);
                                                        if (response.ok) {
                                                            const blob = await response.blob();
                                                            const file = new File([blob], attachment.name, {
                                                                type: attachment.fileType || 'application/octet-stream'
                                                            });
                                                            formData.append('response_attachments', file);
                                                            console.log(` Successfully converted common document to file: ${attachment.name}`);
                                                        } else {
                                                            console.error(` Failed to fetch common document: ${attachment.name}`);
                                                            // Fallback: add as common document reference
                                                            formData.append(`common_document_${i}`, attachment.documentId);
                                                            formData.append(`common_document_name_${i}`, attachment.name);
                                                        }
                                                    } catch (error) {
                                                        console.error(` Error processing common document ${attachment.name}:`, error);
                                                        // Fallback: add as common document reference
                                                        formData.append(`common_document_${i}`, attachment.documentId);
                                                        formData.append(`common_document_name_${i}`, attachment.name);
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    // ENHANCED: Only use the new drag & drop system - remove legacy conflicts
                                    // The new system handles both files and common documents seamlessly

                                    // Debug logging to see what's being sent
                                    console.log(' DEBUG: Enhanced attachments to be sent:', window.currentAttachments);

                                    // Log the final FormData contents
                                    for (let [key, value] of formData.entries()) {
                                        console.log(` FormData: ${key} = ${value}`);
                                    }

                                    // Legacy attachedFiles system removed - enhanced system handles everything

                                    // Add common documents as attachments
                                    const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                                    if (commonDocumentPreview && commonDocumentPreview.children.length > 0) {


                                        for (let i = 0; i < commonDocumentPreview.children.length; i++) {
                                            const docItem = commonDocumentPreview.children[i];
                                            const documentId = docItem.dataset.documentId;
                                            const documentName = docItem.querySelector('span').textContent;



                                            if (documentId) {
                                                // Add document reference to form data in the format expected by backend
                                                formData.append(`common_document_${i}`, documentId);
                                                formData.append(`common_document_name_${i}`, documentName);

                                                // ENHANCED: Add all document metadata to form data for debugging
                                                if (docItem.dataset.documentType) formData.append(`common_document_type_${i}`, docItem.dataset.documentType);
                                                if (docItem.dataset.documentDescription) formData.append(`common_document_description_${i}`, docItem.dataset.documentDescription);
                                                if (docItem.dataset.documentFileName) formData.append(`common_document_filename_${i}`, docItem.dataset.documentFileName);
                                                if (docItem.dataset.documentFileSize) formData.append(`common_document_filesize_${i}`, docItem.dataset.documentFileSize);
                                                if (docItem.dataset.documentFilePath) formData.append(`common_document_filepath_${i}`, docItem.dataset.documentFilePath);
                                                if (docItem.dataset.documentCreatedAt) formData.append(`common_document_created_${i}`, docItem.dataset.documentCreatedAt);
                                                if (docItem.dataset.documentUpdatedAt) formData.append(`common_document_updated_${i}`, docItem.dataset.documentUpdatedAt);
                                                if (docItem.dataset.documentIsActive) formData.append(`common_document_active_${i}`, docItem.dataset.documentIsActive);
                                                if (docItem.dataset.arrayIndex) formData.append(`common_document_arrayindex_${i}`, docItem.dataset.arrayIndex);


                                            }
                                        }

                                    } else {

                                    }



                                    // Send to main API endpoint
                                    const response = await fetch('/api/tickets/' + ticketId + '/reply', {
                                        method: 'POST',
                                        body: formData  // Use FormData instead of URLSearchParams
                                    });



                                    // Also send to n8n webhook (parallel processing)
                                    try {
                                        //  FIXED: Check if ticket was created from email using CORRECT message_id field
                                        const originalMessageId = '{{ ticket.message_id|default("", true) }}';
                                        const creationMethod = '{{ ticket.creation_method|default("", true) }}';

                                        // Email ticket detection: check if message_id exists and is NOT a system-generated ID
                                        const isRealEmailMessageId = originalMessageId && originalMessageId.trim() && !originalMessageId.startsWith('msg-');
                                        const isEmailTicket = creationMethod === 'email' || isRealEmailMessageId;

                                        //  PROCESS ATTACHMENTS for webhook payload
                                        const attachmentData = [];
                                        let totalFiles = 0;

                                        // ENHANCED: Process new drag & drop attachments first
                                        if (window.currentAttachments && window.currentAttachments.length > 0) {
                                            console.log(` Processing ${window.currentAttachments.length} enhanced attachments for webhook`);

                                            for (let i = 0; i < window.currentAttachments.length; i++) {
                                                const attachment = window.currentAttachments[i];

                                                if (attachment.type === 'file') {
                                                    // Process uploaded files
                                                    try {
                                                        const base64Data = await new Promise((resolve, reject) => {
                                                            const reader = new FileReader();
                                                            reader.onload = () => {
                                                                const base64 = reader.result.split(',')[1];
                                                                resolve(base64);
                                                            };
                                                            reader.onerror = reject;
                                                            reader.readAsDataURL(attachment.file);
                                                        });

                                                        attachmentData.push({
                                                            fileName: attachment.name,
                                                            fileData: base64Data,
                                                            size: attachment.size,
                                                            type: attachment.fileType,
                                                            isWarranty: attachment.name.toLowerCase().includes('warranty'),
                                                            source: 'enhanced_drag_drop'
                                                        });
                                                        totalFiles++;
                                                        console.log(` Enhanced file attachment: ${attachment.name} (${attachment.size} bytes)`);
                                                    } catch (error) {
                                                        console.error(` Failed to encode enhanced attachment ${attachment.name}:`, error);
                                                    }
                                                } else if (attachment.type === 'common_document') {
                                                    // Process common document references
                                                    attachmentData.push({
                                                        fileName: attachment.name,
                                                        documentId: attachment.documentId,
                                                        size: attachment.size,
                                                        type: attachment.fileType,
                                                        isWarranty: false,
                                                        source: 'enhanced_common_document',
                                                        isCommonDocument: true
                                                    });
                                                    totalFiles++;
                                                    console.log(` Enhanced common document: ${attachment.name} (ID: ${attachment.documentId})`);
                                                }
                                            }
                                        }

                                        // Process file input attachments (legacy support)
                                        if (fileInput && fileInput.files.length > 0) {

                                            totalFiles += fileInput.files.length;

                                            for (let i = 0; i < fileInput.files.length; i++) {
                                                const file = fileInput.files[i];
                                                try {
                                                    // Convert file to base64 for webhook payload
                                                    const base64Data = await new Promise((resolve, reject) => {
                                                        const reader = new FileReader();
                                                        reader.onload = () => {
                                                            // Remove data:mime/type;base64, prefix
                                                            const base64 = reader.result.split(',')[1];
                                                            resolve(base64);
                                                        };
                                                        reader.onerror = reject;
                                                        reader.readAsDataURL(file);
                                                    });

                                                    attachmentData.push({
                                                        fileName: file.name,
                                                        fileData: base64Data,
                                                        size: file.size,
                                                        type: file.type,
                                                        isWarranty: file.name.toLowerCase().includes('warranty')
                                                    });
                                                    console.log(` Encoded attachment: ${file.name} (${file.size} bytes)`);
                                                } catch (error) {
                                                    console.error(` Failed to encode attachment ${file.name}:`, error);
                                                }
                                            }
                                        }

                                        //  ENHANCED: Process attached files from enhanced attachment system
                                        if (window.currentAttachments && window.currentAttachments.length > 0) {
                                            console.log(` Processing ${window.currentAttachments.length} enhanced attachments for webhook`);

                                            for (let i = 0; i < window.currentAttachments.length; i++) {
                                                const attachment = window.currentAttachments[i];

                                                if (attachment.type === 'file' && attachment.file) {
                                                    // Handle uploaded files
                                                    try {
                                                        const base64Data = await new Promise((resolve, reject) => {
                                                            const reader = new FileReader();
                                                            reader.onload = () => {
                                                                const base64 = reader.result.split(',')[1];
                                                                resolve(base64);
                                                            };
                                                            reader.onerror = reject;
                                                            reader.readAsDataURL(attachment.file);
                                                        });

                                                        attachmentData.push({
                                                            fileName: attachment.name,
                                                            fileData: base64Data,  //  CRITICAL: This is what n8n expects
                                                            size: attachment.size,
                                                            type: attachment.fileType,
                                                            isWarranty: attachment.name.toLowerCase().includes('warranty')
                                                        });
                                                        totalFiles++;
                                                        console.log(` Encoded uploaded file: ${attachment.name} (${attachment.size} bytes)`);
                                                    } catch (error) {
                                                        console.error(` Failed to encode uploaded file ${attachment.name}:`, error);
                                                    }
                                                } else if (attachment.type === 'common_document' && attachment.file) {
                                                    // Handle common documents with file data
                                                    try {
                                                        const base64Data = await new Promise((resolve, reject) => {
                                                            const reader = new FileReader();
                                                            reader.onload = () => {
                                                                const base64 = reader.result.split(',')[1];
                                                                resolve(base64);
                                                            };
                                                            reader.onerror = reject;
                                                            reader.readAsDataURL(attachment.file);
                                                        });

                                                        attachmentData.push({
                                                            fileName: attachment.name,
                                                            fileData: base64Data,  //  CRITICAL: This is what n8n expects
                                                            size: attachment.size,
                                                            type: attachment.fileType,
                                                            isWarranty: attachment.name.toLowerCase().includes('warranty'),
                                                            isCommonDocument: true,
                                                            documentId: attachment.documentId
                                                        });
                                                        totalFiles++;
                                                        console.log(` Encoded common document: ${attachment.name} (${attachment.size} bytes)`);
                                                    } catch (error) {
                                                        console.error(` Failed to encode common document ${attachment.name}:`, error);
                                                    }
                                                }
                                            }
                                        }

                                        // Process common documents for webhook
                                        const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                                        let commonDocData = [];
                                        if (commonDocumentPreview && commonDocumentPreview.children.length > 0) {
                                            console.log(' Processing common documents for webhook...');
                                            commonDocumentPreview.querySelectorAll('[data-document-id]').forEach((item, index) => {
                                                const docId = item.dataset.documentId;
                                                const docName = item.querySelector('span').textContent;

                                                // ENHANCED DEBUGGING: Log all available data for webhook
                                                console.log(` Webhook Common Document ${index + 1}:`);
                                                console.log('  - Document ID:', docId);
                                                console.log('  - Document Name:', docName);
                                                console.log('  - Document Type:', item.dataset.documentType);
                                                console.log('  - Document Description:', item.dataset.documentDescription);
                                                console.log('  - Document File Name:', item.dataset.documentFileName);
                                                console.log('  - Document File Size:', item.dataset.documentFileSize);
                                                console.log('  - Document File Path:', item.dataset.documentFilePath);
                                                console.log('  - Document Created At:', item.dataset.documentCreatedAt);
                                                console.log('  - Document Updated At:', item.dataset.documentUpdatedAt);
                                                console.log('  - Document Is Active:', item.dataset.documentIsActive);
                                                console.log('  - Array Index:', item.dataset.arrayIndex);
                                                console.log('  - Full dataset:', item.dataset);

                                                commonDocData.push({
                                                    document_id: docId,
                                                    document_name: docName,
                                                    type: 'common_document',
                                                    // ENHANCED: Include all metadata for webhook debugging
                                                    document_type: item.dataset.documentType,
                                                    document_description: item.dataset.documentDescription,
                                                    document_filename: item.dataset.documentFileName,
                                                    document_filesize: item.dataset.documentFileSize,
                                                    document_filepath: item.dataset.documentFilePath,
                                                    document_created_at: item.dataset.documentCreatedAt,
                                                    document_updated_at: item.dataset.documentUpdatedAt,
                                                    document_is_active: item.dataset.documentIsActive,
                                                    array_index: item.dataset.arrayIndex
                                                });
                                            });
                                            console.log(' Common documents prepared for webhook:', commonDocData);
                                        }

                                        // Handle custom @VHC_Link tag replacement for emails
                                        // Keep HTML version for html_message reference only
                                        let html_message = responseTextarea.value.replace(/\n/g, '<br>\n');
                                        // Build CLEAN plain text: strip <br>, <a> tags, keep only text
                                        let message_plain = responseTextarea.value
                                            .replace(/<br\s*\/?>/gi, '\n')          // <br>  newline
                                            .replace(/<a\s+[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '$2 ($1)')  // <a href="URL">text</a>  text (URL)
                                            .replace(/<[^>]+>/g, '')               // strip remaining HTML tags
                                            .replace(/\n{3,}/g, '\n\n');           // clean excessive newlines
                                        const ticket_vhc_link = '{{ ticket.vhc_link|default("", true) }}';

                                        if (ticket_vhc_link) {
                                            const html_link = `<a href="${ticket_vhc_link}" target="_blank" style="color: #4f46e5; font-weight: 500; text-decoration: underline;">Vehicle Health Check  click here</a>`;
                                            const regex = /(@VHC_Link|\[VHC_LINK\])/gi;
                                            html_message = html_message.replace(regex, html_link);
                                            message_plain = message_plain.replace(regex, `Vehicle Health Check: ${ticket_vhc_link}`);
                                        }

                                        const webhookData = {
                                            ticket_id: '{{ ticket.ticket_id }}',
                                            response_text: message_plain,
                                            replyMessage: message_plain, // PLAIN TEXT  no HTML tags, N8N Gmail renders as-is
                                            html_message: html_message, // HTML version for reference only
                                            timestamp: new Date().toISOString(),
                                            user_id: '{{ session.member_id if session.member_id else "unknown" }}',
                                            ticket_subject: '{{ ticket.subject|default("", true) }}',
                                            subject: '{{ ticket.subject|default("", true) }}', //  ADDED: subject field for n8n compatibility
                                            ticket_status: '{{ ticket.status|default("", true) }}',
                                            customer_email: '{{ ticket.email|default("", true) }}',
                                            customer_name: '{{ ticket.name|default("", true) }}',
                                            priority: '{{ ticket.Priority|default("", true) }}',
                                            has_attachments: totalFiles > 0, //  Updated to reflect actual file count
                                            attachments: attachmentData, //  Include actual attachment data
                                            attachment_count: attachmentData.length, //  Explicit count
                                            has_common_documents: commonDocData.length > 0,
                                            common_documents: commonDocData,
                                            common_document_count: commonDocData.length,
                                            message_id: isRealEmailMessageId ? originalMessageId : false, // Send original email message ID or false
                                            is_email_ticket: isEmailTicket,
                                            creation_method: creationMethod || 'manual',
                                            ticketSource: isEmailTicket ? 'email' : 'manual' //  ADDED: ticketSource field for n8n compatibility
                                        };

                                        console.log(' SENDING TO N8N WEBHOOK:');
                                        console.log('    Original Message ID from DB:', originalMessageId);
                                        console.log('    Is Real Email Message ID:', isRealEmailMessageId);
                                        console.log('    Message ID being sent:', webhookData.message_id);
                                        console.log('    Is Email Ticket:', webhookData.is_email_ticket);
                                        console.log('    Creation Method:', webhookData.creation_method);
                                        console.log('    Total Files Found:', totalFiles);
                                        console.log('    Attachments Processed:', webhookData.attachment_count);
                                        console.log('    Has Attachments:', webhookData.has_attachments);
                                        if (webhookData.attachments && webhookData.attachments.length > 0) {
                                            webhookData.attachments.forEach((att, index) => {
                                                console.log(`    Attachment ${index + 1}: ${att.fileName} (${att.size} bytes, ${att.type})`);
                                                console.log(`    FileData Length: ${att.fileData ? att.fileData.length : 0} chars`);
                                                console.log(`    Has FileData: ${att.fileData ? 'YES' : 'NO'}`);
                                            });
                                        }
                                        console.log('    Has Common Documents:', webhookData.has_common_documents);
                                        console.log('    Common Document Count:', webhookData.common_document_count);
                                        if (webhookData.common_documents && webhookData.common_documents.length > 0) {
                                            webhookData.common_documents.forEach((doc, index) => {
                                                console.log(`    Common Document ${index + 1}: ${doc.document_name} (ID: ${doc.document_id}, Type: ${doc.document_type})`);
                                            });
                                        }
                                        console.log('    Full Payload:', webhookData);

                                        //  FIXED: Removed frontend webhook call to prevent duplicate webhooks
                                        // Backend already handles webhook triggering when reply is saved
                                        // This prevents automatic replies caused by double webhook firing
                                        console.log(' Skipping frontend webhook - backend will handle webhook triggering');
                                    } catch (webhookError) {
                                        console.error(' WEBHOOK PROCESSING ERROR:', webhookError);
                                        // Don't fail the main process if webhook processing fails
                                    }

                                    if (response.ok) {
                                        const data = await response.json();
                                        console.log(' SUCCESS RESPONSE:', data);

                                        // Clear saved message from localStorage since it was sent successfully
                                        localStorage.removeItem(messageKey);

                                        // Clear form immediately
                                        responseTextarea.value = '';
                                        const responseEditor = document.getElementById('response_editor');
                                        if (responseEditor) responseEditor.innerHTML = '';

                                        // Reset textarea height after clearing
                                        if (typeof window.autoExpandTextarea === 'function') {
                                            window.autoExpandTextarea(responseTextarea);
                                        }

                                        // Clear file input
                                        const fileInput = document.getElementById('response_attachments');
                                        if (fileInput) {
                                            fileInput.value = '';
                                        }

                                        //  REMOVED: Old attachment clearing - enhanced system handles this

                                        // ENHANCED: Clear new drag & drop attachments
                                        if (window.currentAttachments) {
                                            window.currentAttachments = [];
                                            console.log(' Cleared enhanced attachments');
                                        }

                                        // Hide enhanced attachment preview
                                        const enhancedAttachmentPreview = document.getElementById('enhancedAttachmentPreview');
                                        if (enhancedAttachmentPreview) {
                                            enhancedAttachmentPreview.classList.add('hidden');
                                            const attachmentPreviewList = document.getElementById('attachmentPreviewList');
                                            if (attachmentPreviewList) {
                                                attachmentPreviewList.innerHTML = '';
                                            }
                                        }

                                        // Hide attachment preview if visible (legacy support)
                                        const attachmentPreview = document.getElementById('attachmentPreview');
                                        if (attachmentPreview) {
                                            attachmentPreview.innerHTML = '';
                                            attachmentPreview.classList.add('hidden');
                                        }

                                        // Clear common documents
                                        const commonDocumentDropzone = document.getElementById('commonDocumentDropzone');
                                        const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                                        if (commonDocumentDropzone && commonDocumentPreview) {
                                            commonDocumentPreview.innerHTML = '';
                                            commonDocumentDropzone.classList.add('hidden');
                                        }

                                        // Clear processed documents tracking to allow re-adding documents
                                        processedDocuments.clear();
                                        console.log(' Form submitted - cleared processed documents tracking');

                                        // Show success and redirect quickly
                                        showNotification('Reply sent successfully! ', 'success');

                                        // Notify parent window (index page) that a reply was sent
                                        try {
                                            if (window.opener && !window.opener.closed) {
                                                window.opener.postMessage({
                                                    type: 'replySent',
                                                    ticketId: '{{ ticket.ticket_id }}',
                                                    timestamp: Date.now()
                                                }, '*');
                                            }

                                            // Also notify other tabs via localStorage
                                            localStorage.setItem('newReplyAdded', JSON.stringify({
                                                type: 'replySent',
                                                ticketId: '{{ ticket.ticket_id }}',
                                                timestamp: Date.now()
                                            }));

                                            // Clean up localStorage after a short delay
                                            setTimeout(() => {
                                                localStorage.removeItem('newReplyAdded');
                                            }, 5000);
                                        } catch (error) {
                                            console.log('Could not notify parent window:', error);
                                        }

                                        // NO RELOAD - Update UI dynamically
                                        setTimeout(() => {
                                            // Scroll to bottom
                                            const container = document.querySelector('.conversation-container');
                                            if (container) {
                                                container.scrollTop = container.scrollHeight;
                                                window.scrollTo(0, document.body.scrollHeight);
                                            }
                                        }, 100);
                                    } else {
                                        const error = await response.json();
                                        console.error(' API ERROR:', error);
                                        alert('Error: ' + error.message);
                                    }
                                } catch (err) {
                                    console.error(' NETWORK ERROR:', err);
                                    alert('An error occurred while sending the response');
                                } finally {
                                    // Reset flags and button after delay to prevent rapid resubmission
                                    // Keep message in localStorage for retry if sending failed
                                    setTimeout(() => {
                                        isSubmitting = false;
                                        sendBtn.disabled = false;
                                        sendBtn.style.pointerEvents = 'auto';
                                        sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send Response';
                                        console.log(' RESET - Ready for next submission');
                                    }, 2000);
                                }

                                return false;
                            }, { once: false });

                            // Additional protection - remove any other submit handlers
                            freshForm.onsubmit = null;

                            console.log(' REPLY FORM INITIALIZED - Anti-spam protection active');
                        }

                        // Click handler for expanding original message in modal
                        const originalMessage = document.getElementById('originalMessage');
                        if (originalMessage) {
                            originalMessage.addEventListener('click', function (e) {
                                if (e.target.classList.contains('read-more-btn')) return;
                                if (this.classList.contains('truncated')) {
                                    const modalContent = document.getElementById('modalMessageContent');
                                    modalContent.textContent = this.textContent.trim();
                                    openModal('messageModal');
                                }
                            });
                        }

                        // Click handler for expanding reply messages in modal
                        document.querySelectorAll('.reply-message-box').forEach(box => {
                            box.addEventListener('click', function (e) {
                                if (e.target.classList.contains('expand-btn')) return;
                                if (this.classList.contains('truncated')) {
                                    const modalContent = document.getElementById('modalMessageContent');
                                    modalContent.textContent = this.querySelector('.message-content').textContent.trim();
                                    openModal('messageModal');
                                }
                            });
                        });
                    });

                    // Handle file input change event
                    document.getElementById('documentFile').addEventListener('change', function () {
                        const fileName = this.files.length > 0 ? this.files[0].name : 'No file selected';
                        document.getElementById('selectedFileName').textContent = fileName;
                    });

                    // Set up communication with index page
                    function setupIndexPageCommunication() {
                        // Listen for messages from index page
                        window.addEventListener('message', function (event) {
                            if (event.data && event.data.type === 'establishCommunication') {
                                console.log(' Communication established with index page');

                                // Send confirmation back
                                try {
                                    if (event.source && !event.source.closed) {
                                        event.source.postMessage({
                                            type: 'communicationEstablished',
                                            ticketId: '{{ ticket.ticket_id }}',
                                            timestamp: Date.now()
                                        }, '*');
                                    }
                                } catch (error) {
                                    console.log('Could not send confirmation to index page');
                                }
                            }
                        });

                        // Notify index page when this page loads
                        try {
                            if (window.opener && !window.opener.closed) {
                                window.opener.postMessage({
                                    type: 'ticketDetailPageLoaded',
                                    ticketId: '{{ ticket.ticket_id }}',
                                    timestamp: Date.now()
                                }, '*');
                            }
                        } catch (error) {
                            console.log('Could not notify index page of load');
                        }
                    }

                    // Initialize communication
                    setupIndexPageCommunication();

                    // Enhanced Response attachment handling with drag & drop
                    function setupAttachmentHandlers() {
                        console.log('Setting up enhanced attachment handlers with drag & drop');
                        const dropzone = document.getElementById('replyDropzone');
                        const fileInput = document.getElementById('response_attachments');
                        const enhancedAttachmentPreview = document.getElementById('enhancedAttachmentPreview');
                        const attachmentPreviewList = document.getElementById('attachmentPreviewList');
                        const replyForm = document.getElementById('replyForm');
                        const textarea = document.getElementById('response');
                        const responseArea = textarea.parentElement;

                        // Global attachment storage
                        window.currentAttachments = [];

                        // Enhanced drag & drop functionality
                        function setupEnhancedDragAndDrop() {
                            // Make the entire dropzone a drag target
                            dropzone.addEventListener('dragover', function (e) {
                                e.preventDefault();
                                dropzone.classList.add('border-blue-400', 'bg-blue-50');
                                dropzone.style.transform = 'scale(1.01)';
                            });

                            dropzone.addEventListener('dragleave', function (e) {
                                e.preventDefault();
                                dropzone.classList.remove('border-blue-400', 'bg-blue-50');
                                dropzone.style.transform = 'scale(1)';
                            });

                            dropzone.addEventListener('drop', function (e) {
                                e.preventDefault();
                                dropzone.classList.remove('border-blue-400', 'bg-blue-50');
                                dropzone.style.transform = 'scale(1)';

                                console.log('Drop detected in enhanced dropzone');

                                // Handle file drops
                                if (e.dataTransfer.files.length > 0) {
                                    console.log('Files dropped:', e.dataTransfer.files.length);
                                    handleFileDrop(e.dataTransfer.files);
                                }

                                // Handle common document drops
                                if (e.dataTransfer.getData('text')) {
                                    try {
                                        const docData = JSON.parse(e.dataTransfer.getData('text'));
                                        console.log(' RAW DROP DATA PARSED:', docData);
                                        if (docData && docData.type === 'common-document') {
                                            console.log(' Common document dropped in dropzone:', docData);
                                            console.log(' Document ID fields:', {
                                                _id: docData._id,
                                                id: docData.id,
                                                index: docData.index
                                            });
                                            handleCommonDocumentDrop(docData);
                                        }
                                    } catch (err) {
                                        console.error('Error parsing dropped document data:', err);
                                    }
                                }
                            });
                        }

                        // Handle file drops
                        function handleFileDrop(files) {
                            Array.from(files).forEach(file => {
                                if (isValidFile(file)) {
                                    const attachment = {
                                        id: generateAttachmentId(),
                                        type: 'file',
                                        file: file,
                                        name: file.name,
                                        size: file.size,
                                        fileType: file.type || getFileTypeFromName(file.name)
                                    };
                                    addAttachmentToPreview(attachment);
                                }
                            });
                        }

                        // Handle common document drops
                        async function handleCommonDocumentDrop(docData) {
                            console.log(' Common document drop data received:', docData);
                            console.log(' Document data structure:', {
                                _id: docData._id,
                                id: docData.id,
                                index: docData.index,
                                name: docData.name,
                                type: docData.type
                            });

                            try {
                                //  FETCH ACTUAL FILE DATA FROM DATABASE
                                const documentId = docData._id || docData.id || docData.index;
                                console.log(' Fetching file data for common document:', docData.name, '(ID:', documentId + ')');

                                if (!documentId) {
                                    throw new Error('Document ID not found in document data');
                                }

                                const response = await fetch(`/api/common-documents/${documentId}/download`, { credentials: 'include' });

                                if (!response.ok) {
                                    throw new Error(`Failed to fetch document: ${response.status} ${response.statusText}`);
                                }

                                // Get the file as a blob to get actual size and content
                                const fileBlob = await response.blob();
                                console.log(' Successfully fetched file blob:', fileBlob);

                                // Create a File object from the blob
                                const fileName = docData.name || 'document';
                                const fileExtension = getFileExtensionFromMimeType(fileBlob.type) || getFileExtensionFromName(fileName);
                                const actualFileName = fileName.includes('.') ? fileName : `${fileName}.${fileExtension}`;

                                const file = new File([fileBlob], actualFileName, { type: fileBlob.type });
                                console.log(' Successfully converted common document to file:', file.name, 'Size:', file.size, 'Type:', file.type);

                                const attachment = {
                                    id: generateAttachmentId(),
                                    type: 'common_document',
                                    documentId: documentId,
                                    name: docData.name,
                                    size: file.size, //  ACTUAL FILE SIZE
                                    fileType: file.type, //  ACTUAL MIME TYPE
                                    file: file, //  ACTUAL FILE OBJECT
                                    originalDocData: docData // Keep reference to original data
                                };

                                console.log(' Created enhanced attachment object:', attachment);
                                addAttachmentToPreview(attachment);

                            } catch (error) {
                                console.error(' Error fetching common document file data:', error);

                                // Fallback: create attachment without file data
                                const attachment = {
                                    id: generateAttachmentId(),
                                    type: 'common_document',
                                    documentId: docData._id || docData.id || docData.index,
                                    name: docData.name,
                                    size: 0,
                                    fileType: docData.fileType || 'application/octet-stream',
                                    error: 'Failed to fetch file data'
                                };

                                console.log(' Created fallback attachment object:', attachment);
                                addAttachmentToPreview(attachment);
                            }
                        }

                        // Add attachment to preview
                        function addAttachmentToPreview(attachment) {
                            console.log(' Adding attachment to preview:', attachment);
                            window.currentAttachments.push(attachment);
                            console.log(' Current attachments array:', window.currentAttachments);
                            renderAttachmentPreview();
                            showEnhancedAttachmentPreview();
                        }

                        // Remove attachment from preview
                        function removeAttachment(attachmentId) {
                            window.currentAttachments = window.currentAttachments.filter(att => att.id !== attachmentId);
                            renderAttachmentPreview();
                            if (window.currentAttachments.length === 0) {
                                hideEnhancedAttachmentPreview();
                            }
                        }

                        // Render attachment preview
                        function renderAttachmentPreview() {
                            attachmentPreviewList.innerHTML = '';

                            window.currentAttachments.forEach(attachment => {
                                const attachmentCard = createAttachmentCard(attachment);
                                attachmentPreviewList.appendChild(attachmentCard);
                            });
                        }

                        // Create Modern Attachment Card
                        function createAttachmentCard(attachment) {
                            const card = document.createElement('div');
                            card.className = 'attachment-card-modern';
                            card.dataset.attachmentId = attachment.id;

                            // Get professional icon and color based on file type
                            const iconData = getModernFileIcon(attachment.fileType, attachment.name);
                            const size = formatFileSize(attachment.size);

                            // Status info with different badges
                            let statusBadge = '';
                            if (attachment.type === 'common_document') {
                                if (attachment.file && attachment.file.size > 0) {
                                    statusBadge = `<span class="status-badge success"><i class="fas fa-check-circle"></i> Ready</span>`;
                                } else if (attachment.error) {
                                    statusBadge = `<span class="status-badge error"><i class="fas fa-exclamation-circle"></i> Error</span>`;
                                } else {
                                    statusBadge = `<span class="status-badge loading"><i class="fas fa-spinner fa-spin"></i> Loading...</span>`;
                                }
                            } else {
                                statusBadge = `<span class="status-badge">${size}</span>`;
                            }

                            card.innerHTML = `
                        <div class="attachment-icon" style="background: ${iconData.background}; color: ${iconData.color};">
                            <i class="${iconData.icon}"></i>
                        </div>
                        <div class="attachment-info">
                            <div class="attachment-name" title="${attachment.name}">${attachment.name}</div>
                            <div class="attachment-meta">
                                ${statusBadge}
                                ${attachment.type === 'common_document' && attachment.file && attachment.file.size > 0 ? `<span class="file-size">${size}</span>` : ''}
                                ${attachment.fileType ? `<span class="file-type">${getFileTypeLabel(attachment.fileType)}</span>` : ''}
                            </div>
                        </div>
                        <button type="button" class="attachment-remove" onclick="removeAttachment('${attachment.id}')" title="Remove attachment">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

                            return card;
                        }

                        // Modern File Icon System
                        function getModernFileIcon(fileType, fileName = '') {
                            const ext = fileName.split('.').pop().toLowerCase();

                            // PDF
                            if (fileType.includes('pdf') || ext === 'pdf') {
                                return {
                                    icon: 'fas fa-file-pdf',
                                    color: '#ef4444',
                                    background: 'rgba(239, 68, 68, 0.12)'
                                };
                            }

                            // Word Documents
                            if (fileType.includes('word') || fileType.includes('document') || ['doc', 'docx'].includes(ext)) {
                                return {
                                    icon: 'fas fa-file-word',
                                    color: '#3b82f6',
                                    background: 'rgba(59, 130, 246, 0.12)'
                                };
                            }

                            // Excel/Spreadsheets
                            if (fileType.includes('excel') || fileType.includes('spreadsheet') || ['xls', 'xlsx', 'csv'].includes(ext)) {
                                return {
                                    icon: 'fas fa-file-excel',
                                    color: '#10b981',
                                    background: 'rgba(16, 185, 129, 0.12)'
                                };
                            }

                            // Images
                            if (fileType.includes('image') || ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(ext)) {
                                return {
                                    icon: 'fas fa-file-image',
                                    color: '#a855f7',
                                    background: 'rgba(168, 85, 247, 0.12)'
                                };
                            }

                            // Text Files
                            if (fileType.includes('text') || ext === 'txt') {
                                return {
                                    icon: 'fas fa-file-alt',
                                    color: '#64748b',
                                    background: 'rgba(100, 116, 139, 0.12)'
                                };
                            }

                            // Archives/Zip
                            if (fileType.includes('zip') || fileType.includes('archive') || ['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
                                return {
                                    icon: 'fas fa-file-archive',
                                    color: '#f59e0b',
                                    background: 'rgba(245, 158, 11, 0.12)'
                                };
                            }

                            // Default
                            return {
                                icon: 'fas fa-file',
                                color: '#6b7280',
                                background: 'rgba(107, 114, 128, 0.12)'
                            };
                        }

                        // Get friendly file type label
                        function getFileTypeLabel(fileType) {
                            if (fileType.includes('pdf')) return 'PDF';
                            if (fileType.includes('word') || fileType.includes('document')) return 'Document';
                            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'Spreadsheet';
                            if (fileType.includes('image')) return 'Image';
                            if (fileType.includes('text')) return 'Text';
                            if (fileType.includes('zip') || fileType.includes('archive')) return 'Archive';

                            // Extract from MIME type
                            const parts = fileType.split('/');
                            if (parts.length > 1) {
                                return parts[1].split('.').pop().toUpperCase();
                            }
                            return 'File';
                        }

                        // Helper functions
                        function generateAttachmentId() {
                            return 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }

                        function isValidFile(file) {
                            const maxSize = 10 * 1024 * 1024; // 10MB
                            const allowedTypes = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.xlsx', '.xls', '.txt', '.csv', '.zip'];

                            if (file.size > maxSize) {
                                showNotification(`File ${file.name} is too large (max 10MB)`, 'error');
                                return false;
                            }

                            const extension = '.' + file.name.split('.').pop().toLowerCase();
                            if (!allowedTypes.includes(extension)) {
                                showNotification(`File type ${extension} not allowed`, 'error');
                                return false;
                            }

                            return true;
                        }

                        function getFileTypeFromName(filename) {
                            const ext = filename.split('.').pop().toLowerCase();
                            const typeMap = {
                                'pdf': 'application/pdf',
                                'doc': 'application/msword',
                                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                'jpg': 'image/jpeg',
                                'jpeg': 'image/jpeg',
                                'png': 'image/png',
                                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                'xls': 'application/vnd.ms-excel',
                                'txt': 'text/plain',
                                'csv': 'text/csv',
                                'zip': 'application/zip'
                            };
                            return typeMap[ext] || 'application/octet-stream';
                        }

                        function getFileTypeIcon(fileType) {
                            if (fileType.includes('pdf')) return '';
                            if (fileType.includes('word') || fileType.includes('document')) return '';
                            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return '';
                            if (fileType.includes('image')) return '';
                            if (fileType.includes('text')) return '';
                            if (fileType.includes('zip')) return '';
                            return '';
                        }

                        function formatFileSize(bytes) {
                            if (bytes === 0) return '0 Bytes';
                            const k = 1024;
                            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        }

                        //  NEW: Helper functions for file extensions
                        function getFileExtensionFromMimeType(mimeType) {
                            const mimeToExt = {
                                'application/pdf': 'pdf',
                                'application/msword': 'doc',
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
                                'image/jpeg': 'jpg',
                                'image/png': 'png',
                                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
                                'application/vnd.ms-excel': 'xls',
                                'text/plain': 'txt',
                                'text/csv': 'csv',
                                'application/zip': 'zip'
                            };
                            return mimeToExt[mimeType] || null;
                        }

                        function getFileExtensionFromName(filename) {
                            const parts = filename.split('.');
                            return parts.length > 1 ? parts[parts.length - 1].toLowerCase() : null;
                        }

                        function showEnhancedAttachmentPreview() {
                            enhancedAttachmentPreview.classList.remove('hidden');
                        }

                        function hideEnhancedAttachmentPreview() {
                            enhancedAttachmentPreview.classList.add('hidden');
                        }

                        // Reply form submission: handled by SINGLE handler above (clone/replace block).
                        // Do NOT add another submit handler here - it caused duplicate POSTs and duplicate DB replies.

                        // Setup clear all button
                        const clearAllBtn = document.getElementById('clearAllAttachments');
                        if (clearAllBtn) {
                            clearAllBtn.addEventListener('click', function () {
                                console.log(' Clearing all attachments');
                                window.currentAttachments = [];
                                renderAttachmentPreview();
                                hideEnhancedAttachmentPreview();
                                showNotification('All attachments cleared', 'info');
                            });
                            console.log(' CLEAR ALL ATTACHMENTS BUTTON SETUP COMPLETE');
                        }

                        // Initialize enhanced drag & drop
                        setupEnhancedDragAndDrop();
                        console.log(' ENHANCED ATTACHMENT SYSTEM FULLY INITIALIZED');

                        // Make removeAttachment globally accessible
                        window.removeAttachment = removeAttachment;

                        // ENHANCED: Make common documents in sidebar draggable
                        function makeCommonDocumentsDraggable() {
                            const documentsContainer = document.getElementById('documentsContainer');
                            if (documentsContainer) {
                                // Add drag event listeners to all document items
                                documentsContainer.addEventListener('mousedown', function (e) {
                                    const documentItem = e.target.closest('[data-document-id]');
                                    if (documentItem) {
                                        documentItem.draggable = true;
                                        documentItem.addEventListener('dragstart', function (e) {
                                            const documentId = this.dataset.documentId;
                                            const documentName = this.querySelector('.document-name')?.textContent || 'Document';
                                            const documentSize = this.dataset.documentSize || 0;
                                            const documentType = this.dataset.documentType || 'application/octet-stream';

                                            const dragData = {
                                                type: 'common-document',
                                                index: documentId,
                                                name: documentName,
                                                size: parseInt(documentSize),
                                                fileType: documentType
                                            };

                                            e.dataTransfer.setData('text', JSON.stringify(dragData));
                                            e.dataTransfer.effectAllowed = 'copy';

                                            console.log(` Started dragging common document: ${documentName} (ID: ${documentId})`);
                                        });
                                    }
                                });
                            }
                        }

                        // Initialize draggable common documents
                        makeCommonDocumentsDraggable();

                        //  ENHANCED: Handle standard file input change using new system
                        fileInput.addEventListener('change', function (e) {
                            console.log(' File input change detected', this.files.length, 'files');

                            if (this.files.length === 0) return; // No files selected

                            // Process the new files using the enhanced attachment system
                            Array.from(this.files).forEach(file => {
                                if (isValidFile(file)) {
                                    const attachment = {
                                        id: generateAttachmentId(),
                                        type: 'file',
                                        file: file,
                                        name: file.name,
                                        size: file.size,
                                        fileType: file.type || getFileTypeFromName(file.name)
                                    };
                                    addAttachmentToPreview(attachment);
                                }
                            });

                            // Clear the input to allow selecting the same files again
                            this.value = '';
                        });

                        // Handle click on attachment button - SINGLE SOURCE OF TRUTH
                        const attachmentBtn = document.getElementById('attachmentBtn');
                        if (attachmentBtn) {
                            attachmentBtn.addEventListener('click', function (e) {
                                e.preventDefault(); // Prevent any default action
                                e.stopPropagation(); // Stop event from bubbling
                                console.log('Attachment button clicked');

                                // Trigger file input click
                                fileInput.click();
                            });
                        }
                        // Global flag to prevent duplicate document processing across drop zones

                        // Make the entire text area a drop zone
                        textarea.addEventListener('dragover', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            textarea.classList.add('bg-gray-50');
                        });

                        textarea.addEventListener('dragleave', function (e) {
                            e.preventDefault();
                            textarea.classList.remove('bg-gray-50');
                        });

                        textarea.addEventListener('drop', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            textarea.classList.remove('bg-gray-50');

                            if (e.dataTransfer.files.length > 0) {
                                console.log(' Files dropped in textarea - using enhanced system');
                                // Process files using enhanced attachment system
                                Array.from(e.dataTransfer.files).forEach(file => {
                                    if (isValidFile(file)) {
                                        const attachment = {
                                            id: generateAttachmentId(),
                                            type: 'file',
                                            file: file,
                                            name: file.name,
                                            size: file.size,
                                            fileType: file.type || getFileTypeFromName(file.name)
                                        };
                                        addAttachmentToPreview(attachment);
                                    }
                                });
                            } else if (e.dataTransfer.getData('text')) {
                                // This might be a document dragged from the Common Documents section
                                try {
                                    const docData = JSON.parse(e.dataTransfer.getData('text'));
                                    console.log('Received dragged data:', docData);

                                    if (docData && docData.type === 'common-document') {
                                        // Validate document data
                                        const documentId = docData._id || docData.id || docData.index;

                                        if (!documentId) {
                                            console.error(' Invalid document data - index is undefined:', docData);
                                            showNotification('Error: Invalid document data', 'error');
                                            return;
                                        }

                                        // Prevent duplicate processing using global flag and timestamp
                                        const currentTime = Date.now();
                                        const docKey = `${documentId}_${docData.name}`;

                                        console.log('Document drop detected:', {
                                            docKey,
                                            _id: documentId,
                                            name: docData.name,
                                            alreadyProcessed: processedDocuments.has(docKey),
                                            lastProcessed: lastProcessedDocument,
                                            timeSinceLast: currentTime - lastProcessedTime
                                        });

                                        if (!processedDocuments.has(docKey)) {
                                            processedDocuments.add(docKey);
                                            lastProcessedDocument = docKey;
                                            lastProcessedTime = currentTime;
                                            console.log(' Processing document drop in textarea:', docKey);
                                            //  FIXED: Call the proper handler to add document to chat
                                            handleCommonDocumentDrop(docData);
                                        } else {
                                            console.log(' Duplicate document drop prevented:', docKey);
                                            showNotification('Document already added to chat', 'info');
                                        }
                                    }
                                } catch (err) {
                                    console.error('Error parsing dragged data:', err);
                                }
                            }
                        });



                        // Note: makeDocumentsDraggable function removed - drag and drop is now handled directly in loadDocuments



                        //  REMOVED: Old helper functions - replaced by enhanced system

                        // Create preview for uploaded files
                        //  REMOVED: Old createAttachmentPreview function - replaced by enhanced system

                        //  REMOVED: Old updateAttachmentCounter and formatFileSize functions - replaced by enhanced system

                        // DUPLICATE EVENT LISTENER REMOVED - Form submission is now handled by the single unified event listener above
                        // This prevents triple submissions and ensures webhook is triggered only once

                        // Add handler for the "Show Attachments" button in dropdown
                        const showAttachmentsBtn = document.getElementById('showAttachmentsBtn');
                        if (showAttachmentsBtn) {
                            showAttachmentsBtn.addEventListener('click', function (e) {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Show attachments button clicked');
                                // Just trigger the attachmentBtn click which will trigger file input
                                if (attachmentBtn) {
                                    attachmentBtn.click();
                                }
                                document.getElementById('quickResponseDropdown').style.display = 'none';
                            });
                        }
                    }



                    // Setup quick response dropdown
                    function setupQuickResponseDropdown() {
                        const quickResponseBtn = document.getElementById('quickResponseBtn');
                        const quickResponseDropdown = document.getElementById('quickResponseDropdown');
                        const responseTextarea = document.getElementById('response');
                        const attachmentBtn = document.getElementById('attachmentBtn');

                        if (!quickResponseBtn || !quickResponseDropdown || !responseTextarea) return;

                        // Initially hide the dropdown
                        quickResponseDropdown.style.display = 'none';

                        // Toggle dropdown visibility when clicking the button
                        quickResponseBtn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();

                            if (quickResponseBtn.classList.contains('open')) {
                                quickResponseBtn.classList.remove('open');
                                quickResponseDropdown.style.display = 'none';
                            } else {
                                quickResponseBtn.classList.add('open');
                                quickResponseDropdown.style.display = 'block';
                            }
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', function (e) {
                            if (quickResponseBtn && !quickResponseBtn.contains(e.target) &&
                                quickResponseDropdown && quickResponseDropdown.style.display !== 'none') {
                                quickResponseBtn.classList.remove('open');
                                quickResponseDropdown.style.display = 'none';
                            }
                        });

                        // Add click handlers for quick response items
                        document.querySelectorAll('.quick-response-item').forEach(item => {
                            item.addEventListener('click', function (e) {
                                const text = this.textContent.trim();

                                // Insert different template responses based on the selected option
                                let responseTemplate = '';

                                if (text.includes('Issue Resolved')) {
                                    responseTemplate = "I'm pleased to inform you that we have resolved the issue with your claim. The necessary repairs have been authorized and you can proceed with scheduling service at your convenience.\n\nPlease let me know if you need any additional assistance.";
                                } else if (text.includes('Need More Information')) {
                                    responseTemplate = "Thank you for your claim submission. To proceed with your case, we need some additional information:\n\n1. Complete diagnostic report with fault codes\n2. Photos of the affected components\n3. Service history records\n\nPlease provide these at your earliest convenience so we can continue processing your claim.";
                                } else if (text.includes('In Progress Update')) {
                                    responseTemplate = "I wanted to provide you with an update on your claim. We are currently reviewing your case and have forwarded the documentation to our technical specialist.\n\nWe expect to have a decision within 2-3 business days. Thank you for your patience.";
                                } else if (text.includes('Schedule Follow-up')) {
                                    responseTemplate = "I've reviewed your claim and would like to schedule a follow-up call to discuss the next steps. Please let me know your availability in the next few days, and I'll arrange for our technical advisor to contact you directly.";
                                } else if (text.includes('Attach Files')) {
                                    // Trigger attachment button click - this will open the file dialog
                                    if (attachmentBtn) {
                                        attachmentBtn.click();
                                    }
                                    quickResponseDropdown.style.display = 'none';
                                    return;
                                } else if (text.includes('Save as Template')) {
                                    // Open the template modal with current response text
                                    document.getElementById('templateTitle').value = 'New Response Template';
                                    document.getElementById('templateContent').value = responseTextarea.value;
                                    document.getElementById('editTemplateTitle').textContent = 'Save as Template';
                                    document.getElementById('deleteTemplate').classList.add('hidden');
                                    document.getElementById('saveTemplate').removeAttribute('data-template-index');
                                    openModal('editTemplateModal');
                                    quickResponseDropdown.style.display = 'none';
                                    return;
                                }

                                // Insert the template text into the textarea
                                if (responseTemplate) {
                                    // If there's already content, add a line break first
                                    if (responseTextarea.value && !responseTextarea.value.endsWith('\n')) {
                                        responseTextarea.value += '\n\n';
                                    }

                                    responseTextarea.value += responseTemplate;
                                    responseTextarea.focus();

                                    // Move cursor to end of text
                                    responseTextarea.selectionStart = responseTextarea.selectionEnd = responseTextarea.value.length;

                                    // Trigger auto-expand after adding template content
                                    if (typeof window.autoExpandTextarea === 'function') {
                                        window.autoExpandTextarea(responseTextarea);
                                    }

                                    // Hide the dropdown
                                    quickResponseBtn.classList.remove('open');
                                    quickResponseDropdown.style.display = 'none';
                                }
                            });
                        });
                    }

                    // Function to view common documents from reply attachments
                    function viewCommonDocument(documentId) {
                        try {
                            // Download the common document
                            const downloadUrl = `/api/common-documents/${documentId}/download`;

                            // Open in new window/tab
                            const newWindow = window.open(downloadUrl, '_blank');
                            if (!newWindow) {
                                showNotification('Download failed - popup blocked?', 'error');
                            }

                        } catch (error) {
                            showNotification(`Error viewing document: ${error.message}`, 'error');
                        }
                    }

                    // Initialize everything when DOM is loaded
                    document.addEventListener('DOMContentLoaded', function () {
                        // Initialize global variables
                        processedDocuments.clear();
                        lastProcessedDocument = null;
                        lastProcessedTime = 0;

                        // Load existing documents
                        loadDocuments();

                        // Setup event handlers for attachments
                        setupAttachmentHandlers();

                        // Setup quick response dropdown
                        setupQuickResponseDropdown();



                        // Add a function to manually clear processed documents (for debugging)
                        window.clearProcessedDocuments = function () {
                            processedDocuments.clear();
                            lastProcessedDocument = null;
                            lastProcessedTime = 0;
                            console.log(' Manually cleared processed documents tracking');
                            showNotification('Processed documents tracking cleared', 'success');
                        };
                    });

                    // Note: Removed problematic setInterval that was causing duplicate event listeners
                    // Documents are now made draggable only when they are initially loaded

                    // Auto-refresh functionality for webhook replies
                    let lastReplyCount = parseInt('{{ replies|length|default(0) }}', 10);
                    let autoRefreshInterval;

                    const ticketCustomerName = '{{ (ticket.name or ticket.customer_first_name or "")|default("", true) }}';

                    function escapeHtml(text) {
                        if (!text) return '';
                        return text.replace(/[&<>"']/g, function (c) {
                            return {
                                '&': '&amp;',
                                '<': '&lt;',
                                '>': '&gt;',
                                '"': '&quot;',
                                "'": '&#39;'
                            }[c] || c;
                        });
                    }

                    function renderRepliesFromApi(replies) {
                        const container = document.getElementById('repliesContainer');
                        if (!container) return;

                        container.innerHTML = '';

                        (replies || []).forEach((reply, idx) => {
                            const isInternal = (
                                (reply.role && ['Admin', 'Support', 'Technical Director', 'Technician'].includes(reply.role)) ||
                                reply.sender_type === 'agent' ||
                                reply.is_internal
                            );

                            const wrapper = document.createElement('div');
                            wrapper.className = 'message ' + (isInternal ? 'support-message' : 'customer-message');

                            const messageId = 'message-' + (idx + 1);
                            const senderName = isInternal
                                ? (reply.sender_name || 'Support Team')
                                : (reply.sender_name || ticketCustomerName || 'Customer');

                            const createdAt = reply.created_at
                                ? new Date(reply.created_at).toLocaleString()
                                : '';

                            // Build attachment HTML
                            let attachmentHtml = '';
                            const atts = reply.attachments || [];
                            if (atts.length > 0) {
                                const replyId = reply._id || '';
                                const attItems = atts.map((att, attIdx) => {
                                    const filename = att.filename || att.fileName || att.name || 'file';
                                    const ext = filename.toLowerCase().split('.').pop();
                                    const previewExts = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'txt', 'md', 'webp', 'svg', 'bmp'];
                                    const canPreview = previewExts.includes(ext);
                                    // Determine icon
                                    let iconClass = 'fas fa-file text-gray-500';
                                    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(ext)) iconClass = 'fas fa-image text-blue-400';
                                    else if (ext === 'pdf') iconClass = 'fas fa-file-pdf text-red-400';
                                    else if (['doc', 'docx'].includes(ext)) iconClass = 'fas fa-file-word text-blue-400';

                                    return `
                                    <div class="flex items-center bg-white/5 border border-white/10 rounded-lg p-2 gap-2">
                                        <i class="${iconClass} mr-1 flex-shrink-0"></i>
                                        <div class="min-w-0 flex-1">
                                            <div class="font-medium truncate max-w-[120px]" title="${escapeHtml(filename)}">${escapeHtml(filename)}</div>
                                        </div>
                                        <div class="flex gap-1 ml-2 flex-shrink-0">
                                            ${canPreview ? `<button onclick="previewAttachment('${escapeHtml(replyId)}', '${attIdx}', '${escapeHtml(filename)}', 'reply')"
                                                class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-1.5 py-1 rounded text-[10px] transition"
                                                title="Preview ${escapeHtml(filename)}"><i class="fas fa-eye"></i></button>` : ''}
                                            <button onclick="downloadAttachment('${escapeHtml(replyId)}', '${attIdx}', '${escapeHtml(filename)}', 'reply')"
                                                class="bg-green-100 hover:bg-green-200 text-green-600 px-1.5 py-1 rounded text-[10px] transition"
                                                title="Download ${escapeHtml(filename)}"><i class="fas fa-download"></i></button>
                                        </div>
                                    </div>`;
                                }).join('');
                                attachmentHtml = `<div class="flex flex-wrap gap-2 mt-3">${attItems}</div>`;
                            }

                            const contentId = `message-content-${idx + 1}`;
                            const btnId = `toggle-btn-${idx + 1}`;

                            wrapper.innerHTML = `
                                <div class="message-header">
                                    <span class="font-medium flex items-center">
                                        ${isInternal
                                    ? '<i class="fas fa-headset support-icon"></i> ' + escapeHtml(senderName)
                                    : '<i class="fas fa-user-circle customer-icon"></i> ' + escapeHtml(senderName)
                                }
                                    </span>
                                    <span class="message-time">
                                        <i class="fas fa-clock mr-1"></i>${escapeHtml(createdAt)}
                                    </span>
                                </div>
                                <div class="reply-message-box" id="${messageId}">
                                    <div class="message-content line-clamp-3 overflow-hidden text-gray-200 transition-all duration-300"
                                         id="${contentId}"
                                         style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.6;">
                                        ${escapeHtml(reply.message || '')}
                                    </div>
                                    <button onclick="toggleMessage('${idx + 1}')" id="${btnId}"
                                        class="text-blue-400 hover:text-blue-300 text-xs mt-2 font-medium flex items-center focus:outline-none hidden">
                                        <i class="fas fa-chevron-down mr-1"></i> Read More
                                    </button>
                                    ${attachmentHtml}
                                </div>
                            `;

                            container.appendChild(wrapper);
                        });

                        // After rendering all replies, detect truncation and show toggle buttons
                        setTimeout(() => {
                            (replies || []).forEach((reply, idx) => {
                                const content = document.getElementById(`message-content-${idx + 1}`);
                                const btn = document.getElementById(`toggle-btn-${idx + 1}`);
                                if (content && btn) {
                                    const clampedHeight = content.clientHeight;
                                    content.style.webkitLineClamp = 'unset';
                                    content.style.display = 'block';
                                    const fullHeight = content.scrollHeight;
                                    content.style.webkitLineClamp = '3';
                                    content.style.display = '-webkit-box';
                                    if (fullHeight > clampedHeight + 5) {
                                        btn.classList.remove('hidden');
                                    }
                                }
                            });
                        }, 150);
                    }

                    function checkForNewReplies() {
                        fetch(`/api/tickets/{{ ticket.ticket_id }}/reply-count`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && typeof data.count === 'number' && data.count > lastReplyCount) {
                                    console.log(` New replies detected! (${lastReplyCount}  ${data.count})`);
                                    lastReplyCount = data.count;
                                    fetch(`/api/tickets/{{ ticket.ticket_id }}/replies`)
                                        .then(r => r.json())
                                        .then(replyData => {
                                            if (replyData.success) {
                                                renderRepliesFromApi(replyData.replies || []);
                                            }
                                        })
                                        .catch(error => console.error('Error loading replies:', error));
                                }
                            })
                            .catch(error => console.error('Error checking for new replies:', error));
                    }

                    // Auto-refresh: always-on, every 5 seconds
                    setInterval(checkForNewReplies, 5000);

                    // Clear processed documents on page unload
                    window.addEventListener('beforeunload', function () {
                        processedDocuments.clear();
                        lastProcessedDocument = null;
                        lastProcessedTime = 0;
                    });

                    document.addEventListener('DOMContentLoaded', function () {
                        console.log(' Ticket Detail page loaded');

                        // Check for AI response on page load
                        checkForAIResponse();

                        // AI Response checking function
                        function checkForAIResponse() {
                            console.log(' Checking for AI response...');
                            const ticketId = '{{ ticket.ticket_id }}';

                            // Check URL parameters first
                            const urlParams = new URLSearchParams(window.location.search);
                            const aiResponse = urlParams.get('ai_response');

                            if (aiResponse) {
                                console.log(' Found AI response in URL parameters');
                                populateTextareaWithAIResponse(decodeURIComponent(aiResponse));
                                return;
                            }

                            // Check for AI response in database
                            fetch(`/api/ai/get-response/${ticketId}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success && data.ai_response) {
                                        console.log(' Found AI response in database');
                                        populateTextareaWithAIResponse(data.ai_response);
                                    } else {
                                        console.log(' No AI response found');
                                    }
                                })
                                .catch(error => {
                                    console.log(' Error checking for AI response:', error);
                                });
                        }

                        // Function to populate textarea with AI response
                        function populateTextareaWithAIResponse(aiResponse) {
                            console.log(' Populating textarea with AI response...');
                            const textarea = document.getElementById('response');

                            if (textarea) {
                                console.log(' Found textarea, setting value...');
                                textarea.value = aiResponse;
                                console.log(' Textarea populated with:', aiResponse.substring(0, 100) + '...');

                                // Trigger auto-expand
                                if (window.autoExpandTextarea) {
                                    window.autoExpandTextarea(textarea);
                                }

                                // Trigger input event to save to localStorage
                                textarea.dispatchEvent(new Event('input', { bubbles: true }));

                                // Show notification
                                showNotification('AI response loaded into textarea!', 'success');

                                console.log(' AI response successfully loaded!');
                            } else {
                                console.error(' Textarea not found!');
                            }
                        }

                        // Auto-expand textarea functionality (WhatsApp-style) - GLOBAL SCOPE
                        window.autoExpandTextarea = function (textareaElement) {
                            if (!textareaElement) return;

                            // Temporarily disable transition for measurement
                            const originalTransition = textareaElement.style.transition;
                            textareaElement.style.transition = 'none';

                            // Reset height to auto to get accurate scrollHeight
                            textareaElement.style.height = 'auto';

                            // Get the scroll height (full content height)
                            const scrollHeight = textareaElement.scrollHeight;

                            // Re-enable transition for smooth height change
                            textareaElement.style.transition = originalTransition;

                            // Set the height based on content, respecting min/max limits
                            const minHeight = 60; // minimum height (about 3 lines)
                            const maxHeight = 300; // maximum height (about 15 lines)

                            if (scrollHeight <= maxHeight) {
                                textareaElement.style.height = Math.max(scrollHeight, minHeight) + 'px';
                                textareaElement.style.overflowY = 'hidden';
                            } else {
                                textareaElement.style.height = maxHeight + 'px';
                                textareaElement.style.overflowY = 'auto';
                            }
                        };

                        // Initialize auto-expand for response textarea
                        const responseTextarea = document.getElementById('response');
                        if (responseTextarea) {
                            console.log(' Found response textarea, initializing auto-expand');

                            // Apply auto-expand on input events (main trigger)
                            responseTextarea.addEventListener('input', function () {
                                window.autoExpandTextarea(this);
                            });

                            // Apply auto-expand on page load (for existing content)
                            if (responseTextarea.value && responseTextarea.value.trim()) {
                                setTimeout(() => window.autoExpandTextarea(responseTextarea), 100);
                            }

                            // Apply auto-expand on paste operations
                            responseTextarea.addEventListener('paste', function () {
                                setTimeout(() => window.autoExpandTextarea(this), 50);
                            });

                            // Apply auto-expand on any value changes
                            responseTextarea.addEventListener('change', function () {
                                window.autoExpandTextarea(this);
                            });

                            // Apply auto-expand on focus (in case content was added programmatically)
                            responseTextarea.addEventListener('focus', function () {
                                setTimeout(() => window.autoExpandTextarea(this), 10);
                            });

                            console.log(' Auto-expand textarea initialized successfully');
                        } else {
                            console.error(' Response textarea not found');
                        }

                        // Forward ticket functionality
                        const forwardModal = document.getElementById('forwardModal');
                        const forwardBtn = document.getElementById('forwardBtn');
                        const closeForwardModalBtn = document.getElementById('closeForwardModal');
                        const cancelForwardBtn = document.getElementById('cancelForward');
                        const confirmForwardBtn = document.getElementById('confirmForward');

                        if (forwardBtn) {
                            forwardBtn.addEventListener('click', () => {
                                console.log(' Forward button clicked');

                                // Reset form when opening
                                const memberSelectEl = document.getElementById('forwardMemberSelect');
                                const notesEl = document.getElementById('forwardNotes');
                                if (memberSelectEl) memberSelectEl.value = '';
                                if (notesEl) notesEl.value = '';

                                // Open modal using the helper function
                                openModal('forwardModal');
                            });
                        }

                        if (closeForwardModalBtn) {
                            closeForwardModalBtn.addEventListener('click', () => closeModal('forwardModal'));
                        }

                        if (cancelForwardBtn) {
                            cancelForwardBtn.addEventListener('click', () => closeModal('forwardModal'));
                        }

                        if (confirmForwardBtn) {
                            confirmForwardBtn.addEventListener('click', async () => {
                                console.log(' Forward confirmation clicked');

                                try {
                                    // Get form elements
                                    const memberSelectEl = document.getElementById('forwardMemberSelect');
                                    const notesEl = document.getElementById('forwardNotes');

                                    if (!memberSelectEl || !notesEl) {
                                        showNotification('Form elements not found - please refresh the page', 'error');
                                        return;
                                    }

                                    const memberId = memberSelectEl.value;
                                    const notes = notesEl.value;

                                    // SAFE TICKET ID handling
                                    const ticketId = "{{ ticket.ticket_id }}";
                                    console.log(' Forwarding Ticket ID:', ticketId);

                                    // Validation
                                    console.log(' Selected Member ID:', memberId);
                                    if (!memberId || memberId.trim() === '' || memberId === 'Select a member...') {
                                        console.warn(' Member validation failed');
                                        showNotification('Please select a member to forward the ticket to', 'error');

                                        // VISUAL FEEDBACK
                                        memberSelectEl.classList.add('border-red-500', 'ring-2', 'ring-red-500');
                                        memberSelectEl.focus();

                                        // Remove error class after 3 seconds or on change
                                        setTimeout(() => {
                                            memberSelectEl.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
                                        }, 3000);

                                        memberSelectEl.addEventListener('change', function () {
                                            memberSelectEl.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
                                        }, { once: true });

                                        return;
                                    }

                                    // Validate session member_id for forwarding
                                    const sessionMemberId = "{{ session.member_id if session.member_id else '' }}";
                                    console.log(' Session Member ID:', sessionMemberId);

                                    if (!sessionMemberId || sessionMemberId === 'None' || sessionMemberId === 'null' || sessionMemberId === '') {
                                        console.warn(' Session validation failed');
                                        showNotification('Session expired. Please refresh the page and log in again.', 'error');
                                        return;
                                    }

                                    // Prepare API request
                                    const requestBody = {
                                        assigned_to: memberId.trim(),
                                        note: notes.trim(),
                                        is_forwarded: true,
                                        forwarded_from: sessionMemberId
                                    };

                                    console.log(' Preparing forward request:', requestBody);

                                    // Disable button to prevent double-clicks
                                    confirmForwardBtn.disabled = true;
                                    confirmForwardBtn.innerHTML = ' Forwarding...';

                                    console.log(' Sending API request to:', `/api/tickets/${ticketId}/assign`);

                                    const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(requestBody),
                                        credentials: 'include'
                                    });

                                    console.log(' Response received. Status:', response.status);

                                    const data = await response.json();
                                    console.log(' Response data:', data);

                                    if (response.ok && data.status === 'success') {
                                        console.log(' Forward SUCCESS!');

                                        // SUCCESS STATE: Show success button state
                                        confirmForwardBtn.disabled = false;
                                        confirmForwardBtn.innerHTML = ' Forwarded Successfully!';
                                        confirmForwardBtn.style.backgroundColor = '#dcfce7';
                                        confirmForwardBtn.style.color = '#166534';

                                        // Close modal and reset form
                                        closeModal('forwardModal');
                                        memberSelectEl.value = '';
                                        notesEl.value = '';

                                        // Show brief success notification
                                        showNotification('Ticket forwarded successfully!', 'success');

                                        // Update forward button state dynamically
                                        const selectedMemberName = memberSelectEl.options[memberSelectEl.selectedIndex].text;
                                        updateForwardButtonState(selectedMemberName);

                                        // Refresh the page to show updated assignment
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 2000);
                                    } else {
                                        console.error(' Forward FAILED:', data);

                                        let errorMessage = 'Failed to forward ticket';
                                        if (data.message) {
                                            errorMessage = data.message;
                                        }

                                        showNotification(errorMessage, 'error');

                                        // Reset button
                                        confirmForwardBtn.disabled = false;
                                        confirmForwardBtn.innerHTML = 'Forward Ticket';
                                    }
                                } catch (error) {
                                    console.error(' Forward Exception:', error);

                                    // Reset button
                                    confirmForwardBtn.disabled = false;
                                    confirmForwardBtn.innerHTML = 'Forward Ticket';

                                    showNotification('An error occurred while forwarding ticket', 'error');
                                }
                            });
                        }

                        // Function to update forward button state after forwarding
                        function updateForwardButtonState(forwardedToName) {
                            const forwardBtn = document.getElementById('forwardBtn');
                            if (forwardBtn) {
                                forwardBtn.style.display = 'none';

                                // Create or update forward status badge
                                let forwardBadge = document.getElementById('forwardStatusBadge');
                                if (!forwardBadge) {
                                    forwardBadge = document.createElement('div');
                                    forwardBadge.id = 'forwardStatusBadge';
                                    forwardBadge.className = 'px-3 h-9 flex items-center justify-center rounded-xl bg-blue-50 text-blue-700 border border-blue-200 whitespace-nowrap flex-shrink-0';
                                    forwardBtn.parentNode.insertBefore(forwardBadge, forwardBtn);
                                }
                                forwardBadge.innerHTML = `<i class="fas fa-share mr-1"></i> Forwarded to ${forwardedToName}`;
                            }
                        }
                    });

                    // Mobile menu toggle function
                    function toggleMobileMenu() {
                        const mobileMenu = document.getElementById('mobileMenu');
                        if (mobileMenu) {
                            mobileMenu.classList.toggle('active');
                        }
                    }

                    // Close mobile menu when clicking outside
                    document.addEventListener('click', function (event) {
                        const mobileMenu = document.getElementById('mobileMenu');
                        const menuButton = document.querySelector('.mobile-menu-btn');

                        if (mobileMenu && !mobileMenu.contains(event.target) && !menuButton.contains(event.target)) {
                            mobileMenu.classList.add('hidden');
                        }
                    });



                    function showWarrantyFormAnalysis(data, ticketId) {
                        const analysis = data.analysis;
                        const suggestions = data.suggestions;

                        let statusColor = analysis.is_warranty_form ? 'green' : 'red';
                        let statusText = analysis.is_warranty_form ? 'Warranty Form Detected' : 'Not a Warranty Form';

                        const modalContent = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50" id="warrantyAnalysisModal">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i class="fas fa-robot mr-2 text-blue-600"></i>
                                AI Warranty Form Analysis
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="mb-4">
                                <div class="flex items-center mb-2">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                        ${statusText}
                                    </span>
                                    <span class="ml-3 text-sm text-gray-600">Confidence: ${analysis.confidence}%</span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h4 class="font-medium text-gray-700 mb-2">Analysis Details:</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li> Valid file type: ${analysis.analysis.valid_file_type ? 'Yes' : 'No'}</li>
                                    <li> Contains warranty keywords: ${analysis.analysis.has_warranty_keywords ? 'Yes' : 'No'}</li>
                                    ${analysis.analysis.detected_keywords && analysis.analysis.detected_keywords.length > 0
                                ? `<li> Detected keywords: ${analysis.analysis.detected_keywords.join(', ')}</li>`
                                : ''}
                                </ul>
                            </div>
                            
                            ${analysis.is_warranty_form ? `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                    <h4 class="font-medium text-green-800 mb-2">AI Recommendation:</h4>
                                    <p class="text-sm text-green-700">Update ticket status to "Warranty Form Received"</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-sm text-gray-700">Is this analysis correct?</p>
                                    <div class="flex space-x-3">
                                        <button onclick="confirmWarrantyForm('${ticketId}', true)" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-check mr-2"></i>Yes, Correct
                                        </button>
                                        <button onclick="confirmWarrantyForm('${ticketId}', false)" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-times mr-2"></i>No, Incorrect
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                                    <h4 class="font-medium text-orange-800 mb-2">Manual Review Required:</h4>
                                    <p class="text-sm text-orange-700">AI couldn't confidently identify this as a warranty form. Please review manually.</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-sm text-gray-700">Is this actually a warranty form?</p>
                                    <div class="flex space-x-3">
                                        <button onclick="confirmWarrantyForm('${ticketId}', true)" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-check mr-2"></i>Yes, It's a Warranty Form
                                        </button>
                                        <button onclick="confirmWarrantyForm('${ticketId}', false)" 
                                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-times mr-2"></i>No, It's Not
                                        </button>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                            <button onclick="closeWarrantyAnalysisModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

                        document.body.insertAdjacentHTML('beforeend', modalContent);
                    }

                    async function confirmWarrantyForm(ticketId, isCorrect) {
                        try {
                            const response = await fetch(`/api/tickets/${ticketId}/confirm-warranty-form`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    is_correct: isCorrect,
                                    feedback: isCorrect ? 'User confirmed AI detection' : 'User rejected AI detection'
                                })
                            });

                            const data = await response.json();

                            if (data.status === 'success') {
                                showNotification(data.message, 'success');
                                closeWarrantyAnalysisModal();

                                if (isCorrect && data.new_status) {
                                    // Optionally reload the page to show updated status
                                    // PERFORMANCE FIX: Reduced reload delay
                                    setTimeout(() => window.location.reload(), 3000);
                                }
                            } else {
                                showNotification(data.message || 'Confirmation failed', 'error');
                            }
                        } catch (error) {
                            console.error('Error confirming warranty form:', error);
                            showNotification('Confirmation failed', 'error');
                        }
                    }

                    function closeWarrantyAnalysisModal() {
                        const modal = document.getElementById('warrantyAnalysisModal');
                        if (modal) {
                            modal.remove();
                        }
                    }

                    // Email Template Functionality
                    document.addEventListener('DOMContentLoaded', function () {
                        const emailTemplateBtn = document.getElementById('emailTemplateBtn');
                        const emailTemplateModal = document.getElementById('emailTemplateModal');
                        const closeEmailTemplateModal = document.getElementById('closeEmailTemplateModal');
                        const cancelEmailTemplate = document.getElementById('cancelEmailTemplate');
                        const loadTemplate = document.getElementById('loadTemplate');
                        const editTemplate = document.getElementById('editTemplate');
                        const clearFields = document.getElementById('clearFields');
                        const sendEmail = document.getElementById('sendEmail');
                        const templateTypeSelect = document.getElementById('templateTypeSelect');
                        const emailSubject = document.getElementById('emailSubject');
                        const emailBody = document.getElementById('emailBody');
                        const availableAttachments = document.getElementById('availableAttachments');

                        let currentTemplateData = null;

                        // Open email template modal - with null check
                        if (emailTemplateBtn) {
                            emailTemplateBtn.addEventListener('click', function () {
                                openModal('emailTemplateModal');
                                resetEmailTemplateForm();

                                // Clear attachments initially - they will only be populated after clicking "Load Template"
                                if (availableAttachments) {
                                    availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Click "Load Template" to see available attachments.</p>';
                                }

                                //  FIXED: Common documents should NEVER load in email template modal
                                // They are completely separate systems and should not interfere
                                console.log(' BLOCKED: Common documents prevented from loading in email template modal');

                                // Focus on subject field after modal opens
                                setTimeout(() => {
                                    if (emailSubject) emailSubject.focus();
                                }, 100);
                            });
                        } else {
                            console.warn(' emailTemplateBtn not found - email template functionality disabled');
                        }

                        // Close modal handlers - with null checks
                        if (closeEmailTemplateModal) {
                            closeEmailTemplateModal.addEventListener('click', () => {
                                closeModal('emailTemplateModal');
                            });
                        }
                        if (cancelEmailTemplate) {
                            cancelEmailTemplate.addEventListener('click', () => {
                                closeModal('emailTemplateModal');
                            });
                        }

                        // Close modal on outside click - with null check
                        if (emailTemplateModal) {
                            emailTemplateModal.addEventListener('click', (e) => {
                                if (e.target === emailTemplateModal) {
                                    closeModal('emailTemplateModal');
                                }
                            });
                        }

                        // Load template button - with null check
                        if (loadTemplate) {
                            loadTemplate.addEventListener('click', async function () {
                                const templateType = templateTypeSelect ? templateTypeSelect.value : '';
                                const ticketId = '{{ ticket.ticket_id }}';

                                if (!templateType) {
                                    showNotification('Please select a template type', 'error');
                                    return;
                                }

                                try {
                                    // Show loading
                                    loadTemplate.disabled = true;
                                    loadTemplate.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';

                                    const response = await fetch(`/api/email-template/${templateType}/${ticketId}`);
                                    const data = await response.json();

                                    if (response.ok && data.status === 'success') {
                                        currentTemplateData = data.template;

                                        //  CRITICAL DEBUGGING: Log exactly what we received from backend
                                        console.log(' CRITICAL DEBUG: Received template data from backend:', data);
                                        console.log(' CRITICAL DEBUG: Template attachments:', currentTemplateData.attachments);
                                        console.log(' CRITICAL DEBUG: Template data structure:', currentTemplateData);

                                        // Populate form fields
                                        if (emailSubject) emailSubject.value = currentTemplateData.subject;
                                        if (emailBody) emailBody.value = currentTemplateData.body;

                                        // Make fields editable
                                        if (emailSubject) emailSubject.removeAttribute('readonly');
                                        if (emailBody) emailBody.removeAttribute('readonly');

                                        // Update visual styling to show fields are editable
                                        if (emailSubject) emailSubject.classList.add('bg-white', 'cursor-text');
                                        if (emailBody) emailBody.classList.add('bg-white', 'cursor-text');

                                        // Show edit template button
                                        if (editTemplate) editTemplate.style.display = 'inline-block';

                                        // Populate attachments
                                        populateAttachments(currentTemplateData.attachments);

                                        // Enable send button
                                        if (sendEmail) sendEmail.disabled = false;

                                        // Show different notification and indicator based on content source
                                        if (currentTemplateData.has_draft && currentTemplateData.content_source === 'draft') {
                                            showNotification(' Draft email content loaded successfully', 'success');

                                            // Add a visual indicator that this is draft content
                                            const draftIndicator = document.createElement('div');
                                            draftIndicator.id = 'draftIndicator';
                                            draftIndicator.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4';
                                            draftIndicator.innerHTML = `
                                    <div class="flex items-center">
                                        <i class="fas fa-edit text-blue-600 mr-2"></i>
                                        <span class="text-blue-800 font-medium">Draft Content Loaded</span>
                                        <span class="text-blue-600 text-sm ml-2">- This email contains pre-written draft content from the original ticket</span>
                                    </div>
                                `;

                                            // Insert before email body
                                            if (emailBody) {
                                                const emailBodyContainer = emailBody.parentNode;
                                                const existingIndicator = document.getElementById('draftIndicator');
                                                if (existingIndicator) {
                                                    existingIndicator.remove();
                                                }
                                                emailBodyContainer.insertBefore(draftIndicator, emailBody);
                                            }
                                        } else {
                                            showNotification(' Template loaded successfully!', 'success');

                                            // Remove draft indicator if it exists
                                            const existingIndicator = document.getElementById('draftIndicator');
                                            if (existingIndicator) {
                                                existingIndicator.remove();
                                            }
                                        }
                                    } else {
                                        showNotification(data.message || 'Failed to load template', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error loading template:', error);
                                    showNotification('Error loading template', 'error');
                                } finally {
                                    // Reset button
                                    loadTemplate.disabled = false;
                                    loadTemplate.innerHTML = '<i class="fas fa-download mr-2"></i>Load Template';
                                }
                            });
                        }

                        // Regenerate attachments button
                        const regenerateAttachments = document.getElementById('regenerateAttachments');
                        if (regenerateAttachments) {
                            regenerateAttachments.addEventListener('click', async function () {
                                const ticketId = '{{ ticket.ticket_id }}';

                                try {
                                    // Show loading
                                    regenerateAttachments.disabled = true;
                                    regenerateAttachments.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Regenerating...';

                                    const response = await fetch(`/api/tickets/${ticketId}/regenerate-attachments`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        }
                                    });

                                    const data = await response.json();

                                    if (response.ok) {
                                        if (data.status === 'success') {
                                            showNotification(' Attachments regenerated successfully! You can now click "Load Template" to see them.', 'success');
                                        } else if (data.status === 'warning') {
                                            showNotification(' ' + data.message, 'info');
                                        } else {
                                            showNotification(' ' + data.message, 'warning');
                                        }
                                    } else {
                                        showNotification(' ' + (data.message || 'Failed to regenerate attachments'), 'error');
                                    }

                                } catch (error) {
                                    console.error('Error regenerating attachments:', error);
                                    showNotification(' Error regenerating attachments', 'error');
                                } finally {
                                    // Reset button
                                    regenerateAttachments.disabled = false;
                                    regenerateAttachments.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Regenerate Attachments';
                                }
                            });
                        }

                        // Debug attachments button (for troubleshooting)
                        const debugAttachments = document.getElementById('debugAttachments');
                        if (debugAttachments) {
                            debugAttachments.addEventListener('click', async function () {
                                const ticketId = '{{ ticket.ticket_id }}';

                                try {
                                    // Show loading
                                    debugAttachments.disabled = true;
                                    debugAttachments.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Debugging...';

                                    const response = await fetch(`/api/debug/attachments/${ticketId}`);
                                    const data = await response.json();

                                    if (response.ok && data.status === 'success') {
                                        console.log(' DEBUG ATTACHMENTS DATA:', data.debug_info);

                                        // Show debug info in a notification
                                        const debugInfo = data.debug_info;
                                        const summary = `Ticket: ${debugInfo.ticket_id}
Main Attachments: ${debugInfo.main_attachments_count}
Metadata Attachments: ${debugInfo.metadata_attachments_count}
Common Documents: ${debugInfo.common_documents_count}
Source: ${debugInfo.ticket_source.processing_method}
Email Ticket: ${debugInfo.ticket_source.is_email_ticket}`;

                                        showNotification(` Debug Info: ${summary}`, 'info');

                                        // Log detailed info to console for developers
                                        console.log(' DETAILED DEBUG INFO:', debugInfo);
                                    } else {
                                        showNotification(data.message || 'Failed to debug attachments', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error debugging attachments:', error);
                                    showNotification('Error debugging attachments', 'error');
                                } finally {
                                    // Reset button
                                    debugAttachments.disabled = false;
                                    debugAttachments.innerHTML = '<i class="fas fa-bug mr-2"></i>Debug Attachments';
                                }
                            });
                        }

                        // Edit template button - with null check
                        if (editTemplate) {
                            editTemplate.addEventListener('click', function () {
                                // Make fields editable if they aren't already
                                if (emailSubject) emailSubject.removeAttribute('readonly');
                                if (emailBody) emailBody.removeAttribute('readonly');

                                // Update visual styling to show fields are editable
                                if (emailSubject) emailSubject.classList.add('bg-white', 'cursor-text');
                                if (emailBody) emailBody.classList.add('bg-white', 'cursor-text');

                                // Focus on subject field
                                if (emailSubject) emailSubject.focus();

                                // Show notification
                                showNotification(' Template is now editable! You can modify the subject and body.', 'info');

                                // Hide edit button since we're already editing
                                editTemplate.style.display = 'none';
                            });
                        }


                        // Clear fields button - with null check
                        if (clearFields) {
                            clearFields.addEventListener('click', function () {
                                // Clear the fields
                                if (emailSubject) emailSubject.value = '';
                                if (emailBody) emailBody.value = '';

                                // Clear attachments and show message
                                if (availableAttachments) availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Click "Load Template" to see available attachments.</p>';

                                // Focus on subject field
                                if (emailSubject) emailSubject.focus();

                                // Show notification
                                showNotification(' Fields cleared! You can now enter new content.', 'info');

                                // Hide edit button if it was showing
                                if (editTemplate) editTemplate.style.display = 'none';

                                // Reset template data
                                currentTemplateData = null;
                            });
                        }

                        // Make fields interactive when user starts typing - with null checks
                        if (emailSubject) {
                            emailSubject.addEventListener('input', function () {
                                // Ensure field is editable
                                this.removeAttribute('readonly');
                                this.classList.add('bg-white', 'cursor-text');

                                // Add visual feedback for active editing

                                // Auto-scroll to keep the field in view
                                this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            });

                            // Enhanced scrolling for email body
                            emailBody.addEventListener('input', function () {
                                // Ensure field is editable
                                this.removeAttribute('readonly');
                                this.classList.add('bg-white', 'cursor-text');

                                // Auto-scroll to keep the field in view when typing
                                this.scrollIntoView({ behavior: 'smooth', block: 'center' });

                                // Auto-resize textarea
                                this.style.height = 'auto';
                                this.style.height = Math.min(this.scrollHeight, 300) + 'px';
                            });

                            // Enhanced focus management for better UX
                            emailSubject.addEventListener('focus', function () {
                                this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                this.parentElement.classList.add('ring-2', 'ring-green-200');
                            });

                            emailSubject.addEventListener('blur', function () {
                                this.parentElement.classList.remove('ring-2', 'ring-green-200');
                            });

                            emailBody.addEventListener('focus', function () {
                                this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                this.parentElement.classList.add('ring-2', 'ring-green-200');
                            });

                            emailBody.addEventListener('blur', function () {
                                this.parentElement.classList.remove('ring-2', 'ring-green-200');
                            });

                            // Enhanced template type selection
                            templateTypeSelect.addEventListener('change', function () {
                                // Clear form when template type changes
                                emailSubject.value = '';
                                emailBody.value = '';
                                availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Select a template type and click "Load Template" to see available attachments.</p>';

                                // Show notification
                                showNotification(' Template type changed. Please load the new template.', 'info');

                                // Hide edit button
                                editTemplate.style.display = 'none';

                                // Reset template data
                                currentTemplateData = null;
                            });

                            // Keyboard shortcuts for better accessibility
                            document.addEventListener('keydown', function (e) {
                                // Only apply when email template modal is open
                                if (emailTemplateModal.classList.contains('active')) {
                                    // Ctrl/Cmd + Enter to send email
                                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                                        e.preventDefault();
                                        sendEmail.click();
                                    }

                                    // Escape to close modal
                                    if (e.key === 'Escape') {
                                        e.preventDefault();
                                        closeModal('emailTemplateModal');
                                    }

                                    // Tab navigation enhancement
                                    if (e.key === 'Tab') {
                                        // Ensure smooth scrolling when tabbing through fields
                                        setTimeout(() => {
                                            const activeElement = document.activeElement;
                                            if (activeElement && activeElement.closest('.email-template-content')) {
                                                activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            }
                                        }, 50);
                                    }
                                }
                            });

                            // Send email button - ANTI-SPAM PROTECTION ADDED
                            sendEmail.addEventListener('click', async function () {
                                // Allow sending with custom content even without loading template
                                // if (!currentTemplateData) {
                                //     showNotification('Please load a template first', 'error');
                                //     return;
                                // }

                                // PREVENT MULTIPLE SUBMISSIONS
                                if (sendEmail.disabled) {
                                    console.log(' EMAIL TEMPLATE BLOCKED - Already sending');
                                    return;
                                }

                                // Validate required fields
                                if (!emailSubject.value.trim()) {
                                    showNotification('Please enter an email subject', 'error');
                                    emailSubject.focus();
                                    return;
                                }

                                if (!emailBody.value.trim()) {
                                    showNotification('Please enter an email body', 'error');
                                    emailBody.focus();
                                    return;
                                }

                                //  FIXED: Get selected attachments with proper file data handling
                                const selectedAttachments = [];
                                const checkboxes = availableAttachments.querySelectorAll('input[type="checkbox"]:checked');
                                checkboxes.forEach(checkbox => {
                                    const isCommonDocument = checkbox.dataset.isCommonDocument === 'true';
                                    const documentId = checkbox.dataset.documentId;
                                    const hasFileData = checkbox.dataset.hasData === 'true';
                                    const fileData = checkbox.dataset.fileData || '';

                                    // Determine the correct file path based on attachment type
                                    let correctFilePath = checkbox.dataset.filePath || checkbox.dataset.key || '';
                                    if (isCommonDocument && documentId) {
                                        correctFilePath = `/api/common-documents/${documentId}/download`;
                                    }

                                    //  CRITICAL FIX: Validate file data before sending
                                    if (!hasFileData || !fileData || fileData.length < 10) {
                                        console.warn(` ATTACHMENT HAS NO VALID FILE DATA: ${checkbox.dataset.name}`);
                                        console.warn(` File data length: ${fileData ? fileData.length : 0}`);
                                        console.warn(` Has data flag: ${hasFileData}`);
                                    }

                                    const attachmentData = {
                                        name: checkbox.dataset.name,
                                        file_path: correctFilePath,
                                        key: checkbox.dataset.key || '',
                                        ticket_index: checkbox.dataset.ticketIndex ? parseInt(checkbox.dataset.ticketIndex) : null,
                                        fileData: fileData,  //  FIXED: Include the actual file data
                                        size: parseInt(checkbox.dataset.size) || 0,
                                        type: checkbox.dataset.type || 'file',
                                        is_common_document: isCommonDocument,
                                        document_id: documentId || null,
                                        has_data: hasFileData  //  ADDED: Flag to indicate if file has real data
                                    };

                                    console.log(' SELECTED EMAIL TEMPLATE ATTACHMENT:', {
                                        name: attachmentData.name,
                                        hasFileData: hasFileData,
                                        fileDataLength: fileData ? fileData.length : 0,
                                        size: attachmentData.size,
                                        type: attachmentData.type
                                    });
                                    selectedAttachments.push(attachmentData);
                                });

                                // Disable button during processing
                                sendEmail.disabled = true;
                                sendEmail.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

                                console.log(' EMAIL TEMPLATE SUBMISSION - Starting');

                                try {
                                    // Prepare email data
                                    const emailData = {
                                        ticket_id: '{{ ticket.ticket_id }}',
                                        template_type: 'warranty',
                                        custom_subject: emailSubject.value,
                                        custom_body: emailBody.value,
                                        attachments: selectedAttachments
                                    };

                                    console.log(' EMAIL DATA:', emailData);

                                    // Send to API endpoint
                                    const ticketId = '{{ ticket.ticket_id }}';
                                    const response = await fetch(`/api/tickets/${ticketId}/send-email`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify(emailData)
                                    });

                                    if (response.ok) {
                                        const result = await response.json();
                                        console.log(' EMAIL TEMPLATE SUCCESS:', result);
                                        showNotification('Email sent successfully! ', 'success');

                                        // Close modal first
                                        closeModal('emailTemplateModal');

                                        // Refresh the page to show the new email in conversation section
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1000);

                                    } else {
                                        // Fallback to placeholder behavior if API not implemented
                                        console.log(' EMAIL TEMPLATE PLACEHOLDER - API not yet implemented');
                                        showNotification('Email template prepared! (Integration with email service required for actual sending)', 'success');
                                        closeModal('emailTemplateModal');
                                    }

                                } catch (error) {
                                    console.error(' EMAIL TEMPLATE ERROR:', error);
                                    // Fallback to placeholder behavior
                                    showNotification('Email template prepared! (Integration with email service required for actual sending)', 'success');
                                    closeModal('emailTemplateModal');
                                } finally {
                                    // Reset button after delay to prevent spam
                                    setTimeout(() => {
                                        sendEmail.disabled = false;
                                        sendEmail.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Email';
                                        console.log(' EMAIL TEMPLATE RESET - Ready for next send');
                                    }, 2000);
                                }
                            });
                        } // End if (emailSubject)

                        // Priority selection functionality
                        const prioritySelect = document.getElementById('prioritySelect');
                        if (prioritySelect) {
                            // Store initial value for reverting on error
                            prioritySelect.dataset.previousPriority = prioritySelect.value;

                            prioritySelect.addEventListener('change', async function () {
                                const newPriority = this.value;
                                const ticketId = this.dataset.ticketId;

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/priority`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ priority: newPriority })
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        showNotification(`Priority updated to ${newPriority}`, 'success');

                                        // Update the priority badge display in real-time
                                        const priorityBadge = document.querySelector('.ticket-header .px-3.py-1.text-xs.rounded-lg.font-medium');
                                        if (priorityBadge) {
                                            // Update text content
                                            priorityBadge.textContent = '';

                                            // Update icon and text based on new priority
                                            let iconClass, bgClass, textClass;
                                            if (newPriority === 'Urgent') {
                                                iconClass = 'fas fa-exclamation-triangle';
                                                bgClass = 'bg-red-100';
                                                textClass = 'text-red-800';
                                            } else if (newPriority === 'High') {
                                                iconClass = 'fas fa-exclamation';
                                                bgClass = 'bg-orange-100';
                                                textClass = 'text-orange-800';
                                            } else if (newPriority === 'Medium') {
                                                iconClass = 'fas fa-circle';
                                                bgClass = 'bg-yellow-100';
                                                textClass = 'text-yellow-800';
                                            } else if (newPriority === 'Low') {
                                                iconClass = 'fas fa-check';
                                                bgClass = 'bg-green-100';
                                                textClass = 'text-green-800';
                                            }

                                            // Update badge content and styling
                                            priorityBadge.innerHTML = `<i class="${iconClass} mr-1"></i>${newPriority}`;
                                            priorityBadge.className = `px-3 py-1 text-xs rounded-lg font-medium ${bgClass} ${textClass}`;
                                        }

                                        // Update the select styling based on new priority
                                        this.className = this.className.replace(/bg-\w+-100 text-\w+-800/g, '');
                                        this.classList.add('px-3', 'py-1', 'text-xs', 'rounded-full', 'font-medium', 'border-none', 'bg-transparent', 'appearance-none', 'cursor-pointer', 'hover:opacity-80', 'transition');
                                        if (newPriority === 'Urgent') {
                                            this.classList.add('bg-red-100', 'text-red-800');
                                        } else if (newPriority === 'High') {
                                            this.classList.add('bg-orange-100', 'text-orange-800');
                                        } else if (newPriority === 'Medium') {
                                            this.classList.add('bg-yellow-100', 'text-yellow-800');
                                        } else if (newPriority === 'Low') {
                                            this.classList.add('bg-green-100', 'text-green-800');
                                        }

                                        // Store new value as previous for future error handling
                                        this.dataset.previousPriority = newPriority;

                                    } else {
                                        showNotification(data.message || 'Error updating priority', 'error');
                                        // Revert to previous value without page reload
                                        this.value = this.dataset.previousPriority || 'Medium';
                                    }
                                } catch (error) {
                                    console.error('Error updating priority:', error);
                                    showNotification('An error occurred while updating priority', 'error');
                                    // Revert to previous value without page reload
                                    this.value = this.dataset.previousPriority || 'Medium';
                                }
                            });
                        }

                        // Technician assignment functionality
                        const technicianSelect = document.getElementById('technicianSelect');
                        if (technicianSelect) {
                            // Store initial value for reverting on error
                            technicianSelect.dataset.previousTechnician = technicianSelect.value;

                            console.log(' Technician select element found:', technicianSelect);
                            console.log(' Available technicians:', Array.from(technicianSelect.options).map(opt => ({ value: opt.value, text: opt.text })));

                            technicianSelect.addEventListener('change', async function () {
                                const newTechnicianId = this.value;
                                const ticketId = this.dataset.ticketId;

                                console.log(` Assigning technician ${newTechnicianId} to ticket ${ticketId}`);

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/technician`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ technician_id: newTechnicianId })
                                    });

                                    console.log(` Response status: ${response.status}`);
                                    const data = await response.json();
                                    console.log(` Response data:`, data);

                                    if (response.ok && data.status === 'success') {
                                        if (newTechnicianId) {
                                            const selectedOption = this.options[this.selectedIndex];
                                            const technicianName = selectedOption.text.replace(' ', '').split(' (')[0];
                                            console.log(` Technician name extracted: ${technicianName}`);
                                            showNotification(`Technician assigned: ${technicianName}`, 'success');

                                            // Update the select styling
                                            this.className = this.className.replace(/bg-\w+-100 text-\w+-800/g, '');
                                            this.classList.add('px-3', 'py-1', 'text-xs', 'rounded-full', 'font-medium', 'border-none', 'bg-transparent', 'appearance-none', 'cursor-pointer', 'hover:opacity-80', 'transition', 'bg-indigo-100', 'text-indigo-800');

                                            // Update technician display in real-time
                                            const technicianDisplay = document.querySelector('.detail-card .text-gray-800.font-semibold');
                                            if (technicianDisplay && technicianDisplay.textContent.includes('{{ technician or "No Technician" }}')) {
                                                technicianDisplay.textContent = technicianName;
                                            }

                                            // Update technician info section if it exists
                                            const technicianInfoSection = document.querySelector('.detail-card .text-gray-600.text-xs');
                                            if (technicianInfoSection) {
                                                const selectedOption = this.options[this.selectedIndex];
                                                const technicianRole = selectedOption.text.match(/\((.*?)\)/)?.[1] || 'Technician';
                                                technicianInfoSection.innerHTML = `<i class="fas fa-id-badge mr-1"></i> ${technicianName} <span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">${technicianRole}</span>`;
                                            }

                                            // Send immediate update to home page
                                            console.log(` Sending technician update to home page: ${ticketId} -> ${technicianName}`);
                                            sendTechnicianUpdateToHomePage(ticketId, technicianName);

                                            showNotification(`Technician ${technicianName} assigned successfully!`, 'success');

                                            // Store new value as previous for future error handling
                                            this.dataset.previousTechnician = newTechnicianId;
                                        } else {
                                            showNotification('Technician assignment removed', 'success');

                                            // Update the select styling to default
                                            this.className = this.className.replace(/bg-\w+-100 text-\w+-800/g, '');
                                            this.classList.add('px-3', 'py-1', 'text-xs', 'rounded-full', 'font-medium', 'border-none', 'bg-transparent', 'appearance-none', 'cursor-pointer', 'hover:opacity-80', 'transition', 'bg-gray-100', 'text-gray-800');

                                            // Update technician display in real-time when removed
                                            const technicianDisplay = document.querySelector('.detail-card .text-gray-800.font-semibold');
                                            if (technicianDisplay) {
                                                technicianDisplay.textContent = 'No Technician Assigned';
                                            }

                                            // Update technician info section if it exists
                                            const technicianInfoSection = document.querySelector('.detail-card .text-gray-600.text-xs');
                                            if (technicianInfoSection) {
                                                technicianInfoSection.innerHTML = '<i class="fas fa-user-slash mr-1"></i> No technician assigned';
                                            }

                                            // Send immediate update to home page
                                            console.log(` Sending technician removal to home page: ${ticketId} -> null`);
                                            sendTechnicianUpdateToHomePage(ticketId, null);

                                            showNotification('Technician assignment removed!', 'success');

                                            // Store new value as previous for future error handling
                                            this.dataset.previousTechnician = '';
                                        }
                                    } else {
                                        showNotification(data.message || 'Error updating technician assignment', 'error');
                                        // Revert to previous value without page reload
                                        this.value = this.dataset.previousTechnician || '';
                                    }
                                } catch (error) {
                                    console.error('Error updating technician assignment:', error);
                                    showNotification('An error occurred while updating technician assignment', 'error');
                                    // Revert to previous value without page reload
                                    this.value = this.dataset.previousTechnician || '';
                                }
                            });
                        } else {
                            console.error(' Technician select element not found!');
                        }

                        // Outcome editing functionality
                        const editOutcomeBtn = document.getElementById('editOutcomeBtn');
                        const outcomeDisplayView = document.getElementById('outcomeDisplayView');
                        const outcomeEditView = document.getElementById('outcomeEditView');
                        const outcomeForm = document.getElementById('outcomeForm');
                        const cancelOutcomeBtn = document.getElementById('cancelOutcomeBtn');

                        // Revisit Fields Toggling Logic (defined early so edit/cancel buttons can call it)
                        const outcomeCategoryDropdown = document.getElementById('outcomeCategory');
                        const revisitFieldsContainer = document.getElementById('revisitFields');
                        const revisitDateInput = document.getElementById('revisitDate');
                        const revisitTechInput = document.getElementById('revisitTechnician');
                        const revisitReasonInput = document.getElementById('revisitReason');

                        function toggleRevisitFields() {
                            if (!outcomeCategoryDropdown || !revisitFieldsContainer) return;
                            if (outcomeCategoryDropdown.value === 'Revisit') {
                                revisitFieldsContainer.classList.remove('hidden');
                                if (revisitDateInput) revisitDateInput.required = true;
                                if (revisitTechInput) revisitTechInput.required = true;
                                if (revisitReasonInput) revisitReasonInput.required = true;
                            } else {
                                revisitFieldsContainer.classList.add('hidden');
                                if (revisitDateInput) revisitDateInput.required = false;
                                if (revisitTechInput) revisitTechInput.required = false;
                                if (revisitReasonInput) revisitReasonInput.required = false;
                            }
                        }

                        // Run on initial load
                        toggleRevisitFields();

                        // Run whenever dropdown value changes
                        if (outcomeCategoryDropdown) {
                            outcomeCategoryDropdown.addEventListener('change', toggleRevisitFields);
                        }

                        if (editOutcomeBtn) {
                            editOutcomeBtn.addEventListener('click', function () {
                                outcomeDisplayView.classList.add('hidden');
                                outcomeEditView.classList.remove('hidden');
                                // Re-trigger visibility check for revisit fields
                                toggleRevisitFields();
                            });
                        }

                        if (cancelOutcomeBtn) {
                            cancelOutcomeBtn.addEventListener('click', function () {
                                outcomeEditView.classList.add('hidden');
                                outcomeDisplayView.classList.remove('hidden');
                            });
                        }
                        if (outcomeForm) {
                            outcomeForm.addEventListener('submit', async function (e) {
                                e.preventDefault();

                                const outcomeCategory = document.getElementById('outcomeCategory').value;
                                const revisitCarriedOut = document.getElementById('revisitCarriedOut').checked;
                                const cleanUnderWarranty = document.getElementById('cleanUnderWarranty').checked;
                                const outcomeNotes = document.getElementById('outcomeNotes').value;

                                // Grab Revisit Extra Fields Data
                                const revisitDate = document.getElementById('revisitDate') ? document.getElementById('revisitDate').value : '';
                                const revisitTechnician = document.getElementById('revisitTechnician') ? document.getElementById('revisitTechnician').value : '';
                                const revisitReason = document.getElementById('revisitReason') ? document.getElementById('revisitReason').value : '';

                                const saveBtn = document.getElementById('saveOutcomeBtn');
                                saveBtn.disabled = true;
                                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                                try {
                                    const ticketId = '{{ ticket.ticket_id }}';
                                    const response = await fetch(`/api/tickets/${ticketId}/outcome`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            outcome_category: outcomeCategory,
                                            revisit_carried_out: revisitCarriedOut,
                                            clean_under_warranty: cleanUnderWarranty,
                                            outcome_notes: outcomeNotes,
                                            revisit_date: revisitDate,
                                            revisit_technician_id: revisitTechnician,
                                            revisit_reason: revisitReason
                                        }),
                                        credentials: 'include'
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        showNotification('Outcome information updated successfully', 'success');
                                        outcomeDisplayView.classList.remove('hidden');
                                        outcomeEditView.classList.add('hidden');
                                        setTimeout(() => window.location.reload(), 800);
                                    } else {
                                        showNotification(data.message || 'Error updating outcome', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error updating outcome:', error);
                                    showNotification('An error occurred while updating outcome', 'error');
                                } finally {
                                    saveBtn.disabled = false;
                                    saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Outcome';
                                }
                            });
                        }

                        function resetEmailTemplateForm() {
                            emailSubject.value = '';
                            emailBody.value = '';
                            availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Click "Load Template" to see available attachments.</p>';
                            sendEmail.disabled = false;  // Keep button enabled for direct sending
                            currentTemplateData = null;

                            // Ensure fields are editable by default
                            emailSubject.removeAttribute('readonly');
                            emailBody.removeAttribute('readonly');
                            emailSubject.classList.add('bg-white', 'cursor-text');
                            emailBody.classList.add('bg-white', 'cursor-text');

                            // Hide edit template button initially
                            editTemplate.style.display = 'none';

                            // Clean up draft indicator when form is reset
                            const draftIndicator = document.getElementById('draftIndicator');
                            if (draftIndicator) {
                                draftIndicator.remove();
                            }
                        }

                        //  REMOVED: Function to restore common documents - not needed anymore
                        // Common documents are completely separate from email template functionality

                        function populateAttachments(attachments) {
                            if (!attachments || attachments.length === 0) {
                                availableAttachments.innerHTML = '<p class="text-sm text-gray-500">No attachments available for this ticket.</p>';
                                return;
                            }

                            // ============================================================================
                            // ENHANCED CLIENT-SIDE ATTACHMENT VALIDATION WITH DUPLICATE REMOVAL
                            // ============================================================================

                            console.log(' REBUILDING ENHANCED CLIENT ATTACHMENT VALIDATION');
                            console.log(' Raw attachments received:', attachments);

                            //  ENHANCED DEBUGGING: Log detailed attachment structure
                            attachments.forEach((att, index) => {
                                console.log(` ATTACHMENT ${index + 1} DETAILS:`);
                                console.log(`  - Name: ${att.name || att.filename || 'NO_NAME'}`);
                                console.log(`  - Has fileData: ${!!att.fileData}`);
                                console.log(`  - fileData length: ${att.fileData ? att.fileData.length : 0}`);
                                console.log(`  - Has data: ${!!att.data}`);
                                console.log(`  - data length: ${att.data ? att.data.length : 0}`);
                                console.log(`  - Size: ${att.size || 'NO_SIZE'}`);
                                console.log(`  - Type: ${att.type || 'NO_TYPE'}`);
                                console.log(`  - All keys: ${Object.keys(att)}`);
                            });

                            // CLIENT-SIDE DUPLICATE REMOVAL: Remove duplicates before validation
                            const uniqueAttachments = [];
                            const seenNames = new Set();
                            const seenPaths = new Set();
                            const seenContent = new Set();

                            console.log(' CLIENT-SIDE DUPLICATE REMOVAL: Processing attachments for uniqueness');

                            for (const attachment of attachments) {
                                const name = attachment.name || attachment.filename || attachment.fileName || attachment.original_name || '';
                                const path = attachment.file_path || attachment.path || attachment.url || '';
                                const fileData = attachment.fileData || attachment.data || '';
                                const contentHash = `${fileData.length}_${attachment.size || 0}`;

                                // Check for duplicates
                                let isDuplicate = false;

                                if (name && seenNames.has(name)) {
                                    console.log(` CLIENT DUPLICATE DETECTED: ${name} - duplicate name`);
                                    isDuplicate = true;
                                } else if (path && seenPaths.has(path)) {
                                    console.log(` CLIENT DUPLICATE DETECTED: ${name} - duplicate path: ${path}`);
                                    isDuplicate = true;
                                } else if (fileData && seenContent.has(contentHash)) {
                                    console.log(` CLIENT DUPLICATE DETECTED: ${name} - duplicate content`);
                                    isDuplicate = true;
                                }

                                if (!isDuplicate) {
                                    uniqueAttachments.push(attachment);
                                    if (name) seenNames.add(name);
                                    if (path) seenPaths.add(path);
                                    if (fileData) seenContent.add(contentHash);
                                    console.log(` CLIENT UNIQUE ATTACHMENT: ${name}`);
                                } else {
                                    console.log(` CLIENT DUPLICATE REMOVED: ${name}`);
                                }
                            }

                            console.log(` CLIENT DUPLICATE REMOVAL: ${uniqueAttachments.length}/${attachments.length} attachments kept`);

                            // Show user notification if duplicates were removed
                            if (uniqueAttachments.length < attachments.length) {
                                const removedCount = attachments.length - uniqueAttachments.length;
                                showNotification(` Removed ${removedCount} duplicate attachment(s) to prevent confusion`, 'info');
                            }

                            function validateClientAttachment(attachment, index) {
                                // Extract name from any possible field
                                const name = attachment.name || attachment.filename || attachment.fileName || attachment.original_name || '';
                                const filePath = attachment.file_path || attachment.path || attachment.url || '';
                                const hasData = attachment.has_data || attachment.data || false;

                                console.log(` Validating attachment ${index}:`, {
                                    name: name,
                                    filePath: filePath,
                                    hasData: hasData,
                                    source: attachment.source || 'unknown'
                                });

                                // RULE 1: Must have a real name (not generic)
                                if (!name || name.trim() === '') {
                                    console.log(` REJECTED: No name`);
                                    return false;
                                }

                                const nameLower = name.toLowerCase().trim();
                                const fakeNames = ['unknown', 'unknown file', 'unknown_file', 'no name', 'untitled', 'file'];
                                if (fakeNames.includes(nameLower)) {
                                    console.log(` REJECTED: Fake name '${name}'`);
                                    return false;
                                }

                                // RULE 2: Must have either real data OR valid file path
                                const hasRealData = hasData === true || (attachment.data && attachment.data.length > 10);
                                const hasValidPath = filePath && filePath.trim().length > 3;

                                if (!hasRealData && !hasValidPath) {
                                    console.log(` REJECTED: No data and no valid path for '${name}'`);
                                    return false;
                                }

                                // RULE 3: If there's a file path, it must not be a status indicator
                                if (hasValidPath) {
                                    const pathLower = filePath.toLowerCase().trim();
                                    const statusWords = [
                                        'detected', 'true', 'false', 'none', 'null', 'undefined', 'empty',
                                        'yes', 'no', 'found', 'present', 'exists', 'valid', 'invalid'
                                    ];
                                    if (statusWords.includes(pathLower)) {
                                        console.log(` REJECTED: Status indicator path '${filePath}' for '${name}'`);
                                        return false;
                                    }
                                }

                                // RULE 4: Warranty forms must have real file paths or data
                                if (nameLower.includes('warranty') && nameLower.includes('form')) {
                                    if (!hasRealData && !hasValidPath) {
                                        console.log(` REJECTED: Fake warranty form without data '${name}'`);
                                        return false;
                                    }
                                }

                                console.log(` VALIDATED: '${name}' passed all checks`);
                                return true;
                            }

                            // Apply bulletproof validation to unique attachments
                            const validAttachments = uniqueAttachments.filter(validateClientAttachment);

                            console.log(` ENHANCED VALIDATION SUMMARY: ${validAttachments.length}/${uniqueAttachments.length} unique attachments passed validation`);

                            if (validAttachments.length === 0) {
                                availableAttachments.innerHTML = '<p class="text-sm text-gray-500">No attachments available for this ticket.</p>';
                                return;
                            }

                            const attachmentHTML = validAttachments.map(function (attachment) {
                                // Handle different attachment data structures with safe fallbacks
                                const attachmentName = attachment.name || attachment.filename || attachment.fileName || 'File';
                                const attachmentPath = attachment.file_path || attachment.path || '';
                                const attachmentKey = attachment.key || attachment.id || '';
                                const ticketIndex = attachment.ticket_index !== undefined ? attachment.ticket_index : '';
                                const hasData = attachment.has_data || false;

                                console.log(' POPULATING ATTACHMENT:', {
                                    name: attachmentName,
                                    file_path: attachmentPath,
                                    key: attachmentKey,
                                    ticket_index: ticketIndex,
                                    has_data: hasData,
                                    original: attachment
                                });

                                // Add visual indicator for attachments with data
                                const dataIndicator = hasData ? ' ' : ' ';

                                // Add manual ticket attachment indicator
                                const manualIndicator = attachment.is_manual_ticket_attachment ? ' ' : '';

                                // Add size indicator
                                const sizeIndicator = attachment.size ? ` (${(attachment.size / 1024).toFixed(1)} KB)` : '';

                                // Determine the correct file path based on attachment type
                                let correctFilePath = attachmentPath;
                                if (attachment.type === 'common-document' && attachment.document_id) {
                                    // For common documents, use the common document download endpoint
                                    correctFilePath = `/api/common-documents/${attachment.document_id}/download`;
                                }

                                // Add tooltip with attachment details
                                const tooltipText = `Type: ${attachment.type || 'file'}\nSize: ${attachment.size || 0} bytes\nHas Data: ${hasData ? 'Yes' : 'No'}\nManual Ticket: ${attachment.is_manual_ticket_attachment ? 'Yes' : 'No'}`;

                                //  FIXED: Properly handle file data for email template attachments
                                const fileData = attachment.fileData || attachment.data || '';
                                const hasFileData = fileData && fileData.length > 10; // Valid base64 data

                                return '<div class="flex items-center space-x-2 p-2 bg-gray-50 rounded hover:bg-gray-100 transition" title="' + tooltipText + '">' +
                                    '<input type="checkbox" id="attachment_' + attachmentName + '" ' +
                                    'data-name="' + attachmentName + '" ' +
                                    'data-file-path="' + correctFilePath + '" ' +
                                    'data-key="' + attachmentKey + '" ' +
                                    'data-ticket-index="' + (attachment.ticket_index || '') + '" ' +
                                    'data-file-data="' + fileData + '" ' +
                                    'data-size="' + (attachment.size || 0) + '" ' +
                                    'data-type="' + (attachment.type || 'file') + '" ' +
                                    'data-document-id="' + (attachment.document_id || '') + '" ' +
                                    'data-is-common-document="' + (attachment.is_common_document || false) + '" ' +
                                    'data-has-data="' + hasFileData + '" ' +
                                    'class="form-checkbox text-green-600" checked>' +
                                    '<label for="attachment_' + attachmentName + '" class="text-sm text-gray-700 flex-1 cursor-help">' +
                                    '<i class="fas fa-paperclip mr-1"></i>' + attachmentName + dataIndicator + manualIndicator + sizeIndicator +
                                    '</label></div>';
                            }).join('');

                            availableAttachments.innerHTML = attachmentHTML;
                        }
                    });

                    // Email attachment functions
                    function downloadEmailAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/download`;

                        // Create a temporary link to trigger download
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showNotification(`Downloading ${fileName}...`, 'success');
                    }

                    function previewEmailAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/preview`;

                        // Open preview in new window
                        const previewWindow = window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');

                        if (!previewWindow) {
                            showNotification('Popup blocked. Please allow popups for preview functionality.', 'error');
                            return;
                        }

                        showNotification(`Opening preview for ${fileName}...`, 'success');
                    }

                    // Ticket attachment functions
                    function downloadTicketAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/download`;

                        console.log(` Downloading ticket attachment: ${fileName} from ${url}`);

                        // Show downloading indicator
                        showNotification(`Downloading ${fileName}...`, 'info');

                        // Create a temporary link to trigger download
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showNotification(`Download started: ${fileName}`, 'success');

                        // Change button appearance temporarily
                        const button = event.target.closest('button');
                        if (button) {
                            const originalClass = button.className;
                            button.className = 'bg-green-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                            button.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                button.className = originalClass;
                                button.innerHTML = '<i class="fas fa-download"></i>';
                            }, 1500);
                        }
                    }

                    function previewTicketAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/preview`;

                        // Open preview in new window/tab
                        const previewWindow = window.open(url, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');

                        if (!previewWindow) {
                            showNotification('Popup blocked. Please allow popups for preview functionality.', 'error');
                            return;
                        }

                        showNotification(`Previewing ${fileName}...`, 'info');

                        // Change button appearance temporarily
                        const button = event.target.closest('button');
                        if (button) {
                            const originalClass = button.className;
                            button.className = 'bg-green-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                            button.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                button.className = originalClass;
                                button.innerHTML = '<i class="fas fa-eye"></i>';
                            }, 1500);
                        }
                    }

                    // Unified attachment functions for both reply and ticket attachments
                    function downloadAttachment(replyId, attachmentIndex, fileName, source) {
                        let url;
                        const ticketId = '{{ ticket.ticket_id|e }}';

                        // FIXED: Simplified attachment detection - use reply endpoints for all reply attachments
                        if (replyId && replyId !== 'undefined' && replyId !== 'null') {
                            // This is a reply attachment, use reply endpoint
                            url = `/api/replies/${replyId}/attachments/${parseInt(attachmentIndex)}/download`;
                        } else {
                            // This is a ticket attachment, use ticket endpoint
                            url = `/api/tickets/${ticketId}/attachments/${parseInt(attachmentIndex)}/download`;
                        }

                        // Show downloading indicator
                        showNotification(`Downloading ${fileName}...`, 'info');

                        // First check if the attachment exists and get info
                        fetch(url, { method: 'HEAD' })
                            .then(response => {
                                if (response.ok) {
                                    // Create a temporary link to trigger download
                                    const link = document.createElement('a');
                                    link.href = url;
                                    link.download = fileName;
                                    link.style.display = 'none';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);

                                    showNotification(`Download started: ${fileName}`, 'success');

                                    // Change button appearance temporarily
                                    const button = document.querySelector(`button[onclick*="${fileName}"]`);
                                    if (button) {
                                        const originalClass = button.className;
                                        button.className = 'bg-green-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                                        button.innerHTML = '<i class="fas fa-check"></i>';
                                        setTimeout(() => {
                                            button.className = originalClass;
                                            button.innerHTML = '<i class="fas fa-download"></i>';
                                        }, 1500);
                                    }
                                } else {
                                    // Enhanced error handling with better text_reference support
                                    if (response.status === 400) {
                                        // Try to get detailed error message for text_reference attachments
                                        fetch(url)
                                            .then(errorResponse => errorResponse.json())
                                            .then(errorData => {
                                                if (errorData.attachment_info && errorData.attachment_info.type === 'text_reference') {
                                                    showNotification(`This is a text reference: ${errorData.attachment_info.name}`, 'info');
                                                } else {
                                                    showNotification(`Download failed: ${errorData.error || response.statusText}`, 'error');
                                                }
                                            })
                                            .catch(() => {
                                                showNotification(`Download failed: ${response.statusText}`, 'error');
                                            });
                                    } else if (response.status === 404) {
                                        showNotification(`Attachment not found. Try using the Debug button to check attachment details.`, 'error');
                                    } else if (response.status === 401) {
                                        showNotification(`Authentication required. Please refresh the page and try again.`, 'error');
                                    } else {
                                        showNotification(`Download failed: ${response.statusText}. Try debugging the attachment.`, 'error');
                                    }
                                }
                            })
                            .catch(error => {
                                // Enhanced error handling for network issues
                                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                                    showNotification(`Network error. Please check your connection and try again.`, 'error');
                                } else {
                                    showNotification(`Download error: ${error.message}`, 'error');
                                }
                            });
                    }

                    // Function to update technician tag on home page if it's open in another tab
                    function updateHomePageTechnicianTag(ticketId, technicianName) {
                        try {
                            console.log(` Starting technician tag update for ticket ${ticketId} -> ${technicianName || 'None'}`);

                            // Method 1: Try to send a message to the home page if it's open
                            if (window.opener && !window.opener.closed) {
                                console.log(' Sending message to opener window...');
                                window.opener.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName,
                                    timestamp: Date.now()
                                }, '*');
                            }

                            // Method 2: Also try to send to parent window if this is in an iframe
                            if (window.parent && window.parent !== window) {
                                console.log(' Sending message to parent window...');
                                window.parent.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName,
                                    timestamp: Date.now()
                                }, '*');
                            }

                            // Method 3: Try to find other tabs/windows with the same origin
                            console.log(' Broadcasting message to all windows...');
                            window.postMessage({
                                type: 'updateTechnicianTag',
                                ticketId: ticketId,
                                technicianName: technicianName,
                                timestamp: Date.now()
                            }, '*');

                            // Method 4: Try to communicate with localStorage for cross-tab communication
                            try {
                                const updateData = {
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName,
                                    timestamp: Date.now()
                                };
                                localStorage.setItem('technicianUpdate', JSON.stringify(updateData));
                                console.log(' Stored technician update in localStorage');
                            } catch (localStorageError) {
                                console.log(' Could not use localStorage:', localStorageError);
                            }

                            console.log(` Technician update message sent successfully: ${ticketId} -> ${technicianName || 'None'}`);
                        } catch (error) {
                            console.error(' Error sending technician update message:', error);
                        }
                    }

                    // More reliable function to force refresh home page
                    function forceRefreshHomePage(ticketId, technicianName) {
                        console.log(` Force refreshing home page for ticket ${ticketId} -> ${technicianName || 'None'}`);

                        try {
                            // Method 1: Try to refresh the opener window (home page)
                            if (window.opener && !window.opener.closed) {
                                console.log(' Refreshing opener window (home page)...');
                                window.opener.location.reload();
                                return;
                            }

                            // Method 2: Try to refresh parent window
                            if (window.parent && window.parent !== window) {
                                console.log(' Refreshing parent window...');
                                window.parent.location.reload();
                                return;
                            }

                            // Method 3: If no other windows, refresh current page after delay
                            console.log(' No other windows found, refreshing current page in 1 second...');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);

                        } catch (error) {
                            console.error(' Error refreshing home page:', error);
                            // Fallback: refresh current page
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    }

                    function previewAttachment(replyId, attachmentIndex, fileName, source) {
                        let url;
                        const ticketId = '{{ ticket.ticket_id|e }}';

                        // FIXED: Simplified attachment detection - use reply endpoints for all reply attachments
                        if (replyId && replyId !== 'undefined' && replyId !== 'null') {
                            // This is a reply attachment, use reply endpoint
                            url = `/api/replies/${replyId}/attachments/${parseInt(attachmentIndex)}/preview`;
                        } else {
                            // This is a ticket attachment, use ticket endpoint
                            url = `/api/tickets/${ticketId}/attachments/${parseInt(attachmentIndex)}/preview`;
                        }

                        // First check if the attachment can be previewed
                        fetch(url, { method: 'HEAD' })
                            .then(response => {
                                if (response.ok) {
                                    // Open preview in new window/tab
                                    const previewWindow = window.open(url, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');

                                    if (!previewWindow) {
                                        showNotification('Popup blocked. Please allow popups for preview functionality.', 'error');
                                        return;
                                    }

                                    showNotification(`Previewing ${fileName}...`, 'info');

                                    // Change button appearance temporarily
                                    const button = document.querySelector(`button[onclick*="${fileName}"]`);
                                    if (button) {
                                        const originalClass = button.className;
                                        button.className = 'bg-blue-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                                        button.innerHTML = '<i class="fas fa-eye-slash"></i>';
                                        setTimeout(() => {
                                            button.className = originalClass;
                                            button.innerHTML = '<i class="fas fa-eye"></i>';
                                        }, 1500);
                                    }
                                } else {
                                    // Enhanced error handling with better text_reference support
                                    if (response.status === 400) {
                                        // Try to get detailed error message for text_reference attachments
                                        fetch(url)
                                            .then(errorResponse => errorResponse.json())
                                            .then(errorData => {
                                                if (errorData.attachment_info && errorData.attachment_info.type === 'text_reference') {
                                                    showNotification(`This is a text reference: ${errorData.attachment_info.name}`, 'info');
                                                } else {
                                                    showNotification(`File type not supported for preview. Try downloading instead.`, 'error');
                                                }
                                            })
                                            .catch(() => {
                                                showNotification(`File type not supported for preview. Try downloading instead.`, 'error');
                                            });
                                    } else if (response.status === 404) {
                                        showNotification(`Attachment not found. Try using the Debug button to check attachment details.`, 'error');
                                    } else if (response.status === 401) {
                                        showNotification(`Authentication required. Please refresh the page and try again.`, 'error');
                                    } else {
                                        showNotification(`Preview failed: ${response.statusText}. Try debugging the attachment.`, 'error');
                                    }
                                }
                            })
                            .catch(error => {
                                // Enhanced error handling for network issues
                                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                                    showNotification(`Network error. Please check your connection and try again.`, 'error');
                                } else {
                                    showNotification(`Preview error: ${error.message}`, 'error');
                                }
                            });
                    }

                    // Function to handle text reference attachments
                    function handleTextReferenceAttachment(attachmentName, description) {
                        const message = description ? `${attachmentName}: ${description}` : attachmentName;
                        showNotification(` Text Reference: ${message}`, 'info');
                    }



                    // Function to regenerate missing attachments for webhook replies
                    function regenerateWebhookAttachments() {
                        const ticketId = '{{ ticket.ticket_id|e }}';

                        showNotification('Regenerating webhook attachments...', 'info');

                        // Call the webhook-specific regenerate attachments endpoint
                        fetch(`/api/tickets/${ticketId}/regenerate-webhook-attachments`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    showNotification('Webhook attachments regenerated successfully! Refreshing page...', 'success');
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 2000);
                                } else if (data.status === 'warning') {
                                    showNotification(` ${data.message}`, 'info');
                                } else {
                                    showNotification(`Failed to regenerate webhook attachments: ${data.message}`, 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error regenerating webhook attachments:', error);
                                showNotification('Error regenerating webhook attachments. Please try again.', 'error');
                            });
                    }













                    // Function to send immediate technician update to home page
                    function sendTechnicianUpdateToHomePage(ticketId, technicianName) {
                        console.log(` Sending technician update: ${ticketId} -> ${technicianName || 'None'}`);

                        try {
                            // Method 1: Send message to opener window (home page)
                            if (window.opener && !window.opener.closed) {
                                console.log(' Sending to opener window...');
                                window.opener.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName
                                }, '*');
                            }

                            // Method 2: Send to parent window if in iframe
                            if (window.parent && window.parent !== window) {
                                console.log(' Sending to parent window...');
                                window.parent.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName
                                }, '*');
                            }

                            // Method 3: Broadcast to all windows
                            console.log(' Broadcasting to all windows...');
                            window.postMessage({
                                type: 'updateTechnicianTag',
                                ticketId: ticketId,
                                technicianName: technicianName
                            }, '*');

                            // Method 4: localStorage backup
                            try {
                                const updateData = {
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName
                                };
                                localStorage.setItem('technicianUpdate', JSON.stringify(updateData));
                                console.log(' Stored in localStorage');
                            } catch (localStorageError) {
                                console.log(' localStorage failed:', localStorageError);
                            }

                            // Method 5: Force refresh home page if it's open
                            if (window.opener && !window.opener.closed) {
                                console.log(' Refreshing opener window...');
                                setTimeout(() => {
                                    window.opener.location.reload();
                                }, 1000);
                            }

                            // Method 6: Try to find and update the home page directly if it's in the same window
                            try {
                                const homePageTickets = document.querySelectorAll('.ticket-card');
                                if (homePageTickets.length > 0) {
                                    console.log(' Found ticket cards on current page, updating directly...');
                                    // This means we're on the home page, update directly
                                    updateTechnicianTagOnCurrentPage(ticketId, technicianName);
                                }
                            } catch (directError) {
                                console.log(' Direct update not possible:', directError);
                            }

                            console.log(` Technician update sent successfully: ${ticketId} -> ${technicianName || 'None'}`);
                        } catch (error) {
                            console.error(' Error sending technician update:', error);
                        }
                    }

                    // Sidebar toggle functionality - REMOVED DUPLICATE CODE
                    // This functionality is now handled by the enhanced initializeSidebarToggle() function

                    // Initialize sidebar state based on current screen size
                    if (window.innerWidth >= 1921) {
                        rightSidebar.classList.add('ultra-wide-open');
                        if (sidebarToggle) {
                            sidebarToggle.style.display = 'block';
                            sidebarToggle.title = 'Open Sidebar';
                            const icon = sidebarToggle.querySelector('i');
                            if (icon) icon.className = 'fas fa-bars';
                        }
                    } else if (window.innerWidth <= 1280) {
                        if (sidebarToggle) {
                            sidebarToggle.style.display = 'block';
                            sidebarToggle.title = 'Open Sidebar';
                            const icon = sidebarToggle.querySelector('i');
                            if (icon) icon.className = 'fas fa-bars';
                        }
                    } else {
                        if (sidebarToggle) {
                            sidebarToggle.style.display = 'none';
                        }
                    }

                    // Minimize button functionality - removed conflicting listener
                    // The minimize button now properly closes the sidebar via the listener in initializeSidebarToggle()


                    // Function to update technician tag on the current page (if it's the home page)
                    function updateTechnicianTagOnCurrentPage(ticketId, technicianName) {
                        console.log(` Updating technician tag on current page for ticket ${ticketId}: ${technicianName || 'None'}`);

                        // Find the ticket card by ticket ID
                        const ticketCard = document.querySelector(`a[href*="/ticket/${ticketId}"]`)?.closest('.ticket-card');
                        if (!ticketCard) {
                            console.log(` Ticket card not found for ${ticketId}`);
                            return;
                        }

                        // Find or create the technician badge
                        let technicianBadge = ticketCard.querySelector('.technician-badge');

                        if (technicianName) {
                            // Create or update technician badge
                            if (!technicianBadge) {
                                technicianBadge = document.createElement('span');
                                technicianBadge.className = 'technician-badge px-2 py-1 text-xs rounded-full font-medium bg-blue-100 text-blue-800';
                                technicianBadge.innerHTML = ` ${technicianName}`;

                                // Insert after priority badge
                                const priorityBadge = ticketCard.querySelector('.priority-badge');
                                if (priorityBadge) {
                                    priorityBadge.parentNode.insertBefore(technicianBadge, priorityBadge.nextSibling);
                                } else {
                                    // Fallback: insert at the beginning of badges container
                                    const badgesContainer = ticketCard.querySelector('.flex.flex-wrap.items-center.gap-2');
                                    if (badgesContainer) {
                                        badgesContainer.insertBefore(technicianBadge, badgesContainer.firstChild);
                                    }
                                }
                            } else {
                                technicianBadge.innerHTML = ` ${technicianName}`;
                            }

                            console.log(` Technician badge updated for ticket ${ticketId}: ${technicianName}`);
                        } else {
                            // Remove technician badge if it exists
                            if (technicianBadge) {
                                technicianBadge.remove();
                                console.log(` Technician badge removed for ticket ${ticketId}`);
                            }
                        }
                    }

                    // Enhanced sidebar toggle functionality
                    function initializeSidebarToggle() {
                        const sidebarToggle = document.getElementById('sidebarToggleMobile');
                        const rightSidebar = document.querySelector('.right-sidebar');
                        const sidebarOverlay = document.getElementById('sidebarOverlay');
                        const minimizeBtn = document.getElementById('minimizeBtn');

                        if (!sidebarToggle || !rightSidebar) {
                            console.error(' Sidebar elements not found');
                            console.error('sidebarToggle:', sidebarToggle);
                            console.error('rightSidebar:', rightSidebar);
                            return;
                        }

                        console.log(' Initializing sidebar toggle functionality');
                        console.log(' Sidebar toggle button found:', sidebarToggle);
                        console.log(' Right sidebar found:', rightSidebar);

                        // Sidebar toggle click handler
                        sidebarToggle.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();

                            console.log(' Sidebar toggle clicked');
                            console.log(' Current window width:', window.innerWidth);
                            console.log(' Current sidebar classes:', rightSidebar.className);

                            // Get main content element for expansion
                            const mainContent = document.querySelector('.main-content');

                            // Check if we're on ultra-wide screen
                            if (window.innerWidth >= 1921) {
                                console.log(' Ultra-wide screen detected - toggling ultra-wide-open class');
                                console.log(' Before toggle - sidebar classes:', rightSidebar.className);
                                console.log(' Before toggle - sidebar transform:', rightSidebar.style.transform);

                                rightSidebar.classList.toggle('ultra-wide-open');

                                console.log(' After toggle - sidebar classes:', rightSidebar.className);
                                console.log(' After toggle - sidebar transform:', rightSidebar.style.transform);

                                // Update toggle button icon and main content expansion
                                const icon = this.querySelector('i');
                                const appContainer = document.querySelector('.app-container');

                                if (rightSidebar.classList.contains('ultra-wide-open')) {
                                    console.log(' Sidebar is now OPEN - updating UI');
                                    icon.className = 'fas fa-times';
                                    this.title = 'Close Sidebar';

                                    // Force sidebar to be visible with all properties
                                    rightSidebar.style.transform = 'translateX(0)';
                                    rightSidebar.style.visibility = 'visible';
                                    rightSidebar.style.opacity = '1';
                                    rightSidebar.style.display = 'block';
                                    rightSidebar.style.pointerEvents = 'auto';
                                    console.log(' Forced sidebar to be visible with all properties');

                                    // Expand app container when sidebar opens
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-closed');
                                        appContainer.classList.add('sidebar-open');
                                        console.log(' App container set to sidebar-open');
                                    }

                                    // Hide the toggle button when sidebar opens
                                    this.classList.add('hidden');
                                    console.log(' Sidebar opened (ultra-wide) - toggle button hidden');
                                } else {
                                    console.log(' Sidebar is now CLOSED - updating UI');
                                    icon.className = 'fas fa-bars';
                                    this.title = 'Open Sidebar';

                                    // Force sidebar to be hidden
                                    rightSidebar.style.transform = 'translateX(150%)';
                                    console.log(' Forced sidebar transform to translateX(150%)');

                                    // Contract app container when sidebar closes
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-open');
                                        appContainer.classList.add('sidebar-closed');
                                        console.log(' App container set to sidebar-closed');
                                    }

                                    // Show the toggle button when sidebar closes
                                    this.classList.remove('hidden');
                                    console.log(' Sidebar closed (ultra-wide) - toggle button shown');
                                }
                            } else {
                                // Standard mobile/tablet behavior
                                rightSidebar.classList.toggle('sidebar-open');

                                // Update toggle button icon and main content expansion
                                const icon = this.querySelector('i');
                                const appContainer = document.querySelector('.app-container');

                                if (rightSidebar.classList.contains('sidebar-open')) {
                                    icon.className = 'fas fa-times';
                                    this.title = 'Close Sidebar';

                                    // Force sidebar to be visible with all properties
                                    rightSidebar.style.transform = 'translateX(0)';
                                    rightSidebar.style.visibility = 'visible';
                                    rightSidebar.style.opacity = '1';
                                    rightSidebar.style.display = 'block';
                                    rightSidebar.style.pointerEvents = 'auto';
                                    console.log(' Forced sidebar to be visible with all properties');

                                    // Expand app container when sidebar opens
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-closed');
                                        appContainer.classList.add('sidebar-open');
                                    }
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'block';
                                        sidebarOverlay.classList.add('active');
                                    }
                                    // Hide the toggle button when sidebar opens
                                    this.classList.add('hidden');
                                    console.log(' Sidebar opened (mobile/tablet) - toggle button hidden');
                                } else {
                                    icon.className = 'fas fa-bars';
                                    this.title = 'Open Sidebar';
                                    // Contract app container when sidebar closes
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-open');
                                        appContainer.classList.add('sidebar-closed');
                                    }
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'none';
                                        sidebarOverlay.classList.remove('active');
                                    }
                                    // Show the toggle button when sidebar closes
                                    this.classList.remove('hidden');
                                    console.log(' Sidebar closed (mobile/tablet) - toggle button shown');
                                }
                            }
                        });

                        // Overlay click handler
                        if (sidebarOverlay) {
                            sidebarOverlay.addEventListener('click', function () {
                                rightSidebar.classList.remove('sidebar-open');
                                const icon = sidebarToggle.querySelector('i');
                                icon.className = 'fas fa-bars';
                                sidebarToggle.title = 'Open Sidebar';
                                this.style.display = 'none';
                                this.classList.remove('active');

                                // Expand app container to take full width
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                // Show the toggle button when sidebar closes
                                sidebarToggle.classList.remove('hidden');

                                console.log(' Sidebar closed via overlay click - toggle button shown');
                            });
                        }

                        // Minimize button click handler - closes the sidebar
                        if (minimizeBtn) {
                            minimizeBtn.addEventListener('click', function () {
                                console.log(' Minimize button clicked - closing sidebar');

                                // Close sidebar based on screen size
                                if (window.innerWidth >= 1921) {
                                    rightSidebar.classList.remove('ultra-wide-open');
                                } else {
                                    rightSidebar.classList.remove('sidebar-open');
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'none';
                                        sidebarOverlay.classList.remove('active');
                                    }
                                }

                                // Expand app container to take full width
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                // Show the toggle button when sidebar closes
                                sidebarToggle.classList.remove('hidden');

                                // Reset toggle button icon
                                const icon = sidebarToggle.querySelector('i');
                                if (icon) {
                                    icon.className = 'fas fa-bars';
                                    sidebarToggle.title = 'Open Sidebar';
                                }

                                console.log(' Sidebar closed via minimize button - toggle button shown');
                            });
                        }

                        // Close sidebar when clicking outside on mobile
                        document.addEventListener('click', function (e) {
                            if (window.innerWidth <= 1023) {
                                if (!rightSidebar.contains(e.target) &&
                                    !sidebarToggle.contains(e.target) &&
                                    rightSidebar.classList.contains('sidebar-open')) {

                                    rightSidebar.classList.remove('sidebar-open');
                                    const icon = sidebarToggle.querySelector('i');
                                    icon.className = 'fas fa-bars';
                                    sidebarToggle.title = 'Open Sidebar';
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'none';
                                        sidebarOverlay.classList.remove('active');
                                    }

                                    // Expand app container to take full width
                                    const appContainer = document.querySelector('.app-container');
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-open');
                                        appContainer.classList.add('sidebar-closed');
                                    }

                                    // Show the toggle button when sidebar closes
                                    sidebarToggle.classList.remove('hidden');

                                    console.log(' Sidebar closed via outside click - toggle button shown');
                                }
                            }
                        });

                        // Enhanced window resize handler for comprehensive screen size coverage
                        window.addEventListener('resize', function () {
                            const mainContent = document.querySelector('.main-content');

                            if (window.innerWidth >= 2560) {
                                // Very large screen (2560px+): enhanced ultra-wide behavior
                                console.log(' Resize detected: 2560px+ screen - applying ultra-wide behavior');

                                rightSidebar.classList.remove('sidebar-open', 'mobile-open');
                                rightSidebar.classList.add('ultra-wide-open');
                                console.log(' Added ultra-wide-open class to sidebar');

                                // Force sidebar to be hidden initially
                                rightSidebar.style.transform = 'translateX(150%)';
                                console.log(' Forced sidebar transform to translateX(150%)');

                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                    console.log(' App container set to sidebar-closed');
                                }

                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar (Ultra-Wide)';
                                    const icon = sidebarToggle.querySelector('i');
                                    if (icon) {
                                        icon.className = 'fas fa-bars';
                                    }
                                    console.log(' Toggle button shown and titled for ultra-wide');
                                }
                                console.log(' Resized to very large screen (2560px+): enhanced sidebar behavior');
                            } else if (window.innerWidth >= 1921) {
                                // Ultra-wide screen: auto-hide sidebar
                                rightSidebar.classList.remove('sidebar-open', 'mobile-open');
                                rightSidebar.classList.add('ultra-wide-open');

                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                    sidebarToggle.style.width = '56px';
                                    sidebarToggle.style.height = '56px';
                                    sidebarToggle.style.right = '1rem';
                                    const icon = sidebarToggle.querySelector('i');
                                    if (icon) {
                                        icon.className = 'fas fa-bars';
                                        icon.style.fontSize = '1.25rem';
                                    }
                                }
                                console.log(' Resized to ultra-wide: sidebar hidden');
                            } else if (window.innerWidth >= 1711 && window.innerWidth <= 1920) {
                                // Wide desktop (1711px - 1920px): hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                rightSidebar.style.transform = 'translateX(120%)';

                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to wide desktop (1711px-1920px): sidebar hidden by default - toggle button shown');
                            } else if (window.innerWidth >= 1281 && window.innerWidth <= 1710) {
                                // Standard desktop (1281px - 1710px): hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                rightSidebar.style.transform = 'translateX(120%)';

                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to standard desktop (1281px-1710px): sidebar hidden by default - toggle button shown');
                            } else if (window.innerWidth >= 1025 && window.innerWidth <= 1280) {
                                // Medium desktop: hide sidebar by default but allow toggling
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                rightSidebar.style.transform = 'translateX(120%)';

                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to medium desktop (1025px-1280px): sidebar hidden by default - toggle button shown');
                            } else if (window.innerWidth >= 769 && window.innerWidth <= 1024) {
                                // Tablet landscape: hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');

                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to tablet landscape (769px-1024px): sidebar hidden - toggle button shown');
                            } else if (window.innerWidth <= 768) {
                                // Mobile/tablet: hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');

                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }

                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                    const icon = sidebarToggle.querySelector('i');
                                    if (icon) {
                                        icon.className = 'fas fa-bars';
                                    }
                                }
                                console.log(' Resized to mobile/tablet (768px): sidebar hidden - toggle button shown');
                            }
                        });

                        // Enhanced initialization for comprehensive screen size coverage
                        const mainContent = document.querySelector('.main-content');

                        console.log(' Initializing sidebar state for screen width:', window.innerWidth);

                        if (window.innerWidth >= 2560) {
                            // Very large screen (2560px+): enhanced ultra-wide behavior
                            console.log(' Detected 2560px+ screen - applying ultra-wide behavior');

                            // Remove any conflicting classes first
                            rightSidebar.classList.remove('sidebar-open', 'mobile-open');

                            // Add ultra-wide-open class
                            rightSidebar.classList.add('ultra-wide-open');
                            console.log(' Added ultra-wide-open class to sidebar');

                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                                console.log(' App container set to sidebar-closed');
                            } else {
                                console.log(' App container not found');
                            }

                            // Show toggle button
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar (Ultra-Wide)';
                            console.log(' Toggle button shown and titled for ultra-wide');

                            // Force sidebar to be hidden initially
                            rightSidebar.style.transform = 'translateX(150%)';
                            console.log(' Forced sidebar transform to translateX(150%)');

                            console.log(' Initialized for very large screen (2560px+)');
                        } else if (window.innerWidth >= 1025) {
                            // Desktop (>= 1025px): Sidebar ALWAYS VISIBLE
                            rightSidebar.classList.remove('ultra-wide-open');
                            rightSidebar.classList.add('sidebar-open');
                            rightSidebar.style.transform = 'translateX(0)';
                            rightSidebar.style.visibility = 'visible';
                            rightSidebar.style.opacity = '1';
                            rightSidebar.style.display = 'block';

                            // Expand app container
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-closed');
                                appContainer.classList.add('sidebar-open');
                            }

                            // Hide toggle button as it's always open
                            sidebarToggle.classList.add('hidden');
                            console.log(' Initialized for desktop (>= 1025px): Sidebar forced visible');

                        } else if (window.innerWidth >= 769 && window.innerWidth <= 1024) {
                            // Tablet landscape: hidden by default
                            rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                            rightSidebar.style.transform = 'translateX(120%)';

                            // Contract app container
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }

                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for tablet: Sidebar hidden');
                        } else if (window.innerWidth <= 768) {
                            // Mobile/tablet: hide sidebar by default
                            rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');

                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }

                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for mobile/tablet (768px): sidebar hidden - toggle button shown');
                        }

                        console.log(' Sidebar toggle functionality initialized');
                    }

                    // Enhanced test function to verify sidebar toggle is working
                    function testSidebarToggle() {
                        console.log(' Testing sidebar toggle functionality...');
                        console.log(' Current window width:', window.innerWidth);

                        const sidebarToggle = document.getElementById('sidebarToggleMobile');
                        const rightSidebar = document.querySelector('.right-sidebar');
                        const sidebarOverlay = document.getElementById('sidebarOverlay');
                        const minimizeBtn = document.getElementById('minimizeBtn');

                        console.log(' Element search results:');
                        console.log('  - sidebarToggle:', sidebarToggle);
                        console.log('  - rightSidebar:', rightSidebar);
                        console.log('  - sidebarOverlay:', sidebarOverlay);
                        console.log('  - minimizeBtn:', minimizeBtn);

                        if (sidebarToggle) {
                            console.log(' Sidebar toggle button found');
                            console.log('  - ID:', sidebarToggle.id);
                            console.log('  - Classes:', sidebarToggle.className);
                            console.log('  - Display style:', sidebarToggle.style.display);
                            console.log('  - Computed display:', window.getComputedStyle(sidebarToggle).display);
                            console.log('  - Position:', sidebarToggle.style.position);
                            console.log('  - Z-index:', sidebarToggle.style.zIndex);
                            console.log('  - Visible:', sidebarToggle.offsetParent !== null);
                        } else {
                            console.log(' Sidebar toggle button not found');
                        }

                        if (rightSidebar) {
                            console.log(' Right sidebar found');
                            console.log('  - ID:', rightSidebar.id);
                            console.log('  - Classes:', rightSidebar.className);
                            console.log('  - Transform:', rightSidebar.style.transform);
                            console.log('  - Computed transform:', window.getComputedStyle(rightSidebar).transform);
                            console.log('  - Position:', rightSidebar.style.position);
                            console.log('  - Z-index:', rightSidebar.style.zIndex);
                            console.log('  - Visible:', rightSidebar.offsetParent !== null);
                            console.log('  - Bounding rect:', rightSidebar.getBoundingClientRect());
                        } else {
                            console.log(' Right sidebar not found');
                        }

                        if (sidebarOverlay) {
                            console.log(' Sidebar overlay found');
                            console.log('  - ID:', sidebarOverlay.id);
                            console.log('  - Classes:', sidebarOverlay.className);
                        } else {
                            console.log(' Sidebar overlay not found');
                        }

                        if (minimizeBtn) {
                            console.log(' Minimize button found');
                            console.log('  - ID:', minimizeBtn.id);
                            console.log('  - Classes:', minimizeBtn.className);
                        } else {
                            console.log(' Minimize button not found');
                        }

                        // Test CSS classes and styles
                        if (rightSidebar) {
                            console.log(' CSS Analysis:');
                            const computedStyle = window.getComputedStyle(rightSidebar);
                            console.log('  - Computed transform:', computedStyle.transform);
                            console.log('  - Computed position:', computedStyle.position);
                            console.log('  - Computed z-index:', computedStyle.zIndex);
                            console.log('  - Computed display:', computedStyle.display);
                            console.log('  - Computed visibility:', computedStyle.visibility);
                            console.log('  - Computed opacity:', computedStyle.opacity);
                        }
                    }

                    // SIDEBAR ALWAYS VISIBLE - Make sidebar visible on page load
                    (function () {
                        console.log(' Making sidebar always visible (Google Gemini style)');

                        // Force sidebar to be visible
                        const rightSidebar = document.querySelector('.right-sidebar');
                        if (rightSidebar) {
                            rightSidebar.style.transform = 'translateX(0)';
                            rightSidebar.style.pointerEvents = 'auto';
                            rightSidebar.style.visibility = 'visible';
                            rightSidebar.style.opacity = '1';
                            rightSidebar.style.display = 'flex';
                            rightSidebar.classList.add('sidebar-open');
                            console.log(' Sidebar visible on page load');
                        }

                        // Hide the toggle button since sidebar is always visible
                        const sidebarToggle = document.getElementById('sidebarToggleMobile');
                        if (sidebarToggle) {
                            sidebarToggle.style.display = 'none';
                        }
                    })();

                    // Call test function after a short delay
                    setTimeout(testSidebarToggle, 1000);
                </script>
            </div> <!-- Close main-content container -->
        </div> <!-- Close app-container -->

        <!-- Right Sidebar - Now properly positioned inside main-layout but outside app-container -->
        <div id="rightSidebar" class="right-sidebar">
            <!-- Notes Section -->
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Private Notes</h3>
                    <div class="flex items-center space-x-2">
                        <button id="addNoteBtn" class="add-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button id="minimizeBtn" class="minimize-btn" title="Minimize Sidebar">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div id="notesContainer">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <p>No notes yet. Add your first note!</p>
                    </div>
                </div>
            </div>

            <!-- Templates Section -->
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Response Templates</h3>
                    <button id="addTemplateBtn" class="add-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="templatesContainer">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <p>No templates yet. Add your first template!</p>
                    </div>
                </div>
            </div>

            <!-- Common Documents Section -->
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Common Documents</h3>
                    <button id="addDocumentBtn" class="add-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="documentsContainer">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <p>No documents yet. Add your first document!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar overlay for mobile -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
    </div> <!-- Close main-layout -->

    <!-- Socket.IO Real-Time Reply Updates -->
    <script>
        (function () {
            // Get ticket ID from URL
            const ticketId = '{{ ticket.ticket_id }}';
            const currentUserId = '{{ session.user_id if session.user_id else "customer" }}';
            const currentUserType = '{{ "agent" if session.is_agent else "customer" }}';

            // Connect to Socket.IO server
            const socket = io();
            let typingTimeout = null;

            // DEDUPLICATION: Track processed message IDs and content hashes
            const processedReplies = new Set();

            // Initialize with existing message IDs from the DOM
            document.querySelectorAll('.message[data-reply-id]').forEach(msg => {
                const replyId = msg.dataset.replyId;
                if (replyId) processedReplies.add(replyId);
            });

            // Also create hashes of existing messages for content-based deduplication
            document.querySelectorAll('.message').forEach(msg => {
                const content = msg.querySelector('.message-content');
                const sender = msg.querySelector('.message-sender');
                if (content && sender) {
                    const hash = `${sender.textContent.trim()}:${content.textContent.trim().substring(0, 100)}`;
                    processedReplies.add(hash);
                }
            });

            console.log('[SOCKET] Initialized deduplication with', processedReplies.size, 'existing messages');

            socket.on('connect', function () {
                console.log('[SOCKET] Connected - joining ticket room:', ticketId);
                socket.emit('join_ticket', { ticket_id: ticketId });
            });

            socket.on('disconnect', function () {
                console.log('[SOCKET] Disconnected');
            });

            // Listen for new replies
            socket.on('new_reply', function (data) {
                console.log('[SOCKET] New reply received:', data);

                // ROBUST DEDUPLICATION: Check by reply_id first
                if (data.reply_id && processedReplies.has(data.reply_id)) {
                    console.log('[SOCKET] Duplicate message detected by ID, skipping');
                    return;
                }

                // Content-based deduplication as fallback
                const contentHash = `${data.sender_name}:${data.message.substring(0, 100)}`;
                if (processedReplies.has(contentHash)) {
                    console.log('[SOCKET] Duplicate message detected by content hash, skipping');
                    return;
                }

                // Mark as processed
                if (data.reply_id) processedReplies.add(data.reply_id);
                processedReplies.add(contentHash);

                // Show toast notification only if it's NOT from me
                if (data.sender_type !== currentUserType && data.sender_name !== '{{ session.name }}') {
                    showReplyToast(data.sender_name, data.message);
                }

                // Always add to conversation (deduplication logic above handles double-adds)
                addReplyToConversation(data);

                // Clear typing indicator if it exists
                removeTypingIndicator();
            });

            // Listen for typing events
            socket.on('typing', function (data) {
                // Don't show typing indicator for myself
                if (data.user_name === '{{ session.name }}') return;
                showTypingIndicator(data.user_name);
            });

            socket.on('stop_typing', function (data) {
                removeTypingIndicator();
            });

            // Listen for ticket updates (status/priority)
            socket.on('ticket_updated', function (data) {
                console.log('[SOCKET] Ticket updated:', data);
                if (data.status) updateStatusUI(data.status);
                if (data.priority) updatePriorityUI(data.priority);
            });

            // ===== NEW: Specific Status Changed =====
            socket.on('ticket_status_changed', function (data) {
                console.log('[SOCKET] Status changed:', data);
                updateStatusUI(data.new_status);
                showReplyToast('System', `Status changed to ${data.new_status} by ${data.changed_by_name}`);
            });

            // ===== NEW: Specific Priority Changed =====
            socket.on('ticket_priority_changed', function (data) {
                console.log('[SOCKET] Priority changed:', data);
                updatePriorityUI(data.new_priority);
                showReplyToast('System', `Priority changed to ${data.new_priority} by ${data.changed_by_name}`);
            });

            // ===== NEW: Technician Assigned =====
            socket.on('technician_assigned', function (data) {
                console.log('[SOCKET] Technician assigned:', data);
                updateTechnicianUI(data.technician_name);
                showReplyToast('System', `Technician ${data.technician_name} assigned by ${data.assigned_by_name}`);
            });

            // ===== NEW: Ticket Forwarded =====
            socket.on('ticket_forwarded', function (data) {
                console.log('[SOCKET] Ticket forwarded:', data);
                updateForwardedUI(data.forwarded_to_name);
                showReplyToast('System', `Ticket forwarded to ${data.forwarded_to_name} by ${data.forwarded_from_name}`);
            });

            // ===== NEW: Ticket Taken Over =====
            socket.on('ticket_taken_over', function (data) {
                console.log('[SOCKET] Ticket taken over:', data);
                updateAssignedToUI(data.taken_by_name);
                showReplyToast('System', `Ticket taken over by ${data.taken_by_name}`);
            });

            // ===== NEW: Ticket Referred to Tech Director =====
            socket.on('ticket_referred', function (data) {
                console.log('[SOCKET] Ticket referred:', data);
                showReplyToast('System', `Ticket referred to Technical Director by ${data.referred_by_name}`);
            });

            // ===== UI Update Helper Functions =====
            function updateStatusUI(newStatus) {
                // Update status badge in header
                const statusBadge = document.querySelector('.status-badge, [data-status]');
                if (statusBadge) {
                    statusBadge.textContent = newStatus;
                    statusBadge.className = statusBadge.className.replace(/status-\w+/g, '');
                    statusBadge.classList.add(`status-${newStatus.toLowerCase().replace(/\s+/g, '-')}`);
                }

                // Update status dropdown if exists
                const statusDropdown = document.getElementById('statusDropdown');
                if (statusDropdown) statusDropdown.value = newStatus;
            }

            function updatePriorityUI(newPriority) {
                // Update priority badge in header
                const priorityBadge = document.querySelector('.priority-badge, [data-priority]');
                if (priorityBadge) {
                    priorityBadge.textContent = newPriority;
                    priorityBadge.className = priorityBadge.className.replace(/priority-\w+|badge-\w+/g, '');
                    const priorityClass = newPriority === 'Urgent' ? 'badge-urgent' :
                        newPriority === 'High' ? 'badge-fast' :
                            newPriority === 'Medium' ? 'badge-medium' : 'badge-low';
                    priorityBadge.classList.add('priority-badge', priorityClass);
                }

                // Update priority dropdown if exists
                const priorityDropdown = document.getElementById('priorityDropdown');
                if (priorityDropdown) priorityDropdown.value = newPriority;
            }

            function updateTechnicianUI(technicianName) {
                // Update technician display
                const technicianEl = document.querySelector('[data-technician], .assigned-technician');
                if (technicianEl) technicianEl.textContent = technicianName;

                // Update technician dropdown if exists
                const techDropdown = document.getElementById('technicianDropdown');
                if (techDropdown) {
                    const option = Array.from(techDropdown.options).find(o => o.text.includes(technicianName));
                    if (option) techDropdown.value = option.value;
                }
            }

            function updateForwardedUI(forwardedToName) {
                // Update or add forwarded badge
                let forwardedBadge = document.querySelector('.forwarded-badge');
                if (!forwardedBadge) {
                    forwardedBadge = document.createElement('span');
                    forwardedBadge.className = 'forwarded-badge status-badge';
                    forwardedBadge.style.cssText = 'background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.25);';
                    const badgesContainer = document.querySelector('.ticket-badges, .flex.gap-2');
                    if (badgesContainer) badgesContainer.appendChild(forwardedBadge);
                }
                forwardedBadge.innerHTML = `<i class="fas fa-share mr-1"></i>Forwarded to ${forwardedToName}`;
            }

            function updateAssignedToUI(assignedName) {
                // Update assigned to display
                const assignedEl = document.querySelector('[data-assigned-to], .assigned-to');
                if (assignedEl) assignedEl.textContent = assignedName;
            }

            // Emit typing events
            const responseTextarea = document.getElementById('response');
            if (responseTextarea) {
                responseTextarea.addEventListener('input', function () {
                    socket.emit('typing', {
                        ticket_id: ticketId,
                        user_name: '{{ session.name or "User" }}',
                        user_id: currentUserId
                    });

                    if (typingTimeout) clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(function () {
                        socket.emit('stop_typing', {
                            ticket_id: ticketId,
                            user_id: currentUserId
                        });
                    }, 2000);
                });
            }

            // Toast notification for new replies
            function showReplyToast(sender, message) {
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;';
                    document.body.appendChild(container);
                }

                const toast = document.createElement('div');
                toast.style.cssText = `
                background: linear-gradient(135deg, rgba(30, 30, 40, 0.95), rgba(40, 40, 55, 0.95));
                backdrop-filter: blur(10px);
                border: 1px solid rgba(34, 197, 94, 0.4);
                border-radius: 12px;
                padding: 16px 20px;
                min-width: 300px;
                max-width: 400px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
                animation: slideIn 0.3s ease-out;
            `;

                toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <i class="fas fa-comment" style="color: #22c55e; font-size: 20px;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">New Reply from ${sender}</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 13px;">${message.substring(0, 100)}${message.length > 100 ? '...' : ''}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer;"><i class="fas fa-times"></i></button>
                </div>
            `;

                container.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }

            // Add reply to conversation dynamically
            function addReplyToConversation(data) {
                const container = document.querySelector('.conversation-container');
                if (!container) return;

                const isCustomer = data.sender_type !== 'agent';
                const msgClass = isCustomer ? 'customer-message' : 'support-message';
                const iconClass = isCustomer ? 'fas fa-user-circle customer-icon' : 'fas fa-headset support-icon';
                const senderName = data.sender_name || (isCustomer ? '{{ ticket.name }}' : 'Support Team');

                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${msgClass}`;
                msgDiv.style.animation = 'slideIn 0.3s ease-out';

                // Basic structure matching server-side template
                msgDiv.innerHTML = `
                    <div class="message-header">
                        <span class="font-medium flex items-center">
                            <i class="${iconClass}"></i> ${senderName}
                        </span>
                        <span class="message-time">Just now</span>
                    </div>
                    <div class="reply-message-box">
                        <div class="message-content">${data.message}</div>
                    </div>
                `;

                // Handle attachments if present (simplified text representation for now or rudimentary HTML)
                if (data.attachments && data.attachments.length > 0) {
                    // TODO: Build attachment HTML dynamically if needed
                    // For now just appending a note
                    const attDiv = document.createElement('div');
                    attDiv.className = 'mt-2 text-xs text-gray-500';
                    attDiv.innerHTML = `<i class="fas fa-paperclip"></i> ${data.attachments.length} Attachment(s) (Reload to view)`;
                    msgDiv.querySelector('.reply-message-box').appendChild(attDiv);
                }

                container.appendChild(msgDiv);
                window.scrollTo(0, document.body.scrollHeight);
            }

            // Typing Indicator
            function showTypingIndicator(username) {
                const container = document.querySelector('.conversation-container');
                if (!container) return;

                let indicator = document.getElementById('typing-indicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'message customer-message'; // Default style
                    indicator.style.opacity = '0.7';
                    indicator.innerHTML = `
                        <div class="message-header">
                            <span class="font-medium text-xs text-gray-400">
                                <i class="fas fa-keyboard mr-1 animate-pulse"></i> ${username} is typing...
                            </span>
                        </div>
                    `;
                    container.appendChild(indicator);
                    container.scrollTop = container.scrollHeight;
                }
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }

            // Update Status UI
            function updateStatusUI(status) {
                const statusBadge = document.getElementById('statusBadge');
                if (statusBadge) {
                    statusBadge.textContent = status;

                    // Helper to get color class based on status
                    const getStatusColor = (s) => {
                        s = s.toLowerCase();
                        if (s.includes('open')) return 'status-open';
                        if (s.includes('pending')) return 'status-pending';
                        if (s.includes('closed') || s.includes('solved')) return 'status-closed';
                        return 'status-new'; // default
                    };

                    // Remove only status-* color classes, NOT status-badge or other utilities
                    statusBadge.className = statusBadge.className.replace(/\bstatus-(?!badge)[\w-]+\b/g, '');
                    // Add new class and ensure status-badge is present
                    statusBadge.classList.add(getStatusColor(status));
                    statusBadge.classList.add('status-badge');
                    // Add new class
                    statusBadge.classList.add(getStatusColor(status));

                    // Also update the dropdown text if it exists
                    const currentStatusDisplay = document.getElementById('currentStatusDisplay');
                    if (currentStatusDisplay) currentStatusDisplay.textContent = status;
                }
            }

            // Expose globally
            window.toggleMessage = function (index) {
                const content = document.getElementById(`message-content-${index}`);
                const btn = document.getElementById(`toggle-btn-${index}`);

                if (!content || !btn) return;

                if (content.classList.contains('line-clamp-3')) {
                    // Expand  remove clamp and show all text
                    content.classList.remove('line-clamp-3');
                    content.style.webkitLineClamp = 'unset';
                    content.style.lineClamp = 'unset';
                    content.style.display = 'block';
                    content.style.overflow = 'visible';
                    btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Show Less';
                } else {
                    // Collapse  re-apply clamp
                    content.classList.add('line-clamp-3');
                    content.style.webkitLineClamp = '3';
                    content.style.lineClamp = '3';
                    content.style.display = '-webkit-box';
                    content.style.overflow = 'hidden';
                    btn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Read More';
                }
            };



            // Add CSS animation
            if (!document.getElementById('socket-styles')) {
                const style = document.createElement('style');
                style.id = 'socket-styles';
                style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
                document.head.appendChild(style);
            }
        })();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('response_editor');
            const menu = document.getElementById('mentionMenu');

            if (!editor || !menu) return;

            let isMentioning = false;
            let mentionStartIndex = 0;

            // We can show the menu based on the cursor position
            function updateMenuPosition() {
                // Position relative to the editor
                const editorRect = editor.getBoundingClientRect();

                // Simplified positioning logic that works reliably
                menu.style.left = '16px';
                menu.style.bottom = '100%';
                menu.style.top = 'auto'; // override default top
                menu.style.marginBottom = '8px';

                menu.classList.remove('hidden');
                console.log("Showing mention menu!");
            }

            // Capture input for @
            editor.addEventListener('input', (e) => {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);

                // Get text before cursor
                let textBeforeCursor = '';
                if (range.startContainer.nodeType === Node.TEXT_NODE) {
                    textBeforeCursor = range.startContainer.textContent.substring(0, range.startOffset);
                } else if (range.startContainer === editor) {
                    textBeforeCursor = editor.textContent;
                }

                console.log("Text before cursor: '" + textBeforeCursor + "'");

                // Check if we just typed `@` or are currently typing a mention
                const match = textBeforeCursor.match(/(?:^|\s)(@\w*)$/);

                if (match) {
                    isMentioning = true;
                    mentionStartIndex = range.startOffset - match[1].length;
                    updateMenuPosition();
                } else {
                    isMentioning = false;
                    menu.classList.add('hidden');
                }
            });

            // Handle arrow keys and Enter when menu is open
            editor.addEventListener('keydown', (e) => {
                if (!isMentioning) return;

                if (e.key === 'Escape') {
                    isMentioning = false;
                    menu.classList.add('hidden');
                }
            });

            // Handle clicking a mention item
            document.querySelectorAll('.mention-item').forEach(item => {
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Prevents the editor from losing focus
                    e.stopPropagation();
                    insertMention(item.getAttribute('data-value'), item.getAttribute('data-id'));
                });
            });

            function insertMention(value, id) {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);

                // Ensure we are working with text node
                if (range.startContainer.nodeType === Node.TEXT_NODE) {
                    let text = range.startContainer.textContent;

                    // Find the @ typed
                    const beforeCursor = text.substring(0, range.startOffset);
                    const afterCursor = text.substring(range.startOffset);
                    const textParts = beforeCursor.split(/(?:^|\s)(@\w*)$/);

                    if (textParts.length >= 2) {
                        const preMentionText = textParts.slice(0, -2).join('') + (beforeCursor.match(/(?:^|\s)(@\w*)$/)[0].startsWith(' ') ? ' ' : '');

                        // Construct new nodes
                        const preNode = document.createTextNode(preMentionText);
                        const mentionBadge = document.createElement('span');
                        mentionBadge.className = 'mention-badge';
                        mentionBadge.contentEditable = 'false';
                        mentionBadge.dataset.ref = id;
                        mentionBadge.innerHTML = `<i class="fas fa-link mr-1"></i>${value}`;

                        // Add a trailing space so user can keep typing
                        const postNode = document.createTextNode('\u00A0' + afterCursor); // NBSP

                        // Replace the text node with the new elements
                        const parent = range.startContainer.parentNode;
                        parent.insertBefore(preNode, range.startContainer);
                        parent.insertBefore(mentionBadge, range.startContainer);
                        parent.insertBefore(postNode, range.startContainer);
                        parent.removeChild(range.startContainer);

                        // Move cursor right after the badge and the space
                        const newRange = document.createRange();
                        newRange.setStart(postNode, 1);
                        newRange.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }

                // Hide menu
                isMentioning = false;
                menu.classList.add('hidden');

                // Trigger manual input so localstorage updates
                editor.dispatchEvent(new Event('input', { bubbles: true }));
            }

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target) && e.target !== editor) {
                    isMentioning = false;
                    menu.classList.add('hidden');
                }
            });
        });
    </script>
</body>

</html>